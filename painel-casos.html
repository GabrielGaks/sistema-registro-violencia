<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Painel de Casos de ViolÃªncia Escolar</title>
  
  <!-- Esconde conteÃºdo IMEDIATAMENTE para evitar flash -->
  <style>
    html:not(.page-ready) {
      opacity: 0 !important;
      visibility: hidden !important;
    }
    html.page-ready {
      opacity: 1 !important;
      visibility: visible !important;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
  </style>
  
  <!-- TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Estilos Elegantes Compartilhados -->
  <link rel="stylesheet" href="assets/css/styles-elegant.css">
  
  <!-- ConfiguraÃ§Ã£o Centralizada -->
  <script src="config.js"></script>
  <script src="assets/js/utils/config-loader.js"></script>
  
  <!-- Sistema de TransiÃ§Ãµes entre PÃ¡ginas -->
  <script src="assets/js/utils/page-transitions.js"></script>
  
  <!-- Dashboard e EstatÃ­sticas (arquivo separado para evitar HTML muito longo) -->
  <script src="assets/js/modules/dashboard-stats.js"></script>
  
  <!-- Biblioteca para grÃ¡ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- Biblioteca para gerar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <style>
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* AnimaÃ§Ã£o suave para linhas da tabela */
    .record-row {
      animation: slideInRow 0.3s ease-out backwards;
    }
    
    @keyframes slideInRow {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    /* Delay escalonado para cada linha */
    .record-row:nth-child(1) { animation-delay: 0.05s; }
    .record-row:nth-child(2) { animation-delay: 0.1s; }
    .record-row:nth-child(3) { animation-delay: 0.15s; }
    .record-row:nth-child(4) { animation-delay: 0.2s; }
    .record-row:nth-child(5) { animation-delay: 0.25s; }
    .record-row:nth-child(6) { animation-delay: 0.3s; }
    .record-row:nth-child(7) { animation-delay: 0.35s; }
    .record-row:nth-child(8) { animation-delay: 0.4s; }
    .record-row:nth-child(9) { animation-delay: 0.45s; }
    .record-row:nth-child(10) { animation-delay: 0.5s; }
    
    /* Checkboxes personalizados elegantes */
    .custom-checkbox {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid #cbd5e1;
      border-radius: 5px;
      background-color: white;
      cursor: pointer;
      position: relative;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      flex-shrink: 0;
    }
    
    .custom-checkbox:hover {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .custom-checkbox:checked {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      border-color: #2563eb;
      box-shadow: 0 2px 5px rgba(37, 99, 235, 0.3);
    }
    
    .custom-checkbox:checked::after {
      content: 'âœ“';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      color: white;
      font-size: 12px;
      font-weight: bold;
      animation: checkPop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes checkPop {
      0% { transform: translate(-50%, -50%) scale(0); }
      50% { transform: translate(-50%, -50%) scale(1.2); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    
    .checkbox-label {
      cursor: pointer;
      user-select: none;
      transition: color 0.2s ease;
      font-size: 0.875rem;
    }
    
    .checkbox-container:hover .checkbox-label {
      color: #1e40af;
    }
    
    /* Painel avanÃ§ado colapsÃ¡vel */
    .advanced-panel {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      opacity: 0;
    }
    
    .advanced-panel.open {
      max-height: 2000px;
      opacity: 1;
    }
    
    .filter-section.show {
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .toggle-icon {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .toggle-icon.open {
      transform: rotate(180deg);
    }
    
    .checkbox-container {
      transition: all 0.2s ease;
    }
    
    .checkbox-container:hover {
      background-color: #f8fafc;
      transform: translateY(-1px);
    }
    
    /* Cards de filtros clicÃ¡veis */
    .filter-card {
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      min-height: 80px;
      display: flex;
      align-items: center;
    }
    
    .filter-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
      transition: left 0.5s ease;
    }
    
    .filter-card:hover::before {
      left: 100%;
    }
    
    .filter-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      border-color: #3b82f6;
      background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
    }
    
    .filter-card.active {
      border-color: #2563eb;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }
    
    .filter-card-icon {
      transition: transform 0.3s ease;
    }
    
    .filter-card:hover .filter-card-icon {
      transform: scale(1.1) rotate(5deg);
    }
    
    .filter-card.active .filter-card-icon {
      transform: scale(1.15);
    }
    
    .badge-count {
      animation: badgePop 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    @keyframes badgePop {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    /* Grupos de Encaminhamento */
    .encaminhamento-group {
      border: 2px solid #e5e7eb;
      border-radius: 0.75rem;
      overflow: hidden;
      transition: all 0.3s ease;
      background: white;
    }
    
    .encaminhamento-group:hover {
      border-color: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    .group-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.875rem 1rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .group-header:hover {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    }
    
    .group-header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
    }
    
    .group-checkbox-wrapper {
      display: flex;
      align-items: center;
    }
    
    .group-checkbox-wrapper input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .group-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 0.9375rem;
    }
    
    .group-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 1.5rem;
      height: 1.5rem;
      padding: 0 0.5rem;
      background: #3b82f6;
      color: white;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    
    .group-badge.hidden {
      display: none;
    }
    
    .toggle-icon {
      width: 1.25rem;
      height: 1.25rem;
      transition: transform 0.3s ease;
      color: #6b7280;
    }
    
    .toggle-icon.rotated {
      transform: rotate(180deg);
    }
    
    .group-body {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: white;
    }
    
    .group-body.expanded {
      max-height: 1000px;
    }
    
    .group-body-content {
      padding: 1rem;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 0.5rem;
    }
    
    .encaminhamento-group.outros-detectados {
      border-style: dashed;
      border-color: #f59e0b;
      background: #fffbeb;
    }
    
    .encaminhamento-group.outros-detectados .group-header {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    }

    /* Menu Hamburguer Responsivo */
    /* Desktop: Mostra menu horizontal, esconde hamburguer */
    .mobile-menu-button {
      display: none !important;
    }

    .desktop-menu {
      display: flex;
    }

    .mobile-menu {
      display: none;
    }

    /* Apenas Celulares e Tablets: Esconde menu horizontal, mostra hamburguer */
    @media (max-width: 768px) {
      .mobile-menu-button {
        display: flex !important;
      }
      
      .desktop-menu {
        display: none !important;
      }
      
      .mobile-menu {
        display: block !important;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }

      .mobile-menu.show {
        max-height: 500px;
      }
    }

    /* Melhorias de toque para mobile */
    @media (hover: none) and (pointer: coarse) {
      button, a {
        min-height: 44px;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
  
  <!-- Container Principal -->
  <div class="max-w-[1400px] mx-auto px-4 py-8">
  
  <!-- Menu de NavegaÃ§Ã£o -->
  <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl shadow-lg mb-6">
    <div class="px-4 py-3">
      <!-- BotÃ£o Hamburguer (Mobile) -->
      <button onclick="toggleMobileMenu()" class="mobile-menu-button w-full flex items-center justify-between text-white font-semibold">
        <span>ğŸ“± Menu</span>
        <svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
      
      <!-- Menu Desktop -->
      <nav class="desktop-menu flex flex-wrap gap-2 justify-center items-center">
        <a href="painel-casos.html" class="px-5 py-2.5 bg-white text-blue-600 rounded-lg text-sm font-semibold shadow-md hover:shadow-lg transition-all">
          ğŸ“Š Painel de Casos
        </a>
        <a href="registro-novo-caso.html" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
          ğŸ“ Novo Registro
        </a>
        <a href="gerenciar-casos.html" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
          ğŸ“‹ Gerenciar Registros
        </a>
        <a id="menuAdmin" href="gerenciar-usuarios.html" class="hidden px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
          ğŸ”§ Painel Admin
        </a>
        <button id="btnSair" onclick="sair()" class="hidden px-5 py-2.5 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition-all">
          ğŸšª Sair
        </button>
        <button id="btnSairVisualizadorDesktop" onclick="sair()" class="hidden px-5 py-2.5 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition-all">
          ğŸšª Sair
        </button>
      </nav>
      
      <!-- Menu Mobile (Dropdown) -->
      <nav id="mobileMenuNav" class="mobile-menu mt-3">
        <div class="flex flex-col gap-2">
          <a href="painel-casos.html" class="btn-elegant px-5 py-3 bg-white text-blue-600 rounded-lg text-sm font-semibold shadow-md text-center border-2 border-blue-500">
            ğŸ“Š Painel de Casos
          </a>
          <a href="registro-novo-caso.html" class="btn-elegant btn-primary-elegant px-5 py-3 rounded-lg text-sm font-semibold text-center">
            ğŸ“ Novo Registro
          </a>
          <a href="gerenciar-casos.html" class="btn-elegant btn-primary-elegant px-5 py-3 rounded-lg text-sm font-semibold text-center">
            ğŸ“‹ Gerenciar Registros
          </a>
          <a id="menuAdminMobile" href="gerenciar-usuarios.html" class="btn-elegant btn-primary-elegant hidden px-5 py-3 rounded-lg text-sm font-semibold text-center">
            ğŸ”§ Painel Admin
          </a>
          <button id="btnLogoutVisualizadorMobile" onclick="sair()" class="btn-elegant btn-danger-elegant hidden px-5 py-3 rounded-lg text-sm font-semibold text-center">
            ğŸšª Sair
          </button>
          <button id="btnSairMobile" onclick="sair()" class="btn-elegant btn-danger-elegant hidden px-5 py-3 rounded-lg text-sm font-semibold text-center">
            ğŸšª Sair
          </button>
        </div>
      </nav>
    </div>
  </div>
  
  <!-- CABEÃ‡ALHO -->
  <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
    <div class="flex items-center justify-center gap-4 mb-3">
      <div class="h-14 w-14 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 text-3xl shadow-sm">
        ğŸ“Š
      </div>
      <div class="text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-blue-800">
          Painel de Casos de ViolÃªncia Escolar
        </h1>
      </div>
    </div>
    <p class="text-center text-gray-600">Sistema de visualizaÃ§Ã£o e anÃ¡lise de dados conectado ao Google Sheets</p>
    <p class="text-center text-gray-500 text-sm mt-2">âœ… Dados carregados automaticamente da planilha oficial</p>
  </div>
    
    <!-- CONEXÃƒO COM PLANILHA -->
    <section class="bg-white rounded-2xl shadow-xl p-6 mb-6">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ”— ConexÃ£o com Planilha</h2>
      
      <div class="mb-4 flex items-center justify-between">
        <div>
          <p class="text-slate-700 font-medium mb-1">Planilha conectada:</p>
          <p class="text-slate-500 text-sm">Os dados sÃ£o carregados automaticamente da planilha configurada no Google Sheets</p>
        </div>
        <button id="btnAtualizar" class="px-6 py-3 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium transition-colors">
          ğŸ”„ Atualizar Dados
        </button>
      </div>
      
      <div id="uploadStatus" class="p-4 rounded-md bg-blue-50 text-blue-700">â³ Carregando dados da planilha...</div>
    </section>

    <!-- FILTROS -->
    <section id="filtersSection" class="bg-white rounded-2xl shadow-xl p-6 mb-6 hidden fade-in">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4">ğŸ” Filtros</h2>
      
      <!-- Cards de Filtros ClicÃ¡veis -->
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">ğŸ¯ Filtros RÃ¡pidos</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-3">
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="regiao" onclick="openFilterSection('regiao')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">ğŸ“</span>
                <span class="text-sm font-medium text-gray-700">RegiÃ£o</span>
              </div>
              <span id="badge-regiao" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="tipoViolencia" onclick="openFilterSection('tipoViolencia')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">âš ï¸</span>
                <span class="text-sm font-medium text-gray-700">Tipo ViolÃªncia</span>
              </div>
              <span id="badge-tipoViolencia" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="tipoInstituicao" onclick="openFilterSection('tipoInstituicao')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">ğŸ«</span>
                <span class="text-sm font-medium text-gray-700">Tipo InstituiÃ§Ã£o</span>
              </div>
              <span id="badge-tipoInstituicao" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="escola" onclick="openFilterSection('escola')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">ğŸ¢</span>
                <span class="text-sm font-medium text-gray-700">Escola EspecÃ­fica</span>
              </div>
              <span id="badge-escola" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <!-- NOVO CARD: Tempo Integral -->
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="ti" onclick="openFilterSection('ti')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">â±ï¸</span>
                <span class="text-sm font-medium text-gray-700">Tempo Integral</span>
              </div>
              <span id="badge-ti" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="encaminhamento" onclick="openFilterSection('encaminhamento')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">ğŸ“‹</span>
                <span class="text-sm font-medium text-gray-700">Encaminhamento</span>
              </div>
              <span id="badge-encaminhamento" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="raca" onclick="openFilterSection('raca')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">ğŸ‘¥</span>
                <span class="text-sm font-medium text-gray-700">RaÃ§a/Cor</span>
              </div>
              <span id="badge-raca" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="genero" onclick="openFilterSection('genero')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">âš§ï¸</span>
                <span class="text-sm font-medium text-gray-700">GÃªnero (M/F)</span>
              </div>
              <span id="badge-genero" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <!-- NOVO CARD: Tipo de deficiÃªncia/transtorno -->
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="tipoDeficiencia" onclick="openFilterSection('tipoDeficiencia')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">â™¿</span>
                <span class="text-sm font-medium text-gray-700">Tipo de deficiÃªncia</span>
              </div>
              <span id="badge-tipoDeficiencia" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <!-- NOVO CARD: OrientaÃ§Ã£o Sexual -->
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="orientacao" onclick="openFilterSection('orientacao')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">ğŸŒˆ</span>
                <span class="text-sm font-medium text-gray-700">OrientaÃ§Ã£o Sexual</span>
              </div>
              <span id="badge-orientacao" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <!-- NOVO CARD: ClassificaÃ§Ã£o da ViolÃªncia -->
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="classificacao" onclick="openFilterSection('classificacao')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">ğŸ·ï¸</span>
                <span class="text-sm font-medium text-gray-700">ClassificaÃ§Ã£o</span>
              </div>
              <span id="badge-classificacao" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
          <!-- NOVO CARD: MotivaÃ§Ã£o da ViolÃªncia -->
          <div class="filter-card bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm" data-filter="motivacao" onclick="openFilterSection('motivacao')">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <span class="filter-card-icon text-2xl">ğŸ¯</span>
                <span class="text-sm font-medium text-gray-700">MotivaÃ§Ã£o</span>
              </div>
              <span id="badge-motivacao" class="badge-count hidden bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
            </div>
          </div>
          
        </div>
      </div>
      
      <!-- Outros Filtros -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
        
        <!-- Filtro: Ã‰ PCD -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Ã‰ PCD/tem deficiÃªncia:</label>
          <select id="filterPCD" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="S">Sim</option>
            <option value="N">NÃ£o</option>
          </select>
        </div>
        
        <!-- Filtro: Ocorreu na escola -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Ocorreu na escola?</label>
          <select id="filterOcorreuEscola" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="S">Sim</option>
            <option value="N">NÃ£o</option>
          </select>
        </div>
        
        <!-- Filtro: Fonte informada -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Fonte informada:</label>
          <select id="filterFonteInformada" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="S">Sim</option>
            <option value="N">NÃ£o</option>
          </select>
        </div>
        
        <!-- Filtro: ViolÃªncia identificada pela escola ocorrida na escola (Coluna Q) -->
        <div>
          <label class="block text-gray-700 font-medium mb-2 text-sm">ViolÃªncia identificada pela escola ocorrida nela:</label>
          <select id="filterViolenciaEscolaOcorreu" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="S">Sim</option>
            <option value="N">NÃ£o</option>
          </select>
        </div>
        
        <!-- Filtro: Profissional autor -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Profissional da escola foi autor:</label>
          <select id="filterProfissionalAutor" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="S">Sim</option>
            <option value="N">NÃ£o</option>
          </select>
        </div>
        
        <!-- Filtro: Estudante autor -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Estudante foi autor:</label>
          <select id="filterEstudanteAutor" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="S">Sim</option>
            <option value="N">NÃ£o</option>
          </select>
        </div>
        
        <!-- Filtro: ViolÃªncia nÃ£o ocorrida na escola -->
        <div>
          <label class="block text-gray-700 font-medium text-sm" style="margin-bottom: 6px;">ViolÃªncia identificada nÃ£o ocorrida na escola:</label>
          <select id="filterViolenciaNaoEscola" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm" style="margin-top: 2px;">
            <option value="">Todos</option>
            <option value="S">Sim</option>
            <option value="N">NÃ£o</option>
          </select>
        </div>
        
        <!-- Filtro: ViolÃªncia informada Ã  escola -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">ViolÃªncia informada Ã  escola:</label>
          <select id="filterViolenciaInformada" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="S">Sim</option>
            <option value="N">NÃ£o</option>
          </select>
        </div>
        
        <!-- Filtro: Estudo de Caso -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">ğŸ“‹ Foi Realizado Estudo de Caso?</label>
          <select id="filterEstudoCaso" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
            <option value="">Todos</option>
            <option value="S">Sim</option>
            <option value="N">NÃ£o</option>
          </select>
        </div>
        
        <!-- Filtro: Idade MÃ­nima -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Idade MÃ­nima:</label>
          <input type="number" id="filterIdadeMin" placeholder="Ex: 5" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
        </div>
        
        <!-- Filtro: Idade MÃ¡xima -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Idade MÃ¡xima:</label>
          <input type="number" id="filterIdadeMax" placeholder="Ex: 18" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
        </div>

        <!-- Filtro: Data InÃ­cio -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Data InÃ­cio:</label>
          <input type="date" id="filterDataInicio"
                 class="input-elegant w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
        </div>

        <!-- Filtro: Data Fim -->
        <div>
          <label class="block text-gray-700 font-medium mb-2">Data Fim:</label>
          <input type="date" id="filterDataFim"
                 class="input-elegant w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
        </div>
        
        <!-- Filtro: Busca por nome -->
        <div class="md:col-span-2 lg:col-span-3 xl:col-span-4">
          <label class="block text-gray-700 font-medium mb-2">Buscar por nome da crianÃ§a/estudante:</label>
          <input type="text" id="filterNome" placeholder="Digite parte do nome..." class="input-elegant w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
        </div>
        
      </div>
      
      <!-- Painel AvanÃ§ado -->
      <div id="advancedPanel" class="advanced-panel mt-6">
        <div class="bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl p-6 border border-gray-200 shadow-sm">
          <h3 class="text-lg font-semibold text-gray-700 mb-6 flex items-center gap-2">
            <span class="text-2xl">ğŸ”</span>
            <span>Filtros AvanÃ§ados</span>
          </h3>
          
          <!-- RegiÃ£o -->
          <div id="section-regiao" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">ğŸ“ RegiÃ£o</h4>
            <div id="filterRegiaoContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- Tipo de ViolÃªncia -->
          <div id="section-tipoViolencia" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">âš ï¸ Tipo de ViolÃªncia</h4>
            <div id="filterTipoViolenciaContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- Tipo de InstituiÃ§Ã£o (CMEI/EMEF) -->
          <div id="section-tipoInstituicao" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">ğŸ« Tipo de InstituiÃ§Ã£o</h4>
            <div id="filterTipoInstituicaoContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- Escola EspecÃ­fica -->
          <div id="section-escola" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">ğŸ¢ Escola EspecÃ­fica</h4>
            <div id="filterEscolaContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- NOVA SEÃ‡ÃƒO: Tempo Integral -->
          <div id="section-ti" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">â±ï¸ Tempo Integral</h4>
            <div class="flex gap-3 items-center">
              <label class="text-sm font-medium text-gray-700">Filtrar por:</label>
              <select id="filterTI" class="px-4 py-2 border-2 border-gray-300 rounded-lg text-sm font-medium focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all">
                <option value="">Todos</option>
                <option value="TI">Tempo Integral (TI)</option>
                <option value="Regular">Tempo Regular (nÃ£o TI)</option>
              </select>
            </div>
          </div>
          
          <!-- Encaminhamento -->
          <div id="section-encaminhamento" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide flex items-center justify-between">
              <span>ğŸ“‹ Encaminhamento</span>
              <span id="badge-encaminhamento-total" class="badge-count hidden inline-flex items-center justify-center px-2.5 py-1 text-xs font-bold leading-none text-white bg-blue-600 rounded-full">0</span>
            </h4>
            <div id="filterEncaminhamentoContainer" class="space-y-3"></div>
          </div>
          
          <!-- RaÃ§a/Cor -->
          <div id="section-raca" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">ğŸ‘¥ RaÃ§a/Cor</h4>
            <div id="filterRacaContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- Identidade de GÃªnero -->
          <div id="section-genero" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">âš§ï¸ GÃªnero (M/F)</h4>
            <div id="filterGeneroContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- NOVA SEÃ‡ÃƒO: Tipo de deficiÃªncia/transtorno -->
          <div id="section-tipoDeficiencia" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">â™¿ Tipo de deficiÃªncia / transtorno</h4>
            <div id="filterTipoDeficienciaContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- NOVA SEÃ‡ÃƒO: OrientaÃ§Ã£o Sexual -->
          <div id="section-orientacao" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">ğŸŒˆ OrientaÃ§Ã£o Sexual</h4>
            <div id="filterOrientacaoContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- NOVA SEÃ‡ÃƒO: ClassificaÃ§Ã£o da ViolÃªncia -->
          <div id="section-classificacao" class="filter-section mb-6 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">ğŸ·ï¸ ClassificaÃ§Ã£o da ViolÃªncia</h4>
            <div id="filterClassificacaoContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
          
          <!-- NOVA SEÃ‡ÃƒO: MotivaÃ§Ã£o da ViolÃªncia -->
          <div id="section-motivacao" class="filter-section mb-0 hidden">
            <h4 class="text-sm font-semibold text-gray-600 mb-3 uppercase tracking-wide">ğŸ¯ MotivaÃ§Ã£o da ViolÃªncia</h4>
            <div id="filterMotivacaoContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2"></div>
          </div>
        </div>
      </div>
      
      <div class="mt-4 flex gap-2 flex-wrap">
        <button id="btnLimparFiltros" class="btn-elegant btn-secondary-elegant px-4 py-2 rounded-md font-medium">
          ğŸ”„ Limpar Filtros
        </button>
        <button id="btnExportarCSV" class="btn-elegant px-4 py-2 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-md font-medium">
          ğŸ“¥ Exportar CSV
        </button>
        <button id="btnExportarExcel" class="btn-elegant px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-md font-medium">
          ğŸ“Š Exportar Excel
        </button>
        <button id="btnExportarPDF" class="btn-elegant px-4 py-2 bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white rounded-md font-medium">
          ğŸ“„ Exportar PDF
        </button>
      </div>
    </section>

    <!-- DASHBOARD EXECUTIVO -->
    <section id="dashboardExecutivo" class="card-elegant bg-gradient-to-br from-slate-50 to-blue-50 rounded-2xl shadow-xl p-6 mb-6 hidden fade-in border-2 border-blue-200">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
          <span class="text-4xl animate-float">ğŸ“Š</span>
          <span>Dashboard Executivo</span>
        </h2>
        <button id="btnAtualizarKPIs" class="btn-elegant btn-primary-elegant px-4 py-2 rounded-lg text-sm font-semibold">
          ğŸ”„ Atualizar
        </button>
      </div>
      
      <!-- KPIs Principais -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="card-elegant bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl p-5 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium opacity-90">Total de Casos</span>
            <span class="text-2xl">ğŸ“‹</span>
          </div>
          <div id="kpiTotalCasos" class="text-4xl font-bold mb-1">0</div>
          <div class="text-xs opacity-75" id="kpiTotalCasosVariacao">-</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-5 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium opacity-90">Casos Filtrados</span>
            <span class="text-2xl">ğŸ”</span>
          </div>
          <div id="kpiCasosFiltrados" class="text-4xl font-bold mb-1">0</div>
          <div class="text-xs opacity-75" id="kpiCasosFiltradosPercentual">-</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-5 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium opacity-90">Top Escola</span>
            <span class="text-2xl">ğŸ«</span>
          </div>
          <div id="kpiTopEscola" class="text-2xl font-bold mb-1 truncate">-</div>
          <div class="text-xs opacity-75" id="kpiTopEscolaCasos">-</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-5 text-white shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105">
          <div class="flex items-center justify-between mb-2">
            <span class="text-sm font-medium opacity-90">Tipo Mais Frequente</span>
            <span class="text-2xl">âš ï¸</span>
          </div>
          <div id="kpiTipoFrequente" class="text-lg font-bold mb-1 truncate">-</div>
          <div class="text-xs opacity-75" id="kpiTipoFrequenteCasos">-</div>
        </div>
      </div>
      
      <!-- AnÃ¡lise EstatÃ­stica e Top 5 -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
        <div class="card-elegant bg-white rounded-xl p-5 border-2 border-gray-200 shadow-md">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span>ğŸ“ˆ</span>
            <span>EstatÃ­sticas Descritivas (Idade)</span>
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="text-gray-600 font-medium">MÃ©dia:</span>
              <span id="statMediaIdade" class="text-lg font-bold text-blue-600">-</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="text-gray-600 font-medium">Mediana:</span>
              <span id="statMedianaIdade" class="text-lg font-bold text-blue-600">-</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="text-gray-600 font-medium">MÃ­nima:</span>
              <span id="statIdadeMin" class="text-lg font-bold text-green-600">-</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-gray-100">
              <span class="text-gray-600 font-medium">MÃ¡xima:</span>
              <span id="statIdadeMax" class="text-lg font-bold text-red-600">-</span>
            </div>
            <div class="flex justify-between items-center py-2">
              <span class="text-gray-600 font-medium">Desvio PadrÃ£o:</span>
              <span id="statDesvioPadrao" class="text-lg font-bold text-purple-600">-</span>
            </div>
          </div>
        </div>
        
        <div class="card-elegant bg-white rounded-xl p-5 border-2 border-gray-200 shadow-md">
          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span>ğŸ†</span>
            <span>Top 5 Escolas</span>
          </h3>
          <div id="top5Escolas" class="space-y-2">
            <div class="text-gray-400 text-center py-4">Carregando...</div>
          </div>
        </div>
      </div>
      
      <!-- AnÃ¡lise Temporal -->
      <div class="card-elegant bg-white rounded-xl p-5 border-2 border-gray-200 shadow-md">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
          <span>ğŸ“…</span>
          <span>AnÃ¡lise Temporal</span>
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="text-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg border border-blue-200">
            <div class="text-sm text-gray-600 mb-1">Casos Este MÃªs</div>
            <div id="statCasosEsteMes" class="text-3xl font-bold text-blue-700">0</div>
          </div>
          <div class="text-center p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-lg border border-green-200">
            <div class="text-sm text-gray-600 mb-1">Casos MÃªs Anterior</div>
            <div id="statCasosMesAnterior" class="text-3xl font-bold text-green-700">0</div>
          </div>
          <div class="text-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg border border-purple-200">
            <div class="text-sm text-gray-600 mb-1">VariaÃ§Ã£o</div>
            <div id="statVariacaoMensal" class="text-3xl font-bold text-purple-700">0%</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ESTATÃSTICAS -->
    <section id="statsSection" class="card-elegant bg-white rounded-2xl shadow-xl p-6 mb-6 hidden fade-in">
      <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <span class="text-3xl animate-float">ğŸ“ˆ</span>
        <span>EstatÃ­sticas</span>
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card-elegant bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-5 border-2 border-blue-200">
          <div class="text-gray-600 text-sm font-medium mb-2">Total de Registros</div>
          <div id="statTotal" class="text-4xl font-bold text-blue-700">0</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-5 border-2 border-green-200">
          <div class="text-gray-600 text-sm font-medium mb-2">Registros Filtrados</div>
          <div id="statFiltrados" class="text-4xl font-bold text-green-700">0</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-5 border-2 border-amber-200">
          <div class="text-gray-600 text-sm font-medium mb-2">Ocorreram na Escola</div>
          <div id="statEscola" class="text-4xl font-bold text-amber-700">0</div>
        </div>
        
        <div class="card-elegant bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-5 border-2 border-purple-200">
          <div class="text-gray-600 text-sm font-medium mb-2">Tipos de ViolÃªncia</div>
          <div id="statTipos" class="text-sm text-purple-700 mt-1 max-h-20 overflow-y-auto scrollbar-elegant"></div>
        </div>
      </div>
    </section>

    <!-- GRÃFICOS -->
    <section id="chartsSection" class="bg-white rounded-2xl shadow-xl p-6 mb-6 hidden fade-in">
      <h2 class="text-2xl font-semibold text-gray-800 mb-6">ğŸ“Š GrÃ¡ficos DinÃ¢micos</h2>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- GrÃ¡fico: Tipos de ViolÃªncia -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Tipos de ViolÃªncia</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartTipoViolencia"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Por RegiÃ£o -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">Casos por RegiÃ£o</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartRegiao"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Por Escola -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">Top 10 Escolas</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartEscola"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Por Faixa EtÃ¡ria -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">Faixa EtÃ¡ria</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartIdade"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Por GÃªnero -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">GÃªnero (M/F)</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartGenero"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Por RaÃ§a/Cor -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">RaÃ§a/Cor</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartRaca"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Linha do Tempo -->
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 lg:col-span-2">
          <h3 class="text-lg font-semibold text-slate-700 mb-4">Linha do Tempo (Por MÃªs)</h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartTemporal"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Encaminhamentos -->
        <div class="bg-gradient-to-br from-slate-50 to-blue-50 rounded-xl p-5 border-2 border-slate-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ“Š</span>
            <span>Encaminhamentos por Rede</span>
          </h3>
          <div class="relative" style="height: 320px;">
            <canvas id="chartEncaminhamento"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Autor da ViolÃªncia -->
        <div class="bg-gradient-to-br from-slate-50 to-purple-50 rounded-xl p-5 border-2 border-slate-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ‘¤</span>
            <span>Autor da ViolÃªncia</span>
          </h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartAutor"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Ocorreu na Escola? -->
        <div class="bg-gradient-to-br from-slate-50 to-green-50 rounded-xl p-5 border-2 border-slate-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ«</span>
            <span>Ocorreu na Escola?</span>
          </h3>
          <div class="relative" style="height: 300px;">
            <canvas id="chartOcorreuEscola"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: CorrelaÃ§Ã£o Tipo de ViolÃªncia vs Faixa EtÃ¡ria -->
        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-5 border-2 border-indigo-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ”—</span>
            <span>CorrelaÃ§Ã£o: Tipo de ViolÃªncia vs Faixa EtÃ¡ria</span>
          </h3>
          <div class="relative" style="height: 350px;">
            <canvas id="chartCorrelacaoTipoIdade"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: Comparativo Temporal (Ãšltimos 6 Meses vs PerÃ­odo Anterior) -->
        <div class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-xl p-5 border-2 border-amber-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ“Š</span>
            <span>Comparativo Temporal: Ãšltimos 6 Meses vs PerÃ­odo Anterior</span>
          </h3>
          <div class="relative" style="height: 350px;">
            <canvas id="chartComparativoTemporal"></canvas>
          </div>
        </div>
        
        <!-- GrÃ¡fico: TendÃªncia Anual (ComparaÃ§Ã£o Ano Atual vs Ano Anterior) -->
        <div class="bg-gradient-to-br from-teal-50 to-cyan-50 rounded-xl p-5 border-2 border-teal-200 shadow-lg hover:shadow-xl transition-all duration-300 card-hover lg:col-span-2">
          <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
            <span class="text-2xl">ğŸ“ˆ</span>
            <span>TendÃªncia Anual: ComparaÃ§Ã£o MÃªs a MÃªs</span>
          </h3>
          <div class="relative" style="height: 350px;">
            <canvas id="chartTendenciaAnual"></canvas>
          </div>
        </div>
        
      </div>
    </section>

    <!-- RESULTADOS -->
    <section id="resultsSection" class="bg-white rounded-2xl shadow-xl p-6 hidden fade-in">
      <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-gray-200">
        <h2 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
          <span class="text-4xl">ğŸ“‹</span>
          <span>Registros</span>
          <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-800 border border-blue-200">
            <span id="recordCount">0</span>
          </span>
        </h2>
      </div>
      
      <div id="noResultsMessage" class="hidden p-6 text-center text-gray-500">âš ï¸ Nenhum registro encontrado com os filtros atuais.</div>
      
      <div id="tableContainer" class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
        <table class="min-w-full border-collapse text-sm">
          <thead class="bg-gradient-to-r from-blue-50 via-indigo-50 to-purple-50 sticky top-0 shadow-sm">
            <tr>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-blue-200">ğŸ‘¤ CrianÃ§a/Estudante</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-indigo-200">ğŸ“… Idade</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-purple-200">ğŸ—“ï¸ Data</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-blue-200">âš ï¸ Tipo de ViolÃªncia</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-indigo-200">ğŸ« CMEI/EMEF</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-purple-200">ğŸ“ RegiÃ£o</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-blue-200">ğŸ“‹ Encaminhamento</th>
              <th class="px-4 py-3.5 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 border-b-2 border-indigo-200">âœ“ Na Escola?</th>
            </tr>
          </thead>
          <tbody id="tableBody" class="bg-white divide-y divide-slate-200"></tbody>
        </table>
      </div>
      
      <!-- Controles de PaginaÃ§Ã£o Modernos -->
      <div id="paginacao" class="mt-6 flex flex-col sm:flex-row items-center justify-between gap-4 px-6 py-4 bg-gradient-to-r from-gray-50 to-gray-100 rounded-lg border border-gray-200 shadow-sm">
        <div class="flex items-center gap-3">
          <span class="text-sm font-medium text-gray-700">ğŸ“„ Exibir:</span>
          <select id="registrosPorPaginaSelect" class="px-3 py-2 bg-white border-2 border-gray-300 rounded-lg text-sm font-medium text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all hover:border-gray-400 cursor-pointer shadow-sm">
            <option value="5">5 registros</option>
            <option value="10" selected>10 registros</option>
            <option value="25">25 registros</option>
            <option value="50">50 registros</option>
            <option value="100">100 registros</option>
          </select>
        </div>
        
        <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow-sm border border-slate-200">
          <span class="text-xs font-medium text-slate-500 uppercase tracking-wide">PÃ¡gina</span>
          <span id="paginacaoInfo" class="text-sm font-bold text-slate-700 px-2">1 de 1</span>
        </div>
        
        <div class="flex items-center gap-1.5">
          <button id="btnPrimeiraPagina" class="group px-3 py-2 text-sm font-medium text-slate-600 bg-white border-2 border-slate-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-slate-300 disabled:hover:text-slate-600 transition-all duration-200 shadow-sm hover:shadow-md" disabled title="Primeira pÃ¡gina">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
            </svg>
          </button>
          <button id="btnPaginaAnterior" class="group px-4 py-2 text-sm font-medium text-gray-600 bg-white border-2 border-gray-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-gray-300 disabled:hover:text-gray-600 transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-1.5" disabled title="PÃ¡gina anterior">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            <span class="hidden sm:inline">Anterior</span>
          </button>
          <button id="btnProximaPagina" class="group px-4 py-2 text-sm font-medium text-slate-600 bg-white border-2 border-slate-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-slate-300 disabled:hover:text-slate-600 transition-all duration-200 shadow-sm hover:shadow-md flex items-center gap-1.5" title="PrÃ³xima pÃ¡gina">
            <span class="hidden sm:inline">PrÃ³xima</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </button>
          <button id="btnUltimaPagina" class="group px-3 py-2 text-sm font-medium text-slate-600 bg-white border-2 border-slate-300 rounded-lg hover:bg-blue-50 hover:border-blue-500 hover:text-blue-600 disabled:opacity-40 disabled:cursor-not-allowed disabled:hover:bg-white disabled:hover:border-slate-300 disabled:hover:text-slate-600 transition-all duration-200 shadow-sm hover:shadow-md" title="Ãšltima pÃ¡gina">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
            </svg>
          </button>
        </div>
      </div>
    </section>

  </main>

  <!-- MODAL -->
  <div id="recordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
        <h3 class="text-xl font-semibold text-slate-800">Detalhes Completos do Registro</h3>
        <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">Ã—</button>
      </div>
      <div id="modalContent" class="px-6 py-4"></div>
    </div>
  </div>

  <script>
    // ==============================
    // VariÃ¡veis globais
    // ==============================
    let originalData = [];
    let filteredData = [];
    let columnNames = {};
    let charts = {}; // Armazena instÃ¢ncias dos grÃ¡ficos
    
    // ExpÃµe variÃ¡veis globalmente para dashboard-stats.js
    window.originalData = originalData;
    window.filteredData = filteredData;
    window.columnNames = columnNames;
    
    // VariÃ¡veis de paginaÃ§Ã£o (frontend-only)
    let paginaAtual = 1;
    let registrosPorPagina = 10;
    let totalPaginas = 1;
    
    // Dados CSV inline das listas de CMEIs e EMEFs
    const CSV_CMEIS = `Nome,Sigla
AdÃ¡cio Bispo dos Santos TI,ABS
Ãlvaro Fernandes Lima TI,AFL
Ana Maria Chaves Colares,AMCC
AnÃ­zio SpÃ­nola Teixeira,AST
Carlos Alberto Martinelli de Souza TI,EAMS
Carlita CorrÃªa Pereira TI,CCP
Carlos Mendes,CM
Darcy Castello de MendonÃ§a,DCM
Dom. JoÃ£o Batista da Motta e Albuquerque TI,JBMA
Dr. Denizart Santos TI,DS
Darcy Vargas,DV
Edlma Maria Soares Braga TTI,EMSB
Ernestina Pessoa,EP
Gilda de Athayde Ramos,GAR
Gisela da Cruz MilitÃ£o,GCM
Georgiana da Trindade Faria,GTF
Hecy Alves Fraga TI,HAF
Jacivinha Ferreira de Souza SimÃµes TI,JFSS
JuÃ­zo Pedro de Aguiar,JPA
Luiz Carlos Grecco TI,LCG
Laurentina MendonÃ§a CorrÃªa,LMC
LuÃ­za Pereira Muniz CorrÃªa TI,LPMC
Lidia Rocha Feitosa,LRF
Lisandra Ignes Carpanedo do Carmo,LICC
MagnÃ³lia Dias Miranda Cunha TTI,MUMC
Maria Goretti Coutinho Cosme TI,MGCC
Menino Jesus TI,MJ
Maria Nazareth Menegueli TTI,MNM
Marlene Dilande Simonetti,MDS
Nalcyrley Silva Braga,NSB
Oscalina Nunes Andrade,ONA
Odila SimÃµes,OS
Professora Cida Barreto,PCB
Dr. Pedro Feu Rosa,PFR
Padre Giovanni Bartesaghi TTI,PGB
Rubem Braga,RB
Rubens Duarte de Albuquerque TTI,RDA
Robson JosÃ© Nassur PeÃ§oto TI,RJNP
Rubens JosÃ© Vervloet Gomes TI,RJVG
Reinaldo Ridolfi,RR
Professora Sophia Musengiyvi Loureiro,SML
Sinclair Phillips,SP
Silvanete da Silva Rosa Rocha TI,SSRR
Thomas Tommasi TTI,TT
Terezinha Vasconcellos Salvador,TVS
Valdivia de Penna Antunes Rodrigues TI,VPAR
Yolanda Lucas da Silva,VLS
Zilmar Alves de Melo,ZAM
Zulmira Gomes Martins Marcarini Cavalcanti,ZGMC
ZÃ©lia Viana de Aguiar,ZVA`;

    const CSV_EMEFS = `Nome,Sigla
Alberto de Almeida,AA
AdÃ£o Benezath,AB
AristÃ³bulo Barbosa LeÃ£o,ABL
Ãlvaro de Castro Mattos,ACM
Arthur da Costa e Silva,ACS
Amilton Monteiro da Silva,AMS
Alvimar Silva,AS
Adilson da Silva Castro,ASC
Adevalni Sysesmundo Ferreira de Azevedo,ASFA
Anacleta Schneider Lucas TI,ASLC
Ceciliano Abel de Almeida,CAA
Castelo Branco,CB
CustÃ³dia Dias de Campos,CDC
CEJA Prof. Admardo Serafim de Oliveira,EJA ASO
Ã‰ber Louzada Zippinotti,ELZ
Edna de Mattos Siqueira Gaudio TI,EMSG
Eunice Perreira Silveira TI,EPS
Eliane Rodrigues dos Santos,ERS
Escola Experimental de VitÃ³ria-UFES,UFES
Elzira Vivacqua dos Santos,EVS
Francisco Lacerda de Aguiar,FLA
Heloisa Abreu JÃºdice de Mattos,HAJM
IrmÃ£ Jacinta Soares de Souza Lima,IJSSL
Izaura Marques da Silva TI,IMS
JosÃ© Ãureo Monjardim TI,JAM
JoÃ£o Bandeira,JB
Juscelino Kubitschek de Oliveira,JKO
JosÃ© Lemos de Miranda TI,JLM
Lenir Borlot,LB
Moacyr Avidos TI,MA
Mauro Braga,MB
Marieta Escobar,ME
Maria JosÃ© Costa Moraes,MJCM
Maria Leonor Pereira da Silva,MLPS
Marechal Mascarenhas de Moraes,MMM
Maria Madalena Oliveira Domingues,MMOD
Maria Stella de Novaes,MSN
Neusa Nunes GonÃ§alves,NNG
Orlandina D'Almeida Lucas,ODAL
Otto Ewald JÃºnior,OEJ
OctacÃ­lio Lomba,OL
Prezideu Amorim,PA
Padre Anchieta,PAN
Padre Guido Ceotto,PGC
Paulo Reglus Neves Freire TI,PRNF
Paulo Roberto Vieira Gomes,PRVG
Rita de CÃ¡ssia Oliveira,RCO
Regina Maria Silva,RMS
Ronaldo Soares,RS
Suzete Cuendet,SC
SÃ£o Vicente de Paulo,SVP
Tancredo de Almeida Neves,TAN
VercenÃ­lio da Silva Pascoal,VSP
Zilda Andrade,ZA`;
    
    // FunÃ§Ã£o para processar os CSVs e criar os mapeamentos
    function processarCSVs() {
      const linhasCMEI = CSV_CMEIS.split('\n').slice(1); // Remove header
      const linhasEMEF = CSV_EMEFS.split('\n').slice(1); // Remove header
      
      const cmeiSiglas = {};
      const emefSiglas = {};
      
      linhasCMEI.forEach(linha => {
        const partes = linha.split(',');
        if (partes.length >= 2) {
          const sigla = partes[1].trim();
          const nome = partes[0].trim();
          if (sigla && nome) {
            cmeiSiglas[sigla] = nome;
          }
        }
      });
      
      linhasEMEF.forEach(linha => {
        const partes = linha.split(',');
        if (partes.length >= 2) {
          const sigla = partes[1].trim();
          const nome = partes[0].trim();
          if (sigla && nome) {
            emefSiglas[sigla] = nome;
          }
        }
      });
      
      return { cmeiSiglas, emefSiglas };
    }
    
    // Processa os CSVs e cria os mapeamentos
    const { cmeiSiglas: CMEI_SIGLAS, emefSiglas: EMEF_SIGLAS } = processarCSVs();

    // ==============================
    // FunÃ§Ã£o auxiliar: Detecta se escola Ã© Tempo Integral
    // ==============================
    function isTempoIntegral(escolaValor) {
      if (!escolaValor) return false;
      
      const sigla = String(escolaValor).trim().toUpperCase();
      let nomeCompleto = null;

      // Tenta achar nas listas de siglas
      if (CMEI_SIGLAS[sigla]) {
        nomeCompleto = CMEI_SIGLAS[sigla];
      } else if (EMEF_SIGLAS[sigla]) {
        nomeCompleto = EMEF_SIGLAS[sigla];
      } else {
        // Fallback: usa o prÃ³prio valor caso a planilha um dia venha com nome em vez de sigla
        nomeCompleto = String(escolaValor).trim();
      }

      const nomeUpper = nomeCompleto.toUpperCase();

      // Tempo Integral: nome completo termina com " TI" ou " TTI"
      return nomeUpper.endsWith(' TI') || nomeUpper.endsWith(' TTI');
    }

    // ==============================
    // UtilitÃ¡rios de texto / listas
    // ==============================

    // NormalizaÃ§Ã£o para reduzir erro de digitaÃ§Ã£o: tira acento, pontuaÃ§Ã£o, caixa
    // IMPORTANTE: Preserva a barra (/) para tipos compostos como "Financeira/EconÃ´mica"
    function normalizeText(str) {
      return String(str || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9\s\/]/g, ' ') // â† Preserva / alÃ©m de letras, nÃºmeros e espaÃ§os
        .replace(/\s+/g, ' ')
        .trim();
    }
    
    // Identifica se uma escola Ã© EMEF ou CMEI baseado no nome/sigla
    function getTipoInstituicao(nomeEscola) {
      if (!nomeEscola) return null;
      
      const nome = String(nomeEscola).trim().toUpperCase();
      
      // Verifica se Ã© uma sigla exata de EMEF
      if (EMEF_SIGLAS[nome]) {
        return 'EMEF';
      }
      
      // Verifica se Ã© uma sigla exata de CMEI
      if (CMEI_SIGLAS[nome]) {
        return 'CMEI';
      }
      
      // Verifica se o nome contÃ©m a sigla como palavra isolada (EMEF)
      for (const sigla in EMEF_SIGLAS) {
        const regex = new RegExp('\\b' + sigla + '\\b', 'i');
        if (regex.test(nome)) {
          return 'EMEF';
        }
      }
      
      // Verifica se o nome contÃ©m a sigla como palavra isolada (CMEI)
      for (const sigla in CMEI_SIGLAS) {
        const regex = new RegExp('\\b' + sigla + '\\b', 'i');
        if (regex.test(nome)) {
          return 'CMEI';
        }
      }
      
      // Verifica se contÃ©m "EMEF" no nome
      if (nome.includes('EMEF')) {
        return 'EMEF';
      }
      
      // Verifica se contÃ©m "CMEI" no nome
      if (nome.includes('CMEI')) {
        return 'CMEI';
      }
      
      // Se nÃ£o identificou, retorna null
      return null;
    }
    
    // Converte sigla para nome completo (se for uma EMEF ou CMEI conhecida)
    function getDisplayName(nomeEscola) {
      if (!nomeEscola) return '';
      
      const nome = String(nomeEscola).trim().toUpperCase();
      
      // Se for uma sigla exata de EMEF, retorna "EMEF Sigla"
      if (EMEF_SIGLAS[nome]) {
        return `EMEF ${nome}`;
      }
      
      // Se for uma sigla exata de CMEI, retorna "CMEI Sigla"
      if (CMEI_SIGLAS[nome]) {
        return `CMEI ${nome}`;
      }
      
      return nomeEscola;
    }

    // ==============================
    // Sistema de Grupos de Encaminhamento
    // ==============================
    
    // DefiniÃ§Ã£o dos grupos de encaminhamento
    const encaminhamentosAgrupados = {
      redeAssistencia: ['AssistÃªncia Social','CRAS','CREAS','Casa Rosa','PsicÃ³logo'],
      redeSaude: ['SaÃºde','UBS','US','CAPSIN'],
      redeEducacao: ['NAAM','EducaÃ§Ã£o','Escola'],
      conselhoTutelar: ['CT'],
      redeSegurancaJustica: ['DACLE','DEAM','DEPI','DPCA','Defensoria PÃºblica','MinistÃ©rio PÃºblico','Outras delegacias']
    };
    
    // Nomes amigÃ¡veis dos grupos
    const grupoNomes = {
      redeAssistencia: 'Rede de AssistÃªncia Social',
      redeSaude: 'Rede de SaÃºde',
      redeEducacao: 'Rede de EducaÃ§Ã£o',
      conselhoTutelar: 'Conselho Tutelar',
      redeSegurancaJustica: 'Rede de SeguranÃ§a e JustiÃ§a'
    };
    
    // Verifica se um termo pertence a algum grupo
    function belongsToAnyGroup(term) {
      const termNorm = normalizeText(term);
      for (const groupKey in encaminhamentosAgrupados) {
        const children = encaminhamentosAgrupados[groupKey];
        if (children.some(child => normalizeText(child) === termNorm)) {
          return true;
        }
      }
      return false;
    }
    
    // ConstrÃ³i os grupos de encaminhamento baseado nos dados reais
    function buildEncaminhamentoGroups(availableEncaminhamentos) {
      const container = document.getElementById('filterEncaminhamentoContainer');
      container.innerHTML = '';
      
      // Normalizar availableEncaminhamentos para comparaÃ§Ã£o
      const availableNormalized = availableEncaminhamentos.map(e => normalizeText(e));
      
      // Construir cada grupo
      for (const groupKey in encaminhamentosAgrupados) {
        const children = encaminhamentosAgrupados[groupKey];
        
        // Filtrar apenas os filhos que existem nos dados
        const childrenPresent = children.filter(child => 
          availableNormalized.includes(normalizeText(child))
        );
        
        // Se nÃ£o hÃ¡ filhos presentes, nÃ£o renderizar o grupo
        if (childrenPresent.length === 0) continue;
        
        // Renderizar o grupo
        renderEncaminhamentoGroup(groupKey, childrenPresent);
      }
      
      // Identificar encaminhamentos nÃ£o mapeados ("Outros detectados")
      const outrosDetectados = availableEncaminhamentos.filter(term => !belongsToAnyGroup(term));
      
      if (outrosDetectados.length > 0) {
        renderOutrosDetectados(outrosDetectados);
      }
    }
    
    // Renderiza um grupo de encaminhamento
    function renderEncaminhamentoGroup(groupId, childrenPresent) {
      const container = document.getElementById('filterEncaminhamentoContainer');
      const groupName = grupoNomes[groupId] || groupId;
      
      // Criar estrutura do grupo
      const groupDiv = document.createElement('div');
      groupDiv.className = 'encaminhamento-group';
      groupDiv.dataset.group = groupId;
      
      // Header do grupo
      const header = document.createElement('div');
      header.className = 'group-header';
      header.onclick = () => toggleGroupPanel(groupId);
      
      const headerLeft = document.createElement('div');
      headerLeft.className = 'group-header-left';
      
      // Checkbox do grupo
      const checkboxWrapper = document.createElement('div');
      checkboxWrapper.className = 'group-checkbox-wrapper';
      
      const groupCheckbox = document.createElement('input');
      groupCheckbox.type = 'checkbox';
      groupCheckbox.id = `group-${groupId}`;
      groupCheckbox.className = 'custom-checkbox';
      groupCheckbox.onclick = (e) => e.stopPropagation();
      groupCheckbox.onchange = () => onGroupCheckboxChange(groupId);
      
      checkboxWrapper.appendChild(groupCheckbox);
      
      // TÃ­tulo do grupo
      const title = document.createElement('span');
      title.className = 'group-title';
      title.textContent = groupName;
      
      headerLeft.appendChild(checkboxWrapper);
      headerLeft.appendChild(title);
      
      // Badge de contagem
      const badge = document.createElement('span');
      badge.id = `badge-${groupId}`;
      badge.className = 'group-badge hidden';
      badge.textContent = '0';
      
      // Ãcone de toggle
      const toggleIcon = document.createElement('svg');
      toggleIcon.id = `toggle-${groupId}`;
      toggleIcon.className = 'toggle-icon';
      toggleIcon.setAttribute('fill', 'none');
      toggleIcon.setAttribute('stroke', 'currentColor');
      toggleIcon.setAttribute('viewBox', '0 0 24 24');
      toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
      
      header.appendChild(headerLeft);
      header.appendChild(badge);
      header.appendChild(toggleIcon);
      
      // Body do grupo (conteÃºdo colapsÃ¡vel)
      const body = document.createElement('div');
      body.id = `body-${groupId}`;
      body.className = 'group-body';
      
      const bodyContent = document.createElement('div');
      bodyContent.className = 'group-body-content';
      
      // Criar checkboxes dos filhos
      childrenPresent.forEach((child, index) => {
        const childDiv = document.createElement('div');
        childDiv.className = 'checkbox-container flex items-center gap-2.5 p-2.5 bg-gray-50 rounded-lg border border-gray-200';
        
        const childCheckbox = document.createElement('input');
        childCheckbox.type = 'checkbox';
        childCheckbox.id = `${groupId}_child_${index}`;
        childCheckbox.className = 'custom-checkbox';
        childCheckbox.dataset.value = child;
        childCheckbox.dataset.group = groupId;
        childCheckbox.onchange = () => onChildCheckboxChange(groupId);
        
        const label = document.createElement('label');
        label.htmlFor = `${groupId}_child_${index}`;
        label.className = 'checkbox-label flex-1 text-gray-700 text-sm cursor-pointer';
        label.textContent = child;
        
        childDiv.appendChild(childCheckbox);
        childDiv.appendChild(label);
        bodyContent.appendChild(childDiv);
      });
      
      body.appendChild(bodyContent);
      
      groupDiv.appendChild(header);
      groupDiv.appendChild(body);
      container.appendChild(groupDiv);
    }
    
    // Renderiza grupo "Outros detectados"
    function renderOutrosDetectados(termos) {
      const container = document.getElementById('filterEncaminhamentoContainer');
      const groupId = 'outrosDetectados';
      
      const groupDiv = document.createElement('div');
      groupDiv.className = 'encaminhamento-group outros-detectados';
      groupDiv.dataset.group = groupId;
      
      const header = document.createElement('div');
      header.className = 'group-header';
      header.onclick = () => toggleGroupPanel(groupId);
      
      const headerLeft = document.createElement('div');
      headerLeft.className = 'group-header-left';
      
      const checkboxWrapper = document.createElement('div');
      checkboxWrapper.className = 'group-checkbox-wrapper';
      
      const groupCheckbox = document.createElement('input');
      groupCheckbox.type = 'checkbox';
      groupCheckbox.id = `group-${groupId}`;
      groupCheckbox.className = 'custom-checkbox';
      groupCheckbox.onclick = (e) => e.stopPropagation();
      groupCheckbox.onchange = () => onGroupCheckboxChange(groupId);
      
      checkboxWrapper.appendChild(groupCheckbox);
      
      const title = document.createElement('span');
      title.className = 'group-title';
      title.textContent = 'âš ï¸ Outros detectados';
      
      headerLeft.appendChild(checkboxWrapper);
      headerLeft.appendChild(title);
      
      const badge = document.createElement('span');
      badge.id = `badge-${groupId}`;
      badge.className = 'group-badge hidden';
      badge.textContent = '0';
      
      const toggleIcon = document.createElement('svg');
      toggleIcon.id = `toggle-${groupId}`;
      toggleIcon.className = 'toggle-icon';
      toggleIcon.setAttribute('fill', 'none');
      toggleIcon.setAttribute('stroke', 'currentColor');
      toggleIcon.setAttribute('viewBox', '0 0 24 24');
      toggleIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>';
      
      header.appendChild(headerLeft);
      header.appendChild(badge);
      header.appendChild(toggleIcon);
      
      const body = document.createElement('div');
      body.id = `body-${groupId}`;
      body.className = 'group-body';
      
      const bodyContent = document.createElement('div');
      bodyContent.className = 'group-body-content';
      
      termos.forEach((termo, index) => {
        const childDiv = document.createElement('div');
        childDiv.className = 'checkbox-container flex items-center gap-2.5 p-2.5 bg-amber-50 rounded-lg border border-amber-300';
        
        const childCheckbox = document.createElement('input');
        childCheckbox.type = 'checkbox';
        childCheckbox.id = `${groupId}_child_${index}`;
        childCheckbox.className = 'custom-checkbox';
        childCheckbox.dataset.value = termo;
        childCheckbox.dataset.group = groupId;
        childCheckbox.onchange = () => onChildCheckboxChange(groupId);
        
        const label = document.createElement('label');
        label.htmlFor = `${groupId}_child_${index}`;
        label.className = 'checkbox-label flex-1 text-gray-700 text-sm cursor-pointer';
        label.textContent = termo;
        
        childDiv.appendChild(childCheckbox);
        childDiv.appendChild(label);
        bodyContent.appendChild(childDiv);
      });
      
      body.appendChild(bodyContent);
      
      groupDiv.appendChild(header);
      groupDiv.appendChild(body);
      container.appendChild(groupDiv);
    }
    
    // Toggle panel de um grupo
    function toggleGroupPanel(groupId) {
      const body = document.getElementById(`body-${groupId}`);
      const icon = document.getElementById(`toggle-${groupId}`);
      
      if (body && icon) {
        body.classList.toggle('expanded');
        icon.classList.toggle('rotated');
      }
    }
    
    // Handler quando checkbox de grupo muda
    function onGroupCheckboxChange(groupId) {
      const groupCheckbox = document.getElementById(`group-${groupId}`);
      const childCheckboxes = document.querySelectorAll(`input[data-group="${groupId}"]`);
      
      // Marcar/desmarcar todos os filhos
      childCheckboxes.forEach(child => {
        child.checked = groupCheckbox.checked;
      });
      
      updateGroupBadge(groupId);
      updateBadgeEncaminhamentoTotal();
      applyFilters();
    }
    
    // Handler quando checkbox de filho muda
    function onChildCheckboxChange(groupId) {
      const groupCheckbox = document.getElementById(`group-${groupId}`);
      const childCheckboxes = document.querySelectorAll(`input[data-group="${groupId}"]`);
      
      const allChecked = Array.from(childCheckboxes).every(cb => cb.checked);
      const someChecked = Array.from(childCheckboxes).some(cb => cb.checked);
      
      // Atualizar estado do grupo (checked, indeterminate, unchecked)
      groupCheckbox.checked = allChecked;
      groupCheckbox.indeterminate = someChecked && !allChecked;
      
      updateGroupBadge(groupId);
      updateBadgeEncaminhamentoTotal();
      applyFilters();
    }
    
    // Atualiza badge de um grupo especÃ­fico
    function updateGroupBadge(groupId) {
      const childCheckboxes = document.querySelectorAll(`input[data-group="${groupId}"]:checked`);
      const count = childCheckboxes.length;
      const badge = document.getElementById(`badge-${groupId}`);
      
      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }
    
    // Atualiza badge total de encaminhamento
    function updateBadgeEncaminhamentoTotal() {
      const allChildCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
      const count = allChildCheckboxes.length;
      const badge = document.getElementById('badge-encaminhamento-total');
      
      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.classList.remove('hidden');
        } else {
          badge.classList.add('hidden');
        }
      }
    }
    
    // Coleta todos os encaminhamentos selecionados (de todos os grupos)
    function gatherSelectedEncaminhamentos() {
      const selectedCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
      return Array.from(selectedCheckboxes).map(cb => cb.dataset.value);
    }
    
    // Verifica se uma cÃ©lula de encaminhamento corresponde aos termos selecionados (lÃ³gica OR)
    function matchEncaminhamentoCell(cellValue, selectedTerms) {
      if (!cellValue || selectedTerms.length === 0) return true;
      
      // Normalizar cÃ©lula (split por vÃ­rgula e barra)
      const cellValues = String(cellValue)
        .split(',')
        .flatMap(v => v.split('/'))
        .map(v => normalizeText(v.trim()))
        .filter(v => v);
      
      // Normalizar termos selecionados
      const selectedNormalized = selectedTerms.map(t => normalizeText(t));
      
      // Retorna true se qualquer valor da cÃ©lula estiver nos selecionados (OR)
      return cellValues.some(cv => selectedNormalized.includes(cv));
    }

    // Gera opÃ§Ãµes "agrupadas" por texto normalizado (com suporte a multi-valor)
    function buildNormalizedOptions(colKey, data) {
      const map = new Map(); // norm -> rÃ³tulo original mais comum
      data.forEach(row => {
        const raw = row[colKey];
        if (!raw) return;
        
        // Suporta valores mÃºltiplos separados por vÃ­rgula E por barra (/)
        // Primeiro separa por vÃ­rgula, depois cada parte por barra
        const valores = String(raw)
          .split(',')
          .flatMap(v => v.split('/'))
          .map(v => v.trim())
          .filter(v => v);
        
        valores.forEach(val => {
          const norm = normalizeText(val);
          if (!norm) return;
          
          // Guarda o label original mais completo (maior length)
          if (!map.has(norm) || val.length > map.get(norm).length) {
            map.set(norm, val);
          }
        });
      });
      return Array.from(map.values()).sort();
    }
    
    // Gera opÃ§Ãµes para TIPO DE VIOLÃŠNCIA (NÃƒO separa por barra - "Financeira/EconÃ´mica" fica junto)
    function buildNormalizedOptionsTipoViolencia(colKey, data) {
      const map = new Map(); // norm -> rÃ³tulo original mais comum
      data.forEach(row => {
        const raw = row[colKey];
        if (!raw) return;
        
        // Suporta valores mÃºltiplos separados APENAS por vÃ­rgula
        // NÃƒO separa por barra (/) para manter "Financeira/EconÃ´mica" como uma Ãºnica categoria
        const valores = String(raw)
          .split(',')
          .map(v => v.trim())
          .filter(v => v);
        
        valores.forEach(val => {
          const norm = normalizeText(val);
          if (!norm) return;
          
          // Guarda o label original mais completo (maior length)
          if (!map.has(norm) || val.length > map.get(norm).length) {
            map.set(norm, val);
          }
        });
      });
      return Array.from(map.values()).sort();
    }
    
    // ========================================
    // NORMALIZAÃ‡ÃƒO DE TRANSTORNOS (UNIFICAÃ‡ÃƒO)
    // ========================================
    // Unifica variaÃ§Ãµes de transtornos em rÃ³tulos padronizados
    function normalizarTranstorno(label) {
      if (!label) return label;
      
      const norm = normalizeText(label);
      
      // EquivalÃªncias para TDAH
      const equivalenciasTDAH = [
        'tdah',
        'tdh',
        'tda h',
        't d a h',
        'deficit de atencao',
        'deficit atencao',
        'deficitdeatencao',
        'deficit hiperatividade',
        'transtorno de deficit',
        'transtorno deficit',
        'transtorno de deficit de atencao',
        'transtorno deficit atencao',
        'deficit de atencao e hiperatividade',
        'deficit de atencao hiperatividade'
      ];
      
      if (equivalenciasTDAH.some(e => norm.includes(e) || e.includes(norm))) {
        return 'TDAH (DÃ©ficit de AtenÃ§Ã£o e Hiperatividade)';
      }
      
      // EquivalÃªncias para TEA (Autismo)
      const equivalenciasTEA = [
        'tea',
        't e a',
        'autismo',
        'autista',
        'transtorno do espectro autista',
        'espectro autista',
        'transtorno autista'
      ];
      
      if (equivalenciasTEA.some(e => norm.includes(e) || e.includes(norm))) {
        return 'TEA (Transtorno do Espectro Autista)';
      }
      
      // EquivalÃªncias para DI (DeficiÃªncia Intelectual)
      const equivalenciasDI = [
        'di ',
        ' di',
        'd i',
        'deficiencia intelectual',
        'deficiencia mental'
      ];
      
      if (equivalenciasDI.some(e => norm === e || norm.includes(e))) {
        return 'DI (DeficiÃªncia Intelectual)';
      }
      
      // EquivalÃªncias para TOD (Transtorno Opositor Desafiador)
      const equivalenciasTOD = [
        'tod',
        't o d',
        'transtorno opositor',
        'opositor desafiador',
        'transtorno opositor desafiador'
      ];
      
      if (equivalenciasTOD.some(e => norm.includes(e) || e.includes(norm))) {
        return 'TOD (Transtorno Opositor Desafiador)';
      }
      
      // Retorna o label original se nÃ£o encontrou equivalÃªncia
      return label;
    }
    
    // Aplica normalizaÃ§Ã£o a uma lista de opÃ§Ãµes
    function normalizarListaTranstornos(opcoes) {
      const map = new Map(); // Usa Map para evitar duplicatas apÃ³s normalizaÃ§Ã£o
      
      opcoes.forEach(opt => {
        const normalizado = normalizarTranstorno(opt);
        // Guarda apenas uma vez (a primeira ocorrÃªncia)
        if (!map.has(normalizado)) {
          map.set(normalizado, true);
        }
      });
      
      return Array.from(map.keys()).sort();
    }
    
    // Gera opÃ§Ãµes para coluna de GÃªnero (apenas M ou F)
    function buildGeneroOptions(data) {
      const valores = new Set();
      data.forEach(row => {
        const genero = row[columnNames.genero];
        if (genero) {
          const val = String(genero).trim().toUpperCase();
          if (val === 'M' || val === 'F') {
            valores.add(val);
          }
        }
      });
      return Array.from(valores).sort();
    }
    
    // Cria checkboxes elegantes para filtros
    function createCheckboxes(containerId, options, filterName) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      options.forEach((opt, index) => {
        const id = `${filterName}_${index}`;
        const div = document.createElement('div');
        div.className = 'checkbox-container flex items-center gap-2.5 p-3 bg-white rounded-lg border border-gray-200 shadow-sm';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = id;
        checkbox.className = 'custom-checkbox';
        checkbox.dataset.value = opt;
        checkbox.dataset.filter = filterName;
        checkbox.addEventListener('change', function() {
          updateBadge(filterName);
          applyFilters();
        });
        
        const label = document.createElement('label');
        label.htmlFor = id;
        label.className = 'checkbox-label flex-1 text-gray-700';
        label.textContent = opt;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
    }
    
    // ObtÃ©m valores selecionados dos checkboxes
    function getCheckedValues(filterName) {
      const checkboxes = document.querySelectorAll(`input[data-filter="${filterName}"]:checked`);
      return Array.from(checkboxes).map(cb => cb.dataset.value);
    }
    
    // Atualiza o badge de contagem
    function updateBadge(filterName) {
      const count = getCheckedValues(filterName).length;
      const badge = document.getElementById(`badge-${filterName}`);
      
      // Verifica se o badge existe antes de tentar acessar suas propriedades
      if (!badge) {
        console.warn(`[updateBadge] Badge nÃ£o encontrado para filtro: ${filterName}`);
        return;
      }
      
      if (count > 0) {
        badge.textContent = count;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }
    
    // Atualiza badge para filtro TI (select ao invÃ©s de checkboxes)
    function updateBadgeTI() {
      const selectTI = document.getElementById('filterTI');
      const badge = document.getElementById('badge-ti');
      
      if (selectTI && selectTI.value && selectTI.value !== '') {
        badge.textContent = '1';
        badge.classList.remove('hidden');
      } else if (badge) {
        badge.classList.add('hidden');
      }
    }

    // Formata data para exibiÃ§Ã£o (dd/mm/aaaa)
    function formatDate(value) {
      if (!value || value === '') return null; // Retorna null para valores vazios
      const date = parseDateCell(value);
      if (!date) return value; // Se nÃ£o conseguir parsear, retorna o valor original
      
      const dia = String(date.getDate()).padStart(2, '0');
      const mes = String(date.getMonth() + 1).padStart(2, '0');
      const ano = date.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    // Converte cÃ©lula de data (dd/mm/aaaa, nÃºmero serial do Excel, etc.) em Date
    function parseDateCell(value) {
      const str = String(value || '').trim();
      if (!str) return null;

      // IMPORTANTE: Formato Date(YYYY,M,D) do Google Sheets
      // O mÃªs jÃ¡ vem base-0 (0=janeiro, 11=dezembro)
      const dateMatch = str.match(/^Date\((\d{4}),(\d{1,2}),(\d{1,2})\)$/);
      if (dateMatch) {
        const ano = parseInt(dateMatch[1], 10);
        const mes = parseInt(dateMatch[2], 10); // JÃ¡ estÃ¡ em base-0
        const dia = parseInt(dateMatch[3], 10);
        return new Date(ano, mes, dia);
      }

      // Tenta formato dd/mm/aaaa ou dd-mm-aaaa (brasileiro)
      const m = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (m) {
        let dia = parseInt(m[1], 10);
        let mes = parseInt(m[2], 10) - 1;
        let ano = parseInt(m[3], 10);
        if (ano < 100) ano += 2000;
        
        // Valida se a data Ã© vÃ¡lida
        const d = new Date(ano, mes, dia);
        if (d.getFullYear() === ano && d.getMonth() === mes && d.getDate() === dia) {
          return d;
        }
        return null;
      }

      // Tenta como nÃºmero serial do Excel (ex: 45803)
      const num = parseFloat(str);
      if (!isNaN(num) && num > 1 && num < 100000) {
        // Excel conta dias desde 01/01/1900
        // Mas Excel tem um bug: considera 1900 como ano bissexto (nÃ£o Ã©)
        // EntÃ£o para datas >= 01/03/1900, subtraÃ­mos 1 dia extra
        const excelEpoch = new Date(1899, 11, 30); // 30/12/1899
        const days = num >= 60 ? num - 1 : num; // Corrige bug do Excel
        const date = new Date(excelEpoch.getTime() + days * 24 * 60 * 60 * 1000);
        return date;
      }

      // Tenta parse direto (formato ISO ou outros)
      const d = new Date(str);
      return isNaN(d.getTime()) ? null : d;
    }

    // ==============================
    // InicializaÃ§Ã£o da pÃ¡gina
    // ==============================
    window.addEventListener('load', function() {
      document.getElementById('closeModal').addEventListener('click', closeModal);
      document.getElementById('recordModal').addEventListener('click', (e) => {
        if (e.target.id === 'recordModal') closeModal();
      });
      document.getElementById('btnAtualizar').addEventListener('click', carregarDadosPlanilha);
      
      // Event listeners de paginaÃ§Ã£o
      document.getElementById('btnPrimeiraPagina').addEventListener('click', () => irParaPagina(1));
      document.getElementById('btnPaginaAnterior').addEventListener('click', () => irParaPagina(paginaAtual - 1));
      document.getElementById('btnProximaPagina').addEventListener('click', () => irParaPagina(paginaAtual + 1));
      document.getElementById('btnUltimaPagina').addEventListener('click', () => irParaPagina(totalPaginas));
      document.getElementById('registrosPorPaginaSelect').addEventListener('change', alterarRegistrosPorPagina);
      
      // Event listeners de exportaÃ§Ã£o e dashboard
      const btnExportarCSV = document.getElementById('btnExportarCSV');
      const btnExportarExcel = document.getElementById('btnExportarExcel');
      const btnExportarPDF = document.getElementById('btnExportarPDF');
      const btnAtualizarKPIs = document.getElementById('btnAtualizarKPIs');
      
      if (btnExportarCSV) btnExportarCSV.addEventListener('click', exportarCSV);
      if (btnExportarExcel) btnExportarExcel.addEventListener('click', exportarExcel);
      if (btnExportarPDF) btnExportarPDF.addEventListener('click', exportarPDF);
      if (btnAtualizarKPIs) btnAtualizarKPIs.addEventListener('click', atualizarKPIs);
      
      // Carrega os dados automaticamente ao iniciar
      carregarDadosPlanilha();
    });
    
    // Abre seÃ§Ã£o especÃ­fica do filtro
    function openFilterSection(filterName) {
      const panel = document.getElementById('advancedPanel');
      const section = document.getElementById(`section-${filterName}`);
      const card = document.querySelector(`[data-filter="${filterName}"]`);
      
      // Se a seÃ§Ã£o jÃ¡ estÃ¡ visÃ­vel, esconde
      if (section.classList.contains('show')) {
        section.classList.remove('show');
        section.classList.add('hidden');
        card.classList.remove('active');
        
        // Se todas as seÃ§Ãµes estÃ£o escondidas, fecha o painel
        const visibleSections = document.querySelectorAll('.filter-section.show');
        if (visibleSections.length === 0) {
          panel.classList.remove('open');
        }
      } else {
        // Abre o painel se estiver fechado
        if (!panel.classList.contains('open')) {
          panel.classList.add('open');
        }
        
        // Mostra a seÃ§Ã£o
        section.classList.remove('hidden');
        section.classList.add('show');
        card.classList.add('active');
        
        // Scroll suave atÃ© a seÃ§Ã£o
        setTimeout(() => {
          section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      }
    }

    // Busca nome de coluna
    function findColumn(data, possibleNames) {
      if (!data || data.length === 0) return null;
      const keys = Object.keys(data[0]);
      
      for (const possible of possibleNames) {
        const found = keys.find(k => {
          const kLower = k.toLowerCase().trim();
          const pLower = possible.toLowerCase().trim();
          // Busca exata ou que contenha (mas nÃ£o ao contrÃ¡rio para evitar "Idade" pegar "Identidade")
          return kLower === pLower || kLower.includes(pLower);
        });
        if (found) return found;
      }
      return null;
    }

    // ==============================
    // Carregamento de dados do Google Sheets via JSONP
    // ==============================
    
    // ID da planilha (extraÃ­do do link de ediÃ§Ã£o)
    // Usando configuraÃ§Ã£o centralizada (config.js)
    const SPREADSHEET_ID = (typeof CONFIG !== 'undefined' && CONFIG.SPREADSHEET_ID) 
      ? CONFIG.SPREADSHEET_ID 
      : '1A6a2ZLiHegPJBDpE3YLPGsa8RXVRLjpkXmKdauSlb9Y';
    
    function carregarDadosPlanilha() {
      // ValidaÃ§Ã£o: Verifica se SPREADSHEET_ID estÃ¡ configurado
      if (!SPREADSHEET_ID || SPREADSHEET_ID.includes('SEU_ID_DA_PLANILHA_AQUI') || SPREADSHEET_ID.trim() === '') {
        updateUploadStatus('error', 'âš ï¸ Configure SPREADSHEET_ID em config.js para carregar dados da planilha');
        console.error('âŒ SPREADSHEET_ID nÃ£o configurado em config.js');
        return;
      }
      
      updateUploadStatus('loading', 'â³ Carregando dados da planilha...');
      
      console.log('ğŸ”„ Buscando dados via JSONP...', new Date().toLocaleTimeString());
      
      // Remove script antigo se existir
      const oldScript = document.getElementById('jsonp-script');
      if (oldScript) {
        oldScript.remove();
      }
      
      // Timestamp para evitar cache
      const timestamp = Date.now();
      const random = Math.random().toString(36).substring(2, 15);
      
      // Cria objeto global google.visualization para interceptar a resposta
      if (!window.google) {
        window.google = {};
      }
      if (!window.google.visualization) {
        window.google.visualization = {};
      }
      if (!window.google.visualization.Query) {
        window.google.visualization.Query = {};
      }
      
      // Define funÃ§Ã£o que receberÃ¡ os dados
      window.google.visualization.Query.setResponse = function(response) {
        try {
          console.log('âœ… Dados recebidos via JSONP');
          
          if (!response || !response.table || !response.table.rows) {
            updateUploadStatus('error', 'âŒ Formato de resposta invÃ¡lido');
            return;
          }
          
          // Extrai cabeÃ§alhos
          const headers = response.table.cols.map(col => col.label || '');
          
          // Converte linhas para objetos
          const data = response.table.rows.map(row => {
            const obj = {};
            row.c.forEach((cell, index) => {
              const header = headers[index];
              if (header) {
                obj[header] = cell && cell.v !== null && cell.v !== undefined ? cell.v : '';
              }
            });
            return obj;
          });
          
          console.log('ğŸ“Š Total de registros:', data.length);
          console.log('ğŸ• HorÃ¡rio:', new Date().toLocaleTimeString());
          
          // Limpa dados anteriores
          originalData = [];
          filteredData = [];
          window.originalData = [];
          window.filteredData = [];
          
          processLoadedData(data);
          
        } catch (error) {
          console.error('âŒ Erro ao processar:', error);
          updateUploadStatus('error', 'âŒ Erro ao processar dados: ' + error.message);
        }
      };
      
      // Cria script tag para JSONP (nÃ£o usa fetch, nÃ£o precisa de proxy)
      const script = document.createElement('script');
      script.id = 'jsonp-script';
      script.src = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&_=${timestamp}&r=${random}`;
      
      script.onerror = function() {
        console.error('âŒ Erro ao carregar script');
        updateUploadStatus('error', 'âŒ Erro ao conectar com Google Sheets. Verifique se a planilha estÃ¡ compartilhada como "Qualquer pessoa com o link pode visualizar"');
      };
      
      document.head.appendChild(script);
    }

    function processLoadedData(data) {
      if (!data || data.length === 0) {
        updateUploadStatus('error', 'âŒ Arquivo vazio ou sem dados vÃ¡lidos');
        return;
      }
      
      originalData = data;
      filteredData = [...data];
      
      // Atualiza variÃ¡veis globais para dashboard-stats.js
      window.originalData = originalData;
      window.filteredData = filteredData;
      
      // Mapeia colunas - Atualizado para novo cabeÃ§alho
      columnNames = {
        // CrianÃ§a/Estudante
        crianca: findColumn(data, ['crianÃ§a/ estudante', 'crianca/ estudante', 'crianÃ§a/estudante', 'crianca/estudante', 'crianÃ§a', 'crianca', 'estud']),
        
        // Data da NT
        data: findColumn(data, ['data da nt', 'data nt', 'data da', 'data', 'dt']),
        
        // Idade
        idade: findColumn(data, ['idade']),
        
        // Identidade de GÃªnero
        genero: findColumn(data, ['identidade de gÃªnero', 'identidade de genero', 'gÃªnero', 'genero', 'sexo']),
        
        // Ã‰ PCD/tem Transtorno?
        pcd: findColumn(data, ['Ã© pcd/tem transtorno', 'e pcd/tem transtorno', 'pcd/tem transtorno', 'pcd', 'deficiÃªncia', 'deficiencia', 'transtorno']),
        
        // Qual o Transtorno?
        detalhePCD: findColumn(data, [
          'qual o transtorno',
          'qual transtorno',
          'transtorno',
          'detalhamento',
          'detalhamento pcd',
          'detalhamento transtorno',
          'tipo de deficiencia',
          'tipo de deficiÃªncia',
          'tipo de transtorno',
          'detalhamento de pcd',
          'detalhamento de transtorno'
        ]),
        
        // RaÃ§a/Cor
        raca: findColumn(data, ['raÃ§a/cor', 'raca/cor', 'raÃ§a', 'raca', 'cor']),
        
        // Qual a OrientaÃ§Ã£o Sexual?
        orientacaoSexual: findColumn(data, ['qual a orientaÃ§Ã£o sexual', 'qual a orientacao sexual', 'orientaÃ§Ã£o sexual', 'orientacao sexual', 'orientaÃ§Ã£o', 'orientacao']),
        
        // Qual a classificaÃ§Ã£o da Violencia?
        classificacaoViolencia: findColumn(data, ['qual a classificaÃ§Ã£o da violencia', 'qual a classificacao da violencia', 'classificaÃ§Ã£o da violencia', 'classificacao da violencia', 'classificaÃ§Ã£o', 'classificacao']),
        
        // Tipo de ViolÃªncia
        tipo: findColumn(data, ['tipo de violÃªncia', 'tipo de violencia', 'tipo']),
        
        // Qual a MotivaÃ§Ã£o da Violencia?
        motivacaoViolencia: findColumn(data, ['qual a motivaÃ§Ã£o da violencia', 'qual a motivacao da violencia', 'motivaÃ§Ã£o da violencia', 'motivacao da violencia', 'motivaÃ§Ã£o', 'motivacao']),
        
        // Encaminhamento
        encaminhamento: findColumn(data, ['encaminhamento']),
        
        // CMEI/EMEF
        escola: findColumn(data, ['cmei/emef', 'cmei / emef', 'cmei', 'emef', 'escola']),
        
        // RegiÃ£o
        regiao: findColumn(data, ['regiÃ£o', 'regiao']),
        
        // ResponsÃ¡vel pelo Registro
        responsavel: findColumn(data, ['responsÃ¡vel pelo registro', 'responsavel pelo registro', 'responsÃ¡vel', 'responsavel']),
        
        // fonte informadores foi a escola?
        fonteInformada: findColumn(data, ['fonte informadores foi a escola', 'fonte informadora foi a escola', 'fonte informada', 'fonte']),
        
        // violÃªncia identificada pela escola ocorrida na escola
        violenciaEscolaOcorreu: findColumn(data, ['violÃªncia identificada pela escola ocorrida na escola', 'violencia identificada pela escola ocorrida na escola', 'violencia identificada pela escola ocorrida']),
        
        // Algum profissional da escola foi autor da violÃªncia
        profissionalAutor: findColumn(data, ['algum profissional da escola foi autor da violÃªncia', 'algum profissional da escola foi autor', 'profissional da escola foi autor', 'profissional autor']),
        
        // Album estudante foi autor da violÃªncia?? (Algum)
        estudanteAutor: findColumn(data, ['album estudante foi autor da violÃªncia', 'algum estudante foi autor da violÃªncia', 'algum estudante foi autor', 'estudante foi autor', 'estudante autor']),
        
        // violÃªncia identificada pela escola nÃ£o ocorrida na escola
        violenciaNaoEscola: findColumn(data, ['violÃªncia identificada pela escola nÃ£o ocorrida na escola', 'violencia identificada pela escola nao ocorrida na escola', 'violÃªncia identificada pela escola nÃ£o ocorrida', 'violencia nao ocorrida']),
        
        // ocorreu na escola? 1.1
        ocorreu: findColumn(data, ['ocorreu na escola? 1.1', 'ocorreu na escola', 'ocorreu']),
        
        // violÃªncia informada a escola por qualquer um dos agentes que a compÃµe 1.2
        violenciaInformada: findColumn(data, ['violÃªncia informada a escola por qualquer um dos agentes que a compÃµe', 'violencia informada a escola', 'violÃªncia informada Ã  escola', 'violencia informada', 'violÃªncia informada']),
        
        // Estudo de Caso
        estudoCaso: findColumn(data, [
          'foi realizado estudo de caso',
          'foi realizado estudo de caso?',
          'estudo de caso',
          'estudo caso',
          'estudo caso?',
          'estudo'
        ])
      };
      
      // Debug: verificar se as colunas foram encontradas
      console.log('=== DEBUG COLUNAS ===');
      console.log('Coluna de crianÃ§a/estudante encontrada:', columnNames.crianca);
      console.log('Coluna de data encontrada:', columnNames.data);
      console.log('Coluna de idade encontrada:', columnNames.idade);
      console.log('Coluna de gÃªnero encontrada:', columnNames.genero);
      console.log('Coluna de PCD encontrada:', columnNames.pcd);
      console.log('Coluna de detalhePCD encontrada:', columnNames.detalhePCD);
      console.log('Coluna de raÃ§a/cor encontrada:', columnNames.raca);
      console.log('Coluna de orientaÃ§Ã£o sexual encontrada:', columnNames.orientacaoSexual);
      console.log('Coluna de classificaÃ§Ã£o da violÃªncia encontrada:', columnNames.classificacaoViolencia);
      console.log('Coluna de tipo de violÃªncia encontrada:', columnNames.tipo);
      console.log('Coluna de motivaÃ§Ã£o da violÃªncia encontrada:', columnNames.motivacaoViolencia);
      console.log('Coluna de encaminhamento encontrada:', columnNames.encaminhamento);
      console.log('Coluna de escola encontrada:', columnNames.escola);
      console.log('Coluna de regiÃ£o encontrada:', columnNames.regiao);
      console.log('Todas as colunas do primeiro registro:', Object.keys(data[0]));
      
      if (columnNames.data && data.length > 0) {
        console.log('Exemplo de data:', data[0][columnNames.data]);
        console.log('Data parseada:', parseDateCell(data[0][columnNames.data]));
      }
      if (columnNames.genero && data.length > 0) {
        console.log('Exemplo de gÃªnero (primeiro registro):', data[0][columnNames.genero]);
        console.log('Exemplo de gÃªnero (segundo registro):', data[1] ? data[1][columnNames.genero] : 'N/A');
        console.log('Exemplo de gÃªnero (terceiro registro):', data[2] ? data[2][columnNames.genero] : 'N/A');
      }
      if (columnNames.detalhePCD && data.length > 0) {
        console.log('Exemplo de detalhePCD (primeiro registro):', data[0][columnNames.detalhePCD]);
        console.log('Exemplo de detalhePCD (segundo registro):', data[1] ? data[1][columnNames.detalhePCD] : 'N/A');
        console.log('Exemplo de detalhePCD (terceiro registro):', data[2] ? data[2][columnNames.detalhePCD] : 'N/A');
      }
      
      // Verifica se estÃ¡ pegando a coluna errada
      if (columnNames.genero === 'Idade') {
        console.warn('âš ï¸ ERRO: GÃªnero estÃ¡ mapeado para coluna Idade!');
        // Tenta encontrar pela letra da coluna
        const primeiroRegistro = data[0];
        const colunas = Object.keys(primeiroRegistro);
        console.log('Colunas disponÃ­veis:', colunas);
        
        // Procura coluna que contenha apenas M ou F
        for (const col of colunas) {
          const valores = data.slice(0, 10).map(row => String(row[col] || '').trim().toUpperCase());
          const todosMouF = valores.every(v => v === '' || v === 'M' || v === 'F');
          if (todosMouF && valores.some(v => v === 'M' || v === 'F')) {
            console.log(`âœ“ Coluna candidata para gÃªnero: "${col}" - valores:`, valores);
          }
        }
      }
      
      console.log('=== FIM DEBUG ===');
      
      // Atualiza variÃ¡veis globais para dashboard-stats.js
      window.columnNames = columnNames;
      
      updateUploadStatus('success', `âœ… Arquivo carregado â€“ ${data.length} registros`);
      
      initializeFilters(data);
      
      document.getElementById('filtersSection').classList.remove('hidden');
      document.getElementById('statsSection').classList.remove('hidden');
      document.getElementById('chartsSection').classList.remove('hidden');
      document.getElementById('resultsSection').classList.remove('hidden');
      document.getElementById('dashboardExecutivo').classList.remove('hidden');
      
      // Resetar para primeira pÃ¡gina ao carregar dados
      paginaAtual = 1;
      
      renderStats(filteredData);
      renderCharts(filteredData);
      renderTable(filteredData);
      
      // Atualiza KPIs do Dashboard Executivo
      setTimeout(() => {
        if (typeof atualizarKPIs === 'function') {
          atualizarKPIs();
        }
      }, 500);
    }

    function updateUploadStatus(type, message) {
      const statusDiv = document.getElementById('uploadStatus');
      statusDiv.textContent = message;
      statusDiv.className = 'p-4 rounded-md';
      
      if (type === 'loading') {
        statusDiv.classList.add('bg-blue-50', 'text-blue-700');
      } else if (type === 'success') {
        statusDiv.classList.add('bg-green-50', 'text-green-700');
      } else if (type === 'error') {
        statusDiv.classList.add('bg-red-50', 'text-red-700');
      } else {
        statusDiv.classList.add('bg-gray-50', 'text-gray-600');
      }
    }

    // ==============================
    // Filtros
    // ==============================
    function initializeFilters(data) {
      if (columnNames.regiao) {
        const valores = buildNormalizedOptions(columnNames.regiao, data);
        createCheckboxes('filterRegiaoContainer', valores, 'regiao');
      }
      if (columnNames.tipo) {
        // Usa funÃ§Ã£o especÃ­fica que NÃƒO separa por barra (mantÃ©m "Financeira/EconÃ´mica" junto)
        const valores = buildNormalizedOptionsTipoViolencia(columnNames.tipo, data);
        createCheckboxes('filterTipoViolenciaContainer', valores, 'tipoViolencia');
      }
      if (columnNames.escola) {
        // Filtro por tipo de instituiÃ§Ã£o (CMEI/EMEF/NÃ£o Encontrada)
        const tiposSet = new Set();
        data.forEach(row => {
          const tipo = getTipoInstituicao(row[columnNames.escola]);
          if (tipo) {
            tiposSet.add(tipo);
          } else if (row[columnNames.escola]) {
            tiposSet.add('NÃ£o Encontrada');
          }
        });
        const tiposInstituicao = Array.from(tiposSet).sort();
        createCheckboxes('filterTipoInstituicaoContainer', tiposInstituicao, 'tipoInstituicao');
        
        // Filtro por escola especÃ­fica
        const valores = buildNormalizedOptions(columnNames.escola, data);
        createCheckboxes('filterEscolaContainer', valores, 'escola');
      }
      if (columnNames.encaminhamento) {
        const valores = buildNormalizedOptions(columnNames.encaminhamento, data);
        buildEncaminhamentoGroups(valores);
      }
      if (columnNames.raca) {
        const valores = buildNormalizedOptions(columnNames.raca, data);
        createCheckboxes('filterRacaContainer', valores, 'raca');
      }
      if (columnNames.genero) {
        const valores = buildGeneroOptions(data); // FunÃ§Ã£o especÃ­fica para gÃªnero
        createCheckboxes('filterGeneroContainer', valores, 'genero');
      }
      
      // NOVO FILTRO: Tipo de deficiÃªncia/transtorno
      // Gera automaticamente as opÃ§Ãµes a partir da coluna detalhePCD
      // Suporta valores mÃºltiplos separados por vÃ­rgula
      // APLICA NORMALIZAÃ‡ÃƒO para unificar variaÃ§Ãµes (TDAH/TDH/tdh, etc.)
      if (columnNames.detalhePCD) {
        const valoresBrutos = buildNormalizedOptions(columnNames.detalhePCD, data);
        const valoresNormalizados = normalizarListaTranstornos(valoresBrutos);
        createCheckboxes('filterTipoDeficienciaContainer', valoresNormalizados, 'tipoDeficiencia');
      }
      
      // NOVO FILTRO: OrientaÃ§Ã£o Sexual
      if (columnNames.orientacaoSexual) {
        const valores = buildNormalizedOptions(columnNames.orientacaoSexual, data);
        createCheckboxes('filterOrientacaoContainer', valores, 'orientacao');
      }
      
      // NOVO FILTRO: ClassificaÃ§Ã£o da ViolÃªncia
      if (columnNames.classificacaoViolencia) {
        const valores = buildNormalizedOptions(columnNames.classificacaoViolencia, data);
        createCheckboxes('filterClassificacaoContainer', valores, 'classificacao');
      }
      
      // NOVO FILTRO: MotivaÃ§Ã£o da ViolÃªncia
      if (columnNames.motivacaoViolencia) {
        const valores = buildNormalizedOptions(columnNames.motivacaoViolencia, data);
        createCheckboxes('filterMotivacaoContainer', valores, 'motivacao');
      }
      
      const filterIds = [
        'filterPCD', 'filterOcorreuEscola',
        'filterFonteInformada', 'filterViolenciaEscolaOcorreu', 'filterProfissionalAutor',
        'filterEstudanteAutor', 'filterViolenciaNaoEscola', 'filterViolenciaInformada', 'filterEstudoCaso',
        'filterIdadeMin', 'filterIdadeMax', 'filterNome',
        'filterDataInicio', 'filterDataFim', 'filterTI'
      ];
      
      filterIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          // Para inputs type="date", usar 'change' ao invÃ©s de 'input'
          const eventType = (element.type === 'date') ? 'change' : 
                           (element.tagName === 'INPUT') ? 'input' : 'change';
          element.addEventListener(eventType, applyFilters);
        }
      });
      
      // Event listener especÃ­fico para o filtro TI com atualizaÃ§Ã£o de badge
      const filterTIElement = document.getElementById('filterTI');
      if (filterTIElement) {
        filterTIElement.addEventListener('change', function() {
          updateBadgeTI();
          applyFilters();
        });
      }
      
      document.getElementById('btnLimparFiltros').addEventListener('click', clearFilters);
      // Event listeners de exportaÃ§Ã£o jÃ¡ estÃ£o configurados no window.addEventListener('load')
    }

    function populateSelect(selectId, options) {
      const select = document.getElementById(selectId);
      const firstOption = select.options[0] || null;
      select.innerHTML = '';
      if (firstOption) {
        select.appendChild(firstOption);
      }
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
    }

    // S/N
    function checkSN(value, filterValue) {
      if (!filterValue) return true;
      const val = String(value || '').toUpperCase().trim();
      if (!val) return false;
      const f = filterValue.toUpperCase();
      if (f === 'S') {
        return val === 'S' || val === 'SIM';
      }
      if (f === 'N') {
        return val === 'N' || val === 'NAO' || val === 'NÃƒO';
      }
      return false;
    }

    function applyFilters() {
      const filters = {
        regioes:         getCheckedValues('regiao'),
        tipos:           getCheckedValues('tipoViolencia'),
        tiposInstituicao: getCheckedValues('tipoInstituicao'),
        escolas:         getCheckedValues('escola'),
        encaminhamentos: gatherSelectedEncaminhamentos(),
        racas:           getCheckedValues('raca'),
        generos:         getCheckedValues('genero'),
        
        // NOVO FILTRO: Tipos de deficiÃªncia/transtorno selecionados
        tiposDeficiencia: getCheckedValues('tipoDeficiencia'),
        
        // NOVOS FILTROS
        orientacoes:     getCheckedValues('orientacao'),
        classificacoes:  getCheckedValues('classificacao'),
        motivacoes:      getCheckedValues('motivacao'),

        pcd:                  document.getElementById('filterPCD').value,
        ocorreu:              document.getElementById('filterOcorreuEscola').value,
        fonteInformada:       document.getElementById('filterFonteInformada').value,
        violenciaEscolaOcorreu: document.getElementById('filterViolenciaEscolaOcorreu').value,
        profissionalAutor:    document.getElementById('filterProfissionalAutor').value,
        estudanteAutor:       document.getElementById('filterEstudanteAutor').value,
        violenciaNaoEscola:   document.getElementById('filterViolenciaNaoEscola').value,
        violenciaInformada:   document.getElementById('filterViolenciaInformada').value,
        estudoCaso:           document.getElementById('filterEstudoCaso').value,

        idadeMin: document.getElementById('filterIdadeMin').value,
        idadeMax: document.getElementById('filterIdadeMax').value,

        nome: document.getElementById('filterNome').value.toLowerCase(),

        dataInicio: document.getElementById('filterDataInicio').value,
        dataFim:    document.getElementById('filterDataFim').value
      };

      const dataInicioDate = filters.dataInicio ? new Date(filters.dataInicio + 'T00:00:00') : null;
      const dataFimDate    = filters.dataFim    ? new Date(filters.dataFim    + 'T23:59:59') : null;
      
      filteredData = originalData.filter(row => {
        // Multi (OU) - com suporte a campos multi-valor separados por vÃ­rgula
        if (filters.regioes.length && columnNames.regiao) {
          const rowVals = String(row[columnNames.regiao] || '').split(',').map(v => v.trim());
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.regioes.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        if (filters.tipos.length && columnNames.tipo) {
          // Filtro de Tipo de ViolÃªncia: NÃƒO separa por barra (/)
          // "Financeira/EconÃ´mica" Ã© tratada como uma categoria Ãºnica
          const rowVals = String(row[columnNames.tipo] || '')
            .split(',')
            .map(v => v.trim())
            .filter(v => v);
          
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.tipos.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        // Filtro por tipo de instituiÃ§Ã£o (CMEI/EMEF/NÃ£o Encontrada)
        if (filters.tiposInstituicao.length && columnNames.escola) {
          const tipoEscola = getTipoInstituicao(row[columnNames.escola]);
          const tipoParaFiltro = tipoEscola || (row[columnNames.escola] ? 'NÃ£o Encontrada' : null);
          
          if (!tipoParaFiltro || !filters.tiposInstituicao.includes(tipoParaFiltro)) {
            return false;
          }
        }
        if (filters.escolas.length && columnNames.escola) {
          const rowVals = String(row[columnNames.escola] || '').split(',').map(v => v.trim());
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.escolas.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        
        // FILTRO: Tempo Integral (corrigido para usar sigla â†’ nome completo)
        const selectTI = document.getElementById('filterTI');
        const filtroTI = selectTI ? selectTI.value : '';
        
        if (filtroTI && columnNames.escola) {
          const escola = row[columnNames.escola]; // Sigla da escola (ex.: "ABS", "AA")
          
          if (filtroTI === 'TI') {
            // SÃ³ mantÃ©m registros de escolas de tempo integral
            if (!isTempoIntegral(escola)) {
              return false;
            }
          } else if (filtroTI === 'Regular') {
            // SÃ³ mantÃ©m registros de escolas que NÃƒO sÃ£o TI
            if (isTempoIntegral(escola)) {
              return false;
            }
          }
          // Se filtroTI === '' â†’ nÃ£o filtra por tempo integral
        }
        
        if (filters.encaminhamentos.length && columnNames.encaminhamento) {
          if (!matchEncaminhamentoCell(row[columnNames.encaminhamento], filters.encaminhamentos)) {
            return false;
          }
        }
        if (filters.racas.length && columnNames.raca) {
          const rowVals = String(row[columnNames.raca] || '').split(',').map(v => v.trim());
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.racas.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        if (filters.generos.length && columnNames.genero) {
          // Para gÃªnero (coluna D), verifica se Ã© M ou F
          const rowValue = String(row[columnNames.genero] || '').trim().toUpperCase();
          const ok = filters.generos.some(v => v.toUpperCase() === rowValue);
          if (!ok) return false;
        }
        
        // NOVO FILTRO: Tipo de deficiÃªncia/transtorno
        // Este filtro trabalha em conjunto com o filtro de PCD
        // APLICA NORMALIZAÃ‡ÃƒO para que "TDAH", "TDH", "tdah" sejam considerados iguais
        if (filters.tiposDeficiencia.length && columnNames.detalhePCD) {
          // Se o usuÃ¡rio selecionou tipos de deficiÃªncia, o registro deve:
          // 1) Ser PCD (ter "S" ou "SIM" na coluna PCD)
          // 2) Ter um detalhamento que bata com as opÃ§Ãµes selecionadas
          
          // Verifica se Ã© PCD
          const isPCD = checkSN(row[columnNames.pcd], 'S');
          if (!isPCD) return false; // Se nÃ£o Ã© PCD, nÃ£o passa no filtro
          
          // Verifica se o detalhamento bate com alguma opÃ§Ã£o selecionada
          // Separa por vÃ­rgula E por barra (/) para considerar mÃºltiplos transtornos
          const rowVals = String(row[columnNames.detalhePCD] || '')
            .split(',')
            .flatMap(v => v.split('/'))
            .map(v => v.trim())
            .filter(v => v);
          
          // APLICA NORMALIZAÃ‡ÃƒO aos valores do registro E aos filtros selecionados
          const rowNormalizados = rowVals.map(v => normalizarTranstorno(v));
          const filterNormalizados = filters.tiposDeficiencia; // JÃ¡ vem normalizado do checkbox
          
          // Compara usando normalizeText para remover acentos e maiÃºsculas
          const rowNorms = rowNormalizados.map(v => normalizeText(v));
          const filterNorms = filterNormalizados.map(v => normalizeText(v));
          
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        
        // NOVO FILTRO: OrientaÃ§Ã£o Sexual (OU)
        if (filters.orientacoes.length && columnNames.orientacaoSexual) {
          const rowVals = String(row[columnNames.orientacaoSexual] || '')
            .split(',')
            .flatMap(v => v.split('/'))
            .map(v => v.trim())
            .filter(v => v);
          
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.orientacoes.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        
        // NOVO FILTRO: ClassificaÃ§Ã£o da ViolÃªncia (OU)
        if (filters.classificacoes.length && columnNames.classificacaoViolencia) {
          const rowVals = String(row[columnNames.classificacaoViolencia] || '')
            .split(',')
            .flatMap(v => v.split('/'))
            .map(v => v.trim())
            .filter(v => v);
          
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.classificacoes.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }
        
        // NOVO FILTRO: MotivaÃ§Ã£o da ViolÃªncia (OU)
        if (filters.motivacoes.length && columnNames.motivacaoViolencia) {
          const rowVals = String(row[columnNames.motivacaoViolencia] || '')
            .split(',')
            .flatMap(v => v.split('/'))
            .map(v => v.trim())
            .filter(v => v);
          
          const rowNorms = rowVals.map(v => normalizeText(v)).filter(v => v);
          const filterNorms = filters.motivacoes.map(v => normalizeText(v));
          const ok = rowNorms.some(rn => filterNorms.includes(rn));
          if (!ok) return false;
        }

        // S/N
        if (filters.pcd && columnNames.pcd && !checkSN(row[columnNames.pcd], filters.pcd)) return false;
        
        // FILTRO: Ocorreu na escola - Combina colunas U (ocorreu) e Q (violenciaEscolaOcorreu)
        // Se o usuÃ¡rio filtrar "Sim", mostra registros onde U OU Q = Sim
        // Se o usuÃ¡rio filtrar "NÃ£o", mostra registros onde U E Q = NÃ£o
        // FILTRO: Ocorreu na Escola? - Combina colunas U e Q
        if (filters.ocorreu && filters.ocorreu !== '') {
          const ocorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'S') : false;
          const ocorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'S') : false;
          const ocorreuNaEscola = ocorreuU || ocorreuQ;
          
          // Se filtro Ã© 'S', precisa ter ocorrido na escola (U ou Q = 'S')
          if (filters.ocorreu === 'S' && !ocorreuNaEscola) return false;
          
          // Se filtro Ã© 'N', precisa NÃƒO ter ocorrido na escola
          // Verifica se ambas colunas sÃ£o 'N' ou vazias
          if (filters.ocorreu === 'N') {
            const naoOcorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'N') : true;
            const naoOcorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'N') : true;
            // Se ocorreu na escola OU se nenhuma das colunas Ã© 'N', nÃ£o passa no filtro
            if (ocorreuNaEscola || (!naoOcorreuU && !naoOcorreuQ)) return false;
          }
        }
        
        if (filters.fonteInformada && columnNames.fonteInformada && !checkSN(row[columnNames.fonteInformada], filters.fonteInformada)) return false;
        
        // FILTRO: ViolÃªncia identificada pela escola ocorrida na escola - Usa APENAS coluna Q
        if (filters.violenciaEscolaOcorreu && columnNames.violenciaEscolaOcorreu &&
            !checkSN(row[columnNames.violenciaEscolaOcorreu], filters.violenciaEscolaOcorreu)) return false;
        
        // FILTRO: Autor da ViolÃªncia (colunas R e S)
        // LÃ³gica: Se profissionalAutor = 'S', mostra apenas casos onde R = 'S' (independente de S)
        // Se estudanteAutor = 'S', mostra apenas casos onde S = 'S' (independente de R)
        // Se ambos = 'N', mostra apenas casos onde R = 'N' E S = 'N'
        if (filters.profissionalAutor && filters.profissionalAutor !== '') {
          if (columnNames.profissionalAutor) {
            const profissionalS = checkSN(row[columnNames.profissionalAutor], 'S');
            const profissionalN = checkSN(row[columnNames.profissionalAutor], 'N');
            
            if (filters.profissionalAutor === 'S' && !profissionalS) return false;
            if (filters.profissionalAutor === 'N' && !profissionalN) return false;
          }
        }
        
        if (filters.estudanteAutor && filters.estudanteAutor !== '') {
          if (columnNames.estudanteAutor) {
            const estudanteS = checkSN(row[columnNames.estudanteAutor], 'S');
            const estudanteN = checkSN(row[columnNames.estudanteAutor], 'N');
            
            if (filters.estudanteAutor === 'S' && !estudanteS) return false;
            if (filters.estudanteAutor === 'N' && !estudanteN) return false;
          }
        }
        
        // Caso especial: Se ambos estÃ£o definidos como 'N', significa "Outro Agente"
        // Ambos devem ser 'N' para passar no filtro
        if (filters.profissionalAutor === 'N' && filters.estudanteAutor === 'N') {
          if (columnNames.profissionalAutor && columnNames.estudanteAutor) {
            const profissionalN = checkSN(row[columnNames.profissionalAutor], 'N');
            const estudanteN = checkSN(row[columnNames.estudanteAutor], 'N');
            if (!profissionalN || !estudanteN) return false;
          }
        }
        if (filters.violenciaNaoEscola && columnNames.violenciaNaoEscola &&
            !checkSN(row[columnNames.violenciaNaoEscola], filters.violenciaNaoEscola)) return false;
        if (filters.violenciaInformada && columnNames.violenciaInformada &&
            !checkSN(row[columnNames.violenciaInformada], filters.violenciaInformada)) return false;
        if (filters.estudoCaso && columnNames.estudoCaso &&
            !checkSN(row[columnNames.estudoCaso], filters.estudoCaso)) return false;

        // Idade
        if (columnNames.idade) {
          const idade = parseInt(row[columnNames.idade], 10);
          if (filters.idadeMin && !isNaN(idade) && idade < parseInt(filters.idadeMin, 10)) return false;
          if (filters.idadeMax && !isNaN(idade) && idade > parseInt(filters.idadeMax, 10)) return false;
        }

        // Nome (contains)
        if (filters.nome && columnNames.crianca) {
          const nome = String(row[columnNames.crianca] || '').toLowerCase();
          if (!nome.includes(filters.nome)) return false;
        }

        // Data - usa coluna dataNT (Data da NT) ou data
        const dataColumn = columnNames.dataNT || columnNames.data;
        if ((dataInicioDate || dataFimDate) && dataColumn !== undefined) {
          const rowDate = parseDateCell(row[dataColumn]);
          // Se houver filtro de data mas o registro nÃ£o tem data vÃ¡lida, exclui o registro
          if (!rowDate) {
            return false;
          }
          
          // Normaliza as datas para comparaÃ§Ã£o (apenas dia/mÃªs/ano, sem horas)
          const rowDateOnly = new Date(rowDate.getFullYear(), rowDate.getMonth(), rowDate.getDate());
          const dataInicioOnly = dataInicioDate ? new Date(dataInicioDate.getFullYear(), dataInicioDate.getMonth(), dataInicioDate.getDate()) : null;
          const dataFimDateOnly = dataFimDate ? new Date(dataFimDate.getFullYear(), dataFimDate.getMonth(), dataFimDate.getDate()) : null;
          
          if (dataInicioOnly && rowDateOnly < dataInicioOnly) return false;
          if (dataFimDateOnly && rowDateOnly > dataFimDateOnly) return false;
        }

        return true;
      });

      // Atualiza variÃ¡vel global para dashboard-stats.js
      window.filteredData = filteredData;
      
      // Resetar para primeira pÃ¡gina ao aplicar filtros
      paginaAtual = 1;

      renderStats(filteredData);
      renderCharts(filteredData);
      renderTable(filteredData);
      
      // Atualiza KPIs apÃ³s aplicar filtros
      setTimeout(() => {
        if (typeof atualizarKPIs === 'function') {
          atualizarKPIs();
        }
      }, 300);
    }

    function clearFilters() {
      // Limpar checkboxes dos filtros avanÃ§ados
      const allCheckboxes = document.querySelectorAll('.custom-checkbox');
      allCheckboxes.forEach(cb => {
        cb.checked = false;
        cb.indeterminate = false;
      });
      
      // Limpar badges
      const badges = document.querySelectorAll('.badge-count, .group-badge');
      badges.forEach(badge => badge.classList.add('hidden'));
      
      // Remover estados ativos dos cards
      const cards = document.querySelectorAll('.filter-card');
      cards.forEach(card => card.classList.remove('active'));
      
      // Esconder todas as seÃ§Ãµes
      const sections = document.querySelectorAll('.filter-section');
      sections.forEach(section => {
        section.classList.remove('show');
        section.classList.add('hidden');
      });
      
      // Fechar painel
      document.getElementById('advancedPanel').classList.remove('open');
      
      // Limpar selects e inputs
      const filterIds = [
        'filterPCD', 'filterOcorreuEscola',
        'filterFonteInformada', 'filterViolenciaEscolaOcorreu', 'filterProfissionalAutor',
        'filterEstudanteAutor', 'filterViolenciaNaoEscola', 'filterViolenciaInformada',
        'filterIdadeMin', 'filterIdadeMax', 'filterNome',
        'filterDataInicio', 'filterDataFim', 'filterTI'
      ];
      
      filterIds.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName === 'SELECT') {
          Array.from(el.options).forEach(o => o.selected = false);
        } else {
          el.value = '';
        }
      });
      
      filteredData = [...originalData];
      
      // Atualiza variÃ¡vel global para dashboard-stats.js
      window.filteredData = filteredData;
      
      // Resetar para primeira pÃ¡gina ao limpar filtros
      paginaAtual = 1;
      
      renderStats(filteredData);
      renderCharts(filteredData);
      renderTable(filteredData);
      
      // Atualiza KPIs apÃ³s limpar filtros
      setTimeout(() => {
        if (typeof atualizarKPIs === 'function') {
          atualizarKPIs();
        }
      }, 300);
    }

    // ==============================
    // EstatÃ­sticas / Tabela / Modal
    // ==============================
    function renderStats(data) {
      const total = originalData.length;
      const filtrados = data.length;
      
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statFiltrados').textContent = filtrados;
      
      let countEscola = 0;
      // Considera AMBAS as colunas U (ocorreu na escola 1.1) e Q (violÃªncia identificada pela escola ocorrida na escola)
      // Se qualquer uma delas for 'S' ou 'Sim', conta como ocorrido na escola
      if (columnNames.ocorreu || columnNames.violenciaEscolaOcorreu) {
        countEscola = data.reduce((acc, row) => {
          const ocorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'S') : false;
          const ocorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'S') : false;
          return acc + (ocorreuU || ocorreuQ ? 1 : 0);
        }, 0);
      }
      document.getElementById('statEscola').textContent = countEscola;
      
      const tiposDiv = document.getElementById('statTipos');
      tiposDiv.innerHTML = '';
      if (columnNames.tipo) {
        const mapa = {};
        data.forEach(row => {
          const tipo = row[columnNames.tipo];
          if (!tipo) return;
          const rotulo = String(tipo).trim();
          mapa[rotulo] = (mapa[rotulo] || 0) + 1;
        });
        const tipos = Object.keys(mapa).sort();
        if (tipos.length === 0) {
          tiposDiv.textContent = 'Nenhum tipo identificado nos registros filtrados.';
        } else {
          tipos.forEach(t => {
            const p = document.createElement('div');
            p.textContent = `${t}: ${mapa[t]}`;
            tiposDiv.appendChild(p);
          });
        }
      } else {
        tiposDiv.textContent = 'Coluna "Tipo de ViolÃªncia" nÃ£o encontrada.';
      }
    }
    
    // ==============================
    // GrÃ¡ficos
    // ==============================
    function renderCharts(data) {
      // Cores para os grÃ¡ficos
      const colors = [
        'rgba(59, 130, 246, 0.8)',   // azul
        'rgba(239, 68, 68, 0.8)',    // vermelho
        'rgba(34, 197, 94, 0.8)',    // verde
        'rgba(234, 179, 8, 0.8)',    // amarelo
        'rgba(168, 85, 247, 0.8)',   // roxo
        'rgba(236, 72, 153, 0.8)',   // rosa
        'rgba(20, 184, 166, 0.8)',   // teal
        'rgba(251, 146, 60, 0.8)',   // laranja
        'rgba(148, 163, 184, 0.8)',  // cinza
        'rgba(6, 182, 212, 0.8)'     // cyan
      ];
      
      // GrÃ¡fico: Tipos de ViolÃªncia (normalizado)
      if (columnNames.tipo) {
        const dados = {};
        const mapaNormalizado = {}; // norm -> label original mais comum
        
        data.forEach(row => {
          const tipo = row[columnNames.tipo];
          if (tipo) {
            const original = String(tipo).trim();
            const norm = normalizeText(original);
            if (norm) {
              dados[norm] = (dados[norm] || 0) + 1;
              // Guarda o label original mais usado (capitalizado)
              if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                mapaNormalizado[norm] = original;
              }
            }
          }
        });
        
        // Converte de volta para labels originais
        const sorted = Object.entries(dados)
          .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
          .sort((a, b) => b[1] - a[1]);
        renderPieChart('chartTipoViolencia', sorted, colors);
      }
      
      // GrÃ¡fico: Por RegiÃ£o (normalizado)
      if (columnNames.regiao) {
        const dados = {};
        const mapaNormalizado = {};
        
        data.forEach(row => {
          const regiao = row[columnNames.regiao];
          if (regiao) {
            const original = String(regiao).trim();
            const norm = normalizeText(original);
            if (norm) {
              dados[norm] = (dados[norm] || 0) + 1;
              if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                mapaNormalizado[norm] = original;
              }
            }
          }
        });
        
        const sorted = Object.entries(dados)
          .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
          .sort((a, b) => b[1] - a[1]);
        renderBarChart('chartRegiao', sorted, colors);
      }
      
      // GrÃ¡fico: Top 10 Escolas (normalizado)
      if (columnNames.escola) {
        const dados = {};
        const mapaNormalizado = {};
        
        data.forEach(row => {
          const escola = row[columnNames.escola];
          if (escola) {
            const original = String(escola).trim();
            const norm = normalizeText(original);
            if (norm) {
              dados[norm] = (dados[norm] || 0) + 1;
              if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                mapaNormalizado[norm] = original;
              }
            }
          }
        });
        
        const sorted = Object.entries(dados)
          .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);
        renderBarChart('chartEscola', sorted, colors);
      }
      
      // GrÃ¡fico: Faixa EtÃ¡ria
      if (columnNames.idade) {
        const faixas = {
          '0-5 anos': 0,
          '6-10 anos': 0,
          '11-14 anos': 0,
          '15-17 anos': 0,
          '18+ anos': 0
        };
        
        data.forEach(row => {
          const idade = parseInt(row[columnNames.idade], 10);
          if (!isNaN(idade)) {
            if (idade <= 5) faixas['0-5 anos']++;
            else if (idade <= 10) faixas['6-10 anos']++;
            else if (idade <= 14) faixas['11-14 anos']++;
            else if (idade <= 17) faixas['15-17 anos']++;
            else faixas['18+ anos']++;
          }
        });
        
        const sorted = Object.entries(faixas).filter(([k, v]) => v > 0);
        renderBarChart('chartIdade', sorted, colors);
      }
      
      // GrÃ¡fico: GÃªnero (Coluna D: M ou F)
      if (columnNames.genero) {
        const dados = { 'F': 0, 'M': 0 };
        data.forEach(row => {
          const genero = row[columnNames.genero];
          if (genero) {
            const key = String(genero).trim().toUpperCase();
            if (key === 'F') dados['F']++;
            else if (key === 'M') dados['M']++;
          }
        });
        
        // Filtra apenas os que tÃªm valores
        const sorted = Object.entries(dados).filter(([k, v]) => v > 0).sort((a, b) => b[1] - a[1]);
        renderPieChart('chartGenero', sorted, colors);
      }
      
      // GrÃ¡fico: RaÃ§a/Cor (normalizado)
      if (columnNames.raca) {
        const dados = {};
        const mapaNormalizado = {};
        
        data.forEach(row => {
          const raca = row[columnNames.raca];
          if (raca) {
            const original = String(raca).trim();
            const norm = normalizeText(original);
            if (norm) {
              dados[norm] = (dados[norm] || 0) + 1;
              if (!mapaNormalizado[norm] || original.length > mapaNormalizado[norm].length) {
                mapaNormalizado[norm] = original;
              }
            }
          }
        });
        
        const sorted = Object.entries(dados)
          .map(([norm, count]) => [mapaNormalizado[norm] || norm, count])
          .sort((a, b) => b[1] - a[1]);
        renderPieChart('chartRaca', sorted, colors);
      }
      
      // GrÃ¡fico: Linha do Tempo
      if (columnNames.data) {
        console.log('=== INÃCIO DEBUG GRÃFICO TEMPORAL ===');
        console.log('Total de registros:', data.length);
        
        const porMes = {};
        let datasValidas = 0;
        let datasInvalidas = 0;
        
        data.forEach((row, index) => {
          const rawData = row[columnNames.data];
          console.log(`Registro ${index + 1}: rawData =`, rawData, typeof rawData);
          
          const date = parseDateCell(rawData);
          console.log(`  â†’ ApÃ³s parseDateCell:`, date);
          
          if (date) {
            datasValidas++;
            const mes = date.getMonth();
            const ano = date.getFullYear();
            const key = `${ano}-${String(mes + 1).padStart(2, '0')}`;
            
            console.log(`  â†’ Data vÃ¡lida: ${date.toLocaleDateString('pt-BR')} â†’ Chave: ${key}`);
            
            porMes[key] = (porMes[key] || 0) + 1;
          } else {
            datasInvalidas++;
            console.log(`  â†’ Data INVÃLIDA (null/undefined)`);
          }
        });
        
        console.log('Datas vÃ¡lidas:', datasValidas);
        console.log('Datas invÃ¡lidas:', datasInvalidas);
        console.log('Contagem por mÃªs:', porMes);
        
        const sorted = Object.entries(porMes).sort((a, b) => a[0].localeCompare(b[0]));
        console.log('Meses ordenados:', sorted);
        
        const labels = sorted.map(([key]) => {
          const [ano, mes] = key.split('-');
          const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
          return `${meses[parseInt(mes) - 1]}/${ano}`;
        });
        const valores = sorted.map(([, v]) => v);
        
        console.log('Labels para grÃ¡fico:', labels);
        console.log('Valores para grÃ¡fico:', valores);
        console.log('=== FIM DEBUG GRÃFICO TEMPORAL ===');
        
        renderLineChart('chartTemporal', labels, valores);
      }
      
      // GrÃ¡fico: Encaminhamentos (agrupado por redes)
      if (columnNames.encaminhamento) {
        // Contagem por grupo de rede
        const dadosPorGrupo = {};
        
        data.forEach(row => {
          const encaminhamento = row[columnNames.encaminhamento];
          if (encaminhamento) {
            // Suporta valores mÃºltiplos separados por vÃ­rgula e barra
            const valores = String(encaminhamento)
              .split(',')
              .flatMap(v => v.split('/'))
              .map(v => v.trim())
              .filter(v => v);
            
            valores.forEach(val => {
              const original = String(val).trim();
              const norm = normalizeText(original);
              
              if (norm) {
                // Encontrar grupo
                let grupoEncontrado = null;
                for (const groupKey in encaminhamentosAgrupados) {
                  const children = encaminhamentosAgrupados[groupKey];
                  if (children.some(child => normalizeText(child) === norm)) {
                    grupoEncontrado = groupKey;
                    break;
                  }
                }
                
                // Se nÃ£o encontrou grupo, usar "Outros"
                if (!grupoEncontrado) {
                  grupoEncontrado = 'outros';
                }
                
                // Contagem por grupo
                if (!dadosPorGrupo[grupoEncontrado]) {
                  dadosPorGrupo[grupoEncontrado] = 0;
                }
                dadosPorGrupo[grupoEncontrado]++;
              }
            });
          }
        });
        
        // Converter para array e ordenar
        const sorted = Object.entries(dadosPorGrupo)
          .map(([groupId, count]) => {
            const groupName = grupoNomes[groupId] || (groupId === 'outros' ? 'Outros Encaminhamentos' : groupId);
            return [groupName, count, groupId];
          })
          .sort((a, b) => b[1] - a[1]);
        
        if (sorted.length > 0) {
          // Usar cores diferentes para cada grupo
          const coresPorGrupo = {
            'redeAssistencia': 'rgba(59, 130, 246, 0.8)', // Azul
            'redeSaude': 'rgba(34, 197, 94, 0.8)', // Verde
            'redeEducacao': 'rgba(251, 146, 60, 0.8)', // Laranja
            'conselhoTutelar': 'rgba(168, 85, 247, 0.8)', // Roxo
            'redeSegurancaJustica': 'rgba(239, 68, 68, 0.8)', // Vermelho
            'outros': 'rgba(156, 163, 175, 0.8)' // Cinza
          };
          
          const cores = sorted.map(([, , groupId]) => coresPorGrupo[groupId] || coresPorGrupo['outros']);
          const dadosGrafico = sorted.map(([name, count]) => [name, count]);
          
          renderHorizontalBarChartGrouped('chartEncaminhamento', dadosGrafico, cores);
        }
      }
      
      // GrÃ¡fico: Autor da ViolÃªncia (baseado nas colunas R e S)
      // Coluna R (profissionalAutor): 'S' = Profissional da Escola
      // Coluna S (estudanteAutor): 'S' = Estudante
      // Se ambas = 'N': Outro Agente (Fora da InstituiÃ§Ã£o)
      if (columnNames.profissionalAutor || columnNames.estudanteAutor) {
        const dados = {
          'Profissional da Escola': 0,
          'Estudante': 0,
          'Outro Agente (Fora da InstituiÃ§Ã£o)': 0,
          'NÃ£o Informado': 0
        };
        
        data.forEach(row => {
          const profissionalS = columnNames.profissionalAutor ? checkSN(row[columnNames.profissionalAutor], 'S') : false;
          const profissionalN = columnNames.profissionalAutor ? checkSN(row[columnNames.profissionalAutor], 'N') : false;
          const estudanteS = columnNames.estudanteAutor ? checkSN(row[columnNames.estudanteAutor], 'S') : false;
          const estudanteN = columnNames.estudanteAutor ? checkSN(row[columnNames.estudanteAutor], 'N') : false;
          
          // Se coluna R = 'S' â†’ Profissional da Escola
          if (profissionalS) {
            dados['Profissional da Escola']++;
          }
          // Se coluna S = 'S' â†’ Estudante
          else if (estudanteS) {
            dados['Estudante']++;
          }
          // Se ambas colunas R e S = 'N' â†’ Outro Agente (Fora da InstituiÃ§Ã£o)
          else if (profissionalN && estudanteN) {
            dados['Outro Agente (Fora da InstituiÃ§Ã£o)']++;
          }
          // Caso contrÃ¡rio â†’ NÃ£o Informado
          else {
            dados['NÃ£o Informado']++;
          }
        });
        
        const sorted = Object.entries(dados).filter(([k, v]) => v > 0);
        if (sorted.length > 0) {
          renderPieChart('chartAutor', sorted, colors);
        }
      }
      
      // GrÃ¡fico: Ocorreu na Escola? (Sim/NÃ£o)
      if (columnNames.ocorreu || columnNames.violenciaEscolaOcorreu) {
        const dados = {
          'Sim': 0,
          'NÃ£o': 0,
          'NÃ£o Informado': 0
        };
        
        data.forEach(row => {
          const ocorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'S') : false;
          const ocorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'S') : false;
          const ocorreuNaEscola = ocorreuU || ocorreuQ;
          
          const naoOcorreuU = columnNames.ocorreu ? checkSN(row[columnNames.ocorreu], 'N') : false;
          const naoOcorreuQ = columnNames.violenciaEscolaOcorreu ? checkSN(row[columnNames.violenciaEscolaOcorreu], 'N') : false;
          const naoOcorreuNaEscola = naoOcorreuU && naoOcorreuQ;
          
          if (ocorreuNaEscola) {
            dados['Sim']++;
          } else if (naoOcorreuNaEscola) {
            dados['NÃ£o']++;
          } else {
            dados['NÃ£o Informado']++;
          }
        });
        
        const sorted = Object.entries(dados).filter(([k, v]) => v > 0);
        if (sorted.length > 0) {
          renderPieChart('chartOcorreuEscola', sorted, colors);
        }
      }
      
      // GrÃ¡fico: CorrelaÃ§Ã£o Tipo de ViolÃªncia vs Faixa EtÃ¡ria
      if (columnNames.tipo && columnNames.idade) {
        const faixasEtarias = ['0-5', '6-10', '11-14', '15-17', '18+'];
        const tiposViolencia = {};
        const correlacao = {};
        
        // Primeiro, identifica todos os tipos de violÃªncia
        data.forEach(row => {
          const tipo = row[columnNames.tipo];
          if (tipo) {
            const tipoNorm = normalizeText(String(tipo).trim());
            if (tipoNorm && !tiposViolencia[tipoNorm]) {
              tiposViolencia[tipoNorm] = String(tipo).trim();
            }
          }
        });
        
        // Cria estrutura de correlaÃ§Ã£o
        Object.keys(tiposViolencia).forEach(tipoNorm => {
          correlacao[tipoNorm] = {};
          faixasEtarias.forEach(faixa => {
            correlacao[tipoNorm][faixa] = 0;
          });
        });
        
        // Preenche os dados
        data.forEach(row => {
          const tipo = row[columnNames.tipo];
          const idade = row[columnNames.idade];
          
          if (tipo && idade) {
            const tipoNorm = normalizeText(String(tipo).trim());
            if (!tipoNorm) return;
            
            const idadeNum = parseInt(String(idade).trim(), 10);
            if (isNaN(idadeNum)) return;
            
            let faixa = '18+';
            if (idadeNum <= 5) faixa = '0-5';
            else if (idadeNum <= 10) faixa = '6-10';
            else if (idadeNum <= 14) faixa = '11-14';
            else if (idadeNum <= 17) faixa = '15-17';
            
            if (correlacao[tipoNorm] && correlacao[tipoNorm][faixa] !== undefined) {
              correlacao[tipoNorm][faixa]++;
            }
          }
        });
        
        // Prepara dados para o grÃ¡fico (top 5 tipos mais frequentes)
        const tiposOrdenados = Object.entries(tiposViolencia)
          .map(([norm, original]) => {
            const total = faixasEtarias.reduce((sum, faixa) => sum + (correlacao[norm]?.[faixa] || 0), 0);
            return { norm, original, total };
          })
          .sort((a, b) => b.total - a.total)
          .slice(0, 5);
        
        if (tiposOrdenados.length > 0) {
          const datasets = faixasEtarias.map((faixa, idx) => {
            return {
              label: faixa + ' anos',
              data: tiposOrdenados.map(({ norm }) => correlacao[norm]?.[faixa] || 0),
              backgroundColor: colors[idx % colors.length],
              borderColor: colors[idx % colors.length].replace('0.8', '1'),
              borderWidth: 2
            };
          });
          
          const labels = tiposOrdenados.map(({ original }) => original);
          renderGroupedBarChart('chartCorrelacaoTipoIdade', labels, datasets);
        }
      }
      
      // GrÃ¡fico: Comparativo Temporal (Ãšltimos 6 Meses vs PerÃ­odo Anterior)
      if (columnNames.data || columnNames.dataNT) {
        const dataCol = columnNames.data || columnNames.dataNT;
        const agora = new Date();
        const mesAtual = agora.getMonth();
        const anoAtual = agora.getFullYear();
        
        // Ãšltimos 6 meses
        const ultimos6Meses = {};
        for (let i = 0; i < 6; i++) {
          const mes = (mesAtual - i + 12) % 12;
          const ano = mesAtual - i < 0 ? anoAtual - 1 : anoAtual;
          const key = `${ano}-${String(mes + 1).padStart(2, '0')}`;
          ultimos6Meses[key] = { mes, ano, count: 0 };
        }
        
        // PerÃ­odo anterior (meses 7-12 atrÃ¡s)
        const periodoAnterior = {};
        for (let i = 6; i < 12; i++) {
          const mes = (mesAtual - i + 12) % 12;
          const ano = mesAtual - i < 0 ? anoAtual - 1 : anoAtual;
          const key = `${ano}-${String(mes + 1).padStart(2, '0')}`;
          periodoAnterior[key] = { mes, ano, count: 0 };
        }
        
        // Conta os casos
        data.forEach(row => {
          const rawData = row[dataCol];
          if (!rawData) return;
          
          const date = parseDateCell(rawData);
          if (!date || isNaN(date.getTime())) return;
          
          const rowMes = date.getMonth();
          const rowAno = date.getFullYear();
          const key = `${rowAno}-${String(rowMes + 1).padStart(2, '0')}`;
          
          if (ultimos6Meses[key]) {
            ultimos6Meses[key].count++;
          } else if (periodoAnterior[key]) {
            periodoAnterior[key].count++;
          }
        });
        
        // Prepara dados para o grÃ¡fico
        const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        const labels = [];
        const dadosUltimos6 = [];
        const dadosAnterior = [];
        
        // Ordena por data (mais antigo primeiro)
        const sortedUltimos6 = Object.entries(ultimos6Meses)
          .sort((a, b) => a[0].localeCompare(b[0]));
        const sortedAnterior = Object.entries(periodoAnterior)
          .sort((a, b) => a[0].localeCompare(b[0]));
        
        // Cria um mapa do perÃ­odo anterior por mÃªs
        const anteriorPorMes = {};
        sortedAnterior.forEach(([key, { mes, count }]) => {
          anteriorPorMes[mes] = count;
        });
        
        sortedUltimos6.forEach(([key, { mes, count }]) => {
          labels.push(meses[mes]);
          dadosUltimos6.push(count);
          dadosAnterior.push(anteriorPorMes[mes] || 0);
        });
        
        if (labels.length > 0) {
          // Calcula os perÃ­odos reais para as legendas dinÃ¢micas
          const primeiroMesUltimos6 = sortedUltimos6[0][1].mes;
          const ultimoMesUltimos6 = sortedUltimos6[sortedUltimos6.length - 1][1].mes;
          const primeiroAnoUltimos6 = sortedUltimos6[0][1].ano;
          const ultimoAnoUltimos6 = sortedUltimos6[sortedUltimos6.length - 1][1].ano;
          
          const primeiroMesAnterior = sortedAnterior[0][1].mes;
          const ultimoMesAnterior = sortedAnterior[sortedAnterior.length - 1][1].mes;
          const primeiroAnoAnterior = sortedAnterior[0][1].ano;
          const ultimoAnoAnterior = sortedAnterior[sortedAnterior.length - 1][1].ano;
          
          // Cria labels dinÃ¢micas
          let labelUltimos6 = '';
          let labelAnterior = '';
          
          // Se os meses estÃ£o no mesmo ano
          if (primeiroAnoUltimos6 === ultimoAnoUltimos6) {
            labelUltimos6 = `${meses[primeiroMesUltimos6]}-${meses[ultimoMesUltimos6]} ${ultimoAnoUltimos6}`;
          } else {
            labelUltimos6 = `${meses[primeiroMesUltimos6]} ${primeiroAnoUltimos6} - ${meses[ultimoMesUltimos6]} ${ultimoAnoUltimos6}`;
          }
          
          if (primeiroAnoAnterior === ultimoAnoAnterior) {
            labelAnterior = `${meses[primeiroMesAnterior]}-${meses[ultimoMesAnterior]} ${ultimoAnoAnterior}`;
          } else {
            labelAnterior = `${meses[primeiroMesAnterior]} ${primeiroAnoAnterior} - ${meses[ultimoMesAnterior]} ${ultimoAnoAnterior}`;
          }
          
          renderComparativeLineChart('chartComparativoTemporal', labels, dadosUltimos6, dadosAnterior, labelUltimos6, labelAnterior);
        }
      }
      
      // GrÃ¡fico: TendÃªncia Anual (ComparaÃ§Ã£o Ano Atual vs Ano Anterior)
      if (columnNames.data || columnNames.dataNT) {
        const dataCol = columnNames.data || columnNames.dataNT;
        const agora = new Date();
        const anoAtual = agora.getFullYear();
        const anoAnterior = anoAtual - 1;
        
        const dadosAnoAtual = {};
        const dadosAnoAnterior = {};
        
        // Inicializa todos os meses
        for (let mes = 0; mes < 12; mes++) {
          dadosAnoAtual[mes] = 0;
          dadosAnoAnterior[mes] = 0;
        }
        
        // Conta os casos
        data.forEach(row => {
          const rawData = row[dataCol];
          if (!rawData) return;
          
          const date = parseDateCell(rawData);
          if (!date || isNaN(date.getTime())) return;
          
          const rowMes = date.getMonth();
          const rowAno = date.getFullYear();
          
          if (rowAno === anoAtual && dadosAnoAtual[rowMes] !== undefined) {
            dadosAnoAtual[rowMes]++;
          } else if (rowAno === anoAnterior && dadosAnoAnterior[rowMes] !== undefined) {
            dadosAnoAnterior[rowMes]++;
          }
        });
        
        // Prepara dados para o grÃ¡fico
        const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        const labels = meses;
        const dadosAtual = Object.values(dadosAnoAtual);
        const dadosAnterior = Object.values(dadosAnoAnterior);
        
        renderComparativeLineChart('chartTendenciaAnual', labels, dadosAtual, dadosAnterior, `Ano ${anoAtual}`, `Ano ${anoAnterior}`);
      }
    }
    
    // FunÃ§Ã£o para aplicar filtros baseado no clique do grÃ¡fico
    function aplicarFiltroDoGrafico(tipoGrafico, valor) {
      console.log('[aplicarFiltroDoGrafico] Chamado com:', tipoGrafico, valor);
      
      // Limpa filtros anteriores relacionados
      const filtrosRelacionados = {
        'chartTipoViolencia': ['tipoViolencia'],
        'chartRegiao': ['regiao'],
        'chartEscola': ['escola'],
        'chartIdade': ['idade'],
        'chartGenero': ['genero'],
        'chartRaca': ['raca'],
        'chartEncaminhamento': ['encaminhamento'],
        'chartAutor': ['profissionalAutor', 'estudanteAutor'],
        'chartOcorreuEscola': ['ocorreuEscola'],
        'chartTemporal': ['data'],
        'chartComparativoTemporal': ['data'],
        'chartTendenciaAnual': ['data']
      };
      
      // Limpa checkboxes relacionados
      if (filtrosRelacionados[tipoGrafico]) {
        filtrosRelacionados[tipoGrafico].forEach(filtro => {
          const checkboxes = document.querySelectorAll(`input[data-filter="${filtro}"]`);
          checkboxes.forEach(cb => cb.checked = false);
          // SÃ³ atualiza badge se existir
          const badge = document.getElementById(`badge-${filtro}`);
          if (badge) {
            updateBadge(filtro);
          }
        });
      }
      
      // Limpa filtros de select tambÃ©m
      if (tipoGrafico === 'chartAutor') {
        const filterProf = document.getElementById('filterProfissionalAutor');
        const filterEst = document.getElementById('filterEstudanteAutor');
        if (filterProf) filterProf.value = '';
        if (filterEst) filterEst.value = '';
      }
      if (tipoGrafico === 'chartOcorreuEscola') {
        const filterOcorreu = document.getElementById('filterOcorreuEscola');
        if (filterOcorreu) filterOcorreu.value = '';
      }
      if (tipoGrafico === 'chartIdade') {
        const filterIdadeMin = document.getElementById('filterIdadeMin');
        const filterIdadeMax = document.getElementById('filterIdadeMax');
        if (filterIdadeMin) filterIdadeMin.value = '';
        if (filterIdadeMax) filterIdadeMax.value = '';
      }
      if (tipoGrafico === 'chartTemporal' || tipoGrafico === 'chartComparativoTemporal' || tipoGrafico === 'chartTendenciaAnual') {
        const filterDataInicio = document.getElementById('filterDataInicio');
        const filterDataFim = document.getElementById('filterDataFim');
        if (filterDataInicio) filterDataInicio.value = '';
        if (filterDataFim) filterDataFim.value = '';
      }
      
      // Normaliza o valor para comparaÃ§Ã£o
      const valorNormalizado = normalizeText(valor);
      
      // Aplica filtro especÃ­fico baseado no tipo de grÃ¡fico
      switch(tipoGrafico) {
        case 'chartTipoViolencia':
          // Marca checkbox do tipo de violÃªncia (usa data-filter e data-value com normalizaÃ§Ã£o)
          const tipoCheckboxes = document.querySelectorAll(`input[data-filter="tipoViolencia"]`);
          tipoCheckboxes.forEach(cb => {
            const cbValueNorm = normalizeText(cb.dataset.value || '');
            if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
              cb.checked = true;
            }
          });
          updateBadge('tipoViolencia');
          break;
          
        case 'chartRegiao':
          const regiaoCheckboxes = document.querySelectorAll(`input[data-filter="regiao"]`);
          regiaoCheckboxes.forEach(cb => {
            const cbValueNorm = normalizeText(cb.dataset.value || '');
            if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
              cb.checked = true;
            }
          });
          updateBadge('regiao');
          break;
          
        case 'chartEscola':
          const escolaCheckboxes = document.querySelectorAll(`input[data-filter="escola"]`);
          escolaCheckboxes.forEach(cb => {
            const cbValueNorm = normalizeText(cb.dataset.value || '');
            if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
              cb.checked = true;
            }
          });
          updateBadge('escola');
          break;
          
        case 'chartGenero':
          // Para gÃªnero, precisa mapear valores do grÃ¡fico para valores dos checkboxes
          let generoValor = valor;
          if (valor === 'Masculino' || valor === 'M') generoValor = 'M';
          if (valor === 'Feminino' || valor === 'F') generoValor = 'F';
          
          const generoCheckboxes = document.querySelectorAll(`input[data-filter="genero"]`);
          generoCheckboxes.forEach(cb => {
            const cbValue = cb.dataset.value || '';
            if (cbValue.toUpperCase() === generoValor.toUpperCase() || cbValue === valor) {
              cb.checked = true;
            }
          });
          updateBadge('genero');
          break;
          
        case 'chartRaca':
          const racaCheckboxes = document.querySelectorAll(`input[data-filter="raca"]`);
          racaCheckboxes.forEach(cb => {
            const cbValueNorm = normalizeText(cb.dataset.value || '');
            if (cbValueNorm === valorNormalizado || cb.dataset.value === valor) {
              cb.checked = true;
            }
          });
          updateBadge('raca');
          break;
          
        case 'chartEncaminhamento':
          // Encaminhamento usa data-group e data-value nos checkboxes individuais
          // O grÃ¡fico mostra valores originais (mapaNormalizado), mas precisa encontrar checkboxes
          // Primeiro desmarca todos os checkboxes de encaminhamento
          const allEncCheckboxes = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]');
          allEncCheckboxes.forEach(cb => cb.checked = false);
          
          // Normaliza o valor clicado para comparaÃ§Ã£o
          const valorNorm = normalizeText(valor);
          const valorLower = valor.toLowerCase().trim();
          
          // Procura checkboxes que correspondem EXATAMENTE ao valor clicado
          // O valor do grÃ¡fico Ã© o valor original (ex: "CT", "CRAS", etc.)
          // Prioriza correspondÃªncia exata para evitar falsos positivos
          let encontrado = false;
          
          // Primeira passagem: busca exata (mais precisa)
          allEncCheckboxes.forEach(cb => {
            const cbValue = (cb.dataset.value || '').trim();
            if (!cbValue) return;
            
            const cbValueNorm = normalizeText(cbValue);
            const cbValueLower = cbValue.toLowerCase().trim();
            
            // Compara valores exatos primeiro (mais preciso)
            if (cbValue === valor || 
                cbValueNorm === valorNorm ||
                cbValueLower === valorLower) {
              cb.checked = true;
              encontrado = true;
            }
          });
          
          // Segunda passagem: busca parcial apenas se nÃ£o encontrou exato
          // Mas apenas se o valor Ã© uma substring completa (nÃ£o apenas parte de uma palavra)
          if (!encontrado) {
            allEncCheckboxes.forEach(cb => {
              const cbValue = (cb.dataset.value || '').trim();
              if (!cbValue) return;
              
              const cbValueNorm = normalizeText(cbValue);
              
              // Busca parcial: verifica se o valor normalizado corresponde exatamente
              // ou se um Ã© substring completa do outro (evita falsos positivos)
              // SÃ³ marca se for correspondÃªncia exata ou substring no inÃ­cio/fim com espaÃ§o ou barra
              const valorIsSubstring = cbValueNorm === valorNorm || 
                                      (cbValueNorm.includes(valorNorm) && 
                                       (cbValueNorm.startsWith(valorNorm + ' ') || 
                                        cbValueNorm.endsWith(' ' + valorNorm) ||
                                        cbValueNorm.startsWith(valorNorm + '/') ||
                                        cbValueNorm.endsWith('/' + valorNorm) ||
                                        cbValueNorm.startsWith(valorNorm + ',') ||
                                        cbValueNorm.endsWith(',' + valorNorm)));
              const cbIsSubstring = valorNorm === cbValueNorm || 
                                    (valorNorm.includes(cbValueNorm) && 
                                     (valorNorm.startsWith(cbValueNorm + ' ') || 
                                      valorNorm.endsWith(' ' + cbValueNorm) ||
                                      valorNorm.startsWith(cbValueNorm + '/') ||
                                      valorNorm.endsWith('/' + cbValueNorm) ||
                                      valorNorm.startsWith(cbValueNorm + ',') ||
                                      valorNorm.endsWith(',' + cbValueNorm)));
              
              if (valorIsSubstring || cbIsSubstring) {
                cb.checked = true;
                encontrado = true;
              }
            });
          }
          
          // Log para debug se nÃ£o encontrou
          if (!encontrado) {
            console.warn('[Filtro Encaminhamento] NÃ£o encontrou checkbox para:', valor);
            const valoresDisponiveis = Array.from(allEncCheckboxes).slice(0, 10).map(cb => cb.dataset.value);
            console.log('[Filtro Encaminhamento] Primeiros 10 checkboxes disponÃ­veis:', valoresDisponiveis);
          }
          
          // Atualiza badge e grupos
          const encSelected = document.querySelectorAll('#filterEncaminhamentoContainer input[data-group]:checked');
          const encBadge = document.getElementById('badge-encaminhamento-total');
          if (encBadge) {
            if (encSelected.length > 0) {
              encBadge.textContent = encSelected.length;
              encBadge.classList.remove('hidden');
            } else {
              encBadge.classList.add('hidden');
            }
          }
          
          // Atualiza grupos que tÃªm checkboxes marcados
          const grupos = new Set();
          encSelected.forEach(cb => {
            const groupId = cb.closest('.encaminhamento-group')?.dataset.group;
            if (groupId) grupos.add(groupId);
          });
          grupos.forEach(groupId => {
            const groupCheckbox = document.getElementById(`group-${groupId}`);
            if (groupCheckbox) {
              const groupCheckboxes = document.querySelectorAll(`.encaminhamento-group[data-group="${groupId}"] input[data-group]`);
              const groupChecked = document.querySelectorAll(`.encaminhamento-group[data-group="${groupId}"] input[data-group]:checked`);
              groupCheckbox.checked = groupChecked.length > 0;
              groupCheckbox.indeterminate = groupChecked.length > 0 && groupChecked.length < groupCheckboxes.length;
            }
          });
          break;
          
        case 'chartAutor':
          console.log('[Filtro Autor] Aplicando filtro para:', valor);
          const filterProf = document.getElementById('filterProfissionalAutor');
          const filterEst = document.getElementById('filterEstudanteAutor');
          // Limpa ambos primeiro
          if (filterProf) filterProf.value = '';
          if (filterEst) filterEst.value = '';
          // Depois define conforme o valor clicado
          if (valor === 'Profissional da Escola' && filterProf) {
            filterProf.value = 'S';
            console.log('[Filtro Autor] Definido: profissionalAutor = S');
          } else if (valor === 'Estudante' && filterEst) {
            filterEst.value = 'S';
            console.log('[Filtro Autor] Definido: estudanteAutor = S');
          } else if (valor === 'Outro Agente (Fora da InstituiÃ§Ã£o)') {
            if (filterProf) filterProf.value = 'N';
            if (filterEst) filterEst.value = 'N';
            console.log('[Filtro Autor] Definido: profissionalAutor = N, estudanteAutor = N');
          } else {
            console.warn('[Filtro Autor] Valor nÃ£o reconhecido:', valor);
          }
          break;
          
        case 'chartOcorreuEscola':
          console.log('[Filtro OcorreuEscola] Aplicando filtro para:', valor);
          const filterOcorreu = document.getElementById('filterOcorreuEscola');
          if (filterOcorreu) {
            // Limpa primeiro
            filterOcorreu.value = '';
            // Depois define conforme o valor clicado
            if (valor === 'Sim') {
              filterOcorreu.value = 'S';
              console.log('[Filtro OcorreuEscola] Definido: ocorreu = S');
            } else if (valor === 'NÃ£o') {
              filterOcorreu.value = 'N';
              console.log('[Filtro OcorreuEscola] Definido: ocorreu = N');
            } else {
              console.warn('[Filtro OcorreuEscola] Valor nÃ£o reconhecido:', valor);
            }
          } else {
            console.error('[Filtro OcorreuEscola] Elemento filterOcorreuEscola nÃ£o encontrado');
          }
          break;
          
        case 'chartIdade':
          // Para idade, precisa extrair a faixa etÃ¡ria (formato: "0-5 anos", "6-10 anos", "18+ anos")
          const idadeMatch = valor.match(/(\d+)-(\d+)/);
          if (idadeMatch) {
            const filterIdadeMin = document.getElementById('filterIdadeMin');
            const filterIdadeMax = document.getElementById('filterIdadeMax');
            if (filterIdadeMin) filterIdadeMin.value = idadeMatch[1];
            if (filterIdadeMax) filterIdadeMax.value = idadeMatch[2];
          } else if (valor.includes('18+')) {
            // Para 18+ anos, define mÃ­nimo como 18 e mÃ¡ximo vazio
            const filterIdadeMin = document.getElementById('filterIdadeMin');
            const filterIdadeMax = document.getElementById('filterIdadeMax');
            if (filterIdadeMin) filterIdadeMin.value = '18';
            if (filterIdadeMax) filterIdadeMax.value = '';
          }
          break;
          
        case 'chartTemporal':
        case 'chartComparativoTemporal':
        case 'chartTendenciaAnual':
          // Para grÃ¡ficos temporais, filtra por mÃªs (formato: "Jan", "Fev", etc.)
          const meses = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
          const mesNome = valor.trim();
          const mesNum = meses.indexOf(mesNome) + 1;
          
          if (mesNum > 0) {
            const agora = new Date();
            const anoAtual = agora.getFullYear();
            
            // Para grÃ¡ficos comparativos, filtra pelo mÃªs no ano atual
            // Define data de inÃ­cio como primeiro dia do mÃªs
            const dataInicio = `${anoAtual}-${String(mesNum).padStart(2, '0')}-01`;
            // Define data de fim como Ãºltimo dia do mÃªs
            const ultimoDia = new Date(anoAtual, mesNum, 0).getDate();
            const dataFim = `${anoAtual}-${String(mesNum).padStart(2, '0')}-${String(ultimoDia).padStart(2, '0')}`;
            
            const filterDataInicio = document.getElementById('filterDataInicio');
            const filterDataFim = document.getElementById('filterDataFim');
            if (filterDataInicio) filterDataInicio.value = dataInicio;
            if (filterDataFim) filterDataFim.value = dataFim;
            console.log(`[Filtro ${tipoGrafico}] Aplicando filtro para mÃªs ${mesNome}:`, dataInicio, 'atÃ©', dataFim);
          } else {
            console.error(`[Filtro ${tipoGrafico}] MÃªs nÃ£o encontrado:`, mesNome);
          }
          break;
      }
      
      // Aplica filtros e rola atÃ© a tabela
      console.log('[aplicarFiltroDoGrafico] Aplicando filtros apÃ³s configurar:', tipoGrafico, 'valor:', valor);
      applyFilters();
      
      // Aguarda um pouco para garantir que os filtros foram aplicados e a tabela foi atualizada
      setTimeout(() => {
        const tableContainer = document.getElementById('tableContainer');
        if (tableContainer) {
          tableContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        const count = filteredData ? filteredData.length : 0;
        console.log('[aplicarFiltroDoGrafico] âœ… Filtros aplicados! Registros filtrados:', count);
        if (count === 0) {
          console.warn('[aplicarFiltroDoGrafico] âš ï¸ Nenhum registro encontrado apÃ³s filtrar por:', valor);
        }
      }, 150);
    }
    
    function renderPieChart(canvasId, data, colors) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      
      const labels = data.map(([k]) => k);
      const valores = data.map(([, v]) => v);
      
      charts[canvasId] = new Chart(canvas, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: valores,
            backgroundColor: colors,
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onClick: (event, elements) => {
            console.log('[GrÃ¡fico Pizza] Clique detectado no grÃ¡fico:', canvasId);
            console.log('[GrÃ¡fico Pizza] Elements recebidos:', elements);
            if (elements && elements.length > 0) {
              const index = elements[0].index;
              const label = labels[index];
              console.log('[GrÃ¡fico Pizza] Label clicado:', label, 'Index:', index);
              aplicarFiltroDoGrafico(canvasId, label);
            } else {
              console.warn('[GrÃ¡fico Pizza] Nenhum elemento encontrado no clique. Tentando mÃ©todo alternativo...');
              // MÃ©todo alternativo: tenta detectar clique usando getElementsAtEventForMode
              const chart = charts[canvasId];
              if (chart) {
                const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (points && points.length > 0) {
                  const point = points[0];
                  const label = labels[point.index];
                  console.log('[GrÃ¡fico Pizza] Label encontrado via mÃ©todo alternativo:', label);
                  aplicarFiltroDoGrafico(canvasId, label);
                } else {
                  console.error('[GrÃ¡fico Pizza] NÃ£o foi possÃ­vel detectar o elemento clicado');
                }
              }
            }
          },
          onHover: (event, elements) => {
            // Muda cursor para pointer quando hover
            if (event.native && event.native.target) {
              event.native.target.style.cursor = elements && elements.length > 0 ? 'pointer' : 'default';
            }
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 10,
                font: { size: 11 }
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((value / total) * 100).toFixed(1);
                  return `${label}: ${value} caso${value !== 1 ? 's' : ''} (${percentage}%)`;
                },
                footer: function(context) {
                  const total = context.reduce((sum, item) => sum + (item.parsed || 0), 0);
                  return 'Total: ' + total + ' caso' + (total !== 1 ? 's' : '');
                }
              }
            }
          }
        }
      });
    }
    
    function renderBarChart(canvasId, data, colors) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      
      const labels = data.map(([k]) => k);
      const valores = data.map(([, v]) => v);
      
      charts[canvasId] = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade',
            data: valores,
            backgroundColor: colors[0],
            borderColor: colors[0].replace('0.8', '1'),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const label = labels[index];
              aplicarFiltroDoGrafico(canvasId, label);
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 10,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  const valor = context.parsed.y;
                  return `${valor} caso${valor !== 1 ? 's' : ''}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }
    
    function renderHorizontalBarChartGrouped(canvasId, data, colors) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      
      const labels = data.map(([k]) => k);
      const valores = data.map(([, v]) => v);
      
      charts[canvasId] = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Casos',
            data: valores,
            backgroundColor: colors,
            borderColor: colors.map(c => c.replace('0.8', '1')),
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 1000,
            easing: 'easeOutQuart'
          },
          onClick: (event, elements) => {
            console.log('[GrÃ¡fico Encaminhamento] Clique detectado no grÃ¡fico:', canvasId);
            console.log('[GrÃ¡fico Encaminhamento] Elements recebidos:', elements);
            if (elements && elements.length > 0) {
              const index = elements[0].index;
              const label = labels[index];
              console.log('[GrÃ¡fico Encaminhamento] Label clicado:', label, 'Index:', index);
              aplicarFiltroDoGrafico(canvasId, label);
            } else {
              console.warn('[GrÃ¡fico Encaminhamento] Nenhum elemento encontrado no clique');
            }
          },
          onHover: (event, elements) => {
            if (event.native && event.native.target) {
              event.native.target.style.cursor = elements && elements.length > 0 ? 'pointer' : 'default';
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              callbacks: {
                title: function(context) {
                  return context[0].label;
                },
                label: function(context) {
                  const valor = context.parsed.x;
                  return `${valor} caso${valor !== 1 ? 's' : ''}`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { 
                stepSize: 1,
                font: { size: 11 }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)',
                drawBorder: false
              }
            },
            y: {
              ticks: { 
                font: { size: 11 },
                padding: 8
              },
              grid: {
                display: false
              }
            }
          }
        }
      });
    }
    
    function renderHorizontalBarChart(canvasId, data, colors) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      
      const labels = data.map(([k]) => k);
      const valores = data.map(([, v]) => v);
      
      // Cores alternadas para melhor visualizaÃ§Ã£o
      const backgroundColors = valores.map((_, index) => {
        return colors[index % colors.length];
      });
      
      charts[canvasId] = new Chart(canvas, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Quantidade',
            data: valores,
            backgroundColor: backgroundColors,
            borderColor: backgroundColors.map(c => c.replace('0.8', '1')),
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y', // Barras horizontais
          responsive: true,
          maintainAspectRatio: false,
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const index = elements[0].index;
              const label = labels[index];
              aplicarFiltroDoGrafico(canvasId, label);
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Casos: ${context.parsed.x}`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }
    
    // Renderiza grÃ¡fico de barras agrupadas (para correlaÃ§Ãµes)
    function renderGroupedBarChart(canvasId, labels, datasets) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
        delete charts[canvasId];
      }
      
      const ctx = canvas.getContext('2d');
      charts[canvasId] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                padding: 15,
                font: { size: 12, weight: 'bold' }
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + ' casos';
                }
              }
            }
          },
          scales: {
            x: {
              stacked: false,
              ticks: {
                font: { size: 11 },
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              }
            },
            y: {
              stacked: false,
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: { size: 11 }
              },
              title: {
                display: true,
                text: 'Quantidade de Casos',
                font: { size: 12, weight: 'bold' }
              }
            }
          },
          onClick: (event, elements) => {
            if (elements.length > 0) {
              const element = elements[0];
              const datasetIndex = element.datasetIndex;
              const index = element.index;
              const label = labels[index];
              const datasetLabel = datasets[datasetIndex].label;
              aplicarFiltroDoGrafico('chartCorrelacaoTipoIdade', `${label} - ${datasetLabel}`);
            }
          }
        }
      });
    }
    
    // Renderiza grÃ¡fico comparativo de linhas (para anÃ¡lises temporais)
    function renderComparativeLineChart(canvasId, labels, data1, data2, label1 = 'PerÃ­odo 1', label2 = 'PerÃ­odo 2') {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
        delete charts[canvasId];
      }
      
      const ctx = canvas.getContext('2d');
      charts[canvasId] = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: label1,
              data: data1,
              borderColor: 'rgba(59, 130, 246, 1)',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: 'rgba(59, 130, 246, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            },
            {
              label: label2,
              data: data2,
              borderColor: 'rgba(239, 68, 68, 1)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointRadius: 5,
              pointHoverRadius: 7,
              pointBackgroundColor: 'rgba(239, 68, 68, 1)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              position: 'top',
              labels: {
                padding: 15,
                font: { size: 13, weight: 'bold' },
                usePointStyle: true,
                pointStyle: 'circle',
                boxWidth: 12,
                boxHeight: 12
              },
              onClick: (e, legendItem, legend) => {
                // Permite clicar na legenda para mostrar/ocultar datasets
                const index = legendItem.datasetIndex;
                const chart = legend.chart;
                const meta = chart.getDatasetMeta(index);
                meta.hidden = meta.hidden === null ? !chart.data.datasets[index].hidden : null;
                chart.update();
              }
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 12,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              callbacks: {
                title: function(context) {
                  return 'MÃªs: ' + context[0].label;
                },
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + ' caso' + (context.parsed.y !== 1 ? 's' : '');
                },
                footer: function(context) {
                  const total = context.reduce((sum, item) => sum + item.parsed.y, 0);
                  return 'Total: ' + total + ' caso' + (total !== 1 ? 's' : '');
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                font: { size: 11 },
                maxRotation: 45,
                minRotation: 45
              },
              grid: {
                display: false
              }
            },
            y: {
              beginAtZero: true,
              ticks: {
                stepSize: 1,
                font: { size: 11 }
              },
              title: {
                display: true,
                text: 'Quantidade de Casos',
                font: { size: 12, weight: 'bold' }
              }
            }
          },
          onClick: (event, elements) => {
            console.log('[GrÃ¡fico Comparativo] Clique detectado no grÃ¡fico:', canvasId);
            console.log('[GrÃ¡fico Comparativo] Elements recebidos:', elements);
            
            if (elements && elements.length > 0) {
              const element = elements[0];
              const index = element.index;
              const label = labels[index];
              console.log('[GrÃ¡fico Comparativo] Label clicado:', label, 'Index:', index);
              aplicarFiltroDoGrafico(canvasId, label);
            } else {
              console.warn('[GrÃ¡fico Comparativo] Nenhum elemento encontrado no clique. Tentando mÃ©todo alternativo...');
              // MÃ©todo alternativo para grÃ¡fico de linha comparativo
              const chart = charts[canvasId];
              if (chart) {
                const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (points && points.length > 0) {
                  const point = points[0];
                  const label = labels[point.index];
                  console.log('[GrÃ¡fico Comparativo] Label encontrado via mÃ©todo alternativo:', label);
                  aplicarFiltroDoGrafico(canvasId, label);
                } else {
                  console.error('[GrÃ¡fico Comparativo] NÃ£o foi possÃ­vel detectar o elemento clicado');
                }
              }
            }
          },
          onHover: (event, elements) => {
            // Muda cursor para pointer quando hover sobre pontos
            if (event.native && event.native.target) {
              const chart = charts[canvasId];
              if (chart) {
                const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                event.native.target.style.cursor = points && points.length > 0 ? 'pointer' : 'default';
              }
            }
          }
        }
      });
    }
    
    function renderLineChart(canvasId, labels, valores) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      
      // Destroi grÃ¡fico anterior se existir
      if (charts[canvasId]) {
        charts[canvasId].destroy();
      }
      
      charts[canvasId] = new Chart(canvas, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Casos por MÃªs',
            data: valores,
            borderColor: 'rgba(59, 130, 246, 1)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          onClick: (event, elements) => {
            console.log('[GrÃ¡fico Linha] Clique detectado no grÃ¡fico:', canvasId);
            console.log('[GrÃ¡fico Linha] Elements recebidos:', elements);
            if (elements && elements.length > 0) {
              const index = elements[0].index;
              const label = labels[index];
              console.log('[GrÃ¡fico Linha] Label clicado:', label, 'Index:', index);
              aplicarFiltroDoGrafico(canvasId, label);
            } else {
              console.warn('[GrÃ¡fico Linha] Nenhum elemento encontrado no clique. Tentando mÃ©todo alternativo...');
              // MÃ©todo alternativo para grÃ¡fico de linha
              const chart = charts[canvasId];
              if (chart) {
                const points = chart.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                if (points && points.length > 0) {
                  const point = points[0];
                  const label = labels[point.index];
                  console.log('[GrÃ¡fico Linha] Label encontrado via mÃ©todo alternativo:', label);
                  aplicarFiltroDoGrafico(canvasId, label);
                } else {
                  console.error('[GrÃ¡fico Linha] NÃ£o foi possÃ­vel detectar o elemento clicado');
                }
              }
            }
          },
          onHover: (event, elements) => {
            // Muda cursor para pointer quando hover
            if (event.native && event.native.target) {
              event.native.target.style.cursor = elements && elements.length > 0 ? 'pointer' : 'default';
            }
          },
          plugins: {
            legend: { 
              display: true,
              labels: {
                font: { size: 12, weight: 'bold' },
                usePointStyle: true
              }
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              padding: 10,
              titleFont: { size: 13, weight: 'bold' },
              bodyFont: { size: 12 },
              callbacks: {
                title: function(context) {
                  return 'MÃªs: ' + context[0].label;
                },
                label: function(context) {
                  const valor = context.parsed.y;
                  return `${context.dataset.label}: ${valor} caso${valor !== 1 ? 's' : ''}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { stepSize: 1 }
            }
          }
        }
      });
    }

    function renderTable(data) {
      const tbody = document.getElementById('tableBody');
      const recordCount = document.getElementById('recordCount');
      const noResults = document.getElementById('noResultsMessage');
      
      tbody.innerHTML = '';
      recordCount.textContent = data.length;
      
      if (data.length === 0) {
        noResults.classList.remove('hidden');
        document.getElementById('paginacao').style.display = 'none';
        return;
      } else {
        noResults.classList.add('hidden');
        document.getElementById('paginacao').style.display = 'flex';
      }
      
      // Calcular total de pÃ¡ginas
      totalPaginas = Math.ceil(data.length / registrosPorPagina);
      
      // Garantir que a pÃ¡gina atual seja vÃ¡lida
      if (paginaAtual > totalPaginas) {
        paginaAtual = totalPaginas;
      }
      if (paginaAtual < 1) {
        paginaAtual = 1;
      }
      
      // Calcular Ã­ndices para slice
      const inicio = (paginaAtual - 1) * registrosPorPagina;
      const fim = inicio + registrosPorPagina;
      
      // Pegar apenas os registros da pÃ¡gina atual
      const registrosPagina = data.slice(inicio, fim);
      
      registrosPagina.forEach((row, index) => {
        const tr = document.createElement('tr');
        // Adicionar classes para zebra stripes e hover effect modernos
        const zebraClass = (index % 2 === 0) ? 'bg-white' : 'bg-gray-50/50';
        tr.className = 'record-row hover:bg-gradient-to-r hover:from-blue-50 hover:to-indigo-50 cursor-pointer transition-all duration-200 hover:shadow-sm border-l-4 border-l-transparent hover:border-l-blue-500 ' + zebraClass;
        
        const nome = columnNames.crianca ? (row[columnNames.crianca] || 'NÃ£o informado') : 'NÃ£o informado';
        const idade = columnNames.idade ? (row[columnNames.idade] || 'NÃ£o informado') : 'NÃ£o informado';
        const dataViol = columnNames.data ? formatDate(row[columnNames.data]) : 'NÃ£o informado';
        const tipo = columnNames.tipo ? (row[columnNames.tipo] || 'NÃ£o informado') : 'NÃ£o informado';
        const escolaOriginal = columnNames.escola ? (row[columnNames.escola] || '') : '';
        const escola = escolaOriginal ? getDisplayName(escolaOriginal) : 'NÃ£o informado';
        const regiao = columnNames.regiao ? (row[columnNames.regiao] || 'NÃ£o informado') : 'NÃ£o informado';
        const encaminhamento = columnNames.encaminhamento ? (row[columnNames.encaminhamento] || 'NÃ£o informado') : 'NÃ£o informado';
        
        // Combinar colunas U (ocorreu na escola 1.1) e Q (violÃªncia identificada pela escola ocorrida na escola)
        let ocorreuNaEscola = '';
        const ocorreuU = columnNames.ocorreu ? (row[columnNames.ocorreu] || '') : '';
        const ocorreuQ = columnNames.violenciaEscolaOcorreu ? (row[columnNames.violenciaEscolaOcorreu] || '') : '';
        
        if (checkSN(ocorreuU, 'S') || checkSN(ocorreuQ, 'S')) {
          ocorreuNaEscola = 'Sim';
        } else if (checkSN(ocorreuU, 'N') || checkSN(ocorreuQ, 'N')) {
          ocorreuNaEscola = 'NÃ£o';
        } else if (ocorreuU || ocorreuQ) {
          ocorreuNaEscola = ocorreuU || ocorreuQ;
        } else {
          ocorreuNaEscola = 'NÃ£o informado';
        }
        
        const campos = [nome, idade, dataViol, tipo, escola, regiao, encaminhamento, ocorreuNaEscola];
        
        campos.forEach(valor => {
          const td = document.createElement('td');
          td.className = 'px-4 py-3.5 align-top text-gray-700 text-sm font-medium';
          
          // Estilizar "NÃ£o informado" com cor diferente e itÃ¡lico
          if (valor === 'NÃ£o informado') {
            td.className = 'px-4 py-3.5 align-top text-gray-400 text-sm italic';
          }
          
          td.textContent = valor;
          tr.appendChild(td);
        });
        
        tr.addEventListener('click', () => openRecordModal(row));
        tbody.appendChild(tr);
      });
      
      // Atualizar controles de paginaÃ§Ã£o
      updatePaginationControls();
    }

    function openRecordModal(record) {
      const modal = document.getElementById('recordModal');
      const content = document.getElementById('modalContent');
      content.innerHTML = '';
      
      const keys = Object.keys(record);
      
      keys.forEach(key => {
        const value = record[key];
        const rowDiv = document.createElement('div');
        rowDiv.className = 'flex justify-between border-b py-2';
        
        const label = document.createElement('div');
        label.className = 'font-medium text-gray-700 pr-4';
        label.textContent = key;
        
        const valDiv = document.createElement('div');
        valDiv.className = 'text-slate-600 flex-1 text-right';
        
        // Formata data se for a coluna de data
        let displayValue;
        if (key === columnNames.data) {
          displayValue = formatDate(value) || 'NÃ£o informado';
        } else if (value === undefined || value === null || value === '') {
          displayValue = 'NÃ£o informado';
        } else {
          displayValue = value;
        }
        
        // Destaca o campo de detalhamento PCD/transtorno se for essa coluna
        if (key === columnNames.detalhePCD) {
          if (!value || String(value).trim() === '') {
            displayValue = 'NÃ£o informado';
            valDiv.className = 'text-gray-400 flex-1 text-right italic';
          } else {
            // Adiciona Ã­cone e destaque visual
            label.innerHTML = 'â™¿ ' + key;
            valDiv.className = 'text-blue-700 flex-1 text-right font-semibold';
          }
        } else if (displayValue === 'NÃ£o informado') {
          valDiv.className = 'text-gray-400 flex-1 text-right italic';
        }
        
        valDiv.textContent = displayValue;
        
        rowDiv.appendChild(label);
        rowDiv.appendChild(valDiv);
        content.appendChild(rowDiv);
      });
      
      modal.classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('recordModal').classList.add('hidden');
    }

    // ==============================
    // FunÃ§Ãµes de PaginaÃ§Ã£o
    // ==============================
    function updatePaginationControls() {
      const info = document.getElementById('paginacaoInfo');
      const btnPrimeira = document.getElementById('btnPrimeiraPagina');
      const btnAnterior = document.getElementById('btnPaginaAnterior');
      const btnProxima = document.getElementById('btnProximaPagina');
      const btnUltima = document.getElementById('btnUltimaPagina');
      
      info.textContent = paginaAtual + ' de ' + totalPaginas;
      
      // Desabilitar botÃµes conforme necessÃ¡rio
      btnPrimeira.disabled = (paginaAtual === 1);
      btnAnterior.disabled = (paginaAtual === 1);
      btnProxima.disabled = (paginaAtual === totalPaginas);
      btnUltima.disabled = (paginaAtual === totalPaginas);
    }
    
    function irParaPagina(novaPagina) {
      if (novaPagina >= 1 && novaPagina <= totalPaginas) {
        paginaAtual = novaPagina;
        renderTable(filteredData);
        // Scroll suave para a seÃ§Ã£o de resultados
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }
    
    function alterarRegistrosPorPagina() {
      const select = document.getElementById('registrosPorPaginaSelect');
      registrosPorPagina = parseInt(select.value, 10);
      paginaAtual = 1; // Voltar para primeira pÃ¡gina
      renderTable(filteredData);
    }

    // ========================================
    // VERIFICAR AUTENTICAÃ‡ÃƒO
    // ========================================
    function verificarAutenticacao() {
      const userRole = sessionStorage.getItem('userRole');
      const userEmail = sessionStorage.getItem('userEmail');
      
      // Se nÃ£o estiver autenticado, redireciona para login
      if (!userRole || !userEmail) {
        alert('Acesso negado! FaÃ§a login para acessar o sistema.');
        window.location.href = 'index.html';
        return;
      }

    // Ajusta visibilidade do menu para visualizador (somente painel)
    ajustarMenuPorRole(userRole);
    configurarLogoutVisualizador(userRole);
    }

    // ========================================
    // MENU MOBILE TOGGLE
    // ========================================
    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenuNav');
      const menuIcon = document.getElementById('menuIcon');
      mobileMenu.classList.toggle('show');
      menuIcon.style.transform = mobileMenu.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
    }
    
    // Fecha o menu ao redimensionar para desktop
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768) {
        const mobileMenu = document.getElementById('mobileMenuNav');
        const menuIcon = document.getElementById('menuIcon');
        if (mobileMenu && mobileMenu.classList.contains('show')) {
          mobileMenu.classList.remove('show');
          menuIcon.style.transform = 'rotate(0deg)';
        }
      }
    });

    // ========================================
    // VERIFICAR E MOSTRAR MENU ADMIN
    // ========================================
    function verificarMenuAdmin() {
      const userRole = sessionStorage.getItem('userRole');
      const menuAdmin = document.getElementById('menuAdmin');
      const btnSair = document.getElementById('btnSair');
      const menuAdminMobile = document.getElementById('menuAdminMobile');
      const btnSairMobile = document.getElementById('btnSairMobile');
      
      if (userRole === 'admin' || userRole === 'superuser') {
        if (menuAdmin) {
          menuAdmin.classList.remove('hidden');
        }
        if (btnSair) {
          btnSair.classList.remove('hidden');
        }
        if (menuAdminMobile) {
          menuAdminMobile.classList.remove('hidden');
        }
        if (btnSairMobile) {
          btnSairMobile.classList.remove('hidden');
        }
      }
      
      // Configura botÃ£o de sair para visualizador (desktop e mobile)
      configurarLogoutVisualizador(userRole);
    }

  // Esconde links de criaÃ§Ã£o/gestÃ£o para visualizadores
  function ajustarMenuPorRole(role) {
    if (role !== 'visualizador') return;
    const seletorLinksRestritos = [
      'a[href="registro-novo-caso.html"]',
      'a[href="gerenciar-casos.html"]',
      'a[href="gerenciar-usuarios.html"]'
    ].join(',');
    
    document.querySelectorAll(seletorLinksRestritos).forEach(el => {
      el.style.display = 'none';
    });
  }

  // Mostra botÃ£o de sair especÃ­fico para visualizador (desktop e mobile)
  function configurarLogoutVisualizador(role) {
    const btnLogoutMobile = document.getElementById('btnLogoutVisualizadorMobile');
    const btnLogoutDesktop = document.getElementById('btnSairVisualizadorDesktop');
    
    if (role === 'visualizador') {
      // Mostra botÃ£o no mobile
      if (btnLogoutMobile) {
        btnLogoutMobile.classList.remove('hidden');
        btnLogoutMobile.onclick = () => sair();
      }
      // Mostra botÃ£o no desktop
      if (btnLogoutDesktop) {
        btnLogoutDesktop.classList.remove('hidden');
      }
    } else {
      // Esconde botÃµes se nÃ£o for visualizador
      if (btnLogoutMobile) {
        btnLogoutMobile.classList.add('hidden');
      }
      if (btnLogoutDesktop) {
        btnLogoutDesktop.classList.add('hidden');
      }
    }
  }

    // ========================================
    // FECHAR MENU MOBILE AO CLICAR EM LINK
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuLinks = document.querySelectorAll('#mobileMenuNav a');
      mobileMenuLinks.forEach(link => {
        link.addEventListener('click', function() {
          const mobileMenu = document.getElementById('mobileMenuNav');
          const menuIcon = document.getElementById('menuIcon');
          if (mobileMenu && menuIcon) {
            mobileMenu.classList.remove('show');
            menuIcon.style.transform = 'rotate(0deg)';
          }
        });
      });
      
      verificarMenuAdmin();
    });

    // ========================================
    // FUNÃ‡ÃƒO SAIR
    // ========================================
    function sair() {
      if (confirm('Deseja realmente sair do sistema?')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }

    // Chama verificaÃ§Ãµes ao carregar
    verificarAutenticacao();
    verificarMenuAdmin();
  </script>
</body>
</html>
