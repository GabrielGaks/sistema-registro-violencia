<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registro de Casos - Viol√™ncia Escolar</title>
  
  <!-- Esconde conte√∫do IMEDIATAMENTE para evitar flash -->
  <style>
    html:not(.page-ready) {
      opacity: 0 !important;
      visibility: hidden !important;
    }
    html.page-ready {
      opacity: 1 !important;
      visibility: visible !important;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
  </style>
  
  <!-- TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Estilos Elegantes Compartilhados -->
  <link rel="stylesheet" href="assets/css/styles-elegant.css">
  
  <!-- Configura√ß√£o Centralizada -->
  <script src="config.js"></script>
  <script src="assets/js/utils/config-loader.js"></script>
  
  <!-- Sistema de Transi√ß√µes entre P√°ginas -->
  <script src="assets/js/utils/page-transitions.js"></script>
  <script>
    // Bloqueia acesso de visualizadores a esta p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      const role = sessionStorage.getItem('userRole');
      if (!role) {
        window.location.href = 'index.html';
        return;
      }
      if (role === 'visualizador') {
        alert('Acesso permitido apenas para leitura. Redirecionando para o painel.');
        window.location.href = 'painel-casos.html';
      }
    });
  </script>
  
  <style>
    .field-error {
      border-color: #ef4444 !important;
      background-color: #fee2e2 !important;
    }
    
    .alert {
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Estilos para Autocomplete */
    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #d1d5db;
      border-top: none;
      border-radius: 0 0 0.75rem 0.75rem;
      max-height: 250px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
      display: none;
    }

    .autocomplete-list.show {
      display: block;
    }

    .autocomplete-item {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      align-items: flex-start;
      gap: 10px;
      transition: all 0.2s ease;
    }

    .autocomplete-item:hover,
    .autocomplete-item.active {
      background-color: #eff6ff;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      flex-shrink: 0;
      letter-spacing: 0.5px;
    }

    .autocomplete-badge.cmei {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .autocomplete-badge.emef {
      background-color: #d1fae5;
      color: #065f46;
    }

    .autocomplete-nome {
      font-size: 14px;
      color: #374151;
    }

    .no-results {
      padding: 20px;
      text-align: center;
      color: #6b7280;
      font-size: 14px;
    }

    .autocomplete-list::-webkit-scrollbar {
      width: 6px;
    }

    .autocomplete-list::-webkit-scrollbar-track {
      background: #f3f4f6;
    }

    .autocomplete-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .autocomplete-list::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* Estilos para Select Customizado */
    .custom-select-wrapper {
      position: relative;
    }

    .custom-select-trigger {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .custom-select-trigger::after {
      content: '‚ñº';
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      color: #6b7280;
      transition: transform 0.3s ease;
      pointer-events: none;
    }

    .custom-select-trigger.open::after {
      transform: translateY(-50%) rotate(180deg);
    }

    .custom-select-dropdown {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #d1d5db;
      border-radius: 0.75rem;
      max-height: 280px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
      display: none;
      animation: dropdownSlide 0.2s ease-out;
    }

    @keyframes dropdownSlide {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .custom-select-dropdown.show {
      display: block;
    }

    .custom-select-option {
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.15s ease;
      border-bottom: 1px solid #f3f4f6;
      font-size: 14px;
      color: #374151;
    }

    .custom-select-option:last-child {
      border-bottom: none;
    }

    .custom-select-option:hover {
      background-color: #f3f4f6;
    }

    .custom-select-option.selected {
      background-color: #eff6ff;
      color: #1e40af;
      font-weight: 600;
    }

    .custom-select-option.selected::before {
      content: '‚úì ';
      margin-right: 8px;
    }

    .custom-select-dropdown::-webkit-scrollbar {
      width: 6px;
    }

    .custom-select-dropdown::-webkit-scrollbar-track {
      background: #f3f4f6;
    }

    .custom-select-dropdown::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    .custom-select-dropdown::-webkit-scrollbar-thumb:hover {
      background: #9ca3af;
    }

    /* Esconder select nativo mas manter funcionalidade */
    .custom-select-wrapper select {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    /* Estilos para Date Input Customizado */
    input[type="date"] {
      position: relative;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 20px;
      padding-right: 42px;
      color: #374151;
      font-family: inherit;
    }

    input[type="date"]::-webkit-calendar-picker-indicator {
      position: absolute;
      right: 0;
      left: 0;
      top: 0;
      bottom: 0;
      width: auto;
      height: auto;
      cursor: pointer;
      opacity: 0;
      z-index: 10;
    }

    input[type="date"]::-webkit-inner-spin-button,
    input[type="date"]::-webkit-clear-button {
      display: none;
      -webkit-appearance: none;
    }

    input[type="date"]::-webkit-datetime-edit {
      padding: 0;
      color: #374151;
    }

    input[type="date"]::-webkit-datetime-edit-text {
      color: #6b7280;
      padding: 0 2px;
    }

    input[type="date"]::-webkit-datetime-edit-month-field,
    input[type="date"]::-webkit-datetime-edit-day-field,
    input[type="date"]::-webkit-datetime-edit-year-field {
      padding: 2px 4px;
      border-radius: 4px;
      color: #374151;
    }

    input[type="date"]::-webkit-datetime-edit-month-field:focus,
    input[type="date"]::-webkit-datetime-edit-day-field:focus,
    input[type="date"]::-webkit-datetime-edit-year-field:focus {
      background-color: #dbeafe;
      color: #1e40af;
      outline: none;
    }

    input[type="date"]:hover {
      border-color: #9ca3af;
    }

    input[type="date"]:focus {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
    }

    /* Estiliza√ß√£o do popup do calend√°rio */
    input[type="date"]::-webkit-calendar-picker-indicator:hover {
      cursor: pointer;
      background: transparent;
    }

    /* Firefox */
    input[type="date"]::-moz-calendar-picker-indicator {
      cursor: pointer;
      opacity: 0;
    }

    /* Menu Hamburguer Responsivo */
    /* Desktop: Mostra menu horizontal, esconde hamburguer */
    .mobile-menu-button {
      display: none !important;
    }

    .desktop-menu {
      display: flex;
    }

    .mobile-menu {
      display: none;
    }

    /* Apenas Celulares: Esconde menu horizontal, mostra hamburguer */
    @media (max-width: 768px) {
      .mobile-menu-button {
        display: flex !important;
      }
      
      .desktop-menu {
        display: none !important;
      }
      
      .mobile-menu {
        display: block !important;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }

      .mobile-menu.show {
        max-height: 500px;
      }
    }

    /* Melhorias de toque para mobile */
    @media (hover: none) and (pointer: coarse) {
      button, a, input, select, textarea {
        min-height: 44px;
        min-width: 44px;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen py-10 px-4">
  
  <!-- Container Principal -->
  <div class="max-w-5xl mx-auto">
    
    <!-- Menu de Navega√ß√£o -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl shadow-lg mb-6">
      <div class="px-4 py-3">
        <!-- Bot√£o Hamburguer (Mobile) -->
        <button onclick="toggleMobileMenu()" class="mobile-menu-button w-full flex items-center justify-between text-white font-semibold">
          <span>üì± Menu</span>
          <svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        
        <!-- Menu Desktop -->
        <nav class="desktop-menu flex flex-wrap gap-2 justify-center items-center">
          <a href="painel-casos.html" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
            üìä Painel de Casos
          </a>
          <a href="registro-novo-caso.html" class="px-5 py-2.5 bg-white text-blue-600 rounded-lg text-sm font-semibold shadow-md hover:shadow-lg transition-all">
            üìù Novo Registro
          </a>
          <a href="gerenciar-casos.html" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
            üìã Gerenciar Registros
          </a>
          <a id="menuAdmin" href="gerenciar-usuarios.html" class="hidden px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
            üîß Painel Admin
          </a>
          <button id="btnSair" onclick="sair()" class="hidden px-5 py-2.5 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition-all">
            üö™ Sair
          </button>
        </nav>
        
        <!-- Menu Mobile (Dropdown) -->
        <nav id="mobileMenuNav" class="mobile-menu mt-3">
          <div class="flex flex-col gap-2">
            <a href="painel-casos.html" class="px-5 py-3 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all text-center">
              üìä Painel de Casos
            </a>
            <a href="registro-novo-caso.html" class="px-5 py-3 bg-white text-blue-600 rounded-lg text-sm font-semibold shadow-md hover:shadow-lg transition-all text-center">
              üìù Novo Registro
            </a>
            <a href="gerenciar-casos.html" class="px-5 py-3 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all text-center">
              üìã Gerenciar Registros
            </a>
            <a id="menuAdminMobile" href="gerenciar-usuarios.html" class="hidden px-5 py-3 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all text-center">
              üîß Painel Admin
            </a>
            <button id="btnSairMobile" onclick="sair()" class="hidden px-5 py-3 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition-all text-center">
              üö™ Sair
            </button>
          </div>
        </nav>
      </div>
    </div>
    
    <!-- Cabe√ßalho -->
    <div class="bg-gradient-to-r from-white to-blue-50/30 rounded-xl sm:rounded-2xl shadow-xl border border-white/60 backdrop-blur-sm p-4 sm:p-6 md:p-8 mb-6 sm:mb-8">
      <div class="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-4 mb-3">
        <div class="h-12 w-12 sm:h-14 sm:w-14 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 text-2xl sm:text-3xl shadow-sm flex-shrink-0">
          üìã
        </div>
        <div class="text-center">
          <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800 leading-tight">
            Registro de Casos de Viol√™ncia Escolar
          </h1>
        </div>
      </div>
      <div class="flex flex-col items-center gap-2">
        <p class="text-center text-gray-600 text-sm sm:text-base px-2">
          Preencha todos os campos obrigat√≥rios com aten√ß√£o e cuidado
        </p>
        <div class="inline-flex items-center gap-2 bg-blue-100/50 px-3 sm:px-4 py-1.5 rounded-full">
          <span class="text-xs font-semibold text-blue-700">Sistema Interno</span>
          <span class="text-blue-400">¬∑</span>
          <span class="text-xs font-medium text-blue-600">SME Vit√≥ria</span>
        </div>
      </div>
    </div>
    
    <!-- √Årea de Alertas -->
    <div id="alertContainer"></div>
    
    <!-- Indicador de Progresso -->
    <div id="progressIndicator" class="bg-white/90 backdrop-blur-sm rounded-xl shadow-lg border border-gray-200 p-4 sm:p-5 mb-6 hidden">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center gap-3">
          <span class="text-lg sm:text-xl">üìä</span>
          <div>
            <h3 class="text-sm sm:text-base font-semibold text-gray-800">Progresso do Formul√°rio</h3>
            <p class="text-xs sm:text-sm text-gray-600" id="progressText">Calculando...</p>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <!-- Indicador de Auto-Save -->
          <div id="indicadorRascunho" class="hidden"></div>
          
          <button 
            id="btnSalvarRascunho" 
            type="button"
            onclick="AutoSave.salvar()"
            class="btn-elegant btn-secondary-elegant inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg shadow-sm"
            title="Salvar rascunho agora"
          >
            <span>üíæ</span>
            <span class="hidden sm:inline">Salvar Agora</span>
          </button>
          
          <button 
            type="button"
            onclick="if(confirm('Deseja realmente limpar o rascunho?')) AutoSave.limpar()"
            class="btn-elegant btn-secondary-elegant inline-flex items-center gap-2 px-3 py-1.5 text-xs font-semibold rounded-lg shadow-sm bg-gray-100 hover:bg-gray-200 text-gray-700"
            title="Limpar rascunho salvo"
          >
            <span>üóëÔ∏è</span>
            <span class="hidden sm:inline">Limpar</span>
          </button>
          
          <span id="draftStatus" class="text-xs text-gray-500 hidden">
            <span id="draftLastSave"></span>
          </span>
        </div>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-3 sm:h-4 overflow-hidden shadow-inner">
        <div 
          id="progressBar" 
          class="bg-gradient-to-r from-blue-500 via-blue-600 to-indigo-600 h-full rounded-full transition-all duration-500 ease-out shadow-sm"
          style="width: 0%"
        ></div>
      </div>
      <div class="mt-2 flex flex-wrap gap-2 text-xs text-gray-600">
        <span id="progressDetails"></span>
      </div>
    </div>
    
    <!-- Formul√°rio -->
    <form id="registroForm" class="bg-white/80 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-xl border border-white/60 p-4 sm:p-6 md:p-8 lg:p-10 space-y-6 sm:space-y-8">
      
      <!-- =============================================== -->
      <!-- SE√á√ÉO 1: Dados da Crian√ßa/Estudante -->
      <!-- =============================================== -->
      <section>
        <div class="bg-gradient-to-r from-slate-50 to-blue-50/30 rounded-xl sm:rounded-2xl border border-gray-200 shadow-sm p-4 sm:p-5 md:p-6 mb-6">
          <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-blue-100 text-blue-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
              üë§
            </div>
            <div class="flex-1">
              <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                Dados da Crian√ßa/Estudante
              </h2>
              <p class="text-xs sm:text-sm text-gray-600">
                Preencha as informa√ß√µes b√°sicas da crian√ßa ou estudante envolvido no caso
              </p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
            
            <!-- Crian√ßa/Estudante -->
            <div class="md:col-span-2">
              <label for="criancaEstudante" class="block text-sm font-semibold text-gray-700 mb-2">
                Nome da Crian√ßa/Estudante <span class="text-red-500">*</span>
              </label>
              <input 
                type="text" 
                id="criancaEstudante" 
                name="criancaEstudante" 
                required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Digite o nome completo"
              >
            </div>
            
            <!-- Data da NT -->
            <div>
              <label for="dataNT" class="block text-sm font-semibold text-gray-700 mb-2">
                Data da Notifica√ß√£o (NT) <span class="text-red-500">*</span>
              </label>
              <input 
                type="date" 
                id="dataNT" 
                name="dataNT" 
                required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
              >
            </div>
            
            <!-- Idade -->
            <div>
              <label for="idade" class="block text-sm font-semibold text-gray-700 mb-2">
                Idade <span class="text-red-500">*</span>
              </label>
              <input 
                type="number" 
                id="idade" 
                name="idade" 
                min="0" 
                max="120"
                required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Ex: 10"
              >
            </div>
            
            <!-- Identidade de G√™nero -->
            <div>
              <label for="identidadeGenero" class="block text-sm font-semibold text-gray-700 mb-2">
                Identidade de G√™nero <span class="text-red-500">*</span>
              </label>
              <select 
                id="identidadeGenero" 
                name="identidadeGenero" 
                required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
              >
                <option value="">Selecione...</option>
                <option value="M">Masculino</option>
                <option value="F">Feminino</option>
                <option value="N√£o-bin√°rio">N√£o-bin√°rio</option>
                <option value="Outro">Outro</option>
              </select>
            </div>
            
            <!-- √â PCD/tem Transtorno? -->
            <div>
              <label for="pcdTranstorno" class="block text-sm font-semibold text-gray-700 mb-2">
                √â PCD/tem Transtorno?
              </label>
              <select 
                id="pcdTranstorno" 
                name="pcdTranstorno"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
              >
                <option value="">Selecione...</option>
                <option value="Sim">Sim</option>
                <option value="N√£o">N√£o</option>
                <option value="N√£o informado">N√£o informado</option>
              </select>
            </div>
            
            <!-- Detalhes da defici√™ncia/transtorno (condicional) -->
            <div id="pcdDetalhesContainer" class="md:col-span-2 hidden">
              <label for="pcdDetalhes-input" class="block text-sm font-semibold text-gray-700 mb-2">
                Se for PCD/tem transtorno, descreva quais (diagn√≥sticos, laudos, observa√ß√µes): <span class="text-red-500">*</span>
              </label>
              
              <!-- Container de tags -->
              <div id="pcdDetalhes-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
              
              <!-- Input com autocomplete -->
              <div class="relative">
                <input 
                  type="text" 
                  id="pcdDetalhes-input"
                  class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                  placeholder="Digite ou selecione um transtorno/defici√™ncia..."
                  autocomplete="off"
                />
                <div id="pcdDetalhes-suggestions" class="absolute left-0 right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden"></div>
              </div>
              
              <!-- Campo oculto que ser√° enviado -->
              <input type="hidden" id="pcdDetalhes" name="pcdDetalhes" />
              
              <p class="text-xs text-gray-500 mt-1.5">
                Digite para buscar ou adicione um novo transtorno/defici√™ncia. Pressione Enter para adicionar.
              </p>
            </div>
            
            <!-- Ra√ßa/Cor -->
            <div class="md:col-span-2">
              <label for="racaCor" class="block text-sm font-semibold text-gray-700 mb-2">
                Ra√ßa/Cor
              </label>
              <select 
                id="racaCor" 
                name="racaCor"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
              >
                <option value="">Selecione...</option>
                <option value="Branca">Branca</option>
                <option value="Preta">Preta</option>
                <option value="Parda">Parda</option>
                <option value="Amarela">Amarela</option>
                <option value="Ind√≠gena">Ind√≠gena</option>
                <option value="N√£o informado">N√£o informado</option>
              </select>
            </div>
            
            <!-- Orienta√ß√£o Sexual -->
            <div class="md:col-span-2">
              <label for="orientacaoSexual" class="block text-sm font-semibold text-gray-700 mb-2">
                Qual a Orienta√ß√£o Sexual?
              </label>
              <select 
                id="orientacaoSexual" 
                name="orientacaoSexual"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
              >
                <option value="">Selecione...</option>
                <option value="Heterossexual">Heterossexual</option>
                <option value="Homossexual">Homossexual</option>
                <option value="Bissexual">Bissexual</option>
                <option value="Outro">Outro</option>
              </select>
            </div>
            
          </div>
        </div>
      </section>
      
      <!-- =============================================== -->
      <!-- SE√á√ÉO 2: Situa√ß√£o da Viol√™ncia -->
      <!-- =============================================== -->
      <section>
        <div class="bg-gradient-to-r from-red-50/50 to-orange-50/30 rounded-xl sm:rounded-2xl border border-red-200 shadow-sm p-4 sm:p-5 md:p-6 mb-6">
          <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-red-100 text-red-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
              ‚ö†Ô∏è
            </div>
            <div class="flex-1">
              <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                Situa√ß√£o da Viol√™ncia
              </h2>
              <p class="text-xs sm:text-sm text-gray-600">
                Descreva o tipo de viol√™ncia ocorrida e os encaminhamentos realizados
              </p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 gap-4 sm:gap-6">
            
            <!-- Tipo de Viol√™ncia -->
            <div>
              <label for="tipoViolencia-input" class="block text-sm font-semibold text-gray-700 mb-2">
                Tipo de Viol√™ncia <span class="text-red-500">*</span>
              </label>
              
              <!-- Container de tags -->
              <div id="tipoViolencia-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
              
              <!-- Input com autocomplete -->
              <div class="relative">
                <input 
                  type="text"
                  id="tipoViolencia-input" 
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                  placeholder="Digite para adicionar tipo de viol√™ncia (ex: F√≠sica)"
                  autocomplete="off"
                />
                
                <!-- Lista de sugest√µes -->
                <div id="tipoViolencia-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
              </div>
              
              <!-- Campo oculto que ser√° enviado -->
              <input type="hidden" id="tipoViolencia" name="tipoViolencia" required />
              
              <p class="text-xs text-gray-500 mt-1.5">
                Digite e pressione Enter para adicionar. Pode adicionar m√∫ltiplos tipos (ex: F√≠sica, Psicol√≥gica).
              </p>
            </div>
            
            <!-- Classifica√ß√£o da Viol√™ncia -->
            <div>
              <label for="classificacaoViolencia-input" class="block text-sm font-semibold text-gray-700 mb-2">
                Qual a Classifica√ß√£o da Viol√™ncia?
              </label>
              
              <!-- Container de tags -->
              <div id="classificacaoViolencia-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
              
              <!-- Input com autocomplete -->
              <div class="relative">
                <input 
                  type="text"
                  id="classificacaoViolencia-input" 
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                  placeholder="Digite para adicionar classifica√ß√£o (ex: Intrafamiliar)"
                  autocomplete="off"
                />
                
                <!-- Lista de sugest√µes -->
                <div id="classificacaoViolencia-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
              </div>
              
              <!-- Campo oculto que ser√° enviado -->
              <input type="hidden" id="classificacaoViolencia" name="classificacaoViolencia" />
              
              <p class="text-xs text-gray-500 mt-1.5">
                Digite e pressione Enter para adicionar. Clique no √ó para remover.
              </p>
            </div>
            
            <!-- Motiva√ß√£o da Viol√™ncia -->
            <div>
              <label for="motivacaoViolencia-input" class="block text-sm font-semibold text-gray-700 mb-2">
                Qual a Motiva√ß√£o da Viol√™ncia?
              </label>
              
              <!-- Container de tags -->
              <div id="motivacaoViolencia-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
              
              <!-- Input com autocomplete -->
              <div class="relative">
                <input 
                  type="text"
                  id="motivacaoViolencia-input" 
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                  placeholder="Digite para adicionar motiva√ß√£o (ex: Conflito Escolar)"
                  autocomplete="off"
                />
                
                <!-- Lista de sugest√µes -->
                <div id="motivacaoViolencia-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
              </div>
              
              <!-- Campo oculto que ser√° enviado -->
              <input type="hidden" id="motivacaoViolencia" name="motivacaoViolencia" />
              
              <p class="text-xs text-gray-500 mt-1.5">
                Digite e pressione Enter para adicionar. Clique no √ó para remover.
              </p>
            </div>
            
            <!-- Encaminhamento -->
            <div>
              <label for="encaminhamento-input" class="block text-sm font-semibold text-gray-700 mb-2">
                Encaminhamento
              </label>
              
              <!-- Container de tags -->
              <div id="encaminhamentos-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
              
              <!-- Input com autocomplete -->
              <div class="relative">
                <input 
                  type="text"
                  id="encaminhamento-input" 
                  class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                  placeholder="Digite para adicionar encaminhamento (ex: Conselho Tutelar)"
                  autocomplete="off"
                />
                
                <!-- Lista de sugest√µes -->
                <div id="encaminhamento-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
              </div>
              
              <!-- Campo oculto que ser√° enviado -->
              <input type="hidden" id="encaminhamento" name="encaminhamento" />
              
              <p class="text-xs text-gray-500 mt-1.5">
                Digite e pressione Enter para adicionar. Clique no √ó para remover.
              </p>
            </div>
            
          </div>
        </div>
      </section>
      
      <!-- =============================================== -->
      <!-- SE√á√ÉO 3: Unidade e Regi√£o -->
      <!-- =============================================== -->
      <section>
        <div class="bg-gradient-to-r from-green-50/50 to-emerald-50/30 rounded-xl sm:rounded-2xl border border-green-200 shadow-sm p-4 sm:p-5 md:p-6 mb-6">
          <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-green-100 text-green-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
              üè´
            </div>
            <div class="flex-1">
              <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                Unidade e Regi√£o
              </h2>
              <p class="text-xs sm:text-sm text-gray-600">
                Identifique a institui√ß√£o de ensino e regi√£o onde o caso foi registrado
              </p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
            
            <!-- Tipo de Institui√ß√£o -->
            <div class="md:col-span-2">
              <label for="tipoInstituicao" class="block text-sm font-semibold text-gray-700 mb-2">
                Qual o tipo da institui√ß√£o de ensino? <span class="text-red-500">*</span>
              </label>
              <select 
                id="tipoInstituicao" 
                name="tipoInstituicao" 
                required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm"
              >
                <option value="">Selecione o tipo...</option>
                <option value="CMEI">CMEI - Centro Municipal de Educa√ß√£o Infantil</option>
                <option value="EMEF">EMEF - Escola Municipal de Ensino Fundamental</option>
              </select>
            </div>
            
            <!-- CMEI/EMEF com Autocomplete -->
            <div class="md:col-span-2">
              <label for="cmeiEmef" class="block text-sm font-semibold text-gray-700 mb-2">
                Institui√ß√£o de Ensino <span class="text-red-500">*</span>
              </label>
              <div class="autocomplete-wrapper">
                <input 
                  type="text" 
                  id="cmeiEmef" 
                  name="cmeiEmef" 
                  required
                  disabled
                  autocomplete="off"
                  class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm disabled:bg-gray-50 disabled:cursor-not-allowed disabled:text-gray-500"
                  placeholder="Primeiro selecione o tipo de institui√ß√£o"
                >
                <div class="autocomplete-list" id="autocompleteList"></div>
              </div>
              <p class="text-xs text-gray-500 mt-1.5">Digite para filtrar as institui√ß√µes dispon√≠veis</p>
            </div>
            
            <!-- Regi√£o -->
            <div>
              <label for="regiao" class="block text-sm font-semibold text-gray-700 mb-2">
                Regi√£o <span class="text-red-500">*</span>
              </label>
              <select 
                id="regiao" 
                name="regiao" 
                required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm"
              >
                <option value="">Selecione...</option>
                <!-- Op√ß√µes carregadas dinamicamente via JavaScript -->
              </select>
            </div>
            
            <!-- Respons√°vel pelo Registro -->
            <div class="md:col-span-2">
              <label for="responsavelRegistro" class="block text-sm font-semibold text-gray-700 mb-2">
                Respons√°vel pelo Registro <span class="text-red-500">*</span>
              </label>
              <input 
                type="text" 
                id="responsavelRegistro" 
                name="responsavelRegistro" 
                required
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Nome do profissional que est√° registrando"
              >
            </div>
            
          </div>
        </div>
      </section>
      
      <!-- =============================================== -->
      <!-- SE√á√ÉO 4: Perguntas Complementares (Sim/N√£o) -->
      <!-- =============================================== -->
      <section>
        <div class="bg-gradient-to-r from-purple-50/50 to-indigo-50/30 rounded-xl sm:rounded-2xl border border-purple-200 shadow-sm p-4 sm:p-5 md:p-6">
          <div class="flex items-start gap-3 sm:gap-4 mb-4 sm:mb-6">
            <div class="h-10 w-10 sm:h-12 sm:w-12 flex items-center justify-center rounded-lg sm:rounded-xl bg-purple-100 text-purple-600 text-xl sm:text-2xl flex-shrink-0 shadow-sm">
              ‚ùì
            </div>
            <div class="flex-1">
              <h2 class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800 mb-1">
                Informa√ß√µes Complementares
              </h2>
              <p class="text-xs sm:text-sm text-gray-600">
                Responda √†s quest√µes adicionais sobre o contexto da viol√™ncia
              </p>
            </div>
          </div>
          
          <div class="space-y-4">
            
            <!-- Fonte informadores foi a escola? -->
            <div class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                A fonte dos informadores foi a escola?
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="fonteEscola" value="Sim" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="fonteEscola" value="N√£o" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="fonteEscola" value="" checked class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
            
            <!-- Viol√™ncia identificada pela escola ocorrida na escola -->
            <div class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                Viol√™ncia identificada pela escola ocorrida na escola?
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaEscolaOcorreu" value="Sim" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaEscolaOcorreu" value="N√£o" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaEscolaOcorreu" value="" checked class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
            
            <!-- Algum profissional da escola foi autor da viol√™ncia -->
            <div class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                Algum profissional da escola foi autor da viol√™ncia?
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="profissionalAutor" value="Sim" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="profissionalAutor" value="N√£o" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="profissionalAutor" value="" checked class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
            
            <!-- Algum estudante foi autor da viol√™ncia? -->
            <div class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                Algum estudante foi autor da viol√™ncia?
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudanteAutor" value="Sim" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudanteAutor" value="N√£o" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudanteAutor" value="" checked class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
            
            <!-- Viol√™ncia identificada pela escola n√£o ocorrida na escola -->
            <div class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                Viol√™ncia identificada pela escola N√ÉO ocorrida na escola?
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaNaoEscola" value="Sim" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaNaoEscola" value="N√£o" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaNaoEscola" value="" checked class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
            
            <!-- Ocorreu na escola? 1.1 -->
            <div class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                Ocorreu na escola? (1.1)
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="ocorreuEscola" value="Sim" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="ocorreuEscola" value="N√£o" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="ocorreuEscola" value="" checked class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
            
            <!-- Viol√™ncia informada √† escola por qualquer um dos agentes que a comp√µe 1.2 -->
            <div class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                Viol√™ncia informada √† escola por qualquer um dos agentes que a comp√µe? (1.2)
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaInformada" value="Sim" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaInformada" value="N√£o" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="violenciaInformada" value="" checked class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
            
          </div>
          
          <!-- Foi Realizado Estudo de Caso? -->
          <div class="md:col-span-2">
            <div class="bg-white rounded-lg sm:rounded-xl border border-gray-200 shadow-sm p-4 sm:p-5 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-3 sm:mb-4">
                üìã Foi Realizado Estudo de Caso?
                <span class="text-red-500 ml-1">*</span>
              </label>
              <div class="flex flex-wrap gap-2 sm:gap-3">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudoCaso" value="Sim" required class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudoCaso" value="N√£o" class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="estudoCaso" value="" checked class="peer sr-only">
                  <div class="px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg border-2 border-gray-200 bg-gray-50 text-xs sm:text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
      </section>
      
      <!-- =============================================== -->
      <!-- BOT√ïES DE A√á√ÉO -->
      <!-- =============================================== -->
      <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-end pt-6 sm:pt-8 mt-6 sm:mt-8 border-t-2 border-gray-200">
        <button 
          type="button" 
          onclick="limparFormulario()"
          class="inline-flex items-center justify-center gap-2 px-5 sm:px-6 py-2.5 sm:py-3 bg-gradient-to-r from-gray-500 to-gray-600 text-white text-sm sm:text-base font-semibold rounded-full hover:from-gray-600 hover:to-gray-700 transition-all duration-200 shadow-md hover:shadow-lg active:scale-95 sm:hover:scale-105"
        >
          <span class="text-base sm:text-lg">üîÑ</span>
          <span>Limpar Formul√°rio</span>
        </button>
        
        <button 
          type="submit" 
          id="btnSalvar"
          class="btn-elegant btn-primary-elegant inline-flex items-center justify-center gap-2 px-6 sm:px-8 py-2.5 sm:py-3 text-white text-sm sm:text-base font-bold rounded-full shadow-lg"
        >
          <span class="text-base sm:text-lg">üíæ</span>
          <span>Salvar Registro</span>
        </button>
      </div>
      
    </form>
    
    <!-- Rodap√© -->
    <div class="text-center mt-6 sm:mt-8 mb-4">
      <div class="inline-block bg-white/60 backdrop-blur-sm rounded-xl sm:rounded-2xl shadow-md border border-white/60 px-4 sm:px-6 md:px-8 py-4 sm:py-5 max-w-full mx-2">
        <p class="text-gray-700 font-semibold text-sm sm:text-base mb-1">Sistema de Registro de Casos de Viol√™ncia Escolar</p>
        <p class="text-gray-600 text-xs sm:text-sm">Secretaria Municipal de Educa√ß√£o ¬∑ Vit√≥ria/ES</p>
        <div class="mt-3 pt-3 border-t border-gray-200">
          <p class="text-xs text-gray-500">¬© 2025 - Todos os direitos reservados</p>
        </div>
      </div>
    </div>
    
  </div>
  
  <!-- =============================================== -->
  <!-- JAVASCRIPT -->
  <!-- =============================================== -->
  <script>
    // ========================================
    // CONFIGURA√á√ÉO DO GOOGLE APPS SCRIPT
    // ========================================
    // Usando configura√ß√£o centralizada (config.js)
    // Fun√ß√£o para obter a URL do Apps Script de forma segura
    function obterURLAppsScript() {
      // Aguarda um pouco para garantir que config.js foi carregado
      if (typeof CONFIG === 'undefined') {
        console.warn('‚ö†Ô∏è CONFIG n√£o est√° dispon√≠vel ainda. Tentando aguardar...');
        // Tenta novamente ap√≥s um pequeno delay
        setTimeout(() => {
          if (typeof CONFIG !== 'undefined' && CONFIG.APPS_SCRIPT_CASOS) {
            console.log('‚úÖ CONFIG carregado ap√≥s delay');
          } else {
            console.error('‚ùå CONFIG ainda n√£o dispon√≠vel ap√≥s delay');
          }
        }, 100);
      }
      
      console.log('üîß Verificando configura√ß√£o do Apps Script...');
      console.log('CONFIG dispon√≠vel?', typeof CONFIG !== 'undefined');
      
      if (typeof CONFIG !== 'undefined') {
        console.log('CONFIG completo:', CONFIG);
        console.log('CONFIG.APPS_SCRIPT_CASOS?', CONFIG.APPS_SCRIPT_CASOS);
      }
      
      const url = (typeof CONFIG !== 'undefined' && CONFIG.APPS_SCRIPT_CASOS) 
        ? CONFIG.APPS_SCRIPT_CASOS 
        : 'https://script.google.com/macros/s/SEU_ID_AQUI/exec';
      
      console.log('üì° URL do Apps Script obtida:', url);
      
      // Valida√ß√£o: Verifica se est√° configurado
      if (url.includes('SEU_ID_AQUI')) {
        console.error('‚ùå ATEN√á√ÉO: Configure APPS_SCRIPT_CASOS em config.js para salvar registros');
        console.error('‚ö†Ô∏è A URL do Apps Script n√£o est√° configurada!');
        return null; // Retorna null se n√£o estiver configurado
      } else {
        console.log('‚úÖ URL do Apps Script configurada corretamente:', url);
        return url;
      }
    }
    
    // Obt√©m a URL (pode ser null se n√£o estiver configurada)
    // Aguarda o carregamento completo da p√°gina para garantir que config.js foi carregado
    let APPS_SCRIPT_URL = null;
    
    // Fun√ß√£o para inicializar a URL quando o DOM estiver pronto
    function inicializarURLAppsScript() {
      // Usa window.CONFIG diretamente (n√£o pode reatribuir const)
      const config = typeof window !== 'undefined' ? window.CONFIG : (typeof CONFIG !== 'undefined' ? CONFIG : null);
      
      if (config && config.APPS_SCRIPT_CASOS) {
        APPS_SCRIPT_URL = config.APPS_SCRIPT_CASOS;
        console.log('‚úÖ URL do Apps Script inicializada:', APPS_SCRIPT_URL);
        console.log('üîç Verificando se √© a URL correta...');
        
        // Verifica se √© a URL antiga (que pode estar em cache)
        if (APPS_SCRIPT_URL.includes('AKfycbz-Ocm2sp-6c7bFAdLF1Da4FtRVd_gWV0deScEvOko-Sii2NpTqHwkzG0mBYjIct2-o')) {
          console.warn('‚ö†Ô∏è ATEN√á√ÉO: Voc√™ pode estar usando uma URL antiga em cache!');
          console.warn('üí° Solu√ß√£o: Limpe o cache do navegador (Ctrl+Shift+Delete) ou fa√ßa um Hard Refresh (Ctrl+F5)');
        }
      } else {
        console.error('‚ùå CONFIG.APPS_SCRIPT_CASOS n√£o est√° dispon√≠vel');
        console.error('CONFIG dispon√≠vel?', typeof config !== 'undefined' && config !== null);
        if (config) {
          console.error('CONFIG completo:', config);
        }
        APPS_SCRIPT_URL = 'https://script.google.com/macros/s/SEU_ID_AQUI/exec';
      }
    }
    
    // Tenta inicializar imediatamente
    if (document.readyState === 'loading') {
      // Se ainda est√° carregando, aguarda DOMContentLoaded
      document.addEventListener('DOMContentLoaded', inicializarURLAppsScript);
    } else {
      // Se j√° carregou, inicializa imediatamente
      inicializarURLAppsScript();
    }
    
    // ========================================
    // FUN√á√ïES DE FORMATA√á√ÉO (do backend)
    // ========================================
    
    // Fun√ß√£o auxiliar para converter Sim/N√£o em S/N
    function converterSimNao(valor) {
      if (!valor || valor.trim() === '' || valor === 'N√£o informado') return '';
      if (valor === 'Sim') return 'S';
      if (valor === 'N√£o') return 'N';
      return valor;
    }
    
    // Fun√ß√£o para extrair sigla da escola
    function extrairSiglaEscola(nomeCompleto) {
      if (!nomeCompleto) return '';
      
      // Remove o prefixo CMEI/EMEF e TI
      let nome = nomeCompleto.replace(/^(CMEI|EMEF)\s+(TI\s+)?/i, '');
      
      // Palavras que devem ser ignoradas ao gerar siglas
      const ignorar = ['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o', 'as', 'os'];
      
      // Separa as palavras e pega as iniciais das palavras importantes
      const palavras = nome.split(' ').filter(p => p.length > 0);
      const sigla = palavras
        .filter(palavra => !ignorar.includes(palavra.toLowerCase()))
        .map(palavra => palavra[0].toUpperCase())
        .join('');
      
      return sigla;
    }
    
    // Fun√ß√£o para converter data de YYYY-MM-DD para DD/MM/YYYY
    function formatarData(dataISO) {
      if (!dataISO) return '';
      const partes = dataISO.split('-');
      if (partes.length === 3) {
        return partes[2] + '/' + partes[1] + '/' + partes[0];
      }
      return dataISO;
    }

    // ========================================
    // DADOS DAS INSTITUI√á√ïES
    // ========================================
    
    // ========================================
    // FUN√á√ÉO AUXILIAR: Encontrar melhor correspond√™ncia similar
    // ========================================
    function encontrarMelhorCorrespondencia(textoDigitado, opcoesDisponiveis, opcoesJaSelecionadas = []) {
      if (!textoDigitado || !opcoesDisponiveis || opcoesDisponiveis.length === 0) {
        return null;
      }
      
      const textoNormalizado = normalizarTexto(textoDigitado);
      const textoLower = textoNormalizado.toLowerCase();
      
      // Filtra op√ß√µes j√° selecionadas
      const opcoesDisponiveisFiltradas = opcoesDisponiveis.filter(op => !opcoesJaSelecionadas.includes(op));
      
      if (opcoesDisponiveisFiltradas.length === 0) {
        return null;
      }
      
      let melhorCorrespondencia = null;
      let melhorScore = 0;
      
      opcoesDisponiveisFiltradas.forEach(opcao => {
        const opcaoNormalizada = normalizarTexto(opcao);
        const opcaoLower = opcaoNormalizada.toLowerCase();
        
        // Verifica correspond√™ncia exata (ap√≥s normaliza√ß√£o)
        if (opcaoLower === textoLower) {
          melhorCorrespondencia = opcao;
          melhorScore = 1.0;
          return;
        }
        
        // Verifica se o texto digitado est√° contido na op√ß√£o ou vice-versa
        if (opcaoLower.includes(textoLower) || textoLower.includes(opcaoLower)) {
          const score = Math.min(textoLower.length, opcaoLower.length) / Math.max(textoLower.length, opcaoLower.length);
          if (score > melhorScore) {
            melhorScore = score;
            melhorCorrespondencia = opcao;
          }
        }
        
        // Calcula similaridade usando Levenshtein simplificado
        const similaridade = calcularSimilaridade(textoLower, opcaoLower);
        if (similaridade > melhorScore && similaridade >= 0.7) { // 70% de similaridade m√≠nima
          melhorScore = similaridade;
          melhorCorrespondencia = opcao;
        }
      });
      
      // Retorna apenas se a similaridade for alta o suficiente (70%+)
      return melhorScore >= 0.7 ? melhorCorrespondencia : null;
    }
    
    // Normaliza texto para compara√ß√£o
    function normalizarTexto(texto) {
      return String(texto || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }
    
    // Calcula similaridade entre duas strings (0 a 1)
    function calcularSimilaridade(str1, str2) {
      if (str1 === str2) return 1.0;
      if (str1.length === 0 || str2.length === 0) return 0;
      
      // Se uma cont√©m a outra, retorna alta similaridade
      if (str1.includes(str2) || str2.includes(str1)) {
        return 0.9;
      }
      
      // Calcula dist√¢ncia de Levenshtein simplificada
      const maxLen = Math.max(str1.length, str2.length);
      const distancia = distanciaLevenshtein(str1, str2);
      return 1 - (distancia / maxLen);
    }
    
    // Calcula dist√¢ncia de Levenshtein entre duas strings
    function distanciaLevenshtein(str1, str2) {
      const matrix = [];
      const len1 = str1.length;
      const len2 = str2.length;
      
      for (let i = 0; i <= len1; i++) {
        matrix[i] = [i];
      }
      
      for (let j = 0; j <= len2; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= len1; i++) {
        for (let j = 1; j <= len2; j++) {
          if (str1[i - 1] === str2[j - 1]) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j - 1] + 1
            );
          }
        }
      }
      
      return matrix[len1][len2];
    }
    
    // ========================================
    // LISTA DE TRANSTORNOS/DEFICI√äNCIAS PREDEFINIDOS
    // ========================================
    const transtornosPredefinidos = [
      'Autismo (TEA)',
      'TDAH (Transtorno de D√©ficit de Aten√ß√£o e Hiperatividade)',
      'S√≠ndrome de Down',
      'Defici√™ncia Intelectual',
      'Defici√™ncia Visual',
      'Defici√™ncia Auditiva',
      'Defici√™ncia F√≠sica',
      'Defici√™ncia M√∫ltipla',
      'Dislexia',
      'Discalculia',
      'Transtorno do Espectro Autista',
      'Paralisia Cerebral',
      'TOD (Transtorno Opositor Desafiador)',
      'Transtorno de Ansiedade',
      'Depress√£o Infantil',
      'S√≠ndrome de Asperger',
      'Transtorno Bipolar',
      'Esquizofrenia',
      'Transtorno de Conduta',
      'Altas Habilidades/Superdota√ß√£o',
      'Baixa Vis√£o',
      'Cegueira',
      'Surdez',
      'Surdocegueira',
      'Nanismo',
      'Hidrocefalia',
      'Microcefalia',
      'Epilepsia',
      'Outros'
    ];
    
    let transtornosSelecionados = [];
    
    // Renderiza as tags de transtornos selecionados
    function renderizarTagsTranstornos() {
      const container = document.getElementById('pcdDetalhes-tags');
      const hiddenInput = document.getElementById('pcdDetalhes');
      
      if (transtornosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum transtorno/defici√™ncia adicionado</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = transtornosSelecionados.map((trans, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium border border-blue-200 shadow-sm">
          ${trans}
          <button 
            type="button" 
            onclick="removerTranstorno(${index})"
            class="hover:bg-blue-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </span>
      `).join('');
      
      // Atualiza campo oculto com valores separados por v√≠rgula
      hiddenInput.value = transtornosSelecionados.join(', ');
    }
    
    // Remove um transtorno
    function removerTranstorno(index) {
      transtornosSelecionados.splice(index, 1);
      renderizarTagsTranstornos();
      
      // Salva automaticamente ap√≥s remover tag
      if (typeof AutoSave !== 'undefined') {
        AutoSave.salvar();
      }
    }
    
    // Adiciona um transtorno
    function adicionarTranstorno(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Separa por barra (/) para considerar m√∫ltiplos transtornos
      const transtornos = textoTrimmed.split('/').map(t => t.trim()).filter(t => t.length > 0);
      
      // Adiciona cada transtorno separadamente
      transtornos.forEach(transtorno => {
        // Primeiro, tenta encontrar uma correspond√™ncia similar
        const correspondencia = encontrarMelhorCorrespondencia(
          transtorno, 
          transtornosPredefinidos, 
          transtornosSelecionados
        );
        
        // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
        const valorFinal = correspondencia || transtorno;
        
        // Evita duplicatas
        if (!transtornosSelecionados.includes(valorFinal)) {
          transtornosSelecionados.push(valorFinal);
        }
      });
      
      renderizarTagsTranstornos();
      
      // Limpa input
      document.getElementById('pcdDetalhes-input').value = '';
      document.getElementById('pcdDetalhes-suggestions').classList.add('hidden');
      
      // Salva automaticamente ap√≥s adicionar tag
      if (typeof AutoSave !== 'undefined') {
        AutoSave.salvar();
      }
    }
    
    // Filtra e mostra sugest√µes de transtornos
    function mostrarSugestoesTranstornos(query) {
      const suggestionsDiv = document.getElementById('pcdDetalhes-suggestions');
      
      // Se query vazia, mostra todas as op√ß√µes dispon√≠veis
      const filtrados = query.trim() === '' 
        ? transtornosPredefinidos.filter(trans => !transtornosSelecionados.includes(trans))
        : transtornosPredefinidos.filter(trans => 
            trans.toLowerCase().includes(query.toLowerCase()) &&
            !transtornosSelecionados.includes(trans)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhum transtorno encontrado. Pressione <kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs">Enter</kbd> para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(trans => `
        <div 
          class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarTranstorno('${trans.replace(/'/g, "\\'")}')"
        >
          ${trans}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }

    // ========================================
    // SISTEMA DE ENCAMINHAMENTOS COM TAGS
    // ========================================
    const encaminhamentosPredefinidos = [
      'CT',
      'Sa√∫de',
      'UBS',
      'US',
      'NAAM',
      'Educa√ß√£o',
      'Escola',
      'DEAM',
      'DACLE',
      'DPCA',
      'Defensoria P√∫blica',
      'DEPI',
      'Minist√©rio P√∫blico',
      'CRAS',
      'CREAS',
      'CAPSIN',
      'Casa Rosa',
      'Vara da Inf√¢ncia',
      'Assist√™ncia Social',
      'Psic√≥logo',
      'Outros'
    ];
    
    let encaminhamentosSelecionados = [];
    
    // Renderiza as tags selecionadas
    function renderizarTags() {
      const container = document.getElementById('encaminhamentos-tags');
      const hiddenInput = document.getElementById('encaminhamento');
      
      if (encaminhamentosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum encaminhamento adicionado</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = encaminhamentosSelecionados.map((enc, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium border border-red-200 shadow-sm">
          ${enc}
          <button 
            type="button" 
            onclick="removerEncaminhamento(${index})"
            class="hover:bg-red-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');
      
      // Atualiza campo oculto com valores separados por v√≠rgula
      hiddenInput.value = encaminhamentosSelecionados.join(', ');
    }
    
    // Remove um encaminhamento
    function removerEncaminhamento(index) {
      encaminhamentosSelecionados.splice(index, 1);
      renderizarTags();
      
      // Salva automaticamente ap√≥s remover tag
      if (typeof AutoSave !== 'undefined') {
        AutoSave.salvar();
      }
    }
    
    // Adiciona um encaminhamento
    function adicionarEncaminhamento(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Primeiro, tenta encontrar uma correspond√™ncia similar
      const correspondencia = encontrarMelhorCorrespondencia(
        textoTrimmed, 
        encaminhamentosPredefinidos, 
        encaminhamentosSelecionados
      );
      
      // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
      const valorFinal = correspondencia || textoTrimmed;
      
      // Evita duplicatas
      if (!encaminhamentosSelecionados.includes(valorFinal)) {
        encaminhamentosSelecionados.push(valorFinal);
        renderizarTags();
        
        // Salva automaticamente ap√≥s adicionar tag
        if (typeof AutoSave !== 'undefined') {
          AutoSave.salvar();
        }
      }
      
      // Limpa input
      document.getElementById('encaminhamento-input').value = '';
      document.getElementById('encaminhamento-suggestions').classList.add('hidden');
    }
    
    // Filtra e mostra sugest√µes
    function mostrarSugestoes(query) {
      const suggestionsDiv = document.getElementById('encaminhamento-suggestions');
      
      // Se query vazia, mostra todas as op√ß√µes dispon√≠veis
      const filtrados = query.trim() === '' 
        ? encaminhamentosPredefinidos.filter(enc => !encaminhamentosSelecionados.includes(enc))
        : encaminhamentosPredefinidos.filter(enc => 
            enc.toLowerCase().includes(query.toLowerCase()) &&
            !encaminhamentosSelecionados.includes(enc)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(enc => `
        <div 
          class="px-4 py-2 hover:bg-red-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarEncaminhamento('${enc}')">
          ${enc}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    // ========================================
    // SISTEMA DE TAGS - RA√áA/COR
    // ========================================
    const racasCorPredefinidas = [
      'Branca',
      'Preta',
      'Parda',
      'Amarela',
      'Ind√≠gena',
      'N√£o informado'
    ];
    
    // ========================================
    // SISTEMA DE TAGS - TIPO DE VIOL√äNCIA
    // ========================================
    const tiposViolenciaPredefinidos = [
      'Autoprovocada',
      'Bullying',
      'Tortura',
      'Cyberbullying',
      'Financeira/Econ√¥mica',
      'F√≠sica',
      'Institucional',
      'Institucional/f√≠sica',
      'Neglig√™ncia',
      'Psicol√≥gica',
      'Sexual',
      'Suposto Uso de Subst√¢ncias Il√≠citas',
      'Suspeita de envenenamento',
      'Trabalho Infantil',
      'Verbal',
      'Idea√ß√£o suicida',
      'Patrimonial',
      'Outra'
    ];
    
    let tiposViolenciaSelecionados = [];
    
    // Renderiza as tags de tipo de viol√™ncia
    function renderizarTagsTipoViolencia() {
      const container = document.getElementById('tipoViolencia-tags');
      const hiddenInput = document.getElementById('tipoViolencia');
      
      if (tiposViolenciaSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum tipo de viol√™ncia adicionado</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = tiposViolenciaSelecionados.map((tipo, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium border border-red-200 shadow-sm">
          ${tipo}
          <button 
            type="button" 
            onclick="removerTipoViolencia(${index})"
            class="hover:bg-red-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');
      
      // Atualiza campo oculto com valores separados por v√≠rgula
      hiddenInput.value = tiposViolenciaSelecionados.join(', ');
    }
    
    // Remove um tipo de viol√™ncia
    function removerTipoViolencia(index) {
      tiposViolenciaSelecionados.splice(index, 1);
      renderizarTagsTipoViolencia();
      
      // Salva automaticamente ap√≥s remover tag
      if (typeof AutoSave !== 'undefined') {
        AutoSave.salvar();
      }
    }
    
    // Adiciona um tipo de viol√™ncia
    function adicionarTipoViolencia(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Primeiro, tenta encontrar uma correspond√™ncia similar
      const correspondencia = encontrarMelhorCorrespondencia(
        textoTrimmed, 
        tiposViolenciaPredefinidos, 
        tiposViolenciaSelecionados
      );
      
      // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
      const valorFinal = correspondencia || textoTrimmed;
      
      // Evita duplicatas
      if (!tiposViolenciaSelecionados.includes(valorFinal)) {
        tiposViolenciaSelecionados.push(valorFinal);
        renderizarTagsTipoViolencia();
        
        // Salva automaticamente ap√≥s adicionar tag
        if (typeof AutoSave !== 'undefined') {
          AutoSave.salvar();
        }
      }
      
      // Limpa input
      document.getElementById('tipoViolencia-input').value = '';
      document.getElementById('tipoViolencia-suggestions').classList.add('hidden');
    }
    
    // Filtra e mostra sugest√µes de tipo de viol√™ncia
    function mostrarSuggestoesTipoViolencia(query) {
      const suggestionsDiv = document.getElementById('tipoViolencia-suggestions');
      
      // Se query vazia, mostra todas as op√ß√µes dispon√≠veis
      const filtrados = query.trim() === '' 
        ? tiposViolenciaPredefinidos.filter(tipo => !tiposViolenciaSelecionados.includes(tipo))
        : tiposViolenciaPredefinidos.filter(tipo => 
            tipo.toLowerCase().includes(query.toLowerCase()) &&
            !tiposViolenciaSelecionados.includes(tipo)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(tipo => `
        <div 
          class="px-4 py-2 hover:bg-red-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarTipoViolencia('${tipo.replace(/'/g, "\\'")}')">
          ${tipo}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    // ========================================
    // SISTEMA DE TAGS - CLASSIFICA√á√ÉO DA VIOL√äNCIA
    // ========================================
    // IMPORTANTE: Valores devem coincidir com a valida√ß√£o da planilha
    const classificacoesViolenciaPredefinidas = [
      'Autoprovocada',
      'Intrafamiliar/Dom√©stica',
      'Extrafamiliar/Comunit√°ria/Urbana',
      'Coletiva',
      'Institucional',
      'Virtual'
    ];
    
    let classificacoesViolenciaSelecionadas = [];
    
    // Renderiza as tags de classifica√ß√£o da viol√™ncia
    function renderizarTagsClassificacaoViolencia() {
      const container = document.getElementById('classificacaoViolencia-tags');
      const hiddenInput = document.getElementById('classificacaoViolencia');
      
      if (classificacoesViolenciaSelecionadas.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhuma classifica√ß√£o adicionada</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = classificacoesViolenciaSelecionadas.map((classif, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium border border-orange-200 shadow-sm">
          ${classif}
          <button 
            type="button" 
            onclick="removerClassificacaoViolencia(${index})"
            class="hover:bg-orange-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');
      
      hiddenInput.value = classificacoesViolenciaSelecionadas.join(', ');
    }
    
    // Remove uma classifica√ß√£o da viol√™ncia
    function removerClassificacaoViolencia(index) {
      classificacoesViolenciaSelecionadas.splice(index, 1);
      renderizarTagsClassificacaoViolencia();
      
      // Salva automaticamente ap√≥s remover tag
      if (typeof AutoSave !== 'undefined') {
        AutoSave.salvar();
      }
    }
    
    // Adiciona uma classifica√ß√£o da viol√™ncia
    function adicionarClassificacaoViolencia(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Primeiro, tenta encontrar uma correspond√™ncia similar
      const correspondencia = encontrarMelhorCorrespondencia(
        textoTrimmed, 
        classificacoesViolenciaPredefinidas, 
        classificacoesViolenciaSelecionadas
      );
      
      // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
      const valorFinal = correspondencia || textoTrimmed;
      
      if (!classificacoesViolenciaSelecionadas.includes(valorFinal)) {
        classificacoesViolenciaSelecionadas.push(valorFinal);
        renderizarTagsClassificacaoViolencia();
        
        // Salva automaticamente ap√≥s adicionar tag
        if (typeof AutoSave !== 'undefined') {
          AutoSave.salvar();
        }
      }
      
      document.getElementById('classificacaoViolencia-input').value = '';
      document.getElementById('classificacaoViolencia-suggestions').classList.add('hidden');
    }
    
    // Filtra e mostra sugest√µes de classifica√ß√£o da viol√™ncia
    function mostrarSugestoesClassificacaoViolencia(query) {
      const suggestionsDiv = document.getElementById('classificacaoViolencia-suggestions');
      
      const filtrados = query.trim() === '' 
        ? classificacoesViolenciaPredefinidas.filter(classif => !classificacoesViolenciaSelecionadas.includes(classif))
        : classificacoesViolenciaPredefinidas.filter(classif => 
            classif.toLowerCase().includes(query.toLowerCase()) &&
            !classificacoesViolenciaSelecionadas.includes(classif)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(classif => `
        <div 
          class="px-4 py-2 hover:bg-orange-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarClassificacaoViolencia('${classif.replace(/'/g, "\\'")}')">
          ${classif}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    // ========================================
    // SISTEMA DE TAGS - MOTIVA√á√ÉO DA VIOL√äNCIA
    // ========================================
    // IMPORTANTE: Valores devem coincidir EXATAMENTE com a valida√ß√£o da planilha
    const motivacoesViolenciaPredefinidas = [
      'Discrimina√ß√£o',
      'Racismo',
      'G√™nero',
      'LGBTQIAPN+fobia',
      'Intoler√¢ncia religiosa',
      'Gordofobia',
      'Bullying'
    ];
    
    let motivacoesViolenciaSelecionadas = [];
    
    // Renderiza as tags de motiva√ß√£o da viol√™ncia
    function renderizarTagsMotivacaoViolencia() {
      const container = document.getElementById('motivacaoViolencia-tags');
      const hiddenInput = document.getElementById('motivacaoViolencia');
      
      if (motivacoesViolenciaSelecionadas.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhuma motiva√ß√£o adicionada</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = motivacoesViolenciaSelecionadas.map((motiv, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium border border-purple-200 shadow-sm">
          ${motiv}
          <button 
            type="button" 
            onclick="removerMotivacaoViolencia(${index})"
            class="hover:bg-purple-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');
      
      hiddenInput.value = motivacoesViolenciaSelecionadas.join(', ');
    }
    
    // Remove uma motiva√ß√£o da viol√™ncia
    function removerMotivacaoViolencia(index) {
      motivacoesViolenciaSelecionadas.splice(index, 1);
      renderizarTagsMotivacaoViolencia();
      
      // Salva automaticamente ap√≥s remover tag
      if (typeof AutoSave !== 'undefined') {
        AutoSave.salvar();
      }
    }
    
    // Adiciona uma motiva√ß√£o da viol√™ncia
    function adicionarMotivacaoViolencia(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Primeiro, tenta encontrar uma correspond√™ncia similar
      const correspondencia = encontrarMelhorCorrespondencia(
        textoTrimmed, 
        motivacoesViolenciaPredefinidas, 
        motivacoesViolenciaSelecionadas
      );
      
      // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
      const valorFinal = correspondencia || textoTrimmed;
      
      if (!motivacoesViolenciaSelecionadas.includes(valorFinal)) {
        motivacoesViolenciaSelecionadas.push(valorFinal);
        renderizarTagsMotivacaoViolencia();
        
        // Salva automaticamente ap√≥s adicionar tag
        if (typeof AutoSave !== 'undefined') {
          AutoSave.salvar();
        }
      }
      
      document.getElementById('motivacaoViolencia-input').value = '';
      document.getElementById('motivacaoViolencia-suggestions').classList.add('hidden');
    }
    
    // Filtra e mostra sugest√µes de motiva√ß√£o da viol√™ncia
    function mostrarSugestoesMotivacaoViolencia(query) {
      const suggestionsDiv = document.getElementById('motivacaoViolencia-suggestions');
      
      const filtrados = query.trim() === '' 
        ? motivacoesViolenciaPredefinidas.filter(motiv => !motivacoesViolenciaSelecionadas.includes(motiv))
        : motivacoesViolenciaPredefinidas.filter(motiv => 
            motiv.toLowerCase().includes(query.toLowerCase()) &&
            !motivacoesViolenciaSelecionadas.includes(motiv)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(motiv => `
        <div 
          class="px-4 py-2 hover:bg-purple-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarMotivacaoViolencia('${motiv.replace(/'/g, "\\'")}')">
          ${motiv}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    // ========================================
    // MENU MOBILE TOGGLE
    // ========================================
    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenuNav');
      const menuIcon = mobileMenu?.previousElementSibling?.querySelector('svg');
      if (mobileMenu) {
        mobileMenu.classList.toggle('show');
        if (menuIcon) {
          menuIcon.style.transform = mobileMenu.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
        }
      }
    }
    
    // Fecha o menu mobile ao clicar em qualquer link
    document.addEventListener('DOMContentLoaded', function() {
      const mobileMenuLinks = document.querySelectorAll('#mobileMenuNav a');
      mobileMenuLinks.forEach(link => {
        link.addEventListener('click', function() {
          const mobileMenu = document.getElementById('mobileMenuNav');
          const menuIcon = mobileMenu?.previousElementSibling?.querySelector('svg');
          if (mobileMenu) {
            mobileMenu.classList.remove('show');
            if (menuIcon) {
              menuIcon.style.transform = 'rotate(0deg)';
            }
          }
        });
      });
    });
    
    // Fecha o menu ao redimensionar para desktop
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768) {
        const mobileMenu = document.getElementById('mobileMenuNav');
        const menuIcon = mobileMenu?.previousElementSibling?.querySelector('svg');
        if (mobileMenu && mobileMenu.classList.contains('show')) {
          mobileMenu.classList.remove('show');
          if (menuIcon) {
            menuIcon.style.transform = 'rotate(0deg)';
          }
        }
      }
    });
    
    // ========================================
    // CONTROLE CONDICIONAL DO CAMPO PCD DETALHES
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      const pcdTranstornoSelect = document.getElementById('pcdTranstorno');
      const pcdDetalhesContainer = document.getElementById('pcdDetalhesContainer');
      const pcdDetalhesInput = document.getElementById('pcdDetalhes-input');
      const pcdDetalhesHidden = document.getElementById('pcdDetalhes');
      
      // Renderiza estado inicial das tags
      renderizarTagsTranstornos();
      renderizarTagsTipoViolencia();
      renderizarTagsClassificacaoViolencia();
      renderizarTagsMotivacaoViolencia();
      
      // Listener para mostrar/ocultar campo de detalhes
      pcdTranstornoSelect.addEventListener('change', function() {
        if (this.value === 'Sim') {
          // Mostra o campo de detalhes
          pcdDetalhesContainer.classList.remove('hidden');
          // Adiciona anima√ß√£o suave
          pcdDetalhesContainer.style.animation = 'slideDown 0.3s ease-out';
        } else {
          // Esconde o campo de detalhes
          pcdDetalhesContainer.classList.add('hidden');
          // Limpa os transtornos selecionados
          transtornosSelecionados = [];
          renderizarTagsTranstornos();
          // Limpa input
          pcdDetalhesInput.value = '';
          // Remove classe de erro se houver
          pcdDetalhesInput.classList.remove('field-error');
          document.getElementById('pcdDetalhes-tags').classList.remove('field-error');
        }
      });
      
      // Configura eventos do input de transtornos
      // Mostra todas op√ß√µes ao focar no campo vazio
      pcdDetalhesInput.addEventListener('focus', function(e) {
        mostrarSugestoesTranstornos(e.target.value);
      });
      
      // Filtra sugest√µes ao digitar
      pcdDetalhesInput.addEventListener('input', function(e) {
        mostrarSugestoesTranstornos(e.target.value);
      });
      
      // Adiciona ao pressionar Enter
      pcdDetalhesInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTranstorno(e.target.value);
        }
      });
      
      // Esconde sugest√µes ao clicar fora
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#pcdDetalhes-input') && !e.target.closest('#pcdDetalhes-suggestions')) {
          document.getElementById('pcdDetalhes-suggestions').classList.add('hidden');
        }
      });
      
      // === Eventos para Tipo de Viol√™ncia ===
      const tipoViolenciaInput = document.getElementById('tipoViolencia-input');
      
      tipoViolenciaInput.addEventListener('focus', function(e) {
        mostrarSuggestoesTipoViolencia(e.target.value);
      });
      
      tipoViolenciaInput.addEventListener('input', function(e) {
        mostrarSuggestoesTipoViolencia(e.target.value);
      });
      
      tipoViolenciaInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTipoViolencia(e.target.value);
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#tipoViolencia-input') && !e.target.closest('#tipoViolencia-suggestions')) {
          document.getElementById('tipoViolencia-suggestions').classList.add('hidden');
        }
      });
      
      // === Eventos para Classifica√ß√£o da Viol√™ncia ===
      const classificacaoViolenciaInput = document.getElementById('classificacaoViolencia-input');
      
      classificacaoViolenciaInput.addEventListener('focus', function(e) {
        mostrarSugestoesClassificacaoViolencia(e.target.value);
      });
      
      classificacaoViolenciaInput.addEventListener('input', function(e) {
        mostrarSugestoesClassificacaoViolencia(e.target.value);
      });
      
      classificacaoViolenciaInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarClassificacaoViolencia(e.target.value);
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#classificacaoViolencia-input') && !e.target.closest('#classificacaoViolencia-suggestions')) {
          document.getElementById('classificacaoViolencia-suggestions').classList.add('hidden');
        }
      });
      
      // === Eventos para Motiva√ß√£o da Viol√™ncia ===
      const motivacaoViolenciaInput = document.getElementById('motivacaoViolencia-input');
      
      motivacaoViolenciaInput.addEventListener('focus', function(e) {
        mostrarSugestoesMotivacaoViolencia(e.target.value);
      });
      
      motivacaoViolenciaInput.addEventListener('input', function(e) {
        mostrarSugestoesMotivacaoViolencia(e.target.value);
      });
      
      motivacaoViolenciaInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarMotivacaoViolencia(e.target.value);
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#motivacaoViolencia-input') && !e.target.closest('#motivacaoViolencia-suggestions')) {
          document.getElementById('motivacaoViolencia-suggestions').classList.add('hidden');
        }
      });
    });

    // Configura eventos do input
    document.addEventListener('DOMContentLoaded', function() {
      const input = document.getElementById('encaminhamento-input');
      
      // Renderiza estado inicial
      renderizarTags();
      
      // Mostra todas op√ß√µes ao focar no campo vazio
      input.addEventListener('focus', function(e) {
        mostrarSugestoes(e.target.value);
      });
      
      // Filtra sugest√µes ao digitar
      input.addEventListener('input', function(e) {
        mostrarSugestoes(e.target.value);
      });
      
      // Adiciona ao pressionar Enter
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarEncaminhamento(e.target.value);
        }
      });
      
      // Esconde sugest√µes ao clicar fora
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#encaminhamento-input') && !e.target.closest('#encaminhamento-suggestions')) {
          document.getElementById('encaminhamento-suggestions').classList.add('hidden');
        }
      });
    });

    // ========================================
    const instituicoes = [
      // CMEIs (51 unidades)
      { tipo: "CMEI", nomeOriginal: "CMEI Ana Maria Chaves Colares" },
      { tipo: "CMEI", nomeOriginal: "CMEI Anisio Spinola Teixeira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Cecilia Meireles" },
      { tipo: "CMEI", nomeOriginal: "CMEI Darcy Castello de Mendonca" },
      { tipo: "CMEI", nomeOriginal: "CMEI Darcy Vargas" },
      { tipo: "CMEI", nomeOriginal: "CMEI Dr Pedro Feu Rosa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Ernestina Pessoa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Georgina da Trindade Faria" },
      { tipo: "CMEI", nomeOriginal: "CMEI Gilda de Athayde Ramos" },
      { tipo: "CMEI", nomeOriginal: "CMEI Joao Pedro de Aguiar" },
      { tipo: "CMEI", nomeOriginal: "CMEI Laurentina Mendonca Correa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Lidia Rocha Feitosa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Lizandre Ignes Carpanedo do Carmo" },
      { tipo: "CMEI", nomeOriginal: "CMEI Marlene Orlande Simonetti" },
      { tipo: "CMEI", nomeOriginal: "CMEI Nelcy da Silva Braga" },
      { tipo: "CMEI", nomeOriginal: "CMEI Ocarlina Nunes Andrade" },
      { tipo: "CMEI", nomeOriginal: "CMEI Odila Simoes" },
      { tipo: "CMEI", nomeOriginal: "CMEI Professora Sophia Musengny Loureiro" },
      { tipo: "CMEI", nomeOriginal: "CMEI Reinaldo Ridolfi" },
      { tipo: "CMEI", nomeOriginal: "CMEI Rubem Braga" },
      { tipo: "CMEI", nomeOriginal: "CMEI Sinclair Phillips" },
      { tipo: "CMEI", nomeOriginal: "CMEI Terezinha Vasconcellos Salvador" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Aecio Bispo dos Santos" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Alvaro Fernandes Lima" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Carlita Correa Pereira" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Denizart Santos" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Dom Joao Batista da Motta e Albuquerque" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Dr Thomaz Tommasi" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Eldina Maria Soares Braga" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Geisla da Cruz Militao" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Jacy Alves Fraga" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Jacyntha Ferreira de Souza Simoes" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Luiz Carlos Grecco" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Luiza Pereira Muniz Correa" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Magnolia Dias Miranda Cunha" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Maria Goretti Coutinho Cosme" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Maria Nazareth Menegueli" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Menino Jesus" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Padre Giovanni Bartesaghi" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Professor Carlos Alberto Martinelli de Souza" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Professora Cida Barreto" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Robson Jose Nassur Peixoto" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Rubens Duarte de Albuquerque" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Rubens Jose Vervloet Gomes" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Sebastiao Perovano" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Silvanete da Silva Rosa Rocha" },
      { tipo: "CMEI", nomeOriginal: "CMEI TI Valdivia da Penha Antunes Rodrigues" },
      { tipo: "CMEI", nomeOriginal: "CMEI Yolanda Lucas da Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Zelia Vianna de Aguiar" },
      { tipo: "CMEI", nomeOriginal: "CMEI Zenaide Genoveva Marcarini Cavalcanti" },
      { tipo: "CMEI", nomeOriginal: "CMEI Zilmar Alves de Melo" },
      
      // EMEFs (55 unidades)
      { tipo: "EMEF", nomeOriginal: "EMEF Adao Benezath" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adevalni Sysesmundo Ferreira de Azevedo" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adilson da Silva Castro" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alberto de Almeida" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alvaro de Castro Mattos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alvimar Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Aristobulo Barbosa Leao" },
      { tipo: "EMEF", nomeOriginal: "EMEF Arthur da Costa e Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Castelo Branco" },
      { tipo: "EMEF", nomeOriginal: "EMEF Ceciliano Abel de Almeida" },
      { tipo: "EMEF", nomeOriginal: "EMEF Custodia Dias de Campos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Eber Louzada Zippinotti" },
      { tipo: "EMEF", nomeOriginal: "EMEF EJA Prof Admardo Serafim de Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Eliane Rodrigues dos Santos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Elzira Vivacqua dos Santos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Experimental de Vitoria - UFES" },
      { tipo: "EMEF", nomeOriginal: "EMEF Francisco Lacerda de Aguiar" },
      { tipo: "EMEF", nomeOriginal: "EMEF Heloisa Abreu Judice de Mattos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Irma Jacinta Soares de Souza Lima" },
      { tipo: "EMEF", nomeOriginal: "EMEF Juscelino Kubitschek de Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Lenir Borlot" },
      { tipo: "EMEF", nomeOriginal: "EMEF Marechal Mascarenhas de Moraes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Jose Costa Moraes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Leonor Pereira da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Madalena de Oliveira Domingues" },
      { tipo: "EMEF", nomeOriginal: "EMEF Marieta Escobar" },
      { tipo: "EMEF", nomeOriginal: "EMEF Mauro Braga" },
      { tipo: "EMEF", nomeOriginal: "EMEF Neusa Nunes Goncalves" },
      { tipo: "EMEF", nomeOriginal: "EMEF Octacilio Lomba" },
      { tipo: "EMEF", nomeOriginal: "EMEF Orlandina D'Almeida Lucas" },
      { tipo: "EMEF", nomeOriginal: "EMEF Otto Ewald Junior" },
      { tipo: "EMEF", nomeOriginal: "EMEF Padre Anchieta" },
      { tipo: "EMEF", nomeOriginal: "EMEF Padre Guido Ceotto" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prezideu Amorim" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Joao Bandeira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Maria Stella de Novaes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Vercenilio da Silva Pascoal" },
      { tipo: "EMEF", nomeOriginal: "EMEF Professora Regina Maria Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Rita de Cassia Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Sao Vicente de Paulo" },
      { tipo: "EMEF", nomeOriginal: "EMEF Suzete Cuendet" },
      { tipo: "EMEF", nomeOriginal: "EMEF Tancredo de Almeida Neves" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Amilton Monteiro da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Anacleta Schneider Lucas" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Edna de Mattos Siqueira Gaudio" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Izaura Marques da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Jose Aureo Monjardim" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Jose Lemos de Miranda" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Moacyr Avidos" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Paulo Reglus Neves Freire" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Paulo Roberto Vieira Gomes" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Professora Eunice Pereira Silveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Ronaldo Soares" },
      { tipo: "EMEF", nomeOriginal: "EMEF Zilda Andrade" }
    ];

    // ========================================
    // GERAR SIGLAS AUTOMATICAMENTE
    // ========================================
    function gerarSigla(nomeCompleto) {
      // Remove o prefixo CMEI/EMEF e TI
      let nome = nomeCompleto.replace(/^(CMEI|EMEF)\s+(TI\s+)?/i, '');
      
      // Palavras que devem ser ignoradas ao gerar siglas
      const ignorar = ['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o', 'as', 'os'];
      
      // Separa as palavras e pega as iniciais das palavras importantes
      const palavras = nome.split(' ').filter(p => p.length > 0);
      const sigla = palavras
        .filter(palavra => !ignorar.includes(palavra.toLowerCase()))
        .map(palavra => palavra[0].toUpperCase())
        .join('');
      
      return sigla;
    }

    // Adiciona siglas a cada institui√ß√£o
    instituicoes.forEach(inst => {
      inst.sigla = gerarSigla(inst.nomeOriginal);
    });

    // ========================================
    // VARI√ÅVEIS DE CONTROLE DO AUTOCOMPLETE
    // ========================================
    let tipoSelecionado = '';
    let instituicoesFiltradas = [];
    let indiceSelecionado = -1;

    // ========================================
    // ELEMENTOS DO DOM
    // ========================================
    const tipoInstituicaoSelect = document.getElementById('tipoInstituicao');
    const cmeiEmefInput = document.getElementById('cmeiEmef');
    const autocompleteList = document.getElementById('autocompleteList');

    // ========================================
    // EVENTO: Mudan√ßa no tipo de institui√ß√£o
    // ========================================
    tipoInstituicaoSelect.addEventListener('change', function() {
      tipoSelecionado = this.value;
      
      if (tipoSelecionado) {
        // Habilita o campo de institui√ß√£o
        cmeiEmefInput.disabled = false;
        cmeiEmefInput.placeholder = 'Digite para buscar...';
        cmeiEmefInput.value = '';
        cmeiEmefInput.focus();
        
        // Filtra institui√ß√µes pelo tipo
        instituicoesFiltradas = instituicoes.filter(inst => inst.tipo === tipoSelecionado);
      } else {
        // Desabilita o campo de institui√ß√£o
        cmeiEmefInput.disabled = true;
        cmeiEmefInput.placeholder = 'Primeiro selecione o tipo de institui√ß√£o';
        cmeiEmefInput.value = '';
        autocompleteList.classList.remove('show');
      }
    });

    // ========================================
    // EVENTO: Input no campo de autocomplete
    // ========================================
    cmeiEmefInput.addEventListener('input', function() {
      const termo = this.value.trim();
      indiceSelecionado = -1;
      
      if (termo.length === 0) {
        autocompleteList.classList.remove('show');
        return;
      }
      
      // Filtra as institui√ß√µes com base no termo
      const resultados = filtrarInstituicoes(termo);
      
      // Renderiza as sugest√µes
      renderizarSugestoes(resultados);
    });

    // ========================================
    // EVENTO: Navega√ß√£o por teclado
    // ========================================
    cmeiEmefInput.addEventListener('keydown', function(e) {
      const items = autocompleteList.querySelectorAll('.autocomplete-item');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        indiceSelecionado = Math.min(indiceSelecionado + 1, items.length - 1);
        atualizarSelecaoVisual(items);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        indiceSelecionado = Math.max(indiceSelecionado - 1, -1);
        atualizarSelecaoVisual(items);
      } else if (e.key === 'Enter') {
        e.preventDefault();
        if (indiceSelecionado >= 0 && items[indiceSelecionado]) {
          items[indiceSelecionado].click();
        }
      } else if (e.key === 'Escape') {
        autocompleteList.classList.remove('show');
      }
    });

    // ========================================
    // EVENTO: Clique fora fecha autocomplete
    // ========================================
    document.addEventListener('click', function(e) {
      if (!cmeiEmefInput.contains(e.target) && !autocompleteList.contains(e.target)) {
        autocompleteList.classList.remove('show');
      }
    });

    // ========================================
    // FUN√á√ÉO: Filtrar institui√ß√µes
    // ========================================
    function filtrarInstituicoes(termo) {
      const termoLower = removerAcentos(termo.toLowerCase());
      const termoSemEspacos = termoLower.replace(/\s+/g, '');
      
      return instituicoesFiltradas.filter(inst => {
        const nomeNormalizado = removerAcentos(inst.nomeOriginal.toLowerCase());
        const siglaNormalizada = removerAcentos(inst.sigla.toLowerCase());
        
        // Busca por palavras no nome
        const palavras = termoLower.split(' ').filter(p => p.length > 0);
        const matchPorPalavras = palavras.every(palavra => nomeNormalizado.includes(palavra));
        
        // Busca pela sigla (sem espa√ßos)
        const matchPorSigla = siglaNormalizada.includes(termoSemEspacos);
        
        // Busca pela sigla com caracteres consecutivos (ex: "ACM" encontra "Ana Chaves Mendes")
        const matchPorIniciaisConsecutivas = siglaNormalizada.startsWith(termoSemEspacos);
        
        return matchPorPalavras || matchPorSigla || matchPorIniciaisConsecutivas;
      });
    }

    // ========================================
    // FUN√á√ÉO: Remover acentos
    // ========================================
    function removerAcentos(texto) {
      return texto.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    // ========================================
    // FUN√á√ÉO: Renderizar sugest√µes
    // ========================================
    function renderizarSugestoes(resultados) {
      autocompleteList.innerHTML = '';
      
      if (resultados.length === 0) {
        autocompleteList.innerHTML = '<div class="no-results">üîç Nenhuma institui√ß√£o encontrada</div>';
        autocompleteList.classList.add('show');
        return;
      }
      
      resultados.forEach((inst, index) => {
        const item = document.createElement('div');
        item.className = 'autocomplete-item';
        
        // Badge do tipo
        const badge = document.createElement('span');
        badge.className = `autocomplete-badge ${inst.tipo.toLowerCase()}`;
        badge.textContent = inst.tipo;
        
        // Container para nome e sigla
        const infoContainer = document.createElement('div');
        infoContainer.className = 'flex flex-col';
        
        // Nome sem a redund√¢ncia da sigla
        const nomeSemTipo = inst.nomeOriginal.replace(inst.tipo + ' ', '');
        const nomeSpan = document.createElement('span');
        nomeSpan.className = 'autocomplete-nome';
        nomeSpan.textContent = nomeSemTipo;
        
        // Sigla (menor e em cinza)
        const siglaSpan = document.createElement('span');
        siglaSpan.className = 'text-xs text-gray-500 mt-0.5';
        siglaSpan.textContent = `Sigla: ${inst.sigla}`;
        
        infoContainer.appendChild(nomeSpan);
        infoContainer.appendChild(siglaSpan);
        
        item.appendChild(badge);
        item.appendChild(infoContainer);
        
        // Evento de clique
        item.addEventListener('click', function() {
          selecionarInstituicao(inst);
        });
        
        autocompleteList.appendChild(item);
      });
      
      autocompleteList.classList.add('show');
    }

    // ========================================
    // FUN√á√ÉO: Selecionar institui√ß√£o
    // ========================================
    function selecionarInstituicao(inst) {
      // Define o valor completo original no campo (para envio ao backend)
      cmeiEmefInput.value = inst.nomeOriginal;
      
      // Fecha a lista
      autocompleteList.classList.remove('show');
      
      // Remove classe de erro se houver
      cmeiEmefInput.classList.remove('field-error');
    }

    // ========================================
    // FUN√á√ÉO: Atualizar sele√ß√£o visual
    // ========================================
    function atualizarSelecaoVisual(items) {
      items.forEach((item, index) => {
        if (index === indiceSelecionado) {
          item.classList.add('active');
          item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        } else {
          item.classList.remove('active');
        }
      });
    }

    // ========================================
    // INICIALIZA√á√ÉO DE REGI√ïES
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      const regioesDisponiveis = [
        'Centro', 'Continental', 'S√£o Pedro', 'Santo Ant√¥nio',
        'Praia do Canto', 'Jardim da Penha', 'Jardim Camburi',
        'Maru√≠pe', 'Bento Ferreira'
      ];
      carregarOpcoesRegiao(regioesDisponiveis);
    });
    
    // Fun√ß√£o para carregar op√ß√µes de Regi√£o dinamicamente (mantida para compatibilidade)
    function carregarOpcoesRegiao(regioes) {
      const select = document.getElementById('regiao');
      select.innerHTML = '<option value="">Selecione...</option>';
      
      regioes.forEach(function(regiao) {
        const option = document.createElement('option');
        option.value = regiao;
        option.textContent = regiao;
        select.appendChild(option);
      });
    }
    
    // ========================================
    // M√ìDULO DE AUTO-SAVE
    // ========================================
    const AutoSave = {
      CHAVE_STORAGE: 'rascunho_novo_caso',
      DEBOUNCE_TIMEOUT: null,
      DEBOUNCE_DELAY: 1000, // 1 segundo
      BACKUP_INTERVAL: null,
      BACKUP_DELAY: 30000, // 30 segundos
    
      // Inicializar sistema de auto-save
      inicializar() {
        console.log('üîÑ Inicializando auto-save...');
        
        // Carregar rascunho ao abrir p√°gina (aguarda um pouco para garantir que tudo est√° carregado)
        setTimeout(() => {
          this.carregarRascunho();
        }, 1000);
        
        // Configurar listeners para todos os campos
        this.configurarListeners();
        
        // Iniciar backup autom√°tico a cada 30s
        this.iniciarBackupAutomatico();
        
        // Salvar antes de sair da p√°gina
        window.addEventListener('beforeunload', () => this.salvar());
      },
      
      // Configurar eventos de salvamento
      configurarListeners() {
        const form = document.getElementById('registroForm');
        if (!form) return;
        
        // Campos de texto com debounce
        form.querySelectorAll('input[type="text"], input[type="number"], textarea').forEach(campo => {
          campo.addEventListener('input', () => this.salvarComDebounce());
        });
        
        // Campos de data com debounce
        form.querySelectorAll('input[type="date"]').forEach(campo => {
          campo.addEventListener('change', () => this.salvar());
        });
        
        // Selects (salvamento imediato)
        form.querySelectorAll('select').forEach(campo => {
          campo.addEventListener('change', () => this.salvar());
        });
        
        // Radio buttons (salvamento imediato)
        form.querySelectorAll('input[type="radio"]').forEach(campo => {
          campo.addEventListener('change', () => this.salvar());
        });
        
        // Observar mudan√ßas nos sistemas de tags
        this.observarMudancasTags();
      },
      
      // Salvamento com debounce (para campos de texto)
      salvarComDebounce() {
        clearTimeout(this.DEBOUNCE_TIMEOUT);
        this.DEBOUNCE_TIMEOUT = setTimeout(() => {
          this.salvar();
        }, this.DEBOUNCE_DELAY);
      },
      
      // Salvar dados no localStorage
      salvar() {
        try {
          const dados = this.coletarDados();
          
          // N√£o salva se n√£o houver dados
          if (Object.keys(dados).length === 0) {
            return;
          }
          
          const rascunho = {
            timestamp: Date.now(),
            versao: "1.0",
            dados: dados
          };
          
          localStorage.setItem(this.CHAVE_STORAGE, JSON.stringify(rascunho));
          
          // Atualizar indicador visual
          this.atualizarIndicadorSalvamento(new Date());
          
          console.log('üíæ Auto-save: rascunho salvo');
          
        } catch (error) {
          console.error('‚ùå Erro ao salvar rascunho:', error);
          if (error.name === 'QuotaExceededError') {
            console.warn('‚ö†Ô∏è localStorage cheio, tentando limpar e salvar novamente...');
            localStorage.removeItem(this.CHAVE_STORAGE);
            try {
              const dados = this.coletarDados();
              const rascunho = {
                timestamp: Date.now(),
                versao: "1.0",
                dados: dados
              };
              localStorage.setItem(this.CHAVE_STORAGE, JSON.stringify(rascunho));
              this.atualizarIndicadorSalvamento(new Date());
            } catch (e2) {
              console.error('‚ùå Erro persistente ao salvar:', e2);
            }
          }
        }
      },
      
      // Coletar dados de todos os campos
      coletarDados() {
        const dados = {};
        const form = document.getElementById('registroForm');
        if (!form) return dados;
        
        // Campos simples (input, select, textarea)
        form.querySelectorAll('input, select, textarea').forEach(campo => {
          // Ignora bot√µes e campos de input de tags
          if (campo.type === 'button' || campo.type === 'submit') return;
          if (campo.id && (campo.id.includes('-input') || campo.id.includes('-tags'))) return;
          
          const name = campo.name || campo.id;
          if (!name) return;
          
          let valor = '';
          
          if (campo.type === 'radio') {
            if (campo.checked) {
              dados[name] = campo.value;
            }
          } else if (campo.type === 'checkbox') {
            if (campo.checked) {
              dados[name] = campo.value;
            }
          } else if (campo.tagName === 'SELECT') {
            valor = campo.value || '';
            if (valor) dados[name] = valor;
          } else if (campo.type === 'hidden') {
            valor = campo.value || '';
            if (valor) dados[name] = valor;
          } else {
            valor = campo.value || '';
            if (valor && valor.trim() !== '') {
              dados[name] = valor;
            }
          }
        });
        
        // Campos hidden de tags (que cont√™m os valores reais)
        ['pcdDetalhes', 'tipoViolencia', 'classificacaoViolencia', 'motivacaoViolencia', 'encaminhamento'].forEach(id => {
          const campo = document.getElementById(id);
          if (campo && campo.value) {
            dados[id] = campo.value;
          }
        });
        
        // Arrays de tags (backup)
        if (typeof transtornosSelecionados !== 'undefined' && Array.isArray(transtornosSelecionados) && transtornosSelecionados.length > 0) {
          dados.transtornosSelecionados = [...transtornosSelecionados];
        }
        if (typeof tiposViolenciaSelecionados !== 'undefined' && Array.isArray(tiposViolenciaSelecionados) && tiposViolenciaSelecionados.length > 0) {
          dados.tiposViolenciaSelecionados = [...tiposViolenciaSelecionados];
        }
        if (typeof classificacoesSelecionadas !== 'undefined' && Array.isArray(classificacoesSelecionadas) && classificacoesSelecionadas.length > 0) {
          dados.classificacoesSelecionadas = [...classificacoesSelecionadas];
        }
        if (typeof motivacoesSelecionadas !== 'undefined' && Array.isArray(motivacoesSelecionadas) && motivacoesSelecionadas.length > 0) {
          dados.motivacoesSelecionadas = [...motivacoesSelecionadas];
        }
        if (typeof encaminhamentosSelecionados !== 'undefined' && Array.isArray(encaminhamentosSelecionados) && encaminhamentosSelecionados.length > 0) {
          dados.encaminhamentosSelecionados = [...encaminhamentosSelecionados];
        }
        
        return dados;
      },
      
      // Carregar rascunho do localStorage
      carregarRascunho() {
        try {
          const rascunhoStr = localStorage.getItem(this.CHAVE_STORAGE);
          
          if (!rascunhoStr) {
            console.log('‚ÑπÔ∏è Nenhum rascunho encontrado');
            return;
          }
          
          const rascunho = JSON.parse(rascunhoStr);
          
          if (!rascunho.dados || Object.keys(rascunho.dados).length === 0) {
            console.log('‚ÑπÔ∏è Rascunho vazio encontrado');
            localStorage.removeItem(this.CHAVE_STORAGE);
            return;
          }
          
          console.log('üìÇ Carregando rascunho salvo em:', new Date(rascunho.timestamp));
          
          this.preencherFormulario(rascunho.dados);
          this.atualizarIndicadorSalvamento(new Date(rascunho.timestamp));
          
          // Mostrar notifica√ß√£o discreta
          this.mostrarNotificacaoRascunho(rascunho.timestamp);
          
        } catch (error) {
          console.error('‚ùå Erro ao carregar rascunho:', error);
          // Limpar rascunho corrompido
          localStorage.removeItem(this.CHAVE_STORAGE);
        }
      },
      
      // Preencher formul√°rio com dados salvos
      preencherFormulario(dados) {
        const form = document.getElementById('registroForm');
        if (!form) return;
        
        // Primeiro, restaurar campos normais
        Object.keys(dados).forEach(id => {
          // Ignora arrays de tags (ser√£o restaurados depois)
          if (id.endsWith('Selecionados') || id.endsWith('Selecionadas')) {
            return;
          }
          
          const valor = dados[id];
          if (valor === null || valor === undefined || valor === '') return;
          
          // Tenta encontrar por name primeiro
          let campo = form.querySelector(`[name="${id}"]`);
          
          // Se n√£o encontrar, tenta por id
          if (!campo) {
            campo = document.getElementById(id);
          }
          
          if (campo) {
            try {
              if (campo.type === 'radio') {
                // Radio buttons
                const radio = document.querySelector(`input[name="${id}"][value="${valor}"]`);
                if (radio) {
                  radio.checked = true;
                  radio.dispatchEvent(new Event('change', { bubbles: true }));
                }
              } else if (campo.tagName === 'SELECT') {
                // Selects
                campo.value = valor;
                // Atualiza visualmente selects customizados
                const wrapper = campo.closest('.custom-select-wrapper');
                if (wrapper) {
                  const trigger = wrapper.querySelector('.custom-select-trigger');
                  if (trigger) {
                    const selectedOption = campo.options[campo.selectedIndex];
                    if (selectedOption) {
                      trigger.textContent = selectedOption.textContent;
                    }
                  }
                }
                // Disparar evento change para atualizar campos dependentes
                campo.dispatchEvent(new Event('change', { bubbles: true }));
                
                // Tratamento especial para campo PCD condicional
                if (id === 'pcdTranstorno') {
                  const pcdDetalhesContainer = document.getElementById('pcdDetalhesContainer');
                  if (pcdDetalhesContainer) {
                    if (valor === 'Sim') {
                      pcdDetalhesContainer.classList.remove('hidden');
                      pcdDetalhesContainer.style.animation = 'slideDown 0.3s ease-out';
                    } else {
                      pcdDetalhesContainer.classList.add('hidden');
                    }
                  }
                }
                
                // Tratamento especial para tipoInstituicao (habilita campo de autocomplete)
                if (id === 'tipoInstituicao') {
                  const cmeiEmefInput = document.getElementById('cmeiEmef');
                  if (cmeiEmefInput) {
                    cmeiEmefInput.disabled = !valor;
                    if (!valor) {
                      cmeiEmefInput.placeholder = 'Primeiro selecione o tipo de institui√ß√£o';
                    } else {
                      cmeiEmefInput.placeholder = 'Digite para filtrar as institui√ß√µes dispon√≠veis';
                    }
                  }
                }
              } else if (campo.type === 'date') {
                // Campos de data
                campo.value = valor;
              } else if (campo.type === 'hidden') {
                // Campos hidden (tags)
                campo.value = valor;
              } else {
                // Campos normais
                campo.value = valor;
              }
            } catch (e) {
              console.warn('‚ö†Ô∏è Erro ao restaurar campo', id, ':', e);
            }
          }
        });
        
        // Aguarda um pouco e depois restaura tags
        setTimeout(() => {
          // Restaurar arrays de tags
          if (dados.transtornosSelecionados && Array.isArray(dados.transtornosSelecionados)) {
            if (typeof transtornosSelecionados !== 'undefined') {
              transtornosSelecionados = [...dados.transtornosSelecionados];
              if (typeof renderizarTagsTranstornos === 'function') {
                renderizarTagsTranstornos();
              }
            }
          }
          
          if (dados.tiposViolenciaSelecionados && Array.isArray(dados.tiposViolenciaSelecionados)) {
            if (typeof tiposViolenciaSelecionados !== 'undefined') {
              tiposViolenciaSelecionados = [...dados.tiposViolenciaSelecionados];
              if (typeof renderizarTagsTipoViolencia === 'function') {
                renderizarTagsTipoViolencia();
              }
            }
          }
          
          if (dados.classificacoesSelecionadas && Array.isArray(dados.classificacoesSelecionadas)) {
            if (typeof classificacoesSelecionadas !== 'undefined') {
              classificacoesSelecionadas = [...dados.classificacoesSelecionadas];
              if (typeof renderizarTagsClassificacaoViolencia === 'function') {
                renderizarTagsClassificacaoViolencia();
              }
            }
          }
          
          if (dados.motivacoesSelecionadas && Array.isArray(dados.motivacoesSelecionadas)) {
            if (typeof motivacoesSelecionadas !== 'undefined') {
              motivacoesSelecionadas = [...dados.motivacoesSelecionadas];
              if (typeof renderizarTagsMotivacaoViolencia === 'function') {
                renderizarTagsMotivacaoViolencia();
              }
            }
          }
          
          if (dados.encaminhamentosSelecionados && Array.isArray(dados.encaminhamentosSelecionados)) {
            if (typeof encaminhamentosSelecionados !== 'undefined') {
              encaminhamentosSelecionados = [...dados.encaminhamentosSelecionados];
              if (typeof renderizarTags === 'function') {
                renderizarTags();
              }
            }
          }
          
          // Restaurar tags a partir de strings (campos hidden)
          if (dados.pcdDetalhes) {
            this.recriarTags('pcdDetalhes', dados.pcdDetalhes);
          }
          if (dados.tipoViolencia) {
            this.recriarTags('tipoViolencia', dados.tipoViolencia);
          }
          if (dados.classificacaoViolencia) {
            this.recriarTags('classificacaoViolencia', dados.classificacaoViolencia);
          }
          if (dados.motivacaoViolencia) {
            this.recriarTags('motivacaoViolencia', dados.motivacaoViolencia);
          }
          if (dados.encaminhamento) {
            this.recriarTags('encaminhamento', dados.encaminhamento);
          }
          
          // Atualizar progresso
          if (typeof atualizarProgresso === 'function') {
            atualizarProgresso();
          }
        }, 300);
      },
      
      // Recriar tags visuais a partir de string salva
      recriarTags(campoId, valorString) {
        if (!valorString) return;
        
        // Separa por v√≠rgula e limpa espa√ßos
        const valores = valorString.split(',').map(v => v.trim()).filter(v => v);
        
        // Determinar qual sistema de tags usar baseado no ID
        let funcaoAdicionar;
        if (campoId === 'pcdDetalhes') {
          funcaoAdicionar = window.adicionarTranstorno;
        } else if (campoId === 'tipoViolencia') {
          funcaoAdicionar = window.adicionarTipoViolencia;
        } else if (campoId === 'classificacaoViolencia') {
          funcaoAdicionar = window.adicionarClassificacaoViolencia;
        } else if (campoId === 'motivacaoViolencia') {
          funcaoAdicionar = window.adicionarMotivacaoViolencia;
        } else if (campoId === 'encaminhamento') {
          funcaoAdicionar = window.adicionarEncaminhamento;
        }
        
        if (funcaoAdicionar) {
          valores.forEach(valor => {
            try {
              funcaoAdicionar(valor);
            } catch (e) {
              console.warn('‚ö†Ô∏è Erro ao recriar tag', valor, ':', e);
            }
          });
        }
      },
      
      // Observar mudan√ßas nos sistemas de tags
      observarMudancasTags() {
        // Observar mudan√ßas nos campos hidden de tags
        ['pcdDetalhes', 'tipoViolencia', 'classificacaoViolencia', 'motivacaoViolencia', 'encaminhamento'].forEach(id => {
          const campo = document.getElementById(id);
          if (campo) {
            // Usar MutationObserver para detectar mudan√ßas no value
            const observer = new MutationObserver(() => this.salvar());
            observer.observe(campo, { attributes: true, attributeFilter: ['value'] });
            
            // Tamb√©m observar mudan√ßas diretas
            campo.addEventListener('change', () => this.salvar());
            
            // Observar mudan√ßas no input event tamb√©m
            const inputCampo = document.getElementById(id + '-input');
            if (inputCampo) {
              inputCampo.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                  setTimeout(() => this.salvar(), 100);
                }
              });
            }
          }
        });
      },
      
      // Iniciar backup autom√°tico
      iniciarBackupAutomatico() {
        this.BACKUP_INTERVAL = setInterval(() => {
          this.salvar();
          console.log('‚è∞ Backup autom√°tico executado');
        }, this.BACKUP_DELAY);
      },
      
      // Atualizar indicador visual de salvamento
      atualizarIndicadorSalvamento(data) {
        const indicador = document.getElementById('indicadorRascunho');
        if (!indicador) return;
        
        const tempo = this.formatarTempoRelativo(data);
        indicador.innerHTML = `
          <span class="text-xs text-green-600 flex items-center gap-1">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            Rascunho salvo ${tempo}
          </span>
        `;
        indicador.classList.remove('hidden');
      },
      
      // Mostrar notifica√ß√£o discreta de rascunho carregado
      mostrarNotificacaoRascunho(timestamp) {
        const tempo = this.formatarTempoRelativo(new Date(timestamp));
        
        if (typeof mostrarAlerta === 'function') {
          mostrarAlerta(`üìÇ Rascunho recuperado (salvo ${tempo})`, 'info');
        }
      },
      
      // Formatar tempo relativo (ex: "h√° 2 minutos")
      formatarTempoRelativo(data) {
        const agora = new Date();
        const diff = agora - data;
        const segundos = Math.floor(diff / 1000);
        const minutos = Math.floor(segundos / 60);
        const horas = Math.floor(minutos / 60);
        const dias = Math.floor(horas / 24);
        
        if (segundos < 60) return 'agora h√° pouco';
        if (minutos < 60) return `h√° ${minutos} minuto${minutos > 1 ? 's' : ''}`;
        if (horas < 24) return `h√° ${horas} hora${horas > 1 ? 's' : ''}`;
        if (dias < 7) return `h√° ${dias} dia${dias > 1 ? 's' : ''}`;
        return `em ${data.toLocaleDateString('pt-BR')}`;
      },
      
      // Limpar rascunho
      limpar() {
        localStorage.removeItem(this.CHAVE_STORAGE);
        console.log('üóëÔ∏è Rascunho limpo');
        
        const indicador = document.getElementById('indicadorRascunho');
        if (indicador) {
          indicador.classList.add('hidden');
        }
        
        // Atualizar status antigo tamb√©m (compatibilidade)
        if (typeof atualizarStatusRascunho === 'function') {
          atualizarStatusRascunho(false);
        }
      },
      
      // Parar backup autom√°tico (ao sair da p√°gina)
      parar() {
        if (this.BACKUP_INTERVAL) {
          clearInterval(this.BACKUP_INTERVAL);
          this.BACKUP_INTERVAL = null;
        }
        if (this.DEBOUNCE_TIMEOUT) {
          clearTimeout(this.DEBOUNCE_TIMEOUT);
          this.DEBOUNCE_TIMEOUT = null;
        }
      }
    };
    
    // Fun√ß√µes de compatibilidade (manter para n√£o quebrar c√≥digo existente)
    function salvarRascunho() {
      AutoSave.salvar();
    }
    
    function limparRascunho() {
      AutoSave.limpar();
    }
    
    function carregarRascunho() {
      AutoSave.carregarRascunho();
    }
    
    // Fun√ß√£o de compatibilidade para atualizarStatusRascunho (mantida para compatibilidade)
    function atualizarStatusRascunho(temRascunho) {
      if (temRascunho) {
        try {
          const rascunhoStr = localStorage.getItem(AutoSave.CHAVE_STORAGE);
          if (rascunhoStr) {
            const rascunho = JSON.parse(rascunhoStr);
            const draftStatus = document.getElementById('draftStatus');
            const draftLastSave = document.getElementById('draftLastSave');
            if (draftStatus) draftStatus.classList.remove('hidden');
            if (draftLastSave) draftLastSave.textContent = `Salvo: ${new Date(rascunho.timestamp).toLocaleString('pt-BR')}`;
          }
        } catch (e) {
          const draftStatus = document.getElementById('draftStatus');
          if (draftStatus) draftStatus.classList.add('hidden');
        }
      } else {
        const draftStatus = document.getElementById('draftStatus');
        if (draftStatus) draftStatus.classList.add('hidden');
      }
    }
    
    // ========================================
    // INDICADOR DE PROGRESSO
    // ========================================
    function calcularProgresso() {
      const form = document.getElementById('registroForm');
      const camposObrigatorios = form.querySelectorAll('[required]');
      
      // Agrupa radio buttons por name para evitar contagem duplicada
      const gruposRadioProcessados = new Set();
      const camposUnicos = [];
      
      camposObrigatorios.forEach(campo => {
        if (campo.type === 'radio') {
          if (!gruposRadioProcessados.has(campo.name)) {
            gruposRadioProcessados.add(campo.name);
            camposUnicos.push(campo);
          }
        } else {
          camposUnicos.push(campo);
        }
      });
      
      const totalCampos = camposUnicos.length;
      let camposPreenchidos = 0;
      const camposPendentes = [];
      
      console.log('üìä Calculando progresso - Total de campos obrigat√≥rios:', totalCampos);
      
      camposUnicos.forEach(campo => {
        let preenchido = false;
        
        // Valida√ß√£o especial para campos hidden de tags ANTES da valida√ß√£o padr√£o
        // tipoViolencia (sempre obrigat√≥rio)
        if (campo.id === 'tipoViolencia' || campo.name === 'tipoViolencia') {
          const valorHidden = campo.value && campo.value.trim() !== '';
          const temArray = typeof tiposViolenciaSelecionados !== 'undefined' && tiposViolenciaSelecionados.length > 0;
          preenchido = valorHidden || temArray;
        }
        // pcdDetalhes (obrigat√≥rio apenas se PCD = Sim)
        else if (campo.id === 'pcdDetalhes' || campo.name === 'pcdDetalhes') {
          const pcdTranstorno = document.getElementById('pcdTranstorno')?.value || '';
          if (pcdTranstorno === 'Sim') {
            const valorHidden = campo.value && campo.value.trim() !== '';
            const temArray = typeof transtornosSelecionados !== 'undefined' && transtornosSelecionados.length > 0;
            preenchido = valorHidden || temArray;
          } else {
            preenchido = true; // N√£o √© obrigat√≥rio se PCD = N√£o
          }
        }
        // Valida√ß√£o padr√£o para outros campos
        else if (campo.type === 'radio') {
          // Para radio buttons, verifica se ALGUMA op√ß√£o do grupo est√° selecionada
          // (mesmo que seja a op√ß√£o "N√£o informado" com value="")
          const radioGroup = form.querySelectorAll(`input[type="radio"][name="${campo.name}"]`);
          const algumMarcado = Array.from(radioGroup).some(radio => radio.checked);
          // Se algum est√° marcado, considera preenchido (mesmo que seja valor vazio)
          // Isso √© importante para campos como "estudoCaso" que t√™m op√ß√£o padr√£o "N√£o informado"
          preenchido = algumMarcado;
          
          // Log para debug de radio buttons
          if (!preenchido && campo.hasAttribute('required')) {
            console.log('‚ö†Ô∏è Radio button obrigat√≥rio n√£o selecionado:', {
              name: campo.name,
              grupo: Array.from(radioGroup).map(r => ({ value: r.value, checked: r.checked }))
            });
          }
        } else if (campo.type === 'checkbox') {
          preenchido = campo.checked;
        } else if (campo.tagName === 'SELECT') {
          preenchido = campo.value && campo.value !== '' && campo.value !== 'Selecione...';
        } else if (campo.type === 'hidden') {
          // Campos hidden devem ter valor n√£o vazio
          preenchido = campo.value && campo.value.trim() !== '';
        } else {
          preenchido = campo.value && campo.value.trim() !== '';
        }
        
        if (preenchido) {
          camposPreenchidos++;
        } else {
          // Tenta encontrar o label de forma mais robusta
          let label = '';
          
          // Para radio buttons, pega o label do grupo (n√£o da op√ß√£o espec√≠fica)
          if (campo.type === 'radio') {
            const labelElement = form.querySelector(`label[for="${campo.name}"]`) || 
                                campo.closest('div')?.querySelector('label:not([for])') ||
                                campo.closest('fieldset')?.querySelector('legend');
            if (labelElement) {
              label = labelElement.textContent || '';
            }
          } else {
            label = campo.getAttribute('aria-label') || 
                   campo.closest('div')?.querySelector('label')?.textContent || 
                   campo.closest('label')?.textContent ||
                   campo.name || 
                   campo.id || 
                   'Campo';
          }
          
          // Limpa o label: remove asteriscos, checkmarks, e espa√ßos extras
          label = label.replace(/\*/g, '')
                      .replace(/[‚úì‚úî]/g, '')
                      .replace(/\s+/g, ' ')
                      .trim();
          
          // Se ainda n√£o tem label √∫til, usa o name ou id
          if (!label || label.length < 2) {
            label = campo.name || campo.id || 'Campo';
          }
          
          if (label && !camposPendentes.includes(label)) {
            camposPendentes.push(label);
            console.log('‚ö†Ô∏è Campo pendente detectado:', {
              id: campo.id,
              name: campo.name,
              type: campo.type,
              value: campo.value,
              label: label
            });
          }
        }
      });
      
      console.log('üìä Progresso calculado:', {
        preenchidos: camposPreenchidos,
        total: totalCampos,
        percentual: Math.round((camposPreenchidos / totalCampos) * 100),
        pendentes: camposPendentes
      });
      
      const percentual = totalCampos > 0 ? Math.round((camposPreenchidos / totalCampos) * 100) : 0;
      
      return {
        percentual,
        camposPreenchidos,
        totalCampos,
        camposPendentes: camposPendentes.slice(0, 5) // Limita a 5 para n√£o poluir a UI
      };
    }
    
    function atualizarProgresso() {
      const progressIndicator = document.getElementById('progressIndicator');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressDetails = document.getElementById('progressDetails');
      
      const progresso = calcularProgresso();
      
      // Mostra o indicador se houver algum preenchimento
      if (progresso.camposPreenchidos > 0 || progresso.percentual > 0) {
        progressIndicator.classList.remove('hidden');
      }
      
      // Atualiza barra de progresso
      progressBar.style.width = `${progresso.percentual}%`;
      
      // Atualiza texto
      progressText.textContent = `${progresso.camposPreenchidos} de ${progresso.totalCampos} campos obrigat√≥rios preenchidos (${progresso.percentual}%)`;
      
      // Atualiza detalhes
      if (progresso.camposPendentes.length > 0) {
        progressDetails.innerHTML = `
          <span class="font-semibold text-gray-700">Pendentes:</span>
          <span class="text-gray-600">${progresso.camposPendentes.join(', ')}${progresso.camposPendentes.length >= 5 ? '...' : ''}</span>
        `;
      } else if (progresso.percentual === 100) {
        progressDetails.innerHTML = '<span class="text-green-600 font-semibold">‚úÖ Todos os campos obrigat√≥rios preenchidos!</span>';
      } else {
        progressDetails.innerHTML = '';
      }
      
      // Muda cor da barra baseado no progresso
      if (progresso.percentual === 100) {
        progressBar.className = 'bg-gradient-to-r from-green-500 via-green-600 to-emerald-600 h-full rounded-full transition-all duration-500 ease-out shadow-sm';
      } else if (progresso.percentual >= 75) {
        progressBar.className = 'bg-gradient-to-r from-blue-500 via-blue-600 to-indigo-600 h-full rounded-full transition-all duration-500 ease-out shadow-sm';
      } else if (progresso.percentual >= 50) {
        progressBar.className = 'bg-gradient-to-r from-yellow-500 via-yellow-600 to-orange-600 h-full rounded-full transition-all duration-500 ease-out shadow-sm';
      } else {
        progressBar.className = 'bg-gradient-to-r from-red-500 via-red-600 to-pink-600 h-full rounded-full transition-all duration-500 ease-out shadow-sm';
      }
    }
    
    // ========================================
    // VALIDA√á√ÉO INTELIGENTE
    // ========================================
    function validarInteligente() {
      const erros = [];
      const avisos = [];
      
      // 1. Valida√ß√£o de Idade vs Data da Notifica√ß√£o
      const idade = parseInt(document.getElementById('idade')?.value || '0', 10);
      const dataNT = document.getElementById('dataNT')?.value;
      
      if (dataNT && !isNaN(idade) && idade > 0) {
        const dataNotificacao = new Date(dataNT);
        const hoje = new Date();
        const anoNascimentoEstimado = hoje.getFullYear() - idade;
        const dataNascimentoEstimada = new Date(anoNascimentoEstimado, hoje.getMonth(), hoje.getDate());
        const idadeCalculada = Math.floor((hoje - dataNascimentoEstimada) / (365.25 * 24 * 60 * 60 * 1000));
        
        if (Math.abs(idadeCalculada - idade) > 1) {
          avisos.push(`‚ö†Ô∏è A idade informada (${idade} anos) pode estar inconsistente com a data da notifica√ß√£o. Verifique se est√° correta.`);
        }
      }
      
      // 2. Valida√ß√£o de Data Futura
      if (dataNT) {
        const dataNotificacao = new Date(dataNT);
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);
        dataNotificacao.setHours(0, 0, 0, 0);
        
        if (dataNotificacao > hoje) {
          erros.push('‚ùå A data da notifica√ß√£o n√£o pode ser futura. Por favor, corrija a data.');
          const campoData = document.getElementById('dataNT');
          if (campoData) {
            campoData.classList.add('field-error');
          }
        }
      }
      
      // 3. Valida√ß√£o de Idade M√≠nima/M√°xima
      if (!isNaN(idade) && idade > 0) {
        if (idade < 0 || idade > 120) {
          erros.push('‚ùå A idade deve estar entre 0 e 120 anos.');
          const campoIdade = document.getElementById('idade');
          if (campoIdade) {
            campoIdade.classList.add('field-error');
          }
        } else if (idade < 3) {
          avisos.push('‚ö†Ô∏è A idade informada √© muito baixa. Verifique se est√° correta.');
        } else if (idade > 25) {
          avisos.push('‚ö†Ô∏è A idade informada √© muito alta para um estudante. Verifique se est√° correta.');
        }
      }
      
      // 4. Valida√ß√£o de Nome (m√≠nimo de caracteres)
      const nome = document.getElementById('criancaEstudante')?.value?.trim() || '';
      if (nome && nome.length < 3) {
        erros.push('‚ùå O nome deve ter pelo menos 3 caracteres.');
        const campoNome = document.getElementById('criancaEstudante');
        if (campoNome) {
          campoNome.classList.add('field-error');
        }
      } else if (nome && nome.split(' ').length < 2) {
        avisos.push('‚ö†Ô∏è Recomenda-se informar o nome completo (nome e sobrenome).');
      }
      
      // 5. Valida√ß√£o de Consist√™ncia: Ocorreu na Escola
      const ocorreuEscola = document.getElementById('ocorreuEscola')?.value;
      const cmeiEmef = document.getElementById('cmeiEmef')?.value?.trim() || '';
      
      if (ocorreuEscola === 'Sim' && !cmeiEmef) {
        avisos.push('‚ö†Ô∏è Se a viol√™ncia ocorreu na escola, recomenda-se informar a escola.');
      }
      
      // 6. Valida√ß√£o de Consist√™ncia: Autor da Viol√™ncia
      const profissionalAutor = document.getElementById('profissionalAutor')?.value;
      const estudanteAutor = document.getElementById('estudanteAutor')?.value;
      
      if (profissionalAutor === 'Sim' && estudanteAutor === 'Sim') {
        avisos.push('‚ö†Ô∏è Verifique: tanto profissional quanto estudante foram marcados como autores. Isso √© poss√≠vel, mas confirme se est√° correto.');
      }
      
      if (profissionalAutor === 'N√£o' && estudanteAutor === 'N√£o' && ocorreuEscola === 'Sim') {
        avisos.push('‚ö†Ô∏è Se ocorreu na escola mas nenhum profissional nem estudante foi autor, verifique se h√° outro agente envolvido.');
      }
      
      return { erros, avisos };
    }
    
    // Fun√ß√£o de valida√ß√£o no frontend (atualizada)
    function validarFormulario() {
      const form = document.getElementById('registroForm');
      const camposObrigatorios = form.querySelectorAll('[required]');
      let valido = true;
      
      // Remove classes de erro anteriores
      camposObrigatorios.forEach(function(campo) {
        campo.classList.remove('field-error');
      });
      
      // Valida cada campo obrigat√≥rio
      camposObrigatorios.forEach(function(campo) {
        if (!campo.value || campo.value.trim() === '') {
          campo.classList.add('field-error');
          valido = false;
        }
      });
      
      // Valida√ß√£o especial para tipoViolencia (campo obrigat√≥rio de tags)
      const tipoViolenciaHidden = document.getElementById('tipoViolencia');
      const tipoViolenciaTagsContainer = document.getElementById('tipoViolencia-tags');
      if (tipoViolenciaHidden && tipoViolenciaHidden.hasAttribute('required')) {
        const tipoViolenciaValue = tipoViolenciaHidden.value || '';
        const temTiposViolencia = (typeof tiposViolenciaSelecionados !== 'undefined' && tiposViolenciaSelecionados.length > 0) || tipoViolenciaValue.trim() !== '';
        
        if (!temTiposViolencia) {
          if (tipoViolenciaTagsContainer) {
            tipoViolenciaTagsContainer.classList.add('field-error');
          }
          valido = false;
          mostrarAlerta('‚ùå Por favor, adicione pelo menos um tipo de viol√™ncia.', 'error');
        } else {
          if (tipoViolenciaTagsContainer) {
            tipoViolenciaTagsContainer.classList.remove('field-error');
          }
        }
      }
      
      // Valida√ß√£o condicional: se PCD = Sim, ent√£o deve ter pelo menos um transtorno selecionado
      const pcdTranstorno = document.getElementById('pcdTranstorno')?.value || '';
      const pcdDetalhesHidden = document.getElementById('pcdDetalhes');
      const pcdDetalhesTagsContainer = document.getElementById('pcdDetalhes-tags');
      
      if (pcdTranstorno === 'Sim') {
        const temTranstornos = (typeof transtornosSelecionados !== 'undefined' && transtornosSelecionados.length > 0) || 
                               (pcdDetalhesHidden && pcdDetalhesHidden.value && pcdDetalhesHidden.value.trim() !== '');
        
        if (!temTranstornos) {
          if (pcdDetalhesTagsContainer) {
            pcdDetalhesTagsContainer.classList.add('field-error');
          }
          valido = false;
          mostrarAlerta('Por favor, adicione pelo menos um transtorno/defici√™ncia quando marcar "Sim".', 'error');
        } else {
          // Remove classe de erro se estava presente
          if (pcdDetalhesTagsContainer) {
            pcdDetalhesTagsContainer.classList.remove('field-error');
          }
        }
      }
      
      // Valida√ß√£o inteligente
      const validacaoInteligente = validarInteligente();
      
      // Mostra erros primeiro
      if (validacaoInteligente.erros.length > 0) {
        validacaoInteligente.erros.forEach(erro => {
          mostrarAlerta(erro, 'error');
        });
        valido = false;
      }
      
      // Depois mostra avisos (n√£o bloqueiam o envio)
      if (validacaoInteligente.avisos.length > 0) {
        validacaoInteligente.avisos.forEach(aviso => {
          mostrarAlerta(aviso, 'info');
        });
      }
      
      if (!valido) {
        mostrarAlerta('Por favor, preencha todos os campos obrigat√≥rios (marcados com *)!', 'error');
      }
      
      return valido;
    }
    
    // Fun√ß√£o para coletar dados do formul√°rio
    function coletarDadosFormulario() {
      const form = document.getElementById('registroForm');
      if (!form) {
        console.error('Formul√°rio n√£o encontrado!');
        return {};
      }
      
      const dados = {};
      
      // Coleta todos os campos do formul√°rio
      form.querySelectorAll('input, select, textarea').forEach(campo => {
        // Ignora bot√µes e campos de input de tags
        if (campo.type === 'button' || campo.type === 'submit') return;
        if (campo.id && (campo.id.includes('-input') || campo.id.includes('-tags'))) return;
        
        const name = campo.name || campo.id;
        if (!name) return;
        
        let valor = '';
        
        if (campo.type === 'radio') {
          // Radio buttons - s√≥ salva se estiver marcado
          if (campo.checked) {
            dados[name] = campo.value;
          }
        } else if (campo.type === 'checkbox') {
          // Checkboxes - s√≥ salva se estiver marcado
          if (campo.checked) {
            dados[name] = campo.value;
          }
        } else if (campo.tagName === 'SELECT') {
          valor = campo.value || '';
          if (valor) dados[name] = valor;
        } else if (campo.type === 'hidden') {
          // Campos hidden (tags) - s√£o cr√≠ticos
          valor = campo.value || '';
          if (valor) dados[name] = valor;
        } else {
          valor = campo.value || '';
          if (valor && valor.trim() !== '') {
            dados[name] = valor;
          }
        }
      });
      
      // Garante que campos hidden de tags sejam coletados (backup)
      ['pcdDetalhes', 'tipoViolencia', 'classificacaoViolencia', 'motivacaoViolencia', 'encaminhamento'].forEach(id => {
        const campo = document.getElementById(id);
        if (campo && campo.value) {
          dados[id] = campo.value;
        }
      });
      
      // Se campos hidden de tags estiverem vazios mas arrays tiverem valores, preenche
      if (!dados.tipoViolencia || dados.tipoViolencia.trim() === '') {
        if (typeof tiposViolenciaSelecionados !== 'undefined' && tiposViolenciaSelecionados.length > 0) {
          dados.tipoViolencia = tiposViolenciaSelecionados.join(', ');
          console.log('üìù tipoViolencia preenchido a partir do array:', dados.tipoViolencia);
        }
      }
      if (!dados.classificacaoViolencia || dados.classificacaoViolencia.trim() === '') {
        if (typeof classificacoesSelecionadas !== 'undefined' && classificacoesSelecionadas.length > 0) {
          dados.classificacaoViolencia = classificacoesSelecionadas.join(', ');
        }
      }
      if (!dados.motivacaoViolencia || dados.motivacaoViolencia.trim() === '') {
        if (typeof motivacoesSelecionadas !== 'undefined' && motivacoesSelecionadas.length > 0) {
          dados.motivacaoViolencia = motivacoesSelecionadas.join(', ');
        }
      }
      if (!dados.encaminhamento || dados.encaminhamento.trim() === '') {
        if (typeof encaminhamentosSelecionados !== 'undefined' && encaminhamentosSelecionados.length > 0) {
          dados.encaminhamento = encaminhamentosSelecionados.join(', ');
        }
      }
      if (!dados.pcdDetalhes || dados.pcdDetalhes.trim() === '') {
        if (typeof transtornosSelecionados !== 'undefined' && transtornosSelecionados.length > 0) {
          dados.pcdDetalhes = transtornosSelecionados.join(', ');
        }
      }
      
      // Log detalhado dos campos obrigat√≥rios
      const camposObrigatorios = ['criancaEstudante', 'dataNT', 'idade', 'identidadeGenero', 'tipoViolencia', 'cmeiEmef', 'regiao', 'responsavelRegistro'];
      console.log('üìã Status dos campos obrigat√≥rios:');
      camposObrigatorios.forEach(campo => {
        const valor = dados[campo];
        const status = valor && valor.toString().trim() !== '' ? '‚úÖ' : '‚ùå';
        console.log(`  ${status} ${campo}:`, valor || '(vazio)');
      });
      
      // Converte valores Sim/N√£o para S/N conforme necess√°rio
      const camposSimNao = ['fonteEscola', 'violenciaEscolaOcorreu', 'profissionalAutor', 'estudanteAutor', 
                            'violenciaNaoEscola', 'ocorreuEscola', 'violenciaInformada', 'estudoCaso'];
      camposSimNao.forEach(campo => {
        if (dados[campo] !== undefined) {
          dados[campo] = converterSimNao(dados[campo]);
        }
      });
      
      console.log('üì§ Dados coletados para envio:', Object.keys(dados));
      
      return dados;
    }
    
    // Fun√ß√£o de envio do formul√°rio
    document.getElementById('registroForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      console.log('üìù Iniciando envio do formul√°rio...');
      
      // Valida antes de enviar
      const validacao = validarFormulario();
      console.log('‚úÖ Valida√ß√£o retornou:', validacao);
      
      if (!validacao) {
        console.warn('‚ùå Valida√ß√£o falhou, n√£o enviando formul√°rio');
        return;
      }
      
      // Coleta os dados
      const dados = coletarDadosFormulario();
      console.log('üì¶ Dados coletados:', dados);
      
      // Verifica se h√° dados para enviar
      if (Object.keys(dados).length === 0) {
        console.error('‚ùå Nenhum dado coletado!');
        mostrarAlerta('‚ùå Erro: Nenhum dado foi coletado do formul√°rio. Por favor, recarregue a p√°gina e tente novamente.', 'error');
        return;
      }
      
      // Desabilita bot√£o durante envio
      const btnSalvar = document.getElementById('btnSalvar');
      btnSalvar.disabled = true;
      btnSalvar.textContent = '‚è≥ Salvando...';
      
      // Salva rascunho antes de enviar (backup de seguran√ßa)
      if (typeof AutoSave !== 'undefined') {
        AutoSave.salvar();
      }
      
      // Envia para o Apps Script Web App
      console.log('üöÄ Enviando dados para Apps Script...');
      enviarParaAppsScript(dados);
    });
    
    // Fun√ß√£o para enviar dados ao Apps Script via iframe (contorna CORS)
    function enviarParaAppsScript(dados) {
      const btnSalvar = document.getElementById('btnSalvar');
      
      console.log('üìã Validando dados antes de enviar:', dados);
      
      // Valida√ß√£o de campos obrigat√≥rios (verifica se existem e n√£o est√£o vazios)
      const camposObrigatorios = [
        'criancaEstudante', 'dataNT', 'idade', 'identidadeGenero',
        'tipoViolencia', 'cmeiEmef', 'regiao', 'responsavelRegistro'
      ];
      
      const camposFaltando = [];
      for (const campo of camposObrigatorios) {
        const valor = dados[campo];
        if (!valor || (typeof valor === 'string' && valor.trim() === '')) {
          camposFaltando.push(campo);
        }
      }
      
      if (camposFaltando.length > 0) {
        console.error('‚ùå Campos obrigat√≥rios faltando:', camposFaltando);
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'üíæ Salvar Registro';
        mostrarAlerta(`‚ùå Preencha todos os campos obrigat√≥rios! Faltando: ${camposFaltando.join(', ')}`, 'error');
        return;
      }
      
      console.log('‚úÖ Todos os campos obrigat√≥rios preenchidos');
      
      // Verifica se a URL do Apps Script est√° configurada
      // Tenta obter do CONFIG novamente caso n√£o tenha sido carregada antes
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('SEU_ID_AQUI')) {
        // Usa window.CONFIG diretamente (n√£o pode reatribuir const)
        const config = typeof window !== 'undefined' ? window.CONFIG : (typeof CONFIG !== 'undefined' ? CONFIG : null);
        
        if (config && config.APPS_SCRIPT_CASOS) {
          const novaURL = config.APPS_SCRIPT_CASOS;
          
          // Verifica se a URL mudou (pode estar em cache)
          if (APPS_SCRIPT_URL && APPS_SCRIPT_URL !== novaURL) {
            console.warn('‚ö†Ô∏è URL do Apps Script mudou! Atualizando...');
            console.warn('URL antiga:', APPS_SCRIPT_URL);
            console.warn('URL nova:', novaURL);
          }
          
          APPS_SCRIPT_URL = novaURL;
          console.log('‚úÖ URL obtida do CONFIG:', APPS_SCRIPT_URL);
        } else {
          console.error('‚ùå CONFIG.APPS_SCRIPT_CASOS n√£o est√° dispon√≠vel');
          console.error('CONFIG dispon√≠vel?', typeof config !== 'undefined' && config !== null);
          if (config) {
            console.error('CONFIG.APPS_SCRIPT_CASOS:', config.APPS_SCRIPT_CASOS);
          }
        }
      }
      
      if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('SEU_ID_AQUI')) {
        console.error('‚ùå ERRO: URL do Apps Script n√£o configurada!');
        console.error('CONFIG dispon√≠vel?', typeof CONFIG !== 'undefined');
        if (typeof CONFIG !== 'undefined') {
          console.error('CONFIG completo:', CONFIG);
          console.error('CONFIG.APPS_SCRIPT_CASOS:', CONFIG.APPS_SCRIPT_CASOS);
        } else {
          console.error('‚ö†Ô∏è CONFIG n√£o est√° definido. Verifique se config.js est√° sendo carregado corretamente.');
        }
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'üíæ Salvar Registro';
        mostrarAlerta('‚ùå Erro: URL do Apps Script n√£o est√° configurada. Verifique o arquivo config.js e certifique-se de que APPS_SCRIPT_CASOS est√° definido. Recarregue a p√°gina ap√≥s configurar.', 'error');
        return;
      }
      
      console.log('üì° Enviando para URL:', APPS_SCRIPT_URL);
      
      // Cria callback global para receber resposta do Apps Script
      const callbackName = 'handleScriptResponse_' + Date.now();
      window[callbackName] = function(resultado) {
        console.log('üì• Resposta recebida do Apps Script:', resultado);
        console.log('‚úÖ Callback executado com sucesso');
        
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'üíæ Salvar Registro';
        
        // Verifica se resultado existe
        if (!resultado) {
          console.error('‚ùå Resposta vazia ou inv√°lida do Apps Script');
          mostrarAlerta('‚ùå Erro: Resposta inv√°lida do servidor. Verifique os logs do Apps Script.', 'error');
          delete window[callbackName];
          return;
        }
        
        // Verifica sucesso (pode ser 'success' ou 'sucesso')
        const sucesso = resultado.success || resultado.sucesso;
        const mensagem = resultado.message || resultado.mensagem || 'Opera√ß√£o conclu√≠da';
        
        if (sucesso) {
          console.log('‚úÖ Registro salvo com sucesso!');
          mostrarAlerta('‚úÖ Registro salvo com sucesso na planilha!', 'success');
          
          // Limpa o formul√°rio completamente ap√≥s salvar com sucesso
          console.log('üßπ Limpando formul√°rio ap√≥s salvamento bem-sucedido...');
          limparFormulario();
          
          // Scroll suave para o topo
          window.scrollTo({ top: 0, behavior: 'smooth' });
          
          console.log('‚úÖ Formul√°rio limpo e pronto para novo registro!');
        } else {
          console.error('‚ùå Erro ao salvar:', mensagem);
          mostrarAlerta('‚ùå Erro: ' + mensagem, 'error');
        }
        
        // Limpa o callback
        delete window[callbackName];
      };
      
      // Envia dados via JSONP (m√©todo oficial do Apps Script)
      const script = document.createElement('script');
      const params = new URLSearchParams();
      params.append('action', 'saveRegistro');
      params.append('data', JSON.stringify(dados));
      params.append('callback', callbackName);
      
      const urlCompleta = APPS_SCRIPT_URL + '?' + params.toString();
      console.log('üîó URL completa da requisi√ß√£o:', urlCompleta);
      
      script.src = urlCompleta;
      script.onerror = function(error) {
        console.error('‚ùå Erro ao carregar script do Apps Script:', error);
        console.error('URL tentada:', urlCompleta);
        console.error('Poss√≠veis causas:');
        console.error('1. Apps Script n√£o est√° publicado como "Aplicativo da Web"');
        console.error('2. Permiss√µes do Apps Script n√£o est√£o configuradas corretamente');
        console.error('3. URL do Apps Script est√° incorreta');
        console.error('4. CORS ou bloqueio de rede');
        
        btnSalvar.disabled = false;
        btnSalvar.textContent = 'üíæ Salvar Registro';
        mostrarAlerta('‚ùå Erro ao conectar com o servidor. Verifique: 1) Se o Apps Script est√° publicado como "Aplicativo da Web", 2) Se a URL em config.js est√° correta, 3) Se as permiss√µes est√£o configuradas. Veja o console para mais detalhes.', 'error');
        delete window[callbackName];
      };
      
      script.onload = function() {
        console.log('‚úÖ Script do Apps Script carregado com sucesso');
        console.log('‚è≥ Aguardando resposta do callback...');
      };
      
      console.log('üì§ Adicionando script ao DOM para enviar dados...');
      document.body.appendChild(script);
      
      // Timeout de seguran√ßa: se n√£o receber resposta em 30 segundos, considera erro
      setTimeout(() => {
        if (window[callbackName]) {
          console.error('‚è±Ô∏è Timeout: N√£o recebeu resposta do Apps Script em 30 segundos');
          btnSalvar.disabled = false;
          btnSalvar.textContent = 'üíæ Salvar Registro';
          mostrarAlerta('‚ùå Timeout: O servidor n√£o respondeu. Verifique a URL do Apps Script e se o script est√° publicado corretamente.', 'error');
          delete window[callbackName];
        }
      }, 30000);
      
      // Remove o script ap√≥s 5 segundos
      setTimeout(() => {
        if (script.parentNode) {
          script.remove();
          console.log('üßπ Script removido do DOM');
        }
      }, 5000);
    }
    
    // Fun√ß√£o para mostrar alertas
    function mostrarAlerta(mensagem, tipo) {
      const container = document.getElementById('alertContainer');
      
      const cores = {
        success: 'bg-green-100 border-green-500 text-green-700',
        error: 'bg-red-100 border-red-500 text-red-700',
        info: 'bg-blue-100 border-blue-500 text-blue-700'
      };
      
      const icones = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è'
      };
      
      const alerta = document.createElement('div');
      alerta.className = `alert ${cores[tipo]} border-l-4 p-4 mb-4 rounded-md`;
      alerta.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <span class="text-2xl mr-3">${icones[tipo]}</span>
            <p class="font-medium">${mensagem}</p>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="text-xl font-bold hover:opacity-70">
            √ó
          </button>
        </div>
      `;
      
      container.appendChild(alerta);
      
      // Remove automaticamente ap√≥s 5 segundos
      setTimeout(function() {
        alerta.remove();
      }, 5000);
    }
    
    // Fun√ß√£o para limpar formul√°rio
    function limparFormulario() {
      console.log('üßπ Limpando formul√°rio...');
      const form = document.getElementById('registroForm');
      
      // 1. Reseta o formul√°rio (limpa todos os campos padr√£o)
      form.reset();
      
      // 2. Remove classes de erro
      const campos = form.querySelectorAll('.field-error');
      campos.forEach(function(campo) {
        campo.classList.remove('field-error');
      });
      
      // 3. Limpa todos os campos de texto, n√∫mero e textarea manualmente
      form.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], textarea').forEach(campo => {
        campo.value = '';
      });
      
      // 4. Reseta os selects customizados
      document.querySelectorAll('.custom-select-trigger').forEach(trigger => {
        const placeholder = trigger.getAttribute('data-placeholder') || 'Selecione...';
        trigger.textContent = placeholder;
      });
      
      // 5. Reseta selects para primeira op√ß√£o (Selecione...)
      form.querySelectorAll('select').forEach(select => {
        select.selectedIndex = 0;
        // Dispara evento change para atualizar selects customizados
        select.dispatchEvent(new Event('change'));
      });
      
      // 6. Reseta radio buttons para valores padr√£o (N√£o informado quando dispon√≠vel)
      form.querySelectorAll('input[type="radio"]').forEach(radio => {
        // Se houver uma op√ß√£o com value="" e checked por padr√£o, seleciona ela
        const grupo = form.querySelectorAll(`input[type="radio"][name="${radio.name}"]`);
        grupo.forEach(r => {
          if (r.value === '' && r.hasAttribute('checked')) {
            r.checked = true;
          } else {
            r.checked = false;
          }
        });
      });
      
      // 7. Esconde campos condicionais
      const pcdDetalhesContainer = document.getElementById('pcdDetalhesContainer');
      if (pcdDetalhesContainer) {
        pcdDetalhesContainer.classList.add('hidden');
      }
      
      // 8. Limpa campos hidden de tags
      ['pcdDetalhes', 'tipoViolencia', 'classificacaoViolencia', 'motivacaoViolencia', 'encaminhamento'].forEach(id => {
        const campo = document.getElementById(id);
        if (campo) {
          campo.value = '';
        }
      });
      
      // 9. Limpa arrays de tags e renderiza novamente
      if (typeof transtornosSelecionados !== 'undefined') {
        transtornosSelecionados = [];
        if (typeof renderizarTagsTranstornos === 'function') {
          renderizarTagsTranstornos();
        }
      }
      if (typeof tiposViolenciaSelecionados !== 'undefined') {
        tiposViolenciaSelecionados = [];
        if (typeof renderizarTagsTipoViolencia === 'function') {
          renderizarTagsTipoViolencia();
        }
      }
      if (typeof classificacoesSelecionadas !== 'undefined') {
        classificacoesSelecionadas = [];
        if (typeof renderizarTagsClassificacaoViolencia === 'function') {
          renderizarTagsClassificacaoViolencia();
        }
      }
      if (typeof motivacoesSelecionadas !== 'undefined') {
        motivacoesSelecionadas = [];
        if (typeof renderizarTagsMotivacaoViolencia === 'function') {
          renderizarTagsMotivacaoViolencia();
        }
      }
      if (typeof encaminhamentosSelecionados !== 'undefined') {
        encaminhamentosSelecionados = [];
        if (typeof renderizarTags === 'function') {
          renderizarTags();
        }
      }
      
      // 10. Limpa inputs de tags visuais
      form.querySelectorAll('input[id$="-input"]').forEach(input => {
        input.value = '';
      });
      
      // 11. Limpa containers de tags
      form.querySelectorAll('[id$="-tags"]').forEach(container => {
        container.innerHTML = '';
      });
      
      // 12. Limpa rascunho do AutoSave
      if (typeof AutoSave !== 'undefined') {
        AutoSave.limpar();
      }
      
      // 13. Atualiza progresso do formul√°rio
      atualizarProgresso();
      
      console.log('‚úÖ Formul√°rio limpo com sucesso!');
    }

    // ========================================
    // CUSTOM SELECT FUNCTIONALITY
    // ========================================
    function initCustomSelects() {
      document.querySelectorAll('select:not([data-no-custom])').forEach(select => {
        if (select.closest('.custom-select-wrapper')) return; // J√° foi inicializado
        
        const wrapper = document.createElement('div');
        wrapper.className = 'custom-select-wrapper';
        
        const trigger = document.createElement('div');
        const selectedOption = select.options[select.selectedIndex];
        const placeholder = selectedOption.textContent;
        trigger.className = 'custom-select-trigger w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm';
        trigger.textContent = placeholder;
        trigger.setAttribute('data-placeholder', placeholder);
        trigger.setAttribute('tabindex', '0');
        
        const dropdown = document.createElement('div');
        dropdown.className = 'custom-select-dropdown';
        
        Array.from(select.options).forEach((option, index) => {
          const optionDiv = document.createElement('div');
          optionDiv.className = 'custom-select-option';
          optionDiv.textContent = option.textContent;
          optionDiv.setAttribute('data-value', option.value);
          
          if (option.selected) {
            optionDiv.classList.add('selected');
          }
          
          optionDiv.addEventListener('click', () => {
            select.selectedIndex = index;
            select.value = option.value;
            trigger.textContent = option.textContent;
            
            // Atualiza classes selected
            dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
              opt.classList.remove('selected');
            });
            optionDiv.classList.add('selected');
            
            dropdown.classList.remove('show');
            trigger.classList.remove('open');
            
            // Dispara evento change no select original
            select.dispatchEvent(new Event('change', { bubbles: true }));
          });
          
          dropdown.appendChild(optionDiv);
        });
        
        trigger.addEventListener('click', (e) => {
          e.stopPropagation();
          closeAllCustomSelects();
          dropdown.classList.toggle('show');
          trigger.classList.toggle('open');
        });
        
        trigger.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            trigger.click();
          }
        });
        
        select.parentNode.insertBefore(wrapper, select);
        wrapper.appendChild(trigger);
        wrapper.appendChild(dropdown);
        wrapper.appendChild(select);
      });
      
      // Fecha dropdowns ao clicar fora
      document.addEventListener('click', () => {
        closeAllCustomSelects();
      });
    }

    function closeAllCustomSelects() {
      document.querySelectorAll('.custom-select-dropdown').forEach(dropdown => {
        dropdown.classList.remove('show');
      });
      document.querySelectorAll('.custom-select-trigger').forEach(trigger => {
        trigger.classList.remove('open');
      });
    }

    // Observa mudan√ßas din√¢micas no select (para quando op√ß√µes s√£o adicionadas via JS)
    function observeSelectChanges() {
      const observer = new MutationObserver(() => {
        document.querySelectorAll('select:not([data-no-custom])').forEach(select => {
          const wrapper = select.closest('.custom-select-wrapper');
          if (!wrapper) return;
          
          const dropdown = wrapper.querySelector('.custom-select-dropdown');
          const trigger = wrapper.querySelector('.custom-select-trigger');
          
          if (dropdown && select.options.length !== dropdown.children.length) {
            // Reconstruir dropdown
            dropdown.innerHTML = '';
            Array.from(select.options).forEach((option, index) => {
              const optionDiv = document.createElement('div');
              optionDiv.className = 'custom-select-option';
              optionDiv.textContent = option.textContent;
              optionDiv.setAttribute('data-value', option.value);
              
              if (option.selected) {
                optionDiv.classList.add('selected');
                trigger.textContent = option.textContent;
              }
              
              optionDiv.addEventListener('click', () => {
                select.selectedIndex = index;
                select.value = option.value;
                trigger.textContent = option.textContent;
                
                dropdown.querySelectorAll('.custom-select-option').forEach(opt => {
                  opt.classList.remove('selected');
                });
                optionDiv.classList.add('selected');
                
                dropdown.classList.remove('show');
                trigger.classList.remove('open');
                
                select.dispatchEvent(new Event('change', { bubbles: true }));
              });
              
              dropdown.appendChild(optionDiv);
            });
          }
        });
      });
      
      document.querySelectorAll('select:not([data-no-custom])').forEach(select => {
        observer.observe(select, { childList: true, subtree: true });
      });
    }

    // Inicializa custom selects ap√≥s carregamento
    window.addEventListener('DOMContentLoaded', () => {
      verificarAutenticacao();
      initCustomSelects();
      observeSelectChanges();
      verificarMenuAdmin();
      
      // Inicializa sistema de auto-save
      AutoSave.inicializar();
      
      // Inicializa sistema de progresso
      const form = document.getElementById('registroForm');
      if (!form) {
        console.error('Formul√°rio n√£o encontrado!');
        return;
      }
      
      // Atualiza progresso quando campos mudam
      form.addEventListener('input', () => {
        atualizarProgresso();
      });
      
      form.addEventListener('change', () => {
        atualizarProgresso();
      });
      
      // Bot√£o de salvar rascunho manualmente (j√° configurado via onclick no HTML)
      // N√£o precisa adicionar listener aqui, j√° est√° no HTML
      
      // Atualiza progresso inicial
      setTimeout(() => {
        atualizarProgresso();
      }, 1000);
    });

    // ========================================
    // VERIFICAR AUTENTICA√á√ÉO
    // ========================================
    function verificarAutenticacao() {
      const userRole = sessionStorage.getItem('userRole');
      const userEmail = sessionStorage.getItem('userEmail');
      
      // Se n√£o estiver autenticado, redireciona para login
      if (!userRole || !userEmail) {
        alert('Acesso negado! Fa√ßa login para acessar o sistema.');
        window.location.href = 'index.html';
        return;
      }
    }

    // ========================================
    // VERIFICAR E MOSTRAR MENU ADMIN
    // ========================================
    function verificarMenuAdmin() {
      const userRole = sessionStorage.getItem('userRole');
      const menuAdmin = document.getElementById('menuAdmin');
      const btnSair = document.getElementById('btnSair');
      const menuAdminMobile = document.getElementById('menuAdminMobile');
      const btnSairMobile = document.getElementById('btnSairMobile');
      
      if (userRole === 'admin' || userRole === 'superuser') {
        if (menuAdmin) {
          menuAdmin.classList.remove('hidden');
        }
        if (btnSair) {
          btnSair.classList.remove('hidden');
        }
        if (menuAdminMobile) {
          menuAdminMobile.classList.remove('hidden');
        }
        if (btnSairMobile) {
          btnSairMobile.classList.remove('hidden');
        }
      }
    }

    // ========================================
    // FUN√á√ÉO SAIR
    // ========================================
    function sair() {
      if (confirm('Deseja realmente sair do sistema?')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }
  </script>
  
</body>
</html>
