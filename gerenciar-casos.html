<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciar Registros - Viol√™ncia Escolar</title>
  
  <!-- Esconde conte√∫do IMEDIATAMENTE para evitar flash -->
  <style>
    html:not(.page-ready) {
      opacity: 0 !important;
      visibility: hidden !important;
    }
    html.page-ready {
      opacity: 1 !important;
      visibility: visible !important;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
  </style>
  
  <!-- TailwindCSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Estilos Elegantes Compartilhados -->
  <link rel="stylesheet" href="assets/css/styles-elegant.css">
  
  <!-- Configura√ß√£o Centralizada -->
  <script src="config.js?v=2"></script>
  <script src="assets/js/utils/config-loader.js"></script>
  
  <!-- Sistema de Transi√ß√µes entre P√°ginas -->
  <script src="assets/js/utils/page-transitions.js"></script>
  
  <!-- Valida√ß√£o do CONFIG -->
  <script>
    // Verifica se CONFIG foi carregado
    if (typeof CONFIG === 'undefined') {
      alert('‚ùå ERRO CR√çTICO: Arquivo config.js n√£o foi carregado!\n\nRecarregue a p√°gina com Ctrl+F5');
      throw new Error('CONFIG n√£o definido - config.js n√£o carregado');
    }
    console.log('‚úÖ CONFIG carregado com sucesso');
  </script>
  
  <script>
    // Bloqueia acesso de visualizadores a esta p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      const role = sessionStorage.getItem('userRole');
      if (!role) {
        window.location.href = 'index.html';
        return;
      }
      if (role === 'visualizador') {
        alert('Visualizadores t√™m acesso somente ao painel.');
        window.location.href = 'painel-casos.html';
      }
    });
  </script>
  
  <style>
    .alert {
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 9999;
      animation: fadeIn 0.2s ease-out;
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal.show > div {
      animation: fadeInScale 0.3s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 0.5rem;
    }

    table {
      min-width: 1000px;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    /* Autocomplete Styles */
    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-list {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #e5e7eb;
      border-top: none;
      border-radius: 0 0 0.5rem 0.5rem;
      max-height: 200px;
      overflow-y: auto;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .autocomplete-list.show {
      display: block;
    }

    .autocomplete-item {
      padding: 0.75rem 1rem;
      cursor: pointer;
      border-bottom: 1px solid #f3f4f6;
      transition: background-color 0.2s;
    }

    .autocomplete-item:hover,
    .autocomplete-item.selected {
      background-color: #eff6ff;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }
    
    /* Radio Button Custom Animations */
    input[type="radio"].peer:checked ~ div {
      transform: scale(1.05);
      transition: all 0.2s ease-out;
    }
    
    input[type="radio"].peer ~ div {
      transition: all 0.2s ease-out;
    }
    
    input[type="radio"].peer:active ~ div {
      transform: scale(0.98);
    }

    /* Menu Hamburguer Responsivo */
    /* Desktop: Mostra menu horizontal, esconde hamburguer */
    .mobile-menu-button {
      display: none !important;
    }

    .desktop-menu {
      display: flex;
    }

    .mobile-menu {
      display: none;
    }

    /* Apenas Celulares: Esconde menu horizontal, mostra hamburguer */
    @media (max-width: 768px) {
      .mobile-menu-button {
        display: flex !important;
      }
      
      .desktop-menu {
        display: none !important;
      }
      
      .mobile-menu {
        display: block !important;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out;
      }

      .mobile-menu.show {
        max-height: 500px;
      }
    }

    /* Tabela respons√≠vel */
    @media (max-width: 1024px) {
      .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Melhorias de toque para mobile */
    @media (hover: none) and (pointer: coarse) {
      button, a, input, select, textarea {
        min-height: 44px;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-blue-50 min-h-screen font-sans antialiased">

  <div class="container mx-auto px-4 py-6 sm:py-8 max-w-7xl">
    
    <!-- Menu de Navega√ß√£o -->
    <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl shadow-lg mb-6">
      <div class="px-4 py-3">
        <!-- Bot√£o Hamburguer (Mobile) -->
        <button onclick="toggleMobileMenu()" class="mobile-menu-button w-full flex items-center justify-between text-white font-semibold">
          <span>üì± Menu</span>
          <svg class="w-6 h-6 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
        
        <!-- Menu Desktop -->
        <nav class="desktop-menu flex flex-wrap gap-2 justify-center items-center">
          <a href="painel-casos.html" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
            üìä Painel de Casos
          </a>
          <a href="registro-novo-caso.html" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
            üìù Novo Registro
          </a>
          <a href="gerenciar-casos.html" class="px-5 py-2.5 bg-white text-blue-600 rounded-lg text-sm font-semibold shadow-md hover:shadow-lg transition-all">
            üìã Gerenciar Registros
          </a>
          <a id="menuAdmin" href="gerenciar-usuarios.html" class="hidden px-5 py-2.5 bg-blue-500 text-white rounded-lg text-sm font-semibold hover:bg-blue-400 transition-all">
            üîß Painel Admin
          </a>
          <button id="btnSair" onclick="sair()" class="hidden px-5 py-2.5 bg-red-500 text-white rounded-lg text-sm font-semibold hover:bg-red-600 transition-all">
            üö™ Sair
          </button>
        </nav>
        
        <!-- Menu Mobile (Dropdown) -->
        <nav id="mobileMenuNav" class="mobile-menu mt-3">
          <div class="flex flex-col gap-2">
            <a href="painel-casos.html" class="btn-elegant btn-primary-elegant px-5 py-3 rounded-lg text-sm font-semibold text-center">
              üìä Painel de Casos
            </a>
            <a href="registro-novo-caso.html" class="btn-elegant btn-primary-elegant px-5 py-3 rounded-lg text-sm font-semibold text-center">
              üìù Novo Registro
            </a>
            <a href="gerenciar-casos.html" class="btn-elegant px-5 py-3 bg-white text-blue-600 rounded-lg text-sm font-semibold shadow-md text-center border-2 border-blue-500">
              üìã Gerenciar Registros
            </a>
            <a id="menuAdminMobile" href="gerenciar-usuarios.html" class="btn-elegant btn-primary-elegant hidden px-5 py-3 rounded-lg text-sm font-semibold text-center">
              üîß Painel Admin
            </a>
            <button id="btnSairMobile" onclick="sair()" class="btn-elegant btn-danger-elegant hidden px-5 py-3 rounded-lg text-sm font-semibold text-center">
              üö™ Sair
            </button>
          </div>
        </nav>
      </div>
    </div>
    
    <!-- Cabe√ßalho -->
    <div class="bg-gradient-to-r from-white to-blue-50/30 rounded-xl shadow-xl border border-white/60 backdrop-blur-sm p-6 mb-6">
      <div class="flex items-center justify-center gap-4 mb-3">
        <div class="h-14 w-14 flex items-center justify-center rounded-full bg-blue-100 text-blue-600 text-3xl shadow-sm">
          üìã
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800">
          Gerenciar Registros
        </h1>
      </div>
      <p class="text-center text-gray-600">
        Visualize, edite ou exclua registros existentes
      </p>
    </div>
    
    <!-- √Årea de Alertas -->
    <div id="alertContainer"></div>

    <!-- Controles: Carregar e Buscar -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
      <div class="flex flex-col lg:flex-row gap-4 items-stretch lg:items-center justify-between">
        <!-- Bot√£o Carregar -->
        <div class="flex items-center gap-4">
          <button 
            id="btnCarregar" 
            onclick="carregarRegistros()"
            class="btn-elegant btn-primary-elegant px-6 py-3 rounded-lg font-semibold shadow-lg flex items-center gap-2">
            <span>üîÑ</span>
            <span>Carregar Registros</span>
          </button>
          <div id="loadingInfo" class="text-gray-600 text-sm font-medium"></div>
        </div>
        
        <!-- Campo de Busca -->
        <div class="flex-1 max-w-md">
          <div class="relative">
            <svg class="absolute left-3 top-3.5 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input 
              type="text" 
              id="campoBusca" 
              placeholder="Buscar por nome da crian√ßa/estudante..."
              onkeyup="filtrarTabela()"
              class="w-full px-4 py-3 pl-10 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
          </div>
        </div>
      </div>
    </div>

    <!-- Tabela de Registros -->
    <div class="bg-white rounded-xl shadow-xl p-4 sm:p-6">
      <!-- Estat√≠sticas e Pagina√ß√£o -->
      <div class="mb-4 flex flex-wrap gap-4 items-center justify-between">
        <div class="flex gap-4">
          <div class="px-4 py-2 bg-blue-50 rounded-lg border border-blue-200">
            <span class="text-sm text-gray-600">Total:</span>
            <span id="totalRegistros" class="ml-2 text-lg font-bold text-blue-600">0</span>
          </div>
          <div class="px-4 py-2 bg-green-50 rounded-lg border border-green-200">
            <span class="text-sm text-gray-600">Exibindo:</span>
            <span id="registrosVisiveis" class="ml-2 text-lg font-bold text-green-600">0</span>
          </div>
        </div>
        
        <!-- Controles de Pagina√ß√£o -->
        <div class="flex items-center gap-3 bg-gradient-to-r from-gray-50 to-gray-100 px-4 py-2 rounded-xl border border-gray-200">
          <label class="text-sm font-semibold text-gray-700 flex items-center gap-2">
            <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            Itens por p√°gina:
          </label>
          <div class="relative">
            <select id="itensPorPagina" onchange="mudarItensPorPagina()" class="appearance-none px-4 py-2 pr-10 bg-white border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all font-semibold text-gray-700 cursor-pointer hover:border-blue-400 hover:shadow-md">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
              <option value="999999">Todos</option>
            </select>
            <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-500 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
          
          <div id="paginacaoControles" class="flex items-center gap-2"></div>
        </div>
      </div>

      <div class="table-wrapper">
        <table id="tabelaRegistros" class="w-full">
          <thead>
            <tr class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
              <th class="px-4 py-4 text-left text-sm font-bold">Crian√ßa/Estudante</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Data NT</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Idade</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Viol√™ncia</th>
              <th class="px-4 py-4 text-left text-sm font-bold">CMEI/EMEF</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Regi√£o</th>
              <th class="px-4 py-4 text-left text-sm font-bold">Estudo Caso?</th>
              <th class="px-4 py-4 text-center text-sm font-bold">A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="corpoTabela" class="divide-y divide-gray-200">
            <tr>
              <td colspan="8" class="px-4 py-12 text-center text-gray-500">
                <div class="flex flex-col items-center gap-3">
                  <div class="text-5xl">üìã</div>
                  <div class="text-lg font-medium">Nenhum registro carregado</div>
                  <div class="text-sm">Clique em "Carregar Registros" para visualizar os dados</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Modal de Edi√ß√£o -->
  <div id="modalEdicao" class="modal">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-5xl w-full mx-4 max-h-[90vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-6 border-b pb-4">
        <h2 class="text-2xl font-bold text-gray-800">‚úèÔ∏è Editar Registro</h2>
        <button onclick="fecharModal()" class="text-gray-400 hover:text-gray-600 text-2xl transition-colors">√ó</button>
      </div>
      
      <form id="formEdicao" class="space-y-6">
        <input type="hidden" id="edit_linha">
        
        <!-- =============================================== -->
        <!-- SE√á√ÉO 1: Dados da Crian√ßa/Estudante -->
        <!-- =============================================== -->
        <section>
          <div class="bg-gradient-to-r from-slate-50 to-blue-50/30 rounded-xl border border-gray-200 shadow-sm p-5 mb-6">
            <div class="flex items-start gap-3 mb-5">
              <div class="h-10 w-10 flex items-center justify-center rounded-lg bg-blue-100 text-blue-600 text-xl flex-shrink-0 shadow-sm">
                üë§
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-bold text-gray-800 mb-1">
                  Dados da Crian√ßa/Estudante
                </h3>
                <p class="text-xs text-gray-600">
                  Preencha as informa√ß√µes b√°sicas da crian√ßa ou estudante envolvido no caso
                </p>
              </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Crian√ßa/Estudante -->
          <div class="md:col-span-2">
            <label for="edit_criancaEstudante" class="block text-sm font-semibold text-gray-700 mb-2">
              Nome da Crian√ßa/Estudante <span class="text-red-500">*</span>
            </label>
            <input 
              type="text" 
              id="edit_criancaEstudante" 
              name="edit_criancaEstudante" 
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
              placeholder="Digite o nome completo"
            >
          </div>
          
          <!-- Data da NT -->
          <div>
            <label for="edit_dataNT" class="block text-sm font-semibold text-gray-700 mb-2">
              Data da Notifica√ß√£o (NT) <span class="text-red-500">*</span>
            </label>
            <input 
              type="date" 
              id="edit_dataNT" 
              name="edit_dataNT" 
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
            >
          </div>
          
          <!-- Idade -->
          <div>
            <label for="edit_idade" class="block text-sm font-semibold text-gray-700 mb-2">
              Idade <span class="text-red-500">*</span>
            </label>
            <input 
              type="number" 
              id="edit_idade" 
              name="edit_idade" 
              min="0" 
              max="120"
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
              placeholder="Ex: 10"
            >
          </div>
          
          <!-- Identidade de G√™nero -->
          <div>
            <label for="edit_identidadeGenero" class="block text-sm font-semibold text-gray-700 mb-2">
              Identidade de G√™nero <span class="text-red-500">*</span>
            </label>
            <select 
              id="edit_identidadeGenero" 
              name="edit_identidadeGenero" 
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione...</option>
              <option value="M">Masculino</option>
              <option value="F">Feminino</option>
              <option value="N√£o-bin√°rio">N√£o-bin√°rio</option>
              <option value="Outro">Outro</option>
            </select>
          </div>
          
          <!-- √â PCD/tem Transtorno? -->
          <div>
            <label for="edit_pcdTranstorno" class="block text-sm font-semibold text-gray-700 mb-2">
              √â PCD/tem Transtorno?
            </label>
            <select 
              id="edit_pcdTranstorno" 
              name="edit_pcdTranstorno"
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione...</option>
              <option value="Sim">Sim</option>
              <option value="N√£o">N√£o</option>
              <option value="N√£o informado">N√£o informado</option>
            </select>
          </div>
          
          <!-- Detalhes da defici√™ncia/transtorno (condicional) -->
          <div id="edit_pcdDetalhesContainer" class="md:col-span-2 hidden">
            <label for="edit_pcdDetalhes-input" class="block text-sm font-semibold text-gray-700 mb-2">
              Se for PCD/tem transtorno, descreva quais (diagn√≥sticos, laudos, observa√ß√µes): <span class="text-red-500">*</span>
            </label>
            
            <!-- Container de tags -->
            <div id="edit_pcdDetalhes-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
            
            <!-- Input com autocomplete -->
            <div class="relative">
              <input 
                type="text" 
                id="edit_pcdDetalhes-input"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Digite ou selecione um transtorno/defici√™ncia..."
                autocomplete="off"
              />
              <div id="edit_pcdDetalhes-suggestions" class="absolute left-0 right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-60 overflow-y-auto z-50 hidden"></div>
            </div>
            
            <!-- Campo oculto que ser√° enviado -->
            <input type="hidden" id="edit_pcdDetalhes" name="edit_pcdDetalhes" />
            
            <p class="text-xs text-gray-500 mt-1.5">
              Digite para buscar ou adicione um novo transtorno/defici√™ncia. Pressione Enter para adicionar.
            </p>
          </div>
          
          <!-- Ra√ßa/Cor -->
          <div class="md:col-span-2">
            <label for="edit_racaCor" class="block text-sm font-semibold text-gray-700 mb-2">
              Ra√ßa/Cor
            </label>
            <select 
              id="edit_racaCor" 
              name="edit_racaCor"
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione...</option>
              <option value="Branca">Branca</option>
              <option value="Preta">Preta</option>
              <option value="Parda">Parda</option>
              <option value="Amarela">Amarela</option>
              <option value="Ind√≠gena">Ind√≠gena</option>
              <option value="N√£o informado">N√£o informado</option>
            </select>
          </div>
          
          <!-- Orienta√ß√£o Sexual -->
          <div class="md:col-span-2">
            <label for="edit_orientacaoSexual" class="block text-sm font-semibold text-gray-700 mb-2">
              Orienta√ß√£o Sexual
            </label>
            <select 
              id="edit_orientacaoSexual" 
              name="edit_orientacaoSexual"
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500/60 focus:border-blue-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione...</option>
              <option value="Heterossexual">Heterossexual</option>
              <option value="Homossexual">Homossexual</option>
              <option value="Bissexual">Bissexual</option>
              <option value="Assexual">Assexual</option>
              <option value="Pansexual">Pansexual</option>
              <option value="N√£o informado">N√£o informado</option>
            </select>
          </div>
          
        </div>
      </div>
    </section>
    
    <!-- =============================================== -->
    <!-- SE√á√ÉO 2: Situa√ß√£o da Viol√™ncia -->
    <!-- =============================================== -->
    <section>
      <div class="bg-gradient-to-r from-red-50/50 to-orange-50/30 rounded-xl border border-red-200 shadow-sm p-5 mb-6">
        <div class="flex items-start gap-3 mb-5">
          <div class="h-10 w-10 flex items-center justify-center rounded-lg bg-red-100 text-red-600 text-xl flex-shrink-0 shadow-sm">
            ‚ö†Ô∏è
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-1">
              Situa√ß√£o da Viol√™ncia
            </h3>
            <p class="text-xs text-gray-600">
              Descreva o tipo de viol√™ncia ocorrida e os encaminhamentos realizados
            </p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 gap-4">
          
          <div>
            <label for="edit_tipoViolencia-input" class="block text-sm font-semibold text-gray-700 mb-2">
              Tipo de Viol√™ncia <span class="text-red-500">*</span>
            </label>
            
            <!-- Container de tags -->
            <div id="edit_tipoViolencia-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
            
            <!-- Input com autocomplete -->
            <div class="relative">
              <input 
                type="text"
                id="edit_tipoViolencia-input" 
                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Digite para adicionar tipo de viol√™ncia (ex: F√≠sica)"
                autocomplete="off"
              />
              
              <!-- Lista de sugest√µes -->
              <div id="edit_tipoViolencia-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
            </div>
            
            <!-- Campo oculto que ser√° enviado -->
            <input type="hidden" id="edit_tipoViolencia" name="edit_tipoViolencia" required />
            
            <p class="text-xs text-gray-500 mt-1.5">
              Digite e pressione Enter para adicionar. Pode adicionar m√∫ltiplos tipos (ex: F√≠sica, Psicol√≥gica).
            </p>
          </div>
          
          <div>
            <label for="edit_classificacaoViolencia-input" class="block text-sm font-semibold text-gray-700 mb-2">
              Classifica√ß√£o da Viol√™ncia
            </label>
            
            <!-- Container de tags -->
            <div id="edit_classificacaoViolencia-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
            
            <!-- Input com autocomplete -->
            <div class="relative">
              <input 
                type="text"
                id="edit_classificacaoViolencia-input" 
                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500/60 focus:border-orange-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Digite para adicionar classifica√ß√£o (ex: Intrafamiliar)"
                autocomplete="off"
              />
              
              <!-- Lista de sugest√µes -->
              <div id="edit_classificacaoViolencia-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
            </div>
            
            <!-- Campo oculto que ser√° enviado -->
            <input type="hidden" id="edit_classificacaoViolencia" name="edit_classificacaoViolencia" />
            
            <p class="text-xs text-gray-500 mt-1.5">
              Digite e pressione Enter para adicionar. Pode adicionar m√∫ltiplas classifica√ß√µes.
            </p>
          </div>
          
          <div>
            <label for="edit_motivacaoViolencia-input" class="block text-sm font-semibold text-gray-700 mb-2">
              Motiva√ß√£o da Viol√™ncia
            </label>
            
            <!-- Container de tags -->
            <div id="edit_motivacaoViolencia-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
            
            <!-- Input com autocomplete -->
            <div class="relative">
              <input 
                type="text"
                id="edit_motivacaoViolencia-input" 
                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500/60 focus:border-purple-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Digite para adicionar motiva√ß√£o (ex: Bullying)"
                autocomplete="off"
              />
              
              <!-- Lista de sugest√µes -->
              <div id="edit_motivacaoViolencia-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
            </div>
            
            <!-- Campo oculto que ser√° enviado -->
            <input type="hidden" id="edit_motivacaoViolencia" name="edit_motivacaoViolencia" />
            
            <p class="text-xs text-gray-500 mt-1.5">
              Digite e pressione Enter para adicionar. Pode adicionar m√∫ltiplas motiva√ß√µes.
            </p>
          </div>
          
          <div>
            <label for="edit_encaminhamento-input" class="block text-sm font-semibold text-gray-700 mb-2">
              Encaminhamento
            </label>
            
            <!-- Container de tags -->
            <div id="edit_encaminhamentos-tags" class="flex flex-wrap gap-2 mb-2 min-h-[40px] p-2 border border-gray-200 rounded-lg bg-gray-50"></div>
            
            <!-- Input com autocomplete -->
            <div class="relative">
              <input 
                type="text"
                id="edit_encaminhamento-input" 
                class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500/60 focus:border-red-500 transition-all duration-200 bg-white shadow-sm"
                placeholder="Digite para adicionar encaminhamento (ex: Conselho Tutelar)"
                autocomplete="off"
              />
              
              <!-- Lista de sugest√µes -->
              <div id="edit_encaminhamento-suggestions" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto"></div>
            </div>
            
            <!-- Campo oculto que ser√° enviado -->
            <input type="hidden" id="edit_encaminhamento" name="edit_encaminhamento" />
            
            <p class="text-xs text-gray-500 mt-1.5">
              Digite e pressione Enter para adicionar. Clique no √ó para remover.
            </p>
          </div>
          
        </div>
      </div>
    </section>
    
    <!-- =============================================== -->
    <!-- SE√á√ÉO 3: Unidade e Regi√£o -->
    <!-- =============================================== -->
    <section>
      <div class="bg-gradient-to-r from-green-50/50 to-emerald-50/30 rounded-xl border border-green-200 shadow-sm p-5 mb-6">
        <div class="flex items-start gap-3 mb-5">
          <div class="h-10 w-10 flex items-center justify-center rounded-lg bg-green-100 text-green-600 text-xl flex-shrink-0 shadow-sm">
            üè´
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-1">
              Unidade e Regi√£o
            </h3>
            <p class="text-xs text-gray-600">
              Identifique a institui√ß√£o de ensino e regi√£o onde o caso foi registrado
            </p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          
          <!-- Tipo de Institui√ß√£o -->
          <div class="md:col-span-2">
            <label for="edit_tipoInstituicao" class="block text-sm font-semibold text-gray-700 mb-2">
              Qual o tipo da institui√ß√£o de ensino? <span class="text-red-500">*</span>
            </label>
            <select 
              id="edit_tipoInstituicao" 
              name="edit_tipoInstituicao"
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione o tipo...</option>
              <option value="CMEI">CMEI - Centro Municipal de Educa√ß√£o Infantil</option>
              <option value="EMEF">EMEF - Escola Municipal de Ensino Fundamental</option>
            </select>
          </div>
          
          <!-- CMEI/EMEF com Autocomplete -->
          <div class="md:col-span-2">
            <label for="edit_cmeiEmef" class="block text-sm font-semibold text-gray-700 mb-2">
              Institui√ß√£o de Ensino <span class="text-red-500">*</span>
            </label>
            <div class="autocomplete-wrapper">
              <input 
                type="text" 
                id="edit_cmeiEmef" 
                name="edit_cmeiEmef" 
                required
                disabled
                autocomplete="off"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm disabled:bg-gray-50 disabled:cursor-not-allowed disabled:text-gray-500"
                placeholder="Primeiro selecione o tipo de institui√ß√£o"
              >
              <div class="autocomplete-list" id="edit_autocompleteList"></div>
            </div>
            <p class="text-xs text-gray-500 mt-1.5">Digite para filtrar as institui√ß√µes dispon√≠veis</p>
          </div>
          
          <!-- Regi√£o -->
          <div>
            <label for="edit_regiao" class="block text-sm font-semibold text-gray-700 mb-2">
              Regi√£o <span class="text-red-500">*</span>
            </label>
            <select 
              id="edit_regiao" 
              name="edit_regiao" 
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm"
            >
              <option value="">Selecione...</option>
              <!-- Op√ß√µes carregadas dinamicamente via JavaScript -->
            </select>
          </div>
          
          <!-- Respons√°vel pelo Registro -->
          <div class="md:col-span-2">
            <label for="edit_responsavelRegistro" class="block text-sm font-semibold text-gray-700 mb-2">
              Respons√°vel pelo Registro <span class="text-red-500">*</span>
            </label>
            <input 
              type="text" 
              id="edit_responsavelRegistro" 
              name="edit_responsavelRegistro" 
              required
              class="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500/60 focus:border-green-500 transition-all duration-200 bg-white shadow-sm"
              placeholder="Nome do profissional que est√° registrando"
            >
          </div>

        </div>
      </div>
    </section>
    
    <!-- =============================================== -->
    <!-- SE√á√ÉO 4: Informa√ß√µes Complementares -->
    <!-- =============================================== -->
    <section>
      <div class="bg-gradient-to-r from-purple-50/50 to-indigo-50/30 rounded-xl border border-purple-200 shadow-sm p-5">
        <div class="flex items-start gap-3 mb-5">
          <div class="h-10 w-10 flex items-center justify-center rounded-lg bg-purple-100 text-purple-600 text-xl flex-shrink-0 shadow-sm">
            ‚ùì
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-bold text-gray-800 mb-1">
              Informa√ß√µes Complementares
            </h3>
            <p class="text-xs text-gray-600">
              Responda √†s quest√µes adicionais sobre o contexto da viol√™ncia
            </p>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          
          <!-- Campos adicionais -->
          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                A fonte dos informadores foi a escola?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_fonteEscola" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_fonteEscola" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_fonteEscola" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Viol√™ncia identificada pela escola ocorrida na escola?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaEscolaOcorreu" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaEscolaOcorreu" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaEscolaOcorreu" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Algum profissional da escola foi autor da viol√™ncia?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_profissionalAutor" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_profissionalAutor" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_profissionalAutor" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Algum estudante foi autor da viol√™ncia?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudanteAutor" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudanteAutor" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudanteAutor" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Viol√™ncia identificada pela escola N√ÉO ocorrida na escola?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaNaoEscola" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaNaoEscola" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaNaoEscola" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Ocorreu na escola? (1.1)
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_ocorreuEscola" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_ocorreuEscola" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_ocorreuEscola" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                Viol√™ncia informada √† escola por qualquer um dos agentes que a comp√µe? (1.2)
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaInformada" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaInformada" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_violenciaInformada" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>
          
          <div class="md:col-span-2">
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm p-4 transition-all duration-200 hover:shadow-md hover:border-purple-300">
              <label class="block text-sm font-semibold text-gray-700 mb-3">
                üìã Foi Realizado Estudo de Caso?
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudoCaso" value="Sim" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-green-500 peer-checked:bg-green-50 peer-checked:text-green-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úì Sim
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudoCaso" value="N√£o" class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-red-500 peer-checked:bg-red-50 peer-checked:text-red-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚úó N√£o
                  </div>
                </label>
                <label class="relative flex items-center cursor-pointer">
                  <input type="radio" name="edit_estudoCaso" value="" checked class="peer sr-only">
                  <div class="px-4 py-2 rounded-lg border-2 border-gray-200 bg-gray-50 text-sm font-medium text-gray-600 transition-all peer-checked:border-gray-400 peer-checked:bg-gray-100 peer-checked:text-gray-700 hover:border-gray-300 hover:bg-gray-100">
                    ‚äò N√£o informado
                  </div>
                </label>
              </div>
            </div>
          </div>
        </div>
        
        </div>
      </div>
    </section>
        
        <div class="flex gap-4 pt-6 border-t">
          <button 
            type="submit" 
            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-md hover:shadow-lg transform hover:scale-[1.02]">
            üíæ Salvar Altera√ß√µes
          </button>
          <button 
            type="button" 
            onclick="fecharModal()" 
            class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition-all duration-200 hover:shadow-md">
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ========================================
    // CONFIGURA√á√ÉO DO GOOGLE APPS SCRIPT
    // ========================================
    // Usando configura√ß√£o centralizada (config.js)
    let APPS_SCRIPT_URL;
    
    if (typeof CONFIG !== 'undefined' && CONFIG.APPS_SCRIPT_CASOS) {
      APPS_SCRIPT_URL = CONFIG.APPS_SCRIPT_CASOS;
      console.log('‚úÖ Usando APPS_SCRIPT_CASOS do config.js');
    } else {
      console.error('‚ùå CONFIG n√£o encontrado! Verifique se config.js est√° carregado.');
      APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz-Ocm2sp-6c7bFAdLF1Da4FtRVd_gWV0deScEvOko-Sii2NpTqHwkzG0mBYjIct2-o/exec';
    }
    
    // Debug: Verifica se a URL foi carregada corretamente
    console.log('üîß [DEBUG] APPS_SCRIPT_URL:', APPS_SCRIPT_URL ? APPS_SCRIPT_URL.substring(0, 50) + '...' : 'undefined');
    
    if (!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('SEU_SCRIPT') || APPS_SCRIPT_URL.includes('SEU_ID_AQUI')) {
      const msgErro = `
‚ùå ERRO DE CONFIGURA√á√ÉO
      
A URL do Apps Script n√£o est√° configurada corretamente!

SOLU√á√ÉO:
1. Abra o arquivo: config.js
2. Localize: APPS_SCRIPT_CASOS
3. Cole a URL correta do seu Apps Script
4. Salve o arquivo
5. Pressione Ctrl+Shift+R para recarregar

URL atual: ${APPS_SCRIPT_URL || 'undefined'}
`;
      console.error(msgErro);
      alert(msgErro);
      throw new Error('APPS_SCRIPT_CASOS n√£o configurado');
    }
    
    console.log('‚úÖ URL do Apps Script configurada corretamente');
    
    let registrosCache = [];
    let registrosFiltrados = [];
    let paginaAtual = 1;
    let itensPorPagina = 25;

    // ========================================
    // LISTA DE TRANSTORNOS/DEFICI√äNCIAS PREDEFINIDOS
    // ========================================
    const transtornosPredefinidos = [
      'Autismo (TEA)',
      'TDAH (Transtorno de D√©ficit de Aten√ß√£o e Hiperatividade)',
      'S√≠ndrome de Down',
      'Defici√™ncia Intelectual',
      'Defici√™ncia Visual',
      'Defici√™ncia Auditiva',
      'Defici√™ncia F√≠sica',
      'Defici√™ncia M√∫ltipla',
      'Dist√∫rbio de Linguagem',
      'Encefalopatia Cr√¥nica',
      'Encefalopatia Epil√©tica',
      'Dislexia',
      'Discalculia',
      'Transtorno do Espectro Autista',
      'Paralisia Cerebral',
      'TOD (Transtorno Opositor Desafiador)',
      'Transtorno de Ansiedade',
      'Transtorno de P√¢nico',
      'Depress√£o Infantil',
      'S√≠ndrome de Asperger',
      'Transtorno Bipolar',
      'Esquizofrenia',
      'TOC',
      'TDI',
      'Transtorno Mental',
      'Transtorno de Conduta',
      'Transtorno Comportamental',
      'Altas Habilidades/Superdota√ß√£o',
      'Baixa Vis√£o',
      'Cegueira',
      'Surdez',
      'Surdocegueira',
      'Nanismo',
      'Hidrocefalia',
      'Microcefalia',
      'Epilepsia',
      'Outros'
    ];
    
    // ========================================
    // FUN√á√ÉO AUXILIAR: Encontrar melhor correspond√™ncia similar
    // ========================================
    function encontrarMelhorCorrespondencia(textoDigitado, opcoesDisponiveis, opcoesJaSelecionadas = []) {
      if (!textoDigitado || !opcoesDisponiveis || opcoesDisponiveis.length === 0) {
        return null;
      }
      
      const textoNormalizado = normalizarTexto(textoDigitado);
      const textoLower = textoNormalizado.toLowerCase();
      
      // Filtra op√ß√µes j√° selecionadas
      const opcoesDisponiveisFiltradas = opcoesDisponiveis.filter(op => !opcoesJaSelecionadas.includes(op));
      
      if (opcoesDisponiveisFiltradas.length === 0) {
        return null;
      }
      
      let melhorCorrespondencia = null;
      let melhorScore = 0;
      
      opcoesDisponiveisFiltradas.forEach(opcao => {
        const opcaoNormalizada = normalizarTexto(opcao);
        const opcaoLower = opcaoNormalizada.toLowerCase();
        
        // Verifica correspond√™ncia exata (ap√≥s normaliza√ß√£o)
        if (opcaoLower === textoLower) {
          melhorCorrespondencia = opcao;
          melhorScore = 1.0;
          return;
        }
        
        // Verifica se o texto digitado est√° contido na op√ß√£o ou vice-versa
        if (opcaoLower.includes(textoLower) || textoLower.includes(opcaoLower)) {
          const score = Math.min(textoLower.length, opcaoLower.length) / Math.max(textoLower.length, opcaoLower.length);
          if (score > melhorScore) {
            melhorScore = score;
            melhorCorrespondencia = opcao;
          }
        }
        
        // Calcula similaridade usando Levenshtein simplificado
        const similaridade = calcularSimilaridade(textoLower, opcaoLower);
        if (similaridade > melhorScore && similaridade >= 0.7) { // 70% de similaridade m√≠nima
          melhorScore = similaridade;
          melhorCorrespondencia = opcao;
        }
      });
      
      // Retorna apenas se a similaridade for alta o suficiente (70%+)
      return melhorScore >= 0.7 ? melhorCorrespondencia : null;
    }
    
    // Normaliza texto para compara√ß√£o
    function normalizarTexto(texto) {
      return String(texto || '')
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }
    
    // Calcula similaridade entre duas strings (0 a 1)
    function calcularSimilaridade(str1, str2) {
      if (str1 === str2) return 1.0;
      if (str1.length === 0 || str2.length === 0) return 0;
      
      // Se uma cont√©m a outra, retorna alta similaridade
      if (str1.includes(str2) || str2.includes(str1)) {
        return 0.9;
      }
      
      // Calcula dist√¢ncia de Levenshtein simplificada
      const maxLen = Math.max(str1.length, str2.length);
      const distancia = distanciaLevenshtein(str1, str2);
      return 1 - (distancia / maxLen);
    }
    
    // Calcula dist√¢ncia de Levenshtein entre duas strings
    function distanciaLevenshtein(str1, str2) {
      const matrix = [];
      const len1 = str1.length;
      const len2 = str2.length;
      
      for (let i = 0; i <= len1; i++) {
        matrix[i] = [i];
      }
      
      for (let j = 0; j <= len2; j++) {
        matrix[0][j] = j;
      }
      
      for (let i = 1; i <= len1; i++) {
        for (let j = 1; j <= len2; j++) {
          if (str1[i - 1] === str2[j - 1]) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j - 1] + 1
            );
          }
        }
      }
      
      return matrix[len1][len2];
    }
    
    // ========================================
    // LISTAS PREDEFINIDAS - RA√áA/COR E TIPO DE VIOL√äNCIA
    // ========================================
    const racasCorPredefinidas = [
      'Branca',
      'Preta',
      'Parda',
      'Amarela',
      'Ind√≠gena',
      'N√£o informado'
    ];
    
    const tiposViolenciaPredefinidos = [
      'Autoprovocada',
      'Interpessoal/Intrafamiliar/Dom√©stica',
      'Interpessoal/Extrafamiliar/Comunit√°ria/Urbana',
      'Coletiva',
      'Institucional',
      'Virtual',

    
    
    ];
    
    // LISTA DE CLASSIFICA√á√ïES DA VIOL√äNCIA
    // Deve coincidir EXATAMENTE com a valida√ß√£o da planilha
    const classificacoesViolenciaPredefinidas = [
      'Autoprovocada',
      'Intrafamiliar/Dom√©stica',
      'Extrafamiliar/Comunit√°ria/Urbana',
      'Coletiva',
      'Institucional',
      'Virtual'
    ];
    
    // LISTA DE MOTIVA√á√ïES DA VIOL√äNCIA
    // IMPORTANTE: Valores devem coincidir EXATAMENTE com a valida√ß√£o da planilha
    const motivacoesViolenciaPredefinidas = [
      'Discrimina√ß√£o',
      'Racismo',
      'G√™nero',
      'LGBTQIAPN+fobia',
      'Intoler√¢ncia religiosa',
      'Gordofobia',
      'Bullying'
    ];
    
    let editTranstornosSelecionados = [];
    let editTiposViolenciaSelecionados = [];
    let editClassificacoesViolenciaSelecionadas = [];
    let editMotivacoesViolenciaSelecionadas = [];
    let editEncaminhamentosSelecionados = [];
    
    // ========================================
    // LISTA DE ENCAMINHAMENTOS PREDEFINIDOS
    // ========================================
    const encaminhamentosPredefinidos = [
      'Conselho Tutelar',
      'Rede de Sa√∫de',
      'UBS',
      'Delegacia',
      'Delegacia da Mulher',
      'Minist√©rio P√∫blico',
      'CRAS',
      'CREAS',
      'CAPS',
      'Hospital',
      'Vara da Inf√¢ncia',
      'ONG',
      'Assist√™ncia Social',
      'Psic√≥logo',
      'Outros'
    ];
    
    // ========================================
    // LISTA DE REGI√ïES
    // ========================================
    const regioesDisponiveis = [
      'Centro', 'Continental', 'S√£o Pedro', 'Santo Ant√¥nio',
      'Praia do Canto', 'Jardim da Penha', 'Jardim Camburi',
      'Maru√≠pe', 'Bento Ferreira'
    ];

    // ========================================
    // LISTA DE INSTITUI√á√ïES (CMEI E EMEF)
    // ========================================
    const instituicoes = [
      { tipo: "CMEI", nomeOriginal: "CMEI Adalberto Sim\u00e3o Nader" },
      { tipo: "CMEI", nomeOriginal: "CMEI Altair Siqueira Costa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Araci Cortes da Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Beatriz Zouain de Oliveira Viana" },
      { tipo: "CMEI", nomeOriginal: "CMEI Bernadete Candia Ferreira de Almeida" },
      { tipo: "CMEI", nomeOriginal: "CMEI Bom Pastor" },
      { tipo: "CMEI", nomeOriginal: "CMEI Branca de Nieve Tayt-Sohn Martins de Andrade" },
      { tipo: "CMEI", nomeOriginal: "CMEI Carlos Alberto Martinelli" },
      { tipo: "CMEI", nomeOriginal: "CMEI Celina Damiao Linhalis" },
      { tipo: "CMEI", nomeOriginal: "CMEI Clotildes Gomes do Nascimento" },
      { tipo: "CMEI", nomeOriginal: "CMEI Clovis Correa do Santos" },
      { tipo: "CMEI", nomeOriginal: "CMEI Creche Tia Tereza" },
      { tipo: "CMEI", nomeOriginal: "CMEI Deolinda Lage Caldeira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Dilson Rodrigues Fonseca" },
      { tipo: "CMEI", nomeOriginal: "CMEI Domingas de Souza Costalonga" },
      { tipo: "CMEI", nomeOriginal: "CMEI Dona Laura" },
      { tipo: "CMEI", nomeOriginal: "CMEI Eliene Rodrigues dos Santos" },
      { tipo: "CMEI", nomeOriginal: "CMEI Elizabeth Santos Oliveira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Ernesto Paulino de Oliveira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Floracy Peres Faria" },
      { tipo: "CMEI", nomeOriginal: "CMEI Francisco Coelho Avanza" },
      { tipo: "CMEI", nomeOriginal: "CMEI Gilvan dos Santos Almeida" },
      { tipo: "CMEI", nomeOriginal: "CMEI Iracema Conceicao Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Irma Maria Horta" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jacyntha Simoes Ferreira Paiao" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jernida Ribeiro de Mendonca" },
      { tipo: "CMEI", nomeOriginal: "CMEI Joao Pedro Paulista Pizzol" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jose Mario Vieira Barbosa" },
      { tipo: "CMEI", nomeOriginal: "CMEI Jurema Santos Rangel" },
      { tipo: "CMEI", nomeOriginal: "CMEI Licinha Coco Oliveira" },
      { tipo: "CMEI", nomeOriginal: "CMEI Lucia Helena Rodrigues Almeida" },
      { tipo: "CMEI", nomeOriginal: "CMEI Magnolia Amaral da Cunha" },
      { tipo: "CMEI", nomeOriginal: "CMEI Marcos e Mirtes Rosa Coelho da Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria Anselmo" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria Aparecida Gomes Soares" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria das Gracas Pimentel Lyra" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria de Lourdes Fraga Rocha" },
      { tipo: "CMEI", nomeOriginal: "CMEI Maria Odetina Santos Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Merces Macedo" },
      { tipo: "CMEI", nomeOriginal: "CMEI Ocarlina Nunes Andrade" },
      { tipo: "CMEI", nomeOriginal: "CMEI Olga Souza Silva" },
      { tipo: "CMEI", nomeOriginal: "CMEI Perpetua M\u00e1rcia T Menezes" },
      { tipo: "CMEI", nomeOriginal: "CMEI Prof\u00aa Sueli Salles de Carvalho" },
      { tipo: "CMEI", nomeOriginal: "CMEI Prof\u00aa Thereza Costa Vervloet Sarmento" },
      { tipo: "CMEI", nomeOriginal: "CMEI Professora Maria Helena Souza de Freitas" },
      { tipo: "CMEI", nomeOriginal: "CMEI Professora Neusa Nunes Goncalves" },
      { tipo: "CMEI", nomeOriginal: "CMEI Projeto Quatro" },
      { tipo: "CMEI", nomeOriginal: "CMEI Recanto Feliz" },
      { tipo: "CMEI", nomeOriginal: "CMEI Regina Maura Rezende Sagrillo" },
      { tipo: "CMEI", nomeOriginal: "CMEI Valdete Rouver de Freitas" },
      { tipo: "CMEI", nomeOriginal: "CMEI Walma Rodrigues Correia" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adao Benezath" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adevalni Sysesmundo Ferreira de Azevedo" },
      { tipo: "EMEF", nomeOriginal: "EMEF Adilson da Silva Castro" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alberto de Almeida" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alvaro de Castro Mattos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Alvimar Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Aristobulo Barbosa Leao" },
      { tipo: "EMEF", nomeOriginal: "EMEF Arthur da Costa e Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Castelo Branco" },
      { tipo: "EMEF", nomeOriginal: "EMEF Ceciliano Abel de Almeida" },
      { tipo: "EMEF", nomeOriginal: "EMEF Custodia Dias de Campos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Eber Louzada Zippinotti" },
      { tipo: "EMEF", nomeOriginal: "EMEF EJA Prof Admardo Serafim de Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Eliane Rodrigues dos Santos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Elzira Vivacqua dos Santos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Experimental de Vitoria - UFES" },
      { tipo: "EMEF", nomeOriginal: "EMEF Francisco Lacerda de Aguiar" },
      { tipo: "EMEF", nomeOriginal: "EMEF Heloisa Abreu Judice de Mattos" },
      { tipo: "EMEF", nomeOriginal: "EMEF Irma Jacinta Soares de Souza Lima" },
      { tipo: "EMEF", nomeOriginal: "EMEF Juscelino Kubitschek de Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Lenir Borlot" },
      { tipo: "EMEF", nomeOriginal: "EMEF Marechal Mascarenhas de Moraes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Jose Costa Moraes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Leonor Pereira da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Maria Madalena de Oliveira Domingues" },
      { tipo: "EMEF", nomeOriginal: "EMEF Marieta Escobar" },
      { tipo: "EMEF", nomeOriginal: "EMEF Mauro Braga" },
      { tipo: "EMEF", nomeOriginal: "EMEF Neusa Nunes Goncalves" },
      { tipo: "EMEF", nomeOriginal: "EMEF Octacilio Lomba" },
      { tipo: "EMEF", nomeOriginal: "EMEF Orlandina D'Almeida Lucas" },
      { tipo: "EMEF", nomeOriginal: "EMEF Otto Ewald Junior" },
      { tipo: "EMEF", nomeOriginal: "EMEF Padre Anchieta" },
      { tipo: "EMEF", nomeOriginal: "EMEF Padre Guido Ceotto" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prezideu Amorim" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Joao Bandeira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Maria Stella de Novaes" },
      { tipo: "EMEF", nomeOriginal: "EMEF Prof Vercenilio da Silva Pascoal" },
      { tipo: "EMEF", nomeOriginal: "EMEF Professora Regina Maria Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF Rita de Cassia Oliveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF Sao Vicente de Paulo" },
      { tipo: "EMEF", nomeOriginal: "EMEF Suzete Cuendet" },
      { tipo: "EMEF", nomeOriginal: "EMEF Tancredo de Almeida Neves" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Amilton Monteiro da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Anacleta Schneider Lucas" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Edna de Mattos Siqueira Gaudio" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Izaura Marques da Silva" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Jose Aureo Monjardim" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Jose Lemos de Miranda" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Moacyr Avidos" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Paulo Reglus Neves Freire" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Paulo Roberto Vieira Gomes" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Professora Eunice Pereira Silveira" },
      { tipo: "EMEF", nomeOriginal: "EMEF TI Ronaldo Soares" },
      { tipo: "EMEF", nomeOriginal: "EMEF Zilda Andrade" }
    ];

    // Gera siglas para cada institui√ß√£o
    function gerarSiglaEdit(nomeCompleto) {
      let nome = nomeCompleto.replace(/^(CMEI|EMEF)\s+(TI\s+)?/i, '');
      const ignorar = ['de', 'da', 'do', 'das', 'dos', 'e', 'a', 'o', 'as', 'os'];
      const palavras = nome.split(' ').filter(p => p.length > 0);
      const sigla = palavras
        .filter(palavra => !ignorar.includes(palavra.toLowerCase()))
        .map(palavra => palavra[0].toUpperCase())
        .join('');
      return sigla;
    }

    instituicoes.forEach(inst => {
      inst.sigla = gerarSiglaEdit(inst.nomeOriginal);
    });

    // Vari√°veis de controle do autocomplete de institui√ß√µes
    let edit_tipoInstituicaoSelecionado = '';
    let edit_instituicoesFiltradas = [];
    let edit_indiceSelecionado = -1;
    
    // Renderiza as tags de transtornos selecionados no modal de edi√ß√£o
    function renderizarTagsTranstornosEdit() {
      const container = document.getElementById('edit_pcdDetalhes-tags');
      const hiddenInput = document.getElementById('edit_pcdDetalhes');
      
      if (editTranstornosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum transtorno/defici√™ncia adicionado</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = editTranstornosSelecionados.map((trans, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium border border-blue-200 shadow-sm">
          ${trans}
          <button 
            type="button" 
            onclick="removerTranstornoEdit(${index})"
            class="hover:bg-blue-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
            </svg>
          </button>
        </span>
      `).join('');
      
      // Atualiza campo oculto com valores separados por v√≠rgula
      hiddenInput.value = editTranstornosSelecionados.join(', ');
    }
    
    // Remove um transtorno
    function removerTranstornoEdit(index) {
      editTranstornosSelecionados.splice(index, 1);
      renderizarTagsTranstornosEdit();
    }
    
    // Adiciona um transtorno (suporta separa√ß√£o por barra /)
    function adicionarTranstornoEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Separa por barra (/) para considerar m√∫ltiplos transtornos
      const transtornos = textoTrimmed.split('/').map(t => t.trim()).filter(t => t.length > 0);
      
      // Adiciona cada transtorno separadamente
      transtornos.forEach(transtorno => {
        // Primeiro, tenta encontrar uma correspond√™ncia similar
        const correspondencia = encontrarMelhorCorrespondencia(
          transtorno, 
          transtornosPredefinidos, 
          editTranstornosSelecionados
        );
        
        // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
        const valorFinal = correspondencia || transtorno;
        
        // Evita duplicatas
        if (!editTranstornosSelecionados.includes(valorFinal)) {
          editTranstornosSelecionados.push(valorFinal);
        }
      });
      
      renderizarTagsTranstornosEdit();
      
      // Limpa input
      document.getElementById('edit_pcdDetalhes-input').value = '';
      document.getElementById('edit_pcdDetalhes-suggestions').classList.add('hidden');
    }
    
    // Filtra e mostra sugest√µes de transtornos
    function mostrarSugestoesTranstornosEdit(query) {
      const suggestionsDiv = document.getElementById('edit_pcdDetalhes-suggestions');
      
      // Se query vazia, mostra todas as op√ß√µes dispon√≠veis
      const filtrados = query.trim() === '' 
        ? transtornosPredefinidos.filter(trans => !editTranstornosSelecionados.includes(trans))
        : transtornosPredefinidos.filter(trans => 
            trans.toLowerCase().includes(query.toLowerCase()) &&
            !editTranstornosSelecionados.includes(trans)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhum transtorno encontrado. Pressione <kbd class="px-2 py-1 bg-gray-100 border border-gray-300 rounded text-xs">Enter</kbd> para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(trans => `
        <div 
          class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarTranstornoEdit('${trans.replace(/'/g, "\\\'")}')">
          ${trans}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    // Configura eventos do campo de transtornos no modal de edi√ß√£o
    function configurarEventosTranstornosEdit() {
      const pcdTranstornoSelect = document.getElementById('edit_pcdTranstorno');
      const pcdDetalhesContainer = document.getElementById('edit_pcdDetalhesContainer');
      const pcdDetalhesInput = document.getElementById('edit_pcdDetalhes-input');
      
      // Listener para mostrar/ocultar campo de detalhes
      pcdTranstornoSelect.addEventListener('change', function() {
        if (this.value === 'Sim') {
          pcdDetalhesContainer.classList.remove('hidden');
        } else {
          pcdDetalhesContainer.classList.add('hidden');
          editTranstornosSelecionados = [];
          renderizarTagsTranstornosEdit();
          pcdDetalhesInput.value = '';
        }
      });
      
      // Eventos do input de transtornos
      pcdDetalhesInput.addEventListener('focus', function(e) {
        mostrarSugestoesTranstornosEdit(e.target.value);
      });
      
      pcdDetalhesInput.addEventListener('input', function(e) {
        mostrarSugestoesTranstornosEdit(e.target.value);
      });
      
      pcdDetalhesInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTranstornoEdit(e.target.value);
        }
      });
      
      // Esconde sugest√µes ao clicar fora
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#edit_pcdDetalhes-input') && !e.target.closest('#edit_pcdDetalhes-suggestions')) {
          document.getElementById('edit_pcdDetalhes-suggestions').classList.add('hidden');
        }
      });
    }
    
    // Inicializa eventos quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
      configurarEventosTranstornosEdit();
      configurarEventosTipoViolenciaEdit();
      configurarEventosClassificacaoViolenciaEdit();
      configurarEventosMotivacaoViolenciaEdit();
      configurarEventosEncaminhamentoEdit();
      configurarEventosInstituicaoEdit();
      carregarOpcoesRegiaoEdit();
      
      // Listener para mostrar/ocultar campo de detalhes PCD
      const pcdTranstornoSelect = document.getElementById('edit_pcdTranstorno');
      const pcdDetalhesContainer = document.getElementById('edit_pcdDetalhesContainer');
      const pcdDetalhesInput = document.getElementById('edit_pcdDetalhes-input');
      
      pcdTranstornoSelect.addEventListener('change', function() {
        if (this.value === 'Sim') {
          // Mostra o campo de detalhes
          pcdDetalhesContainer.classList.remove('hidden');
          // Adiciona anima√ß√£o suave
          pcdDetalhesContainer.style.animation = 'slideDown 0.3s ease-out';
        } else {
          // Esconde o campo de detalhes
          pcdDetalhesContainer.classList.add('hidden');
          // Limpa os transtornos selecionados
          editTranstornosSelecionados = [];
          renderizarTagsTranstornosEdit();
          // Limpa input
          pcdDetalhesInput.value = '';
        }
      });
    });
    
    // ========================================
    // SISTEMA TIPO DE VIOL√äNCIA - M√öLTIPLAS TAGS (EDI√á√ÉO)
    // ========================================
    
    // Renderiza as tags de tipo de viol√™ncia
    function renderizarTagsTipoViolenciaEdit() {
      const container = document.getElementById('edit_tipoViolencia-tags');
      const hiddenInput = document.getElementById('edit_tipoViolencia');
      
      if (editTiposViolenciaSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum tipo de viol√™ncia adicionado</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = editTiposViolenciaSelecionados.map((tipo, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium border border-red-200 shadow-sm">
          ${tipo}
          <button 
            type="button" 
            onclick="removerTipoViolenciaEdit(${index})"
            class="hover:bg-red-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');
      
      // Atualiza campo oculto com valores separados por v√≠rgula
      hiddenInput.value = editTiposViolenciaSelecionados.join(', ');
    }
    
    // Remove um tipo de viol√™ncia
    function removerTipoViolenciaEdit(index) {
      editTiposViolenciaSelecionados.splice(index, 1);
      renderizarTagsTipoViolenciaEdit();
    }
    
    // Adiciona um tipo de viol√™ncia
    function adicionarTipoViolenciaEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Primeiro, tenta encontrar uma correspond√™ncia similar
      const correspondencia = encontrarMelhorCorrespondencia(
        textoTrimmed, 
        tiposViolenciaPredefinidos, 
        editTiposViolenciaSelecionados
      );
      
      // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
      const valorFinal = correspondencia || textoTrimmed;
      
      // Evita duplicatas
      if (!editTiposViolenciaSelecionados.includes(valorFinal)) {
        editTiposViolenciaSelecionados.push(valorFinal);
        renderizarTagsTipoViolenciaEdit();
      }
      
      // Limpa input
      document.getElementById('edit_tipoViolencia-input').value = '';
      document.getElementById('edit_tipoViolencia-suggestions').classList.add('hidden');
    }
    
    // Filtra e mostra sugest√µes de tipo de viol√™ncia
    function mostrarSuggestoesTipoViolenciaEdit(query) {
      const suggestionsDiv = document.getElementById('edit_tipoViolencia-suggestions');
      
      // Se query vazia, mostra todas as op√ß√µes dispon√≠veis
      const filtrados = query.trim() === '' 
        ? tiposViolenciaPredefinidos.filter(tipo => !editTiposViolenciaSelecionados.includes(tipo))
        : tiposViolenciaPredefinidos.filter(tipo => 
            tipo.toLowerCase().includes(query.toLowerCase()) &&
            !editTiposViolenciaSelecionados.includes(tipo)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(tipo => `
        <div 
          class="px-4 py-2 hover:bg-red-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarTipoViolenciaEdit('${tipo.replace(/'/g, "\\'")}')">
          ${tipo}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    function configurarEventosTipoViolenciaEdit() {
      const input = document.getElementById('edit_tipoViolencia-input');
      
      input.addEventListener('focus', function(e) {
        mostrarSuggestoesTipoViolenciaEdit(e.target.value);
      });
      
      input.addEventListener('input', function(e) {
        mostrarSuggestoesTipoViolenciaEdit(e.target.value);
      });
      
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarTipoViolenciaEdit(e.target.value);
        } else if (e.key === 'Escape') {
          document.getElementById('edit_tipoViolencia-suggestions').classList.add('hidden');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#edit_tipoViolencia-input') && !e.target.closest('#edit_tipoViolencia-suggestions')) {
          document.getElementById('edit_tipoViolencia-suggestions').classList.add('hidden');
        }
      });
    }

    // ========================================
    // SISTEMA CLASSIFICA√á√ÉO DA VIOL√äNCIA - M√öLTIPLAS TAGS (EDI√á√ÉO)
    // ========================================
    
    // Renderiza as tags de classifica√ß√£o da viol√™ncia
    function renderizarTagsClassificacaoViolenciaEdit() {
      const container = document.getElementById('edit_classificacaoViolencia-tags');
      const hiddenInput = document.getElementById('edit_classificacaoViolencia');
      
      if (editClassificacoesViolenciaSelecionadas.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhuma classifica√ß√£o adicionada</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = editClassificacoesViolenciaSelecionadas.map((classif, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium border border-orange-200 shadow-sm">
          ${classif}
          <button 
            type="button" 
            onclick="removerClassificacaoViolenciaEdit(${index})"
            class="hover:bg-orange-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');
      
      hiddenInput.value = editClassificacoesViolenciaSelecionadas.join(', ');
    }
    
    // Remove uma classifica√ß√£o
    function removerClassificacaoViolenciaEdit(index) {
      editClassificacoesViolenciaSelecionadas.splice(index, 1);
      renderizarTagsClassificacaoViolenciaEdit();
    }
    
    // Adiciona uma classifica√ß√£o
    function adicionarClassificacaoViolenciaEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Primeiro, tenta encontrar uma correspond√™ncia similar
      const correspondencia = encontrarMelhorCorrespondencia(
        textoTrimmed, 
        classificacoesViolenciaPredefinidas, 
        editClassificacoesViolenciaSelecionadas
      );
      
      // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
      const valorFinal = correspondencia || textoTrimmed;
      
      // Evita duplicatas
      if (!editClassificacoesViolenciaSelecionadas.includes(valorFinal)) {
        editClassificacoesViolenciaSelecionadas.push(valorFinal);
        renderizarTagsClassificacaoViolenciaEdit();
      }
      
      // Limpa input
      document.getElementById('edit_classificacaoViolencia-input').value = '';
      document.getElementById('edit_classificacaoViolencia-suggestions').classList.add('hidden');
    }
    
    // Filtra e mostra sugest√µes
    function mostrarSugestoesClassificacaoViolenciaEdit(query) {
      const suggestionsDiv = document.getElementById('edit_classificacaoViolencia-suggestions');
      
      const filtrados = query.trim() === '' 
        ? classificacoesViolenciaPredefinidas.filter(classif => !editClassificacoesViolenciaSelecionadas.includes(classif))
        : classificacoesViolenciaPredefinidas.filter(classif => 
            classif.toLowerCase().includes(query.toLowerCase()) &&
            !editClassificacoesViolenciaSelecionadas.includes(classif)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(classif => `
        <div 
          class="px-4 py-2 hover:bg-orange-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarClassificacaoViolenciaEdit('${classif.replace(/'/g, "\\'")}')">
          ${classif}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    function configurarEventosClassificacaoViolenciaEdit() {
      const input = document.getElementById('edit_classificacaoViolencia-input');
      
      input.addEventListener('focus', function(e) {
        mostrarSugestoesClassificacaoViolenciaEdit(e.target.value);
      });
      
      input.addEventListener('input', function(e) {
        mostrarSugestoesClassificacaoViolenciaEdit(e.target.value);
      });
      
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarClassificacaoViolenciaEdit(e.target.value);
        } else if (e.key === 'Escape') {
          document.getElementById('edit_classificacaoViolencia-suggestions').classList.add('hidden');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#edit_classificacaoViolencia-input') && !e.target.closest('#edit_classificacaoViolencia-suggestions')) {
          document.getElementById('edit_classificacaoViolencia-suggestions').classList.add('hidden');
        }
      });
    }

    // ========================================
    // SISTEMA MOTIVA√á√ÉO DA VIOL√äNCIA - M√öLTIPLAS TAGS (EDI√á√ÉO)
    // ========================================
    
    // Renderiza as tags de motiva√ß√£o da viol√™ncia
    function renderizarTagsMotivacaoViolenciaEdit() {
      const container = document.getElementById('edit_motivacaoViolencia-tags');
      const hiddenInput = document.getElementById('edit_motivacaoViolencia');
      
      if (editMotivacoesViolenciaSelecionadas.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhuma motiva√ß√£o adicionada</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = editMotivacoesViolenciaSelecionadas.map((motiv, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-purple-100 text-purple-700 rounded-lg text-sm font-medium border border-purple-200 shadow-sm">
          ${motiv}
          <button 
            type="button" 
            onclick="removerMotivacaoViolenciaEdit(${index})"
            class="hover:bg-purple-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');
      
      hiddenInput.value = editMotivacoesViolenciaSelecionadas.join(', ');
    }
    
    // Remove uma motiva√ß√£o
    function removerMotivacaoViolenciaEdit(index) {
      editMotivacoesViolenciaSelecionadas.splice(index, 1);
      renderizarTagsMotivacaoViolenciaEdit();
    }
    
    // Adiciona uma motiva√ß√£o
    function adicionarMotivacaoViolenciaEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Primeiro, tenta encontrar uma correspond√™ncia similar
      const correspondencia = encontrarMelhorCorrespondencia(
        textoTrimmed, 
        motivacoesViolenciaPredefinidas, 
        editMotivacoesViolenciaSelecionadas
      );
      
      // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
      const valorFinal = correspondencia || textoTrimmed;
      
      // Evita duplicatas
      if (!editMotivacoesViolenciaSelecionadas.includes(valorFinal)) {
        editMotivacoesViolenciaSelecionadas.push(valorFinal);
        renderizarTagsMotivacaoViolenciaEdit();
      }
      
      // Limpa input
      document.getElementById('edit_motivacaoViolencia-input').value = '';
      document.getElementById('edit_motivacaoViolencia-suggestions').classList.add('hidden');
    }
    
    // Filtra e mostra sugest√µes
    function mostrarSugestoesMotivacaoViolenciaEdit(query) {
      const suggestionsDiv = document.getElementById('edit_motivacaoViolencia-suggestions');
      
      const filtrados = query.trim() === '' 
        ? motivacoesViolenciaPredefinidas.filter(motiv => !editMotivacoesViolenciaSelecionadas.includes(motiv))
        : motivacoesViolenciaPredefinidas.filter(motiv => 
            motiv.toLowerCase().includes(query.toLowerCase()) &&
            !editMotivacoesViolenciaSelecionadas.includes(motiv)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(motiv => `
        <div 
          class="px-4 py-2 hover:bg-purple-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarMotivacaoViolenciaEdit('${motiv.replace(/'/g, "\\'")}')">
          ${motiv}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    function configurarEventosMotivacaoViolenciaEdit() {
      const input = document.getElementById('edit_motivacaoViolencia-input');
      
      input.addEventListener('focus', function(e) {
        mostrarSugestoesMotivacaoViolenciaEdit(e.target.value);
      });
      
      input.addEventListener('input', function(e) {
        mostrarSugestoesMotivacaoViolenciaEdit(e.target.value);
      });
      
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarMotivacaoViolenciaEdit(e.target.value);
        } else if (e.key === 'Escape') {
          document.getElementById('edit_motivacaoViolencia-suggestions').classList.add('hidden');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#edit_motivacaoViolencia-input') && !e.target.closest('#edit_motivacaoViolencia-suggestions')) {
          document.getElementById('edit_motivacaoViolencia-suggestions').classList.add('hidden');
        }
      });
    }

    // ========================================
    // SISTEMA DE ENCAMINHAMENTO COM TAGS (EDI√á√ÉO)
    // ========================================
    function renderizarTagsEncaminhamentoEdit() {
      const container = document.getElementById('edit_encaminhamentos-tags');
      const hiddenInput = document.getElementById('edit_encaminhamento');
      
      if (editEncaminhamentosSelecionados.length === 0) {
        container.innerHTML = '<span class="text-gray-400 text-sm">Nenhum encaminhamento adicionado</span>';
        hiddenInput.value = '';
        return;
      }
      
      container.innerHTML = editEncaminhamentosSelecionados.map((enc, index) => `
        <span class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-red-100 text-red-700 rounded-lg text-sm font-medium border border-red-200 shadow-sm">
          ${enc}
          <button 
            type="button" 
            onclick="removerEncaminhamentoEdit(${index})"
            class="hover:bg-red-200 rounded-full p-0.5 transition-colors">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </button>
        </span>
      `).join('');
      
      hiddenInput.value = editEncaminhamentosSelecionados.join(', ');
    }
    
    function removerEncaminhamentoEdit(index) {
      editEncaminhamentosSelecionados.splice(index, 1);
      renderizarTagsEncaminhamentoEdit();
    }
    
    function adicionarEncaminhamentoEdit(texto) {
      const textoTrimmed = texto.trim();
      if (!textoTrimmed) return;
      
      // Primeiro, tenta encontrar uma correspond√™ncia similar
      const correspondencia = encontrarMelhorCorrespondencia(
        textoTrimmed, 
        encaminhamentosPredefinidos, 
        editEncaminhamentosSelecionados
      );
      
      // Se encontrou correspond√™ncia similar, usa ela; caso contr√°rio, usa o texto digitado
      const valorFinal = correspondencia || textoTrimmed;
      
      if (!editEncaminhamentosSelecionados.includes(valorFinal)) {
        editEncaminhamentosSelecionados.push(valorFinal);
        renderizarTagsEncaminhamentoEdit();
      }
      
      document.getElementById('edit_encaminhamento-input').value = '';
      document.getElementById('edit_encaminhamento-suggestions').classList.add('hidden');
    }
    
    function mostrarSugestoesEncaminhamentoEdit(query) {
      const suggestionsDiv = document.getElementById('edit_encaminhamento-suggestions');
      
      const filtrados = query.trim() === '' 
        ? encaminhamentosPredefinidos.filter(enc => !editEncaminhamentosSelecionados.includes(enc))
        : encaminhamentosPredefinidos.filter(enc => 
            enc.toLowerCase().includes(query.toLowerCase()) &&
            !editEncaminhamentosSelecionados.includes(enc)
          );
      
      if (filtrados.length === 0) {
        if (query.trim()) {
          suggestionsDiv.innerHTML = `
            <div class="p-3 text-sm text-gray-500">
              Nenhuma sugest√£o. Pressione Enter para adicionar "${query}"
            </div>
          `;
          suggestionsDiv.classList.remove('hidden');
        } else {
          suggestionsDiv.classList.add('hidden');
        }
        return;
      }
      
      suggestionsDiv.innerHTML = filtrados.map(enc => `
        <div 
          class="px-4 py-2 hover:bg-red-50 cursor-pointer text-sm transition-colors border-b border-gray-100 last:border-0"
          onclick="adicionarEncaminhamentoEdit('${enc}')">
          ${enc}
        </div>
      `).join('');
      
      suggestionsDiv.classList.remove('hidden');
    }
    
    function configurarEventosEncaminhamentoEdit() {
      const input = document.getElementById('edit_encaminhamento-input');
      
      input.addEventListener('focus', function(e) {
        mostrarSugestoesEncaminhamentoEdit(e.target.value);
      });
      
      input.addEventListener('input', function(e) {
        mostrarSugestoesEncaminhamentoEdit(e.target.value);
      });
      
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          adicionarEncaminhamentoEdit(e.target.value);
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!e.target.closest('#edit_encaminhamento-input') && !e.target.closest('#edit_encaminhamento-suggestions')) {
          document.getElementById('edit_encaminhamento-suggestions').classList.add('hidden');
        }
      });
    }

    // ========================================
    // SISTEMA DE AUTOCOMPLETE CMEI/EMEF (EDI√á√ÉO)
    // ========================================
    function removerAcentosEdit(texto) {
      return texto.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    }

    function filtrarInstituicoesEdit(termo) {
      const termoLower = removerAcentosEdit(termo.toLowerCase());
      const termoSemEspacos = termoLower.replace(/\s+/g, '');
      
      return edit_instituicoesFiltradas.filter(inst => {
        const nomeNormalizado = removerAcentosEdit(inst.nomeOriginal.toLowerCase());
        const siglaNormalizada = removerAcentosEdit(inst.sigla.toLowerCase());
        
        const palavras = termoLower.split(' ').filter(p => p.length > 0);
        const matchPorPalavras = palavras.every(palavra => nomeNormalizado.includes(palavra));
        const matchPorSigla = siglaNormalizada.includes(termoSemEspacos);
        const matchPorIniciaisConsecutivas = siglaNormalizada.startsWith(termoSemEspacos);
        
        return matchPorPalavras || matchPorSigla || matchPorIniciaisConsecutivas;
      });
    }

    function renderizarSugestoesEdit(resultados) {
      const autocompleteList = document.getElementById('edit_autocompleteList');
      
      if (resultados.length === 0) {
        autocompleteList.classList.remove('show');
        return;
      }
      
      autocompleteList.innerHTML = resultados
        .slice(0, 10)
        .map(inst => `
          <div class="autocomplete-item" data-value="${inst.nomeOriginal}">
            ${inst.nomeOriginal}
          </div>
        `).join('');
      
      autocompleteList.classList.add('show');
      
      autocompleteList.querySelectorAll('.autocomplete-item').forEach(item => {
        item.addEventListener('click', function() {
          document.getElementById('edit_cmeiEmef').value = this.textContent.trim();
          document.getElementById('edit_cmeiEmef').setAttribute('data-user-edited', 'true');
          autocompleteList.classList.remove('show');
        });
      });
    }

    function atualizarSelecaoVisualEdit(items) {
      items.forEach((item, index) => {
        if (index === edit_indiceSelecionado) {
          item.classList.add('selected');
          item.scrollIntoView({ block: 'nearest' });
        } else {
          item.classList.remove('selected');
        }
      });
    }

    function configurarEventosInstituicaoEdit() {
      const tipoInstituicaoSelect = document.getElementById('edit_tipoInstituicao');
      const cmeiEmefInput = document.getElementById('edit_cmeiEmef');
      const autocompleteList = document.getElementById('edit_autocompleteList');
      
tipoInstituicaoSelect.addEventListener('change', function() {
  edit_tipoInstituicaoSelecionado = this.value;
  
  // CR√çTICO: N√£o limpa o campo se estamos carregando dados de edi√ß√£o
  const isLoading = cmeiEmefInput.getAttribute('data-loading') === 'true';
  
  if (edit_tipoInstituicaoSelecionado) {
    cmeiEmefInput.disabled = false;
    cmeiEmefInput.placeholder = 'Digite para buscar...';
    
    // S√≥ limpa o campo se N√ÉO estiver carregando dados
    if (!isLoading) {
      cmeiEmefInput.value = '';
      cmeiEmefInput.focus();
    }
    
    edit_instituicoesFiltradas = instituicoes.filter(inst => inst.tipo === edit_tipoInstituicaoSelecionado);
  } else {
    cmeiEmefInput.disabled = true;
    cmeiEmefInput.placeholder = 'Primeiro selecione o tipo de institui√ß√£o';
    
    // S√≥ limpa o campo se N√ÉO estiver carregando dados
    if (!isLoading) {
      cmeiEmefInput.value = '';
    }
    
    autocompleteList.classList.remove('show');
  }
});
      
      cmeiEmefInput.addEventListener('input', function() {
        const termo = this.value.trim();
        edit_indiceSelecionado = -1;
        
        if (termo.length === 0) {
          autocompleteList.classList.remove('show');
          return;
        }
        
        const resultados = filtrarInstituicoesEdit(termo);
        renderizarSugestoesEdit(resultados);
      });
      
      cmeiEmefInput.addEventListener('keydown', function(e) {
        const items = autocompleteList.querySelectorAll('.autocomplete-item');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          edit_indiceSelecionado = Math.min(edit_indiceSelecionado + 1, items.length - 1);
          atualizarSelecaoVisualEdit(items);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          edit_indiceSelecionado = Math.max(edit_indiceSelecionado - 1, -1);
          atualizarSelecaoVisualEdit(items);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (edit_indiceSelecionado >= 0 && items[edit_indiceSelecionado]) {
            items[edit_indiceSelecionado].click();
          }
        } else if (e.key === 'Escape') {
          autocompleteList.classList.remove('show');
        }
      });
      
      document.addEventListener('click', function(e) {
        if (!cmeiEmefInput.contains(e.target) && !autocompleteList.contains(e.target)) {
          autocompleteList.classList.remove('show');
        }
      });
    }

    // ========================================
    // CARREGAR OP√á√ïES DE REGI√ÉO (EDI√á√ÉO)
    // ========================================
    function carregarOpcoesRegiaoEdit() {
      const select = document.getElementById('edit_regiao');
      select.innerHTML = '<option value="">Selecione...</option>';
      
      regioesDisponiveis.forEach(function(regiao) {
        const option = document.createElement('option');
        option.value = regiao;
        option.textContent = regiao;
        select.appendChild(option);
      });
    }

    // ========================================
    // FUN√á√ïES DE ALERTA
    // ========================================
    function mostrarAlerta(mensagem, tipo = 'info') {
      const container = document.getElementById('alertContainer');
      const cores = {
        success: 'bg-green-50 border-green-200 text-green-800',
        error: 'bg-red-50 border-red-200 text-red-800',
        info: 'bg-blue-50 border-blue-200 text-blue-800'
      };
      
      const alerta = document.createElement('div');
      alerta.className = `alert ${cores[tipo]} border-l-4 p-4 mb-4 rounded-lg shadow-md`;
      alerta.innerHTML = `
        <div class="flex items-center justify-between">
          <p class="font-medium">${mensagem}</p>
          <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 ml-4">√ó</button>
        </div>
      `;
      
      container.appendChild(alerta);
      setTimeout(() => alerta.remove(), 5000);
    }

    // ========================================
    // CARREGAR REGISTROS DA PLANILHA
    // ========================================
    function carregarRegistros(manterPagina = false) {
      const btn = document.getElementById('btnCarregar');
      const info = document.getElementById('loadingInfo');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="animate-spin inline-block">‚è≥</span> <span>Carregando...</span>';
      btn.classList.add('opacity-75', 'cursor-not-allowed');
      info.textContent = 'Buscando dados da planilha...';
      info.classList.add('animate-pulse');
      
      // Cria iframe oculto (otimizado)
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = APPS_SCRIPT_URL + '?action=list&t=' + Date.now();
      
      // Listener para receber resposta
      const messageHandler = function(event) {
        // Aceita APENAS mensagens do Google Apps Script
        if (!event.origin.includes('google')) {
          return; // Ignora silenciosamente outras origens
        }
        
        // Verifica se √© a resposta esperada (tem success e registros)
        if (!event.data || typeof event.data.success === 'undefined') {
          return; // Ignora mensagens que n√£o s√£o do nosso Apps Script
        }
        
        btn.disabled = false;
        btn.innerHTML = 'üîÑ Carregar Registros';
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        info.classList.remove('animate-pulse');
        
        if (event.data.success && event.data.registros) {
          registrosCache = event.data.registros;
          renderizarTabela(event.data.registros, manterPagina);
          info.textContent = event.data.registros.length + ' registros encontrados';
          info.classList.remove('text-red-600');
          info.classList.add('text-green-600');
        } else {
          info.textContent = 'Erro ao carregar';
          info.classList.remove('text-green-600');
          info.classList.add('text-red-600');
          mostrarAlerta('‚ùå ' + (event.data.message || 'Erro ao carregar registros'), 'error');
        }
        
        window.removeEventListener('message', messageHandler);
        setTimeout(() => iframe.remove(), 100);
      };
      
      window.addEventListener('message', messageHandler);
      document.body.appendChild(iframe);
      
      // Timeout otimizado (reduzido de 15s para 8s)
      setTimeout(() => {
        if (btn.disabled) {
          btn.disabled = false;
          btn.innerHTML = 'üîÑ Carregar Registros';
          btn.classList.remove('opacity-75', 'cursor-not-allowed');
          info.textContent = 'Timeout';
          info.classList.remove('animate-pulse', 'text-green-600');
          info.classList.add('text-red-600');
          window.removeEventListener('message', messageHandler);
          iframe.remove();
          mostrarAlerta('‚è±Ô∏è Timeout ao carregar', 'error');
        }
      }, 8000);
    }

    // ========================================
    // RENDERIZAR TABELA COM PAGINA√á√ÉO
    // ========================================
    function renderizarTabela(registros, manterPagina = false) {
      registrosFiltrados = registros || [];
      if (!manterPagina) {
        paginaAtual = 1; // Reset para primeira p√°gina apenas se n√£o for reload
      }
      renderizarPagina();
    }

    function renderizarPagina() {
      const tbody = document.getElementById('corpoTabela');
      const registros = registrosFiltrados;
      
      if (!registros || registros.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-4 py-12 text-center text-gray-500">
              <div class="flex flex-col items-center gap-3">
                <div class="text-5xl">üîç</div>
                <div class="text-lg font-medium">Nenhum registro encontrado</div>
              </div>
            </td>
          </tr>
        `;
        atualizarContadores(0, 0);
        renderizarPaginacao(0);
        return;
      }
      
      // Calcula √≠ndices da pagina√ß√£o
      const inicio = (paginaAtual - 1) * itensPorPagina;
      const fim = inicio + itensPorPagina;
      const registrosPagina = registros.slice(inicio, fim);
      
      tbody.innerHTML = registrosPagina.map((reg, idx) => `
        <tr class="hover:bg-blue-50/50 transition-colors duration-150 border-b border-gray-100" data-nome="${(reg.criancaEstudante || '').toLowerCase()}">
          <td class="px-4 py-4 text-sm text-gray-800 font-medium">
            ${reg.criancaEstudante || '-'}
            ${(reg.pcdTranstorno === 'Sim' && reg.pcdDetalhes) ? '<span class="ml-2 text-blue-600" title="PCD: ' + (reg.pcdDetalhes || '').replace(/"/g, '&quot;') + '">‚ôø</span>' : ''}
          </td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.dataNT || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.idade || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded-full text-xs font-semibold">
              ${reg.tipoViolencia || '-'}
            </span>
          </td>
          <td class="px-4 py-4 text-sm text-gray-600">${reg.cmeiEmef || '-'}</td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
              ${reg.regiao || '-'}
            </span>
          </td>
          <td class="px-4 py-4 text-sm text-gray-600">
            <span class="px-2 py-1 ${reg.estudoCaso === 'Sim' ? 'bg-green-100 text-green-800' : reg.estudoCaso === 'N√£o' ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-600'} rounded-full text-xs font-semibold">
              ${reg.estudoCaso || 'N√£o informado'}
            </span>
          </td>
          <td class="px-4 py-4">
            <div class="flex gap-2 justify-center">
              <button 
                onclick="abrirEdicao(${reg.linha})"
                class="px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg text-xs font-semibold hover:from-blue-600 hover:to-blue-700 transition shadow hover:shadow-md flex items-center gap-1">
                <span>‚úèÔ∏è</span>
                <span>Editar</span>
              </button>
              <button 
                onclick="confirmarExclusao(${reg.linha}, '${(reg.criancaEstudante || '').replace(/'/g, "\\'")}')"
                class="px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg text-xs font-semibold hover:from-red-600 hover:to-red-700 transition shadow hover:shadow-md flex items-center gap-1">
                <span>üóëÔ∏è</span>
                <span>Excluir</span>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
      
      atualizarContadores(registros.length, registrosPagina.length);
      renderizarPaginacao(registros.length);
    }

    // ========================================
    // PAGINA√á√ÉO
    // ========================================
    function renderizarPaginacao(total) {
      const container = document.getElementById('paginacaoControles');
      const totalPaginas = Math.ceil(total / itensPorPagina);
      
      if (totalPaginas <= 1) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // Bot√£o Anterior
      html += `
        <button 
          onclick="irParaPagina(${paginaAtual - 1})" 
          ${paginaAtual === 1 ? 'disabled' : ''}
          class="group px-4 py-2 rounded-lg font-semibold transition-all duration-200 ${paginaAtual === 1 ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 hover:shadow-lg hover:scale-105 active:scale-95'}">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4 ${paginaAtual === 1 ? '' : 'group-hover:-translate-x-1 transition-transform'}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/>
            </svg>
            Anterior
          </span>
        </button>
      `;
      
      // N√∫meros das p√°ginas - mostra no m√°ximo 3 n√∫meros + primeira e √∫ltima
      const maxBotoesVisiveis = 3;
      
      // Se total de p√°ginas √© menor ou igual a 5, mostra todas
      if (totalPaginas <= 5) {
        for (let i = 1; i <= totalPaginas; i++) {
          html += `
            <button 
              onclick="irParaPagina(${i})" 
              class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${i === paginaAtual ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">
              ${i}
            </button>
          `;
        }
      } else {
        // Sempre mostra primeira p√°gina
        html += `<button onclick="irParaPagina(1)" class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${paginaAtual === 1 ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">1</button>`;
        
        // Determina quais p√°ginas do meio mostrar
        let inicio, fim;
        
        if (paginaAtual <= 3) {
          // Pr√≥ximo √†s primeiras p√°ginas: mostra 2, 3, 4
          inicio = 2;
          fim = 4;
        } else if (paginaAtual >= totalPaginas - 2) {
          // Pr√≥ximo √†s √∫ltimas p√°ginas: mostra (total-3), (total-2), (total-1)
          inicio = totalPaginas - 3;
          fim = totalPaginas - 1;
        } else {
          // No meio: mostra (atual-1), atual, (atual+1)
          inicio = paginaAtual - 1;
          fim = paginaAtual + 1;
        }
        
        // Adiciona elipse antes se necess√°rio
        if (inicio > 2) {
          html += '<span class="text-gray-400 font-bold px-2">‚Ä¢‚Ä¢‚Ä¢</span>';
        }
        
        // Mostra as p√°ginas do meio
        for (let i = inicio; i <= fim; i++) {
          html += `
            <button 
              onclick="irParaPagina(${i})" 
              class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${i === paginaAtual ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">
              ${i}
            </button>
          `;
        }
        
        // Adiciona elipse depois se necess√°rio
        if (fim < totalPaginas - 1) {
          html += '<span class="text-gray-400 font-bold px-2">‚Ä¢‚Ä¢‚Ä¢</span>';
        }
        
        // Sempre mostra √∫ltima p√°gina
        html += `<button onclick="irParaPagina(${totalPaginas})" class="px-4 py-2 rounded-lg font-bold transition-all duration-200 hover:scale-105 active:scale-95 ${paginaAtual === totalPaginas ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg border-2 border-blue-600 scale-110' : 'bg-white text-gray-700 border-2 border-gray-300 hover:border-blue-500 hover:text-blue-600 hover:shadow-md'}">${totalPaginas}</button>`;
      }
      
      // Bot√£o Pr√≥ximo
      html += `
        <button 
          onclick="irParaPagina(${paginaAtual + 1})" 
          ${paginaAtual === totalPaginas ? 'disabled' : ''}
          class="group px-4 py-2 rounded-lg font-semibold transition-all duration-200 ${paginaAtual === totalPaginas ? 'bg-gray-100 text-gray-300 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-blue-600 text-white hover:from-blue-600 hover:to-blue-700 hover:shadow-lg hover:scale-105 active:scale-95'}">
          <span class="flex items-center gap-1">
            Pr√≥ximo
            <svg class="w-4 h-4 ${paginaAtual === totalPaginas ? '' : 'group-hover:translate-x-1 transition-transform'}" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
          </span>
        </button>
      `;
      
      container.innerHTML = html;
    }

    function irParaPagina(pagina) {
      const totalPaginas = Math.ceil(registrosFiltrados.length / itensPorPagina);
      if (pagina < 1 || pagina > totalPaginas) return;
      paginaAtual = pagina;
      renderizarPagina();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function mudarItensPorPagina() {
      itensPorPagina = parseInt(document.getElementById('itensPorPagina').value);
      paginaAtual = 1;
      renderizarPagina();
    }

    // ========================================
    // FILTRAR TABELA POR NOME
    // ========================================
    function filtrarTabela() {
      const busca = document.getElementById('campoBusca').value.toLowerCase().trim();
      
      if (!busca) {
        registrosFiltrados = registrosCache;
      } else {
        registrosFiltrados = registrosCache.filter(reg => 
          (reg.criancaEstudante || '').toLowerCase().includes(busca)
        );
      }
      
      paginaAtual = 1;
      renderizarPagina();
    }

    // ========================================
    // ATUALIZAR CONTADORES
    // ========================================
    function atualizarContadores(total, visiveis) {
      document.getElementById('totalRegistros').textContent = total;
      document.getElementById('registrosVisiveis').textContent = visiveis;
    }

    // ========================================
    // ABRIR MODAL DE EDI√á√ÉO
    // ========================================
    function abrirEdicao(linha) {
      const registro = registrosCache.find(r => r.linha === linha);
      
      if (!registro) {
        mostrarAlerta('‚ùå Registro n√£o encontrado!', 'error');
        return;
      }
      
      console.log('[gerenciar] Abrindo edi√ß√£o do registro:', registro);
      console.log('[gerenciar] dataNT_ISO:', registro.dataNT_ISO);
      console.log('[gerenciar] identidadeGenero:', registro.identidadeGenero);
      
      // Preenche TODOS os campos do formul√°rio
      document.getElementById('edit_linha').value = linha;
      document.getElementById('edit_criancaEstudante').value = registro.criancaEstudante || '';
      document.getElementById('edit_dataNT').value = registro.dataNT_ISO || '';
      document.getElementById('edit_idade').value = registro.idade || '';
      
      // Mapeamento de identidade de g√™nero (compatibilidade com registros antigos)
      let identidadeGeneroValue = (registro.identidadeGenero || '').trim();
      const mapeamentoGenero = {
        'Menino': 'M',
        'Menina': 'F',
        'M': 'M',
        'F': 'F',
        'N√£o-bin√°rio': 'N√£o-bin√°rio',
        'Outro': 'Outro'
      };
      identidadeGeneroValue = mapeamentoGenero[identidadeGeneroValue] || identidadeGeneroValue;
      document.getElementById('edit_identidadeGenero').value = identidadeGeneroValue;
      console.log('[gerenciar] identidadeGenero original:', registro.identidadeGenero, '‚Üí mapeado:', identidadeGeneroValue);
      
      document.getElementById('edit_pcdTranstorno').value = (registro.pcdTranstorno || '').trim();
      document.getElementById('edit_encaminhamento').value = registro.encaminhamento || '';
      document.getElementById('edit_cmeiEmef').value = registro.cmeiEmef || '';
      document.getElementById('edit_regiao').value = registro.regiao || '';
      document.getElementById('edit_responsavelRegistro').value = registro.responsavelRegistro || '';
      
      // Preenche campos adicionais (radio buttons)
      // Fonte Escola
      const fonteEscolaValue = (registro.fonteEscola || '').trim();
      const fonteEscolaRadio = document.querySelector(`input[name="edit_fonteEscola"][value="${fonteEscolaValue}"]`);
      if (fonteEscolaRadio) fonteEscolaRadio.checked = true;
      
      // Viol√™ncia Escola Ocorreu
      const violenciaEscolaValue = (registro.violenciaEscolaOcorreu || '').trim();
      const violenciaEscolaRadio = document.querySelector(`input[name="edit_violenciaEscolaOcorreu"][value="${violenciaEscolaValue}"]`);
      if (violenciaEscolaRadio) violenciaEscolaRadio.checked = true;
      
      // Profissional Autor
      const profissionalAutorValue = (registro.profissionalAutor || '').trim();
      const profissionalAutorRadio = document.querySelector(`input[name="edit_profissionalAutor"][value="${profissionalAutorValue}"]`);
      if (profissionalAutorRadio) profissionalAutorRadio.checked = true;
      
      // Estudante Autor
      const estudanteAutorValue = (registro.estudanteAutor || '').trim();
      const estudanteAutorRadio = document.querySelector(`input[name="edit_estudanteAutor"][value="${estudanteAutorValue}"]`);
      if (estudanteAutorRadio) estudanteAutorRadio.checked = true;
      
      // Viol√™ncia N√£o Escola
      const violenciaNaoEscolaValue = (registro.violenciaNaoEscola || '').trim();
      const violenciaNaoEscolaRadio = document.querySelector(`input[name="edit_violenciaNaoEscola"][value="${violenciaNaoEscolaValue}"]`);
      if (violenciaNaoEscolaRadio) violenciaNaoEscolaRadio.checked = true;
      
      // Ocorreu Escola
      const ocorreuEscolaValue = (registro.ocorreuEscola || '').trim();
      const ocorreuEscolaRadio = document.querySelector(`input[name="edit_ocorreuEscola"][value="${ocorreuEscolaValue}"]`);
      if (ocorreuEscolaRadio) ocorreuEscolaRadio.checked = true;
      
      // Viol√™ncia Informada
      const violenciaInformadaValue = (registro.violenciaInformada || '').trim();
      const violenciaInformadaRadio = document.querySelector(`input[name="edit_violenciaInformada"][value="${violenciaInformadaValue}"]`);
      if (violenciaInformadaRadio) violenciaInformadaRadio.checked = true;
      
      // Estudo de Caso
      const estudoCasoValue = (registro.estudoCaso || '').trim();
      const estudoCasoRadio = document.querySelector(`input[name="edit_estudoCaso"][value="${estudoCasoValue}"]`);
      if (estudoCasoRadio) estudoCasoRadio.checked = true;
      
      // Preenche campo pcdDetalhes e configura exibi√ß√£o condicional
      const pcdDetalhesContainer = document.getElementById('edit_pcdDetalhesContainer');
      const pcdDetalhesValue = registro.pcdDetalhes || '';
      
      // Limpa transtornos anteriores e popula com os do registro
      editTranstornosSelecionados = [];
      if (pcdDetalhesValue) {
        // Separa por v√≠rgula e depois por barra para processar corretamente
        const transtornos = pcdDetalhesValue
          .split(',')
          .flatMap(t => t.split('/'))
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editTranstornosSelecionados = transtornos;
      }
      renderizarTagsTranstornosEdit();
      
      // Preenche campo racaCor (select simples)
      const racaCorValue = (registro.racaCor || '').trim();
      document.getElementById('edit_racaCor').value = racaCorValue;
      console.log('[gerenciar] Campo racaCor preenchido com:', racaCorValue);
      
      // Preenche campo orientacaoSexual (select simples)
      const orientacaoSexualValue = (registro.orientacaoSexual || '').trim();
      document.getElementById('edit_orientacaoSexual').value = orientacaoSexualValue;
      console.log('[gerenciar] Campo orientacaoSexual preenchido com:', orientacaoSexualValue);
      
      // Preenche campo tipoViolencia (M√öLTIPLAS TAGS)
      editTiposViolenciaSelecionados = [];
      const tipoViolenciaValue = registro.tipoViolencia || '';
      if (tipoViolenciaValue) {
        const tipos = tipoViolenciaValue
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editTiposViolenciaSelecionados = tipos;
      }
      renderizarTagsTipoViolenciaEdit();
      console.log('[gerenciar] Tipos de viol√™ncia carregados:', editTiposViolenciaSelecionados);
      
      // Preenche campo classificacaoViolencia (M√öLTIPLAS TAGS)
      editClassificacoesViolenciaSelecionadas = [];
      const classificacaoViolenciaValue = registro.classificacaoViolencia || '';
      if (classificacaoViolenciaValue) {
        const classificacoes = classificacaoViolenciaValue
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editClassificacoesViolenciaSelecionadas = classificacoes;
      }
      renderizarTagsClassificacaoViolenciaEdit();
      console.log('[gerenciar] Classifica√ß√µes da viol√™ncia carregadas:', editClassificacoesViolenciaSelecionadas);
      
      // Preenche campo motivacaoViolencia (M√öLTIPLAS TAGS)
      editMotivacoesViolenciaSelecionadas = [];
      const motivacaoViolenciaValue = registro.motivacaoViolencia || '';
      if (motivacaoViolenciaValue) {
        const motivacoes = motivacaoViolenciaValue
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editMotivacoesViolenciaSelecionadas = motivacoes;
      }
      renderizarTagsMotivacaoViolenciaEdit();
      console.log('[gerenciar] Motiva√ß√µes da viol√™ncia carregadas:', editMotivacoesViolenciaSelecionadas);
      
      // Preenche campo encaminhamento com sistema de tags
      editEncaminhamentosSelecionados = [];
      const encaminhamentoValue = registro.encaminhamento || '';
      if (encaminhamentoValue) {
        const encaminhamentos = encaminhamentoValue
          .split(',')
          .map(t => t.trim())
          .filter(t => t.length > 0);
        editEncaminhamentosSelecionados = encaminhamentos;
      }
      renderizarTagsEncaminhamentoEdit();
      console.log('[gerenciar] Encaminhamentos carregados:', editEncaminhamentosSelecionados);
      
      // Preenche campo CMEI/EMEF com autocomplete
      const cmeiEmefValue = registro.cmeiEmef || '';
      if (cmeiEmefValue) {
        // Verifica se √© uma sigla (2-6 letras mai√∫sculas)
        const isSigla = /^[A-Z]{2,6}$/.test(cmeiEmefValue.trim());
        
        // Detecta o tipo de institui√ß√£o a partir do nome ou busca nas institui√ß√µes
        let tipoDetectado = '';
        if (cmeiEmefValue.startsWith('CMEI')) {
          tipoDetectado = 'CMEI';
        } else if (cmeiEmefValue.startsWith('EMEF')) {
          tipoDetectado = 'EMEF';
        } else if (isSigla) {
          // Se √© uma sigla, tenta encontrar o tipo nas institui√ß√µes
          const instEncontrada = instituicoes.find(inst => inst.sigla === cmeiEmefValue.trim());
          if (instEncontrada) {
            tipoDetectado = instEncontrada.tipo;
          } else {
            // Se n√£o encontrar, tenta ambos os tipos (deixa o usu√°rio escolher)
            tipoDetectado = '';
          }
        } else {
          // Se n√£o come√ßa com CMEI/EMEF e n√£o √© sigla, assume EMEF por padr√£o
          tipoDetectado = 'EMEF';
        }
        
        // IMPORTANTE: Define uma flag para indicar que estamos CARREGANDO dados
        document.getElementById('edit_cmeiEmef').setAttribute('data-loading', 'true');
        
        // Se encontrou um tipo, preenche
        if (tipoDetectado) {
          document.getElementById('edit_tipoInstituicao').value = tipoDetectado;
          edit_tipoInstituicaoSelecionado = tipoDetectado;
          edit_instituicoesFiltradas = instituicoes.filter(inst => inst.tipo === tipoDetectado);
          document.getElementById('edit_cmeiEmef').disabled = false;
          document.getElementById('edit_cmeiEmef').placeholder = 'Digite para buscar...';
        }
        
        // CR√çTICO: Preenche o valor AP√ìS configurar tudo
        // Se √© uma sigla, preserva como est√°; caso contr√°rio, usa o valor completo
        document.getElementById('edit_cmeiEmef').value = cmeiEmefValue;
        
        // Marca como editado pelo usu√°rio se for uma sigla (para preservar)
        if (isSigla) {
          document.getElementById('edit_cmeiEmef').setAttribute('data-user-edited', 'true');
        }
        
        // Remove a flag ap√≥s um pequeno delay
        setTimeout(() => {
          document.getElementById('edit_cmeiEmef').removeAttribute('data-loading');
        }, 100);
        
        console.log('[gerenciar] CMEI/EMEF carregado:', cmeiEmefValue, 'Tipo:', tipoDetectado, '√â sigla:', isSigla);
      }
      // Preenche campo regi√£o (select)
      const regiaoValue = (registro.regiao || '').trim();
      document.getElementById('edit_regiao').value = regiaoValue;
      console.log('[gerenciar] Regi√£o preenchida com:', regiaoValue);
      
      // Mostra/oculta o campo conforme o valor de PCD
      if (registro.pcdTranstorno === 'Sim') {
        pcdDetalhesContainer.classList.remove('hidden');
      } else {
        pcdDetalhesContainer.classList.add('hidden');
      }
      
      console.log('[gerenciar] Valores recebidos do backend:');
      console.log('[gerenciar]   - fonteEscola:', registro.fonteEscola);
      console.log('[gerenciar]   - violenciaEscolaOcorreu:', registro.violenciaEscolaOcorreu);
      console.log('[gerenciar]   - profissionalAutor:', registro.profissionalAutor);
      console.log('[gerenciar]   - estudanteAutor:', registro.estudanteAutor);
      console.log('[gerenciar]   - violenciaNaoEscola:', registro.violenciaNaoEscola);
      console.log('[gerenciar]   - ocorreuEscola:', registro.ocorreuEscola);
      console.log('[gerenciar]   - violenciaInformada:', registro.violenciaInformada);
      console.log('[gerenciar]   - estudoCaso:', registro.estudoCaso);
      console.log('[gerenciar]   - pcdDetalhes:', registro.pcdDetalhes);
      
      console.log('[gerenciar] Campo dataNT preenchido com:', document.getElementById('edit_dataNT').value);
      console.log('[gerenciar] Campo identidadeGenero preenchido com:', document.getElementById('edit_identidadeGenero').value);
      
      // Mostra o modal
      document.getElementById('modalEdicao').classList.add('show');
    }

    // ========================================
    // FECHAR MODAL
    // ========================================
    function fecharModal() {
      document.getElementById('modalEdicao').classList.remove('show');
    }

    // ========================================
    // SALVAR EDI√á√ÉO
    // ========================================
    document.getElementById('formEdicao').addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Valida√ß√£o: se PCD = Sim, deve ter pelo menos um transtorno
      const pcdTranstorno = document.getElementById('edit_pcdTranstorno').value;
      const pcdDetalhes = document.getElementById('edit_pcdDetalhes').value;
      
      if (pcdTranstorno === 'Sim' && (!pcdDetalhes || pcdDetalhes.trim() === '')) {
        mostrarAlerta('‚ö†Ô∏è Por favor, adicione pelo menos um transtorno/defici√™ncia quando marcar "Sim" em PCD/Transtorno.', 'error');
        document.getElementById('edit_pcdDetalhes-tags').classList.add('border-red-500');
        setTimeout(() => {
          document.getElementById('edit_pcdDetalhes-tags').classList.remove('border-red-500');
        }, 3000);
        return;
      }
      
      const dados = {
        action: 'update',
        linha: document.getElementById('edit_linha').value,
        criancaEstudante: document.getElementById('edit_criancaEstudante').value,
        dataNT: document.getElementById('edit_dataNT').value,
        idade: document.getElementById('edit_idade').value,
        identidadeGenero: document.getElementById('edit_identidadeGenero').value,
        pcdTranstorno: document.getElementById('edit_pcdTranstorno').value,
        pcdDetalhes: document.getElementById('edit_pcdDetalhes').value,
        racaCor: document.getElementById('edit_racaCor').value,
        orientacaoSexual: document.getElementById('edit_orientacaoSexual').value,
        tipoViolencia: document.getElementById('edit_tipoViolencia').value,
        classificacaoViolencia: document.getElementById('edit_classificacaoViolencia').value,
        motivacaoViolencia: document.getElementById('edit_motivacaoViolencia').value,
        encaminhamento: document.getElementById('edit_encaminhamento').value,
        cmeiEmef: document.getElementById('edit_cmeiEmef').value,
        regiao: document.getElementById('edit_regiao').value,
        responsavelRegistro: document.getElementById('edit_responsavelRegistro').value,
        // Campos adicionais (radio buttons)
        fonteEscola: document.querySelector('input[name="edit_fonteEscola"]:checked')?.value || '',
        violenciaEscolaOcorreu: document.querySelector('input[name="edit_violenciaEscolaOcorreu"]:checked')?.value || '',
        profissionalAutor: document.querySelector('input[name="edit_profissionalAutor"]:checked')?.value || '',
        estudanteAutor: document.querySelector('input[name="edit_estudanteAutor"]:checked')?.value || '',
        violenciaNaoEscola: document.querySelector('input[name="edit_violenciaNaoEscola"]:checked')?.value || '',
        ocorreuEscola: document.querySelector('input[name="edit_ocorreuEscola"]:checked')?.value || '',
        violenciaInformada: document.querySelector('input[name="edit_violenciaInformada"]:checked')?.value || '',
        estudoCaso: document.querySelector('input[name="edit_estudoCaso"]:checked')?.value || ''
      };
      
      console.log('[gerenciar] === DADOS DE ATUALIZA√á√ÉO ===');
      console.log('[gerenciar] Campos de viol√™ncia sendo enviados:');
      console.log('[gerenciar]   - tipoViolencia:', dados.tipoViolencia);
      console.log('[gerenciar]   - classificacaoViolencia:', dados.classificacaoViolencia);
      console.log('[gerenciar]   - motivacaoViolencia:', dados.motivacaoViolencia);
      console.log('[gerenciar] Campos adicionais sendo enviados:');
      console.log('[gerenciar]   - pcdDetalhes:', dados.pcdDetalhes);
      console.log('[gerenciar]   - fonteEscola:', dados.fonteEscola);
      console.log('[gerenciar]   - violenciaEscolaOcorreu:', dados.violenciaEscolaOcorreu);
      console.log('[gerenciar]   - profissionalAutor:', dados.profissionalAutor);
      console.log('[gerenciar]   - estudanteAutor:', dados.estudanteAutor);
      console.log('[gerenciar]   - violenciaNaoEscola:', dados.violenciaNaoEscola);
      console.log('[gerenciar]   - ocorreuEscola:', dados.ocorreuEscola);
      console.log('[gerenciar]   - violenciaInformada:', dados.violenciaInformada);
      console.log('[gerenciar]   - estudoCaso:', dados.estudoCaso);
      console.log('[gerenciar] Payload completo:', JSON.stringify(dados));
      
      mostrarAlerta('üîÑ Salvando altera√ß√µes...', 'info');
      enviarAtualizacao(dados);
    });

    function enviarAtualizacao(dados) {
      // Se o campo n√£o foi alterado pelo usu√°rio, mant√©m o valor original
      const cmeiEmefInput = document.getElementById('edit_cmeiEmef');
      if (!cmeiEmefInput.getAttribute('data-user-edited')) {
        dados.cmeiEmef = cmeiEmefInput.value;
      }
      cmeiEmefInput.removeAttribute('data-user-edited');
      // Cria iframe oculto (otimizado)
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      
      // Listener para resposta
      const messageHandler = function(event) {
        // Aceita APENAS mensagens do Google Apps Script com resposta v√°lida
        if (!event.origin.includes('google') || !event.data || typeof event.data.success === 'undefined') {
          return;
        }
        
        if (event.data && event.data.success) {
          fecharModal();
          mostrarAlerta('‚úÖ Registro atualizado com sucesso!', 'success');
          setTimeout(() => carregarRegistros(true), 100);
        } else {
          mostrarAlerta('‚ùå Erro: ' + (event.data?.message || 'Falha ao atualizar'), 'error');
        }
        
        window.removeEventListener('message', messageHandler);
        setTimeout(() => iframe.remove(), 100);
      };
      
      window.addEventListener('message', messageHandler);
      
      // Cria formul√°rio para enviar via POST
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = APPS_SCRIPT_URL;
      form.target = iframe.name = 'frame_' + Date.now();
      
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'dados';
      input.value = JSON.stringify(dados);
      form.appendChild(input);
      
      document.body.appendChild(iframe);
      document.body.appendChild(form);
      form.submit();
      setTimeout(() => form.remove(), 100);
      
      // Timeout de seguran√ßa
      setTimeout(() => {
        window.removeEventListener('message', messageHandler);
        iframe.remove();
      }, 10000);
    }

    // ========================================
    // CONFIRMAR EXCLUS√ÉO
    // ========================================
    function confirmarExclusao(linha, nome) {
      const confirmacao = confirm(
        `‚ö†Ô∏è ATEN√á√ÉO - EXCLUS√ÉO PERMANENTE\n\n` +
        `Deseja realmente EXCLUIR o registro de:\n` +
        `"${nome}"\n\n` +
        `Esta a√ß√£o N√ÉO pode ser desfeita!\n\n` +
        `Clique em OK para confirmar a exclus√£o.`
      );
      
      if (confirmacao) {
        mostrarAlerta('üîÑ Excluindo registro...', 'info');
        excluirRegistro(linha);
      }
    }

    function excluirRegistro(linha) {
      const dados = {
        action: 'delete',
        linha: linha
      };
      
      // Cria iframe oculto
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      
      // Listener para resposta
      const messageHandler = function(event) {
        // Aceita APENAS mensagens do Google Apps Script com resposta v√°lida
        if (!event.origin.includes('google') || !event.data || typeof event.data.success === 'undefined') {
          return;
        }
        
        if (event.data && event.data.success) {
          mostrarAlerta('üóëÔ∏è Registro exclu√≠do com sucesso!', 'success');
          setTimeout(() => carregarRegistros(true), 300);
        } else {
          mostrarAlerta('‚ùå Erro: ' + (event.data?.message || 'Falha ao excluir'), 'error');
        }
        
        window.removeEventListener('message', messageHandler);
        setTimeout(() => iframe.remove(), 100);
      };
      
      window.addEventListener('message', messageHandler);
      
      // Cria formul√°rio para enviar via POST
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = APPS_SCRIPT_URL;
      form.target = iframe.name = 'frame_' + Date.now();
      
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'dados';
      input.value = JSON.stringify(dados);
      form.appendChild(input);
      
      document.body.appendChild(iframe);
      document.body.appendChild(form);
      form.submit();
      setTimeout(() => form.remove(), 100);
      
      // Timeout de seguran√ßa otimizado (reduzido de 10s para 6s)
      setTimeout(() => {
        window.removeEventListener('message', messageHandler);
        iframe.remove();
      }, 6000);
    }

    // ========================================
    // VERIFICAR AUTENTICA√á√ÉO
    // ========================================
    function verificarAutenticacao() {
      const userRole = sessionStorage.getItem('userRole');
      const userEmail = sessionStorage.getItem('userEmail');
      
      // Se n√£o estiver autenticado, redireciona para login
      if (!userRole || !userEmail) {
        alert('Acesso negado! Fa√ßa login para acessar o sistema.');
        window.location.href = 'index.html';
        return;
      }
    }

    // ========================================
    // MENU MOBILE TOGGLE
    // ========================================
    function toggleMobileMenu() {
      const mobileMenu = document.getElementById('mobileMenuNav');
      const menuIcon = mobileMenu?.previousElementSibling?.querySelector('svg');
      if (mobileMenu) {
        mobileMenu.classList.toggle('show');
        if (menuIcon) {
          menuIcon.style.transform = mobileMenu.classList.contains('show') ? 'rotate(90deg)' : 'rotate(0deg)';
        }
      }
    }
    
    // Fecha o menu ao redimensionar para desktop
    window.addEventListener('resize', function() {
      if (window.innerWidth > 768) {
        const mobileMenu = document.getElementById('mobileMenuNav');
        const menuIcon = mobileMenu?.previousElementSibling?.querySelector('svg');
        if (mobileMenu && mobileMenu.classList.contains('show')) {
          mobileMenu.classList.remove('show');
          if (menuIcon) {
            menuIcon.style.transform = 'rotate(0deg)';
          }
        }
      }
    });

    // ========================================
    // VERIFICAR E MOSTRAR MENU ADMIN
    // ========================================
    function verificarMenuAdmin() {
      const userRole = sessionStorage.getItem('userRole');
      const menuAdmin = document.getElementById('menuAdmin');
      const btnSair = document.getElementById('btnSair');
      const menuAdminMobile = document.getElementById('menuAdminMobile');
      const btnSairMobile = document.getElementById('btnSairMobile');
      
      if (userRole === 'admin' || userRole === 'superuser') {
        if (menuAdmin) {
          menuAdmin.classList.remove('hidden');
        }
        if (btnSair) {
          btnSair.classList.remove('hidden');
        }
        if (menuAdminMobile) {
          menuAdminMobile.classList.remove('hidden');
        }
        if (btnSairMobile) {
          btnSairMobile.classList.remove('hidden');
        }
      }
    }

    // ========================================
    // FUN√á√ÉO SAIR
    // ========================================
    function sair() {
      if (confirm('Deseja realmente sair do sistema?')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    }

    // Inicializa ao carregar p√°gina
    window.addEventListener('DOMContentLoaded', () => {
      // Fecha o menu mobile ao clicar em qualquer link
      const mobileMenuLinks = document.querySelectorAll('#mobileMenuNav a');
      mobileMenuLinks.forEach(link => {
        link.addEventListener('click', function() {
          const mobileMenu = document.getElementById('mobileMenuNav');
          const menuIcon = mobileMenu?.previousElementSibling?.querySelector('svg');
          if (mobileMenu) {
            mobileMenu.classList.remove('show');
            if (menuIcon) {
              menuIcon.style.transform = 'rotate(0deg)';
            }
          }
        });
      });
      
      verificarAutenticacao();
      verificarMenuAdmin();
      carregarRegistros(); // Carrega os registros automaticamente
    });
  </script>

</body>
</html>
